<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <!-- disqus image-->
  <meta property="og:image" content="https://dustinpfister.github.io/css/images/banner.jpg">
  
  <title>Idle Game Electronjs project example - MrSun Idle prototype | Dustin John Pfister at github pages</title>
  
  <!-- no index tag or blank here -->
  
  
  <link rel="canonical" href="https://dustinpfister.github.io/2023/04/28/electronjs-example-game-mrsun/" />

  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="When it comes to my collection of electronjs examples thus far I do not have an example that is some kind of game project, so I have started one project that is a kind of Idle Game. The game prototype">
<meta property="og:type" content="article">
<meta property="og:title" content="Idle Game Electronjs project example - MrSun Idle prototype">
<meta property="og:url" content="https://dustinpfister.github.io/2023/04/28/electronjs-example-game-mrsun/index.html">
<meta property="og:site_name" content="Dustin John Pfister at github pages">
<meta property="og:description" content="When it comes to my collection of electronjs examples thus far I do not have an example that is some kind of game project, so I have started one project that is a kind of Idle Game. The game prototype">
<meta property="og:updated_time" content="2023-05-05T16:00:20.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Idle Game Electronjs project example - MrSun Idle prototype">
<meta name="twitter:description" content="When it comes to my collection of electronjs examples thus far I do not have an example that is some kind of game project, so I have started one project that is a kind of Idle Game. The game prototype">
  
    <link rel="alternate" href="/atom.xml" title="Dustin John Pfister at github pages" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.ico">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  <!-- Google Analytics -->

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-Y8XLNG6JRW"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-Y8XLNG6JRW');
</script>
<!-- End Google Analytics -->


  <!-- structured data set in structured-data.ejs -->
<script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "Person",
    "email": "distin.pfister@gmail.com",
    "givenName": "Dustin",
    "familyName" : "Pfister",
    "additionalName": "John",
    "name": "Dustin John Pfister",
    "gender": "Male"
}
</script>
<!-- end structured data -->
  
  <!-- adsense if indexed -->
  
  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
  (adsbygoogle = window.adsbygoogle || []).push({
    google_ad_client: "ca-pub-1658284027672315",
    enable_page_level_ads: true
  });
  </script>
  
  
</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <!-- added the image, as well as the link to my youtube -->
        <a href="https://www.youtube.com/user/javaweaver"><div class="selfimage"></div></a>
        <!--<a href="/" id="logo">Dustin John Pfister at github pages</a>-->
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
          <a class="main-nav-link" href="/2021/02/19/threejs-examples/">ThreeJS</a>
        
          <a class="main-nav-link" href="/2020/03/23/canvas-example/">Canvas</a>
        
          <a class="main-nav-link" href="https://www.youtube.com/user/javaweaver">Youtube</a>
        
          <a class="main-nav-link" href="https://github.com/dustinpfister">Github</a>
        
          <a class="main-nav-link" href="/about">About</a>
        
      </nav>
      <nav id="sub-nav">
        <!-- removed rss link-->
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://dustinpfister.github.io"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article itemscope itemtype="http://schema.org/Blog" id="post-electronjs-example-game-mrsun" class="article article-type-post" itemprop="blogPost">
  <div class="article-meta">
    <a href="/2023/04/28/electronjs-example-game-mrsun/" class="article-date"> Published:
  <time datetime="2023-04-28T12:19:00.000Z" itemprop="datePublished">2023-04-28</time>
</a>

    <!-- other info (dustin) -->
    <a href="/2023/04/28/electronjs-example-game-mrsun/" class="article-date"> Modified:
  <time datetime="2023-05-05T16:00:20.000Z" itemprop="dateModified">2023-05-05</time>
</a>

    <span class="article-date">V1.11</span>

    
  <div class="article-category">
    <a class="article-category-link" href="/categories/electronjs/">electronjs</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Idle Game Electronjs project example - MrSun Idle prototype
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="text">
      
        <p>When it comes to my collection of electronjs examples thus far I do not have an example that is some kind of game project, so I have started one project that is a kind of <a href="https://en.wikipedia.org/wiki/Incremental_game" target="_blank" rel="external">Idle Game</a>. The game prototype idea is called MrSun, and the general idea is to have a single object that is a sun, and a bunch of objects around the sun that are land sections. Each land section is then composed of a grid of slots, each of which can contain a block that will generate the main game currently which in this case is mana.</p>
<p>The sun can then be moved into other locations in the area between all the land section objects. When doing so the distance from the sun to each land section object will change which will result in temperature changes for each land section. The changes in temperature will then effect the rate at which mana for each block in a given land section is. That is that I have a base mana amount, and a temperature mana amount that together compose the total mana delta amount for each block in each slot in each land section.</p>
<p>I have made a whole lot of game prototypes in the past when it comes to my collection of html canvas examples, but this time around with my electronjs examples I would like to focus more so on quality rather than quantity. For this game prototype I have stayed in my lane for the good part of a month, and on top of that I have plans to continue working on this project in a stand alone repository as well. So then this will not just be yet another prototype but a game that I will keep working on, and playing myself, for a little while every day.</p>
<p>What I have in mind here then is not just another idle game, but a game that also pulls in elements of strategy, simulation, and sandbox type games. The core features of an idle game are there is the prototype all ready, and as I keep working on this as a stand alone project I will be seeking to further refine the features in place as well as take additional steps with various other ideas that I think will add more value to this project.</p>
<a id="more"></a>
<h2 id="The-MrSun-Idle-Game-Prototype-and-what-to-know-first"><a href="#The-MrSun-Idle-Game-Prototype-and-what-to-know-first" class="headerlink" title="The MrSun Idle Game Prototype and what to know first"></a>The MrSun Idle Game Prototype and what to know first</h2><p>In this post I am writing about a electronjs project example that is my first electronjs game project that is an example of an idle game project. I really went off the deep end with this one when it comes to the client system which is composed of many modules of my own design. I did not write all of them from the ground up though, many are based on source code examples that I have started for many other projects, others are hacked over threejs source code files. I have also borrowed code from a few other projects as well, and it would look like I will need to release any final product based on this under the MIT License because of it. In any case this is not a post for people that are <a href="/2022/02/07/electronjs-hello-world/">new to using electronjs</a></p>
<h3 id="The-full-up-to-date-source-code-for-the-prototype-can-be-found-on-Github"><a href="#The-full-up-to-date-source-code-for-the-prototype-can-be-found-on-Github" class="headerlink" title="The full up to date source code for the prototype can be found on Github"></a>The full up to date source code for the prototype can be found on Github</h3><p>The best way to get things up and running with the prototype that I am writing about in this post might be to <a href="https://github.com/dustinpfister/examples-electronjs" target="_blank" rel="external">clone down my elecitonjs examples repo</a> and then do an npm install for the <a href="https://github.com/dustinpfister/examples-electronjs/tree/master/for_post/electronjs-example-mrsun" target="_blank" rel="external">electronjs-example-mrsun project</a> in the for post folder. This will install the version of electronjs I was using and as of this writing that is the only npm package that is being used for this one.</p>
<h3 id="Version-Numbers"><a href="#Version-Numbers" class="headerlink" title="Version Numbers"></a>Version Numbers</h3><p>When I wrote this blog post I was writing about R86 of my MrSun Idle Electionjs Example. Sense the writing of this post it is likley that I have made at least a few more revisions of the example, and have not got around to editing this post just yet. Also I might have started a whole other project based off of this source code as well.</p>
<h2 id="1-electronjs-Files"><a href="#1-electronjs-Files" class="headerlink" title="1 - electronjs Files"></a>1 - electronjs Files</h2><p>As with just about any electronjs project there are two general things to write about, electronjs code and the client system code. In this section I am going to be writing about what it is that I have in place when it comes to the typical electronjs files such as the main.js and <a href="/2022/02/21/electronjs-context-bridge/">preload.js</a> files. On top of those two files I also have one additional nodejs script that I should write about also while I am at it.</p>
<h3 id="1-1-The-main-js-file"><a href="#1-1-The-main-js-file" class="headerlink" title="1.1 - The main.js file"></a>1.1 - The main.js file</h3><p>There is not much to write about when it comes to the main.js file with this one actually. For this project I really went off the deep end when it comes to the client side code, but not so much when it comes to the front end code. So I just have a create main window helper function, a custom menu, and then a few events here.</p>
<h3 id="1-2-The-preload-js-file"><a href="#1-2-The-preload-js-file" class="headerlink" title="1.2 - The preload.js file"></a>1.2 - The preload.js file</h3><p>While working on this project I ran into a problem that had to do with a race condition when saving a game state file to the file system. If a save was in progress and I quit or reloaded the game before the save was finished I would loose my save state. There might be a number of ways to go about addressing this problem but the way that I solved it was by just making use of an additional nodejs file and using the <a href="/2019/08/07/nodejs-child-process-fork/">fork method</a> of the <a href="/2018/02/04/nodejs-child-process/">nodejs child process module</a> to launch a save as a whole other detached process on the client system. This way the detached process will continue even if the main game process was killed, or the game was reloaded.</p>
<h3 id="1-3-The-save-file-script-savefile-js"><a href="#1-3-The-save-file-script-savefile-js" class="headerlink" title="1.3 - The save file script savefile.js"></a>1.3 - The save file script savefile.js</h3><p>As I have covered in the section on the preload.js file for this game prototype. Nothing major with this script as it just needs to be a very basic script that will just write a file using the write file method of the <a href="/2019/06/14/nodejs-filesystem-write-file/">nodejs file system module</a>.</p>
<h2 id="2-The-Client-system"><a href="#2-The-Client-system" class="headerlink" title="2 - The Client system"></a>2 - The Client system</h2><p>Now that I have covered all the code that has to do with the electronjs files there is now going over all the code that has to do with the client system for this game. This is where things get a little involved with this as I worked on this game prototype a little each day for the good part of a month. There are a lot of javaScript modules that compose the game code thus far then. The onces that I have not done much with I will just write about and link to where you can see the copies of the modules that I am using in the github project folder. Others I have hacked over a lot, or have wrote from the ground up and as such I might post the code here then.</p>
<h2 id="3-Using-a-copy-of-Decimal-js-for-high-percision-math"><a href="#3-Using-a-copy-of-Decimal-js-for-high-percision-math" class="headerlink" title="3 - Using a copy of Decimal.js for high percision math"></a>3 - Using a copy of Decimal.js for high percision math</h2><p>I have went with <a href="https://github.com/dustinpfister/examples-electronjs/tree/master/for_post/electronjs-example-mrsun/html/js/decimal" target="_blank" rel="external">decimal.js</a> as a module for working with very big numbers. If you have coded with javaScript as long as I have then chances are I do not need to lecture you as to why it is a good idea to use a library like this when making any kind of project that involves working with very big numbers which is often the case with idle games. If not then there is reading up more on what <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number/MAX_SAFE_INTEGER" target="_blank" rel="external">max safe integer</a> is to get an idea with what the limits are with regular javaScript numbers. A possible native alternative to bothering with a user space module would be to use <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/BigInt" target="_blank" rel="external">big integers</a>, however I find them lacking when it comes to math methods.</p>
<h2 id="4-Using-event-dispatcher-from-threejs"><a href="#4-Using-event-dispatcher-from-threejs" class="headerlink" title="4 - Using event-dispatcher from threejs"></a>4 - Using event-dispatcher from threejs</h2><p>I am using the <a href="https://github.com/dustinpfister/examples-electronjs/tree/master/for_post/electronjs-example-mrsun/html/js/event-dispatcher" target="_blank" rel="external">event-dispatcher source code</a> files from the threejs project. I have decided to make this a 2d game, but I have found that I would still like to use some features from threejs by just making use of some of the source code files. The <a href="https://threejs.org/docs/index.html#api/en/core/EventDispatcher" target="_blank" rel="external">event dispatcher</a> in threejs is a way to go about creating custom user space events for plain old javaScript objects rather that elements. I am using this to create events for my main game object.</p>
<h2 id="5-Using-lz-string-to-compress-save-state-data"><a href="#5-Using-lz-string-to-compress-save-state-data" class="headerlink" title="5 - Using lz-string to compress save state data"></a>5 - Using lz-string to compress save state data</h2><p>I have went with <a href="https://github.com/dustinpfister/examples-electronjs/tree/master/for_post/electronjs-example-mrsun/html/js/lz-string" target="_blank" rel="external">lz-string</a> to compress save state data. For this project I have made a custom hack job of the file in order to turn it into a javaScript module, and while I was at it I removed all the code that I was not using.</p>
<h2 id="6-A-hacked-over-THREEJS-Vector2-Class"><a href="#6-A-hacked-over-THREEJS-Vector2-Class" class="headerlink" title="6 - A hacked over THREEJS Vector2 Class"></a>6 - A hacked over THREEJS Vector2 Class</h2><p>I made a <a href="https://github.com/dustinpfister/examples-electronjs/tree/master/for_post/electronjs-example-mrsun/html/js/vector2" target="_blank" rel="external">copy of the Vector2 class</a> and hacked over it a little. One major change that I made has to do with the methods for getting angles between two points as I have found that the angle to method that comes with the class is not working the way that I would like it to. I thus went with an angle to method that is just an abstraction for the usual deal with the Math.atan2 method that is often what will be used for this kind of task in some way. The angle to method in the threejs vector2 class also makes use of a single method in that math utils object, so the options are then to add the whole math utils module also, copy over the source code for this single method, or just start removing code that I am not using from this custom cut Vector2 class module.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Vector2 class for electronjs-example-mrsun</span></div><div class="line"><span class="comment">// Based on the source code from the Vector2 class from r151 of threejs</span></div><div class="line"><span class="comment">// https://raw.githubusercontent.com/mrdoob/three.js/r151/src/math/Vector2.js</span></div><div class="line"><span class="comment">//-------- ----------</span></div><div class="line"><span class="comment">// EXPORT</span></div><div class="line"><span class="comment">//-------- ----------</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Vector2</span> </span>&#123;</div><div class="line">    <span class="keyword">constructor</span>(x = 0, y = 0) &#123;</div><div class="line">        Vector2.prototype.isVector2 = <span class="literal">true</span>;</div><div class="line">        <span class="keyword">this</span>.x = x;</div><div class="line">        <span class="keyword">this</span>.y = y;</div><div class="line">    &#125;</div><div class="line">    get width() &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.x;</div><div class="line">    &#125;</div><div class="line">    set width(value) &#123;</div><div class="line">        <span class="keyword">this</span>.x = value;</div><div class="line">    &#125;</div><div class="line">    get height() &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.y;</div><div class="line">    &#125;</div><div class="line">    set height(value) &#123;</div><div class="line">        <span class="keyword">this</span>.y = value;</div><div class="line">    &#125;</div><div class="line">    set(x, y) &#123;</div><div class="line">        <span class="keyword">this</span>.x = x;</div><div class="line">        <span class="keyword">this</span>.y = y;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">    &#125;</div><div class="line">    clone() &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="keyword">this</span>.constructor(<span class="keyword">this</span>.x, <span class="keyword">this</span>.y);</div><div class="line">    &#125;</div><div class="line">    copy(v) &#123;</div><div class="line">        <span class="keyword">this</span>.x = v.x;</div><div class="line">        <span class="keyword">this</span>.y = v.y;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">    &#125;</div><div class="line">    normalize() &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.divideScalar(<span class="keyword">this</span>.length() || <span class="number">1</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// added a radianTo method becuse the angleTo method is not working a certain way that I need it to.</span></div><div class="line">    radianTo(v)&#123;</div><div class="line">        <span class="keyword">const</span> r = <span class="built_in">Math</span>.atan2(<span class="keyword">this</span>.y - v.y, <span class="keyword">this</span>.x - v.x);</div><div class="line">        <span class="keyword">return</span> r &lt; <span class="number">0</span> ? <span class="built_in">Math</span>.PI * <span class="number">2</span> + r  : r;</div><div class="line">    &#125;</div><div class="line">    distanceTo(v) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="built_in">Math</span>.sqrt(<span class="keyword">this</span>.distanceToSquared(v));</div><div class="line">    &#125;</div><div class="line">    distanceToSquared(v) &#123;</div><div class="line">        <span class="keyword">const</span> dx = <span class="keyword">this</span>.x - v.x,</div><div class="line">        dy = <span class="keyword">this</span>.y - v.y;</div><div class="line">        <span class="keyword">return</span> dx * dx + dy * dy;</div><div class="line">    &#125;</div><div class="line">    setLength(length) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.normalize().multiplyScalar(length);</div><div class="line">    &#125;</div><div class="line">    lerp(v, alpha) &#123;</div><div class="line">        <span class="keyword">this</span>.x += (v.x - <span class="keyword">this</span>.x) * alpha;</div><div class="line">        <span class="keyword">this</span>.y += (v.y - <span class="keyword">this</span>.y) * alpha;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">    &#125;</div><div class="line">     * [<span class="built_in">Symbol</span>.iterator]() &#123;</div><div class="line">        <span class="keyword">yield</span> <span class="keyword">this</span>.x;</div><div class="line">        <span class="keyword">yield</span> <span class="keyword">this</span>.y;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">//-------- ----------</span></div><div class="line"><span class="comment">// EXPORT</span></div><div class="line"><span class="comment">//-------- ----------</span></div><div class="line"><span class="keyword">export</span> &#123; Vector2 &#125;;</div></pre></td></tr></table></figure>
<h2 id="7-Object2d"><a href="#7-Object2d" class="headerlink" title="7 - Object2d"></a>7 - Object2d</h2><p>I <a href="https://github.com/dustinpfister/examples-electronjs/tree/master/for_post/electronjs-example-mrsun/html/js/object2d" target="_blank" rel="external">started an Object2d class</a> which I would like to make like that of the Object3d class in threejs. Maybe not so much in this prototype, but as I start to work on a final game based off of this I am sure I will expand on this class a whole lot.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Object2d class based on the Object3d class of threejs</span></div><div class="line"><span class="comment">// https://raw.githubusercontent.com/mrdoob/three.js/r151/src/core/Object3D.js</span></div><div class="line"><span class="keyword">import</span> &#123; Vector2 &#125; <span class="keyword">from</span> <span class="string">'../vector2/vector2.mjs'</span>;</div><div class="line"><span class="keyword">import</span> &#123; EventDispatcher &#125; <span class="keyword">from</span> <span class="string">'../event-dispatcher/EventDispatcher.mjs'</span>;</div><div class="line"> </div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Object2D</span> <span class="keyword">extends</span> <span class="title">EventDispatcher</span> </span>&#123;</div><div class="line">    <span class="keyword">constructor</span>() &#123;</div><div class="line">        <span class="keyword">super</span>();</div><div class="line">        <span class="keyword">this</span>.name = <span class="string">''</span>;</div><div class="line">        <span class="keyword">this</span>.type = <span class="string">'Object3D'</span>;</div><div class="line">        <span class="keyword">this</span>.parent = <span class="literal">null</span>;</div><div class="line">        <span class="keyword">this</span>.children = [];</div><div class="line">        <span class="comment">// position</span></div><div class="line">        <span class="keyword">const</span> position = <span class="keyword">new</span> Vector2();</div><div class="line">        <span class="keyword">const</span> size = <span class="keyword">new</span> Vector2();</div><div class="line">        <span class="built_in">Object</span>.defineProperties( <span class="keyword">this</span>, &#123;</div><div class="line">            <span class="attr">position</span>: &#123;</div><div class="line">            <span class="attr">configurable</span>: <span class="literal">true</span>,</div><div class="line">                <span class="attr">enumerable</span>: <span class="literal">true</span>,</div><div class="line">                <span class="attr">value</span>: position</div><div class="line">            &#125;</div><div class="line">        &#125; );</div><div class="line">        <span class="keyword">this</span>.userData = &#123;&#125;;</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line"> </div><div class="line"><span class="keyword">export</span> &#123; Object2D &#125;;</div></pre></td></tr></table></figure>
<h2 id="8-Object2d-sprite"><a href="#8-Object2d-sprite" class="headerlink" title="8 - Object2d-sprite"></a>8 - Object2d-sprite</h2><p>For this prototype thus far I have one additional module in which I <a href="https://github.com/dustinpfister/examples-electronjs/tree/master/for_post/electronjs-example-mrsun/html/js/object2d-sprite" target="_blank" rel="external">extend from my base object2d class that is a sprite class</a>.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> &#123; Vector2 &#125; <span class="keyword">from</span> <span class="string">'../vector2/vector2.mjs'</span>;</div><div class="line"><span class="keyword">import</span> &#123; Object2D &#125; <span class="keyword">from</span> <span class="string">'../object2d/object2d.mjs'</span>;</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">SpriteSheet</span> </span>&#123;</div><div class="line">    <span class="keyword">constructor</span>(image) &#123;</div><div class="line">        <span class="keyword">this</span>.image = image || <span class="literal">null</span>;</div><div class="line">        <span class="keyword">this</span>.cell_data = [];</div><div class="line">        <span class="keyword">this</span>.cell_count = <span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// set the cell data to a grid using the current image, and a given cellSize Vector2</span></div><div class="line">    setCellDataToGrid( cellSize = <span class="keyword">new</span> Vector2(<span class="number">32</span>, <span class="number">32</span>) )&#123;</div><div class="line">        <span class="keyword">this</span>.cell_data = [];</div><div class="line">        <span class="keyword">let</span> i = <span class="number">0</span>;</div><div class="line">        <span class="keyword">const</span> grid_w = <span class="built_in">Math</span>.floor( <span class="keyword">this</span>.image.width / cellSize.x );</div><div class="line">        <span class="keyword">const</span> grid_h = <span class="built_in">Math</span>.floor( <span class="keyword">this</span>.image.height / cellSize.y );</div><div class="line">        <span class="keyword">const</span> len = <span class="keyword">this</span>.cell_count = grid_w * grid_h;</div><div class="line">        <span class="keyword">while</span>(i &lt; len)&#123;</div><div class="line">            <span class="keyword">const</span> gx = i % grid_w;</div><div class="line">            <span class="keyword">const</span> gy = <span class="built_in">Math</span>.floor(i / grid_w );</div><div class="line">            <span class="keyword">const</span> x = gx * cellSize.x;</div><div class="line">            <span class="keyword">const</span> y = gy * cellSize.y;</div><div class="line">            <span class="keyword">this</span>.cell_data.push(x, y, cellSize.x, cellSize.y);</div><div class="line">            i += <span class="number">1</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    getCell( index = <span class="number">0</span> )&#123;</div><div class="line">        <span class="keyword">const</span> cd = <span class="keyword">this</span>.cell_data;</div><div class="line">        <span class="keyword">return</span> &#123;</div><div class="line">           <span class="attr">sx</span>: cd[ index * <span class="number">4</span> + <span class="number">0</span> ],</div><div class="line">           <span class="attr">sy</span>: cd[ index * <span class="number">4</span> + <span class="number">1</span> ],</div><div class="line">           <span class="attr">sw</span>: cd[ index * <span class="number">4</span> + <span class="number">2</span> ],</div><div class="line">           <span class="attr">sh</span>: cd[ index * <span class="number">4</span> + <span class="number">3</span> ]</div><div class="line">        &#125;;</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Sprite</span> <span class="keyword">extends</span> <span class="title">Object2D</span> </span>&#123;</div><div class="line">    <span class="keyword">constructor</span>() &#123;</div><div class="line">        <span class="keyword">super</span>();</div><div class="line">        <span class="keyword">this</span>.type = <span class="string">'Sprite'</span>;</div><div class="line">        <span class="comment">// size</span></div><div class="line">        <span class="keyword">const</span> size = <span class="keyword">new</span> Vector2();</div><div class="line">        <span class="built_in">Object</span>.defineProperties( <span class="keyword">this</span>, &#123;</div><div class="line">            <span class="attr">size</span>: &#123;</div><div class="line">                <span class="attr">configurable</span>: <span class="literal">true</span>,</div><div class="line">                <span class="attr">enumerable</span>: <span class="literal">true</span>,</div><div class="line">                <span class="attr">value</span>: size</div><div class="line">            &#125;</div><div class="line">        &#125; );</div><div class="line">        <span class="keyword">this</span>.sheets = [];</div><div class="line">        <span class="keyword">this</span>.cellIndices = [];</div><div class="line">        <span class="keyword">this</span>.userData = &#123;&#125;;</div><div class="line">    &#125;</div><div class="line">    getCell(sheetIndex)&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.sheets[ sheetIndex ].getCell( <span class="keyword">this</span>.cellIndices[ sheetIndex] );</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line"><span class="keyword">export</span> &#123; Sprite, SpriteSheet &#125;;</div></pre></td></tr></table></figure>
<h2 id="9-Canvas"><a href="#9-Canvas" class="headerlink" title="9 - Canvas"></a>9 - Canvas</h2><p>I started a custom canvas module for this game based on what I made for my <a href="/2018/04/17/threejs-canvas-texture/">blog post on canvas textures in threejs</a>. I removed a lot of the built in draw functions that I will not be using in this project, and also turned it into a javaScript module rather than the IIFE format that is was in.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// canvas.mjs - a canvas module</span></div><div class="line"><span class="comment">// based on r2 of my canvas module from my blog post on canvas textures from threejs-canvas-texture</span></div><div class="line"><span class="keyword">import</span> &#123; LZString &#125;  <span class="keyword">from</span> <span class="string">"../lz-string/1.4.4/lz-string.mjs"</span></div><div class="line"><span class="keyword">const</span> canvasMod = &#123;&#125;;</div><div class="line"><span class="comment">//-------- ----------</span></div><div class="line"><span class="comment">// HELEPRS</span></div><div class="line"><span class="comment">//-------- ----------</span></div><div class="line"><span class="comment">// parse draw option helper</span></div><div class="line"><span class="keyword">const</span> parseDrawOption = <span class="function">(<span class="params">opt</span>) =&gt;</span> &#123;</div><div class="line">    <span class="comment">// if opt.draw is false for any reason return DRAW.square</span></div><div class="line">    <span class="keyword">if</span>(!opt.draw)&#123;</div><div class="line">        <span class="keyword">return</span> DRAW.rnd;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// if a string is given assume it is a key for a built in draw method</span></div><div class="line">    <span class="keyword">if</span>(<span class="keyword">typeof</span> opt.draw === <span class="string">'string'</span>)&#123;</div><div class="line">        <span class="keyword">return</span> DRAW[opt.draw];</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// assume we where given a custom function</span></div><div class="line">    <span class="keyword">return</span> opt.draw;</div><div class="line">&#125;;</div><div class="line"><span class="comment">// parse state data objects</span></div><div class="line"><span class="keyword">const</span> parseStateData = <span class="function">(<span class="params">canObj, opt</span>) =&gt;</span> &#123;</div><div class="line">    <span class="keyword">const</span> data = canObj.state.data</div><div class="line">    <span class="comment">// all of this only applys to data strings</span></div><div class="line">    <span class="keyword">if</span>(<span class="keyword">typeof</span> data != <span class="string">'string'</span>)&#123;</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// plain data string ex '0,0,0,0,0,0,0,0'</span></div><div class="line">    <span class="keyword">if</span>(opt.dataParse === <span class="string">'string'</span>)&#123;</div><div class="line">        canObj.state.data = data.split(<span class="string">','</span>);</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// try to use LZString if it is there</span></div><div class="line">    <span class="keyword">if</span>(opt.dataParse === <span class="string">'lzstring'</span>)&#123;</div><div class="line">        <span class="keyword">try</span>&#123;</div><div class="line">           <span class="keyword">const</span> str = LZString.decompress(data);</div><div class="line">           canObj.state.data = str.split(<span class="string">','</span>);</div><div class="line">           <span class="keyword">return</span>;</div><div class="line">        &#125;<span class="keyword">catch</span>(e)&#123;</div><div class="line">           <span class="built_in">console</span>.log(<span class="string">'some error with lz-string.js'</span>);</div><div class="line">           <span class="built_in">console</span>.log(e);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// try to use LZString if it is there base64 style</span></div><div class="line">    <span class="keyword">if</span>(opt.dataParse === <span class="string">'lzstring64'</span>)&#123;</div><div class="line">       <span class="keyword">try</span>&#123;</div><div class="line">           <span class="keyword">const</span> str = LZString.decompressFromBase64(data);</div><div class="line">           canObj.state.data = str.split(<span class="string">','</span>);</div><div class="line">           <span class="keyword">return</span>;</div><div class="line">       &#125;<span class="keyword">catch</span>(e)&#123;</div><div class="line">           <span class="built_in">console</span>.log(<span class="string">'some error with lz-string.js'</span>);</div><div class="line">           <span class="built_in">console</span>.log(e);</div><div class="line">       &#125;</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line"><span class="comment">// draw grid helper for built in draw methods 'grid_palette' and 'rnd'</span></div><div class="line"><span class="keyword">const</span> draw_grid_fill = <span class="function">(<span class="params">ctx, canvas, iw, ih, getColor</span>) =&gt;</span> &#123;</div><div class="line">    getColor = getColor || <span class="function"><span class="keyword">function</span>(<span class="params">color</span>)</span>&#123; <span class="keyword">return</span> color &#125;;</div><div class="line">    <span class="keyword">const</span> len = iw * ih;</div><div class="line">    <span class="keyword">const</span> pxW = canvas.width / iw;</div><div class="line">    <span class="keyword">const</span> pxH = canvas.height / ih;</div><div class="line">    <span class="keyword">let</span> i = <span class="number">0</span>;</div><div class="line">    ctx.clearRect(<span class="number">0</span>, <span class="number">0</span>, canvas.width, canvas.height);</div><div class="line">    <span class="keyword">while</span>(i &lt; len)&#123;</div><div class="line">        <span class="keyword">const</span> x = i % iw;</div><div class="line">        <span class="keyword">const</span> y = <span class="built_in">Math</span>.floor(i / iw);</div><div class="line">        ctx.fillStyle = getColor(x, y, i);</div><div class="line">        <span class="keyword">const</span> px = x * pxW;</div><div class="line">        <span class="keyword">const</span> py = y * pxH;</div><div class="line">        ctx.fillRect(px, py, pxW, pxH);</div><div class="line">        i += <span class="number">1</span>;</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line"><span class="comment">//-------- ----------</span></div><div class="line"><span class="comment">// built in draw methods</span></div><div class="line"><span class="comment">//-------- ----------</span></div><div class="line"><span class="keyword">const</span> DRAW = &#123;&#125;;</div><div class="line"><span class="comment">// draw a grid with palette data</span></div><div class="line">DRAW.grid_palette = <span class="function">(<span class="params">canObj, ctx, canvas, state</span>) =&gt;</span> &#123;</div><div class="line">    <span class="keyword">const</span> w =  state.w === <span class="literal">undefined</span> ? <span class="number">16</span> : state.w;</div><div class="line">    <span class="keyword">const</span> h =  state.h === <span class="literal">undefined</span> ? <span class="number">16</span> : state.h;</div><div class="line">    <span class="keyword">const</span> data = state.data || [];</div><div class="line">    <span class="keyword">const</span> len = w * h;</div><div class="line">    <span class="keyword">const</span> pxW = canObj.size / w;</div><div class="line">    <span class="keyword">const</span> pxH = canObj.size / h;</div><div class="line">    draw_grid_fill(ctx, canvas, w, h, <span class="function"><span class="keyword">function</span>(<span class="params">x, y, i</span>)</span>&#123;</div><div class="line">        <span class="keyword">const</span> ci = data[i];</div><div class="line">        <span class="keyword">return</span> canObj.palette[ci];</div><div class="line">    &#125;);</div><div class="line">&#125;;</div><div class="line"><span class="comment">// random using palette colors</span></div><div class="line">DRAW.rnd = <span class="function">(<span class="params">canObj, ctx, canvas, state</span>) =&gt;</span> &#123;</div><div class="line">    <span class="keyword">let</span> i = <span class="number">0</span>;</div><div class="line">    <span class="keyword">const</span> gSize =  state.gSize === <span class="literal">undefined</span> ? <span class="number">5</span> : state.gSize;</div><div class="line">    <span class="keyword">const</span> len = gSize * gSize;</div><div class="line">    <span class="keyword">const</span> pxSize = canObj.size / gSize;</div><div class="line">    draw_grid_fill(ctx, canvas, gSize, gSize, <span class="function"><span class="keyword">function</span>(<span class="params">x, y, i</span>)</span>&#123;</div><div class="line">        <span class="keyword">const</span> ci = <span class="built_in">Math</span>.floor( canObj.palette.length * <span class="built_in">Math</span>.random() );</div><div class="line">        <span class="keyword">return</span> canObj.palette[ci];</div><div class="line">    &#125;);</div><div class="line">&#125;;</div><div class="line"><span class="comment">//-------- ----------</span></div><div class="line"><span class="comment">// PUBLIC API</span></div><div class="line"><span class="comment">//-------- ----------</span></div><div class="line"><span class="comment">// create and return a canvas texture</span></div><div class="line">canvasMod.create = <span class="function"><span class="keyword">function</span> (<span class="params">opt</span>) </span>&#123;</div><div class="line">    opt = opt || &#123;&#125;;</div><div class="line">    <span class="comment">// create canvas, get context, set size</span></div><div class="line">    <span class="keyword">const</span> canvas = <span class="built_in">document</span>.createElement(<span class="string">'canvas'</span>),</div><div class="line">    ctx = canvas.getContext(<span class="string">'2d'</span>, &#123; <span class="attr">willReadFrequently</span>: <span class="literal">true</span> &#125; );</div><div class="line">    opt.size = opt.size === <span class="literal">undefined</span> ? <span class="number">16</span> : opt.size;</div><div class="line">    opt.dataParse = opt.dataParse || <span class="string">'string'</span>; <span class="comment">// parse data strings into arrays </span></div><div class="line">    canvas.width = opt.size;</div><div class="line">    canvas.height = opt.size;</div><div class="line">    <span class="comment">// create canvas object</span></div><div class="line">    <span class="keyword">const</span> canObj = &#123;</div><div class="line">        <span class="attr">texture</span>: <span class="literal">null</span>,</div><div class="line">        <span class="attr">texture_data</span>: <span class="literal">null</span>,</div><div class="line">        <span class="attr">update_mode</span>: opt.update_mode || <span class="string">'canvas'</span>,</div><div class="line">        <span class="attr">size</span>: opt.size,</div><div class="line">        <span class="attr">canvas</span>: canvas, </div><div class="line">        <span class="attr">ctx</span>: ctx,</div><div class="line">        <span class="attr">palette</span>: opt.palette || [<span class="string">'black'</span>, <span class="string">'white'</span>],</div><div class="line">        <span class="attr">state</span>: opt.state || &#123;&#125;,</div><div class="line">        <span class="attr">draw</span>: parseDrawOption(opt)</div><div class="line">    &#125;;</div><div class="line">    <span class="comment">// parse data strings into arrays</span></div><div class="line">    parseStateData(canObj, opt);</div><div class="line">    <span class="comment">// update for first time</span></div><div class="line">    canvasMod.update(canObj);</div><div class="line">    <span class="keyword">return</span> canObj;</div><div class="line">&#125;;</div><div class="line"><span class="comment">// update</span></div><div class="line"><span class="keyword">const</span> UPDATE = &#123;&#125;;</div><div class="line"><span class="comment">// update canvas only update mode</span></div><div class="line">UPDATE.canvas = <span class="function">(<span class="params">canObj</span>) =&gt;</span> &#123;</div><div class="line">    <span class="comment">// update canvas texture</span></div><div class="line">    canObj.draw.call(canObj, canObj, canObj.ctx, canObj.canvas, canObj.state);</div><div class="line">&#125;;</div><div class="line">canvasMod.update = <span class="function">(<span class="params">canObj</span>) =&gt;</span> &#123;</div><div class="line">    UPDATE[canObj.update_mode](canObj);</div><div class="line">&#125;;</div><div class="line"><span class="keyword">export</span> &#123; canvasMod &#125;;</div></pre></td></tr></table></figure>
<h2 id="10-Mrsun-constant"><a href="#10-Mrsun-constant" class="headerlink" title="10 - Mrsun-constant"></a>10 - Mrsun-constant</h2><p>When I first started working on this I ended up with a lot of constant values up at the top of my main game state module. I then ran into a situation in which I need to get at these constant values from one of my other modules that has to do with the state machine or some render function. So I have found that it might just be best to have some kind of main module that is just one big collection of constant values that are used in the game state, as well as all over the program in general. I then import this module in my game module, and then everywhere else where I would need to do so as well.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// constant.mjs - for electronjs-example-mrsun</span></div><div class="line"><span class="keyword">import</span> &#123; Decimal &#125;  <span class="keyword">from</span> <span class="string">"../decimal/10.4.3/decimal.mjs"</span></div><div class="line"><span class="keyword">import</span> &#123; Vector2 &#125;  <span class="keyword">from</span> <span class="string">"../vector2/vector2.mjs"</span></div><div class="line"><span class="comment">//-------- ----------</span></div><div class="line"><span class="comment">// CONSTANT OBJECT</span></div><div class="line"><span class="comment">//-------- ----------</span></div><div class="line"><span class="keyword">const</span> constant = &#123;&#125;;</div><div class="line">constant.SUN_RADIUS = <span class="number">40</span>;</div><div class="line">constant.LAND_RADIUS = <span class="number">40</span>;</div><div class="line">constant.SUNAREA_RADIUS = <span class="number">150</span>;</div><div class="line">constant.SUN_CENTER = <span class="keyword">new</span> Vector2(<span class="number">320</span>, <span class="number">240</span>);</div><div class="line">constant.SUN_DMAX = constant.SUNAREA_RADIUS * <span class="number">2</span> - constant.SUN_RADIUS * <span class="number">2</span>;</div><div class="line">constant.LAND_OBJECT_COUNT = <span class="number">12</span>;</div><div class="line">constant.LAND_RADIUS_TOCENTER = constant.LAND_RADIUS + constant.SUNAREA_RADIUS;</div><div class="line">constant.BLOCK_MAX_LEVEL = <span class="number">99</span>;</div><div class="line">constant.MANA_MAX = <span class="keyword">new</span> Decimal(<span class="string">'1e100'</span>);</div><div class="line">constant.MANA_START = <span class="string">'5'</span>;</div><div class="line">constant.TEMP_MAX = <span class="number">999</span>;</div><div class="line">constant.MAX_BLOCK_POW = <span class="built_in">Math</span>.log(<span class="number">10000000</span>) / <span class="built_in">Math</span>.log(<span class="number">2</span>);</div><div class="line">constant.SLOT_UNLOCK_MAXEXP = <span class="number">30</span>;</div><div class="line">constant.SLOT_GRID_WIDTH = <span class="number">10</span>;</div><div class="line">constant.SLOT_GRID_HEIGHT = <span class="number">8</span>;</div><div class="line">constant.SLOT_GRID_LEN = constant.SLOT_GRID_WIDTH * constant.SLOT_GRID_HEIGHT;</div><div class="line">constant.SLOT_RADIUS_DELTA = <span class="number">68</span> / constant.SLOT_GRID_HEIGHT;</div><div class="line">constant.SLOT_RADIAN_DELTA = <span class="built_in">Math</span>.PI / <span class="number">180</span> * <span class="number">15</span>;</div><div class="line">constant.BLOCK_LAND_MAX = <span class="built_in">Math</span>.round(constant.SLOT_GRID_LEN); <span class="comment">//!!! might do away with this</span></div><div class="line">constant.LANDS_START_SECTION_DATA = [];</div><div class="line">constant.SUNSPOTS_WORLDVALUE_BASE_MAX = <span class="number">10</span>;</div><div class="line">constant.SUNSPOTS_WORLDVALUE_BASE_MIN = <span class="number">1.0005</span>;</div><div class="line">constant.SUNSPOTS_WORLDVALUE_MAXMANA = <span class="built_in">Math</span>.pow(<span class="number">10</span>, <span class="number">10</span>);</div><div class="line">constant.DEFAULT_CREATE_OPTIONS = &#123;</div><div class="line">    <span class="attr">mana</span>: constant.MANA_START,</div><div class="line">    <span class="attr">mana_spent</span>: <span class="string">'0'</span>,</div><div class="line">    <span class="attr">mana_level</span>: <span class="number">1</span>,</div><div class="line">    <span class="attr">supernova_count</span>: <span class="number">0</span>,</div><div class="line">    <span class="attr">sunspots</span>: <span class="string">'0'</span>, </div><div class="line">    <span class="attr">sectionData</span>: constant.LANDS_START_SECTION_DATA</div><div class="line">&#125;;</div><div class="line">constant.DECIMAL_OPTIONS = &#123; </div><div class="line">    <span class="attr">precision</span>: <span class="number">40</span>,</div><div class="line">    <span class="attr">maxE</span>: <span class="number">100</span>,</div><div class="line">    <span class="attr">minE</span>: <span class="number">-100</span></div><div class="line">&#125;;</div><div class="line"><span class="comment">//-------- ----------</span></div><div class="line"><span class="comment">// SUPERNOVA</span></div><div class="line"><span class="comment">//-------- ----------</span></div><div class="line">constant.SUPERNOVA_STARTCOST_BASE = <span class="number">2</span>;</div><div class="line">constant.SUPERNOVA_STARTCOST_MAXPOW = <span class="number">40</span>;</div><div class="line">constant.SUPERNOVA_STARTCOST_NUM = <span class="number">10000</span>;</div><div class="line"><span class="comment">//-------- ----------</span></div><div class="line"><span class="comment">// BLOCK TYPES</span></div><div class="line"><span class="comment">//-------- ----------</span></div><div class="line">constant.BLOCKS = &#123;&#125;;</div><div class="line">constant.BLOCKS.blank = &#123;</div><div class="line">    <span class="attr">type</span>: <span class="string">'blank'</span>,</div><div class="line">    <span class="attr">mana_base</span>: <span class="number">0</span>,</div><div class="line">    <span class="attr">mana_temp</span>: <span class="number">0</span></div><div class="line">&#125;;</div><div class="line">constant.BLOCKS.rock = &#123;</div><div class="line">    <span class="attr">type</span>: <span class="string">'rock'</span>,</div><div class="line">    <span class="attr">mana_base</span>: <span class="number">1.00</span>,</div><div class="line">    <span class="attr">mana_temp</span>: <span class="number">0.75</span></div><div class="line">&#125;;</div><div class="line"><span class="comment">//-------- ----------</span></div><div class="line"><span class="comment">// IMG DATA OBJECTS ( used to render slots / blocks )</span></div><div class="line"><span class="comment">//-------- ----------</span></div><div class="line"><span class="keyword">const</span> IMG = constant.IMG = &#123;&#125;;</div><div class="line">IMG.locked = &#123;</div><div class="line">    <span class="attr">palette</span>: [<span class="string">'blue'</span>, <span class="string">'cyan'</span>],</div><div class="line">    <span class="attr">w</span>: <span class="number">2</span>, <span class="attr">h</span>: <span class="number">2</span>,</div><div class="line">    <span class="attr">color_indices</span>: [</div><div class="line">        <span class="number">0</span>, <span class="number">1</span>,</div><div class="line">        <span class="number">1</span>, <span class="number">0</span></div><div class="line">    ]</div><div class="line">&#125;;</div><div class="line">IMG.blank = &#123;</div><div class="line">    <span class="attr">palette</span>: [<span class="string">'black'</span>],</div><div class="line">    <span class="attr">w</span>: <span class="number">1</span>, <span class="attr">h</span>: <span class="number">1</span>,</div><div class="line">    <span class="attr">color_indices</span>: [<span class="number">0</span>]</div><div class="line">&#125;;</div><div class="line"><span class="comment">// 2 by 2 rock</span></div><div class="line">IMG.rock = &#123;</div><div class="line">    <span class="attr">palette</span>: [</div><div class="line">        <span class="string">'#2a2a2a'</span>, </div><div class="line">        <span class="string">'#664400'</span>, <span class="string">'#442200'</span>, </div><div class="line">    ],</div><div class="line">    <span class="attr">w</span>: <span class="number">4</span>, <span class="attr">h</span>: <span class="number">4</span>,</div><div class="line">    <span class="attr">color_indices</span>: [</div><div class="line">        <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>,</div><div class="line">        <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>,</div><div class="line">        <span class="number">1</span>, <span class="number">2</span>, <span class="number">1</span>, <span class="number">2</span>,</div><div class="line">        <span class="number">2</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">1</span></div><div class="line">   ]</div><div class="line">&#125;;</div><div class="line"><span class="comment">//-------- ----------</span></div><div class="line"><span class="comment">// HARD CODED SAVE? - add lz-string compressed save, or set as empty string</span></div><div class="line"><span class="comment">//-------- ----------</span></div><div class="line">constant.SAVE_STRING = <span class="string">''</span>;</div><div class="line"><span class="comment">//-------- ----------</span></div><div class="line"><span class="comment">// EXPORT</span></div><div class="line"><span class="comment">//-------- ----------</span></div><div class="line"><span class="keyword">export</span> &#123; constant &#125;;</div></pre></td></tr></table></figure>
<h2 id="11-mrsun-game"><a href="#11-mrsun-game" class="headerlink" title="11 - mrsun-game"></a>11 - mrsun-game</h2><p>I have a folder that contains that main game state module, as well as a number of other supporting files for this. The main game module create method is what I call to create a main game state object. I then have also took code that has to do with the state of the sun object, as well as the land objects broken down into other files.</p>
<h3 id="11-1-The-sun-module"><a href="#11-1-The-sun-module" class="headerlink" title="11.1 - The sun module"></a>11.1 - The sun module</h3><p>This module contains that main sun class which I use to create the object the stores the current position of the sun. I also have a number of methods in this class that have to do with updating the animation state of the sun, as well as the position of the sun relative to a fixed center position.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// sun.mjs - for electronjs-example-mrsun</span></div><div class="line"><span class="keyword">import</span> &#123; Vector2 &#125; <span class="keyword">from</span> <span class="string">'../vector2/vector2.mjs'</span></div><div class="line"><span class="keyword">import</span> &#123; canvasMod &#125; <span class="keyword">from</span> <span class="string">'../canvas/canvas.mjs'</span></div><div class="line"><span class="keyword">import</span> &#123; Sprite, SpriteSheet &#125; <span class="keyword">from</span> <span class="string">'../object2d-sprite/sprite.mjs'</span></div><div class="line"><span class="keyword">import</span> &#123; constant &#125; <span class="keyword">from</span> <span class="string">'../mrsun-constant/constant.mjs'</span></div><div class="line"><span class="comment">//-------- ----------</span></div><div class="line"><span class="comment">// Decimal</span></div><div class="line"><span class="comment">//-------- ----------</span></div><div class="line"><span class="comment">//Decimal.set(constant.DECIMAL_OPTIONS);</span></div><div class="line"><span class="comment">//-------- ----------</span></div><div class="line"><span class="comment">// Canvas Objects for Sun Class</span></div><div class="line"><span class="comment">//-------- ----------</span></div><div class="line"><span class="keyword">const</span> can1 = canvasMod.create(&#123;</div><div class="line">    <span class="attr">size</span>: <span class="number">128</span>,</div><div class="line">    <span class="attr">palette</span>: [<span class="string">'yellow'</span>, <span class="string">'#ff0000'</span>, <span class="string">'#880000'</span>, <span class="string">'#440000'</span>],</div><div class="line">    <span class="attr">state</span>: &#123;&#125;,</div><div class="line">    <span class="attr">draw</span>: <span class="function">(<span class="params">canObj, ctx, canvas, state</span>) =&gt;</span> &#123;</div><div class="line">        ctx.clearRect(<span class="number">0</span>,<span class="number">0</span>, canvas.width, canvas.height);</div><div class="line">        ctx.strokeStyle = <span class="string">'black'</span>;</div><div class="line">        <span class="keyword">let</span> i = <span class="number">0</span>;</div><div class="line">        <span class="keyword">const</span> len = <span class="number">16</span>;</div><div class="line">        <span class="keyword">const</span> tri_count = <span class="number">16</span>;</div><div class="line">        <span class="keyword">const</span> radian_step = <span class="built_in">Math</span>.PI * <span class="number">2</span> / tri_count;</div><div class="line">        <span class="keyword">while</span>(i &lt; len)&#123;</div><div class="line">            <span class="keyword">const</span> x = i % <span class="number">4</span>;</div><div class="line">            <span class="keyword">const</span> y = <span class="built_in">Math</span>.floor(i / <span class="number">4</span>);</div><div class="line">            <span class="keyword">const</span> cx = <span class="number">16</span> + <span class="number">32</span> * x;</div><div class="line">            <span class="keyword">const</span> cy = <span class="number">16</span> + <span class="number">32</span> * y;</div><div class="line">            <span class="comment">// draw triangles</span></div><div class="line">            <span class="keyword">let</span> i_tri = <span class="number">0</span>;</div><div class="line">            <span class="keyword">while</span>(i_tri &lt; tri_count)&#123;</div><div class="line">               <span class="keyword">const</span> radian = radian_step * i_tri + radian_step * <span class="number">3</span> * (i / len);</div><div class="line">               <span class="keyword">const</span> x = cx + <span class="built_in">Math</span>.cos(radian) * <span class="number">16</span>;</div><div class="line">               <span class="keyword">const</span> y = cy + <span class="built_in">Math</span>.sin(radian) * <span class="number">16</span>;</div><div class="line">               ctx.fillStyle = canObj.palette[<span class="number">1</span> + i_tri % <span class="number">3</span>];</div><div class="line">               ctx.beginPath();</div><div class="line">               ctx.moveTo(x, y);</div><div class="line">               ctx.lineTo(</div><div class="line">                   cx + <span class="built_in">Math</span>.cos(radian - <span class="built_in">Math</span>.PI / <span class="number">180</span> * <span class="number">12</span>) * <span class="number">10</span>,</div><div class="line">                   cy + <span class="built_in">Math</span>.sin(radian - <span class="built_in">Math</span>.PI / <span class="number">180</span> * <span class="number">12</span>) * <span class="number">10</span></div><div class="line">               );</div><div class="line">               ctx.lineTo(</div><div class="line">                   cx + <span class="built_in">Math</span>.cos(radian + <span class="built_in">Math</span>.PI / <span class="number">180</span> * <span class="number">12</span>) * <span class="number">10</span>,</div><div class="line">                   cy + <span class="built_in">Math</span>.sin(radian + <span class="built_in">Math</span>.PI / <span class="number">180</span> * <span class="number">12</span>) * <span class="number">10</span></div><div class="line">               );</div><div class="line">               ctx.fill();</div><div class="line">               i_tri += <span class="number">1</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="comment">// draw base yellow circle</span></div><div class="line">            ctx.beginPath();</div><div class="line">            ctx.arc(cx, cy, <span class="number">10</span>, <span class="number">0</span>, <span class="built_in">Math</span>.PI * <span class="number">2</span>);</div><div class="line">            ctx.fillStyle = canObj.palette[<span class="number">0</span>];</div><div class="line">            ctx.fill();</div><div class="line">            ctx.stroke();</div><div class="line">            i += <span class="number">1</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;);</div><div class="line"><span class="keyword">const</span> can2 = canvasMod.create(&#123;</div><div class="line">    <span class="attr">size</span>: <span class="number">128</span>,</div><div class="line">    <span class="attr">palette</span>: [<span class="string">'black'</span>, <span class="string">'white'</span>],</div><div class="line">    <span class="attr">state</span>: &#123;&#125;,</div><div class="line">    <span class="attr">draw</span>: <span class="function">(<span class="params">canObj, ctx, canvas, state</span>) =&gt;</span> &#123;</div><div class="line">        ctx.fillStyle = canObj.palette[<span class="number">0</span>];</div><div class="line">        ctx.strokeStyle = canObj.palette[<span class="number">0</span>];</div><div class="line">        ctx.beginPath();</div><div class="line">        ctx.arc(<span class="number">13</span>, <span class="number">16</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="built_in">Math</span>.PI * <span class="number">2</span>);</div><div class="line">        ctx.arc(<span class="number">19</span>, <span class="number">16</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="built_in">Math</span>.PI * <span class="number">2</span>);</div><div class="line">        ctx.fill();</div><div class="line">        ctx.beginPath();</div><div class="line">        ctx.lineWidth = <span class="number">2</span>;</div><div class="line">        ctx.moveTo(<span class="number">12</span>, <span class="number">20</span>);</div><div class="line">        ctx.lineTo(<span class="number">14</span>, <span class="number">22</span>);</div><div class="line">        ctx.lineTo(<span class="number">18</span>, <span class="number">22</span>);</div><div class="line">        ctx.lineTo(<span class="number">20</span>, <span class="number">20</span>);</div><div class="line">        ctx.stroke();</div><div class="line">    &#125;</div><div class="line">&#125;);</div><div class="line"><span class="comment">//-------- ----------</span></div><div class="line"><span class="comment">// Sun Class</span></div><div class="line"><span class="comment">//-------- ----------</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Sun</span> <span class="keyword">extends</span> <span class="title">Sprite</span> </span>&#123;</div><div class="line">    <span class="keyword">constructor</span> () &#123;</div><div class="line">        <span class="keyword">super</span>();</div><div class="line">        <span class="keyword">this</span>.type = <span class="string">'Sun'</span>;</div><div class="line">        <span class="keyword">const</span> center = constant.SUN_CENTER.clone();</div><div class="line">        <span class="built_in">Object</span>.defineProperties( <span class="keyword">this</span>, &#123;</div><div class="line">            <span class="attr">center</span>: &#123;</div><div class="line">                <span class="attr">configurable</span>: <span class="literal">true</span>,</div><div class="line">                <span class="attr">enumerable</span>: <span class="literal">true</span>,</div><div class="line">                <span class="attr">value</span>: center</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">        <span class="keyword">this</span>.radius = constant.SUN_RADIUS;</div><div class="line">        <span class="keyword">this</span>.size.set(<span class="number">64</span>, <span class="number">64</span>);</div><div class="line">        <span class="keyword">const</span> sheet1 = <span class="keyword">new</span> SpriteSheet(can1.canvas);</div><div class="line">        sheet1.setCellDataToGrid();</div><div class="line">        <span class="keyword">const</span> sheet2 = <span class="keyword">new</span> SpriteSheet(can2.canvas);</div><div class="line">        sheet2.setCellDataToGrid();</div><div class="line">        <span class="keyword">this</span>.sheets.push(sheet1);</div><div class="line">        <span class="keyword">this</span>.sheets.push(sheet2);</div><div class="line">        <span class="keyword">this</span>.cellIndices[<span class="number">0</span>] = <span class="number">0</span>;</div><div class="line">        <span class="keyword">this</span>.cellIndices[<span class="number">1</span>] = <span class="number">0</span>;</div><div class="line">        <span class="keyword">this</span>.centerPos();</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// step the base animation forward one cell</span></div><div class="line">    stepBaseAnimation () &#123;</div><div class="line">        <span class="keyword">let</span> i_cell = <span class="keyword">this</span>.cellIndices[<span class="number">0</span>];</div><div class="line">        i_cell += <span class="number">1</span>;</div><div class="line">        i_cell = i_cell &gt;= <span class="keyword">this</span>.sheets[<span class="number">0</span>].cell_count ? <span class="number">0</span> : i_cell;</div><div class="line">        <span class="keyword">this</span>.cellIndices[<span class="number">0</span>] = i_cell;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// set sun position by a given vector2 object</span></div><div class="line">    setPosByVector2 (v) &#123;</div><div class="line">        <span class="keyword">this</span>.position.copy(v);</div><div class="line">        <span class="keyword">const</span> d = <span class="keyword">this</span>.position.distanceTo(<span class="keyword">this</span>.center);</div><div class="line">        <span class="keyword">const</span> md = constant.SUNAREA_RADIUS - <span class="keyword">this</span>.radius;</div><div class="line">        <span class="keyword">if</span>(d &gt;= md)&#123;</div><div class="line">            <span class="keyword">const</span> a = <span class="keyword">this</span>.position.radianTo(<span class="keyword">this</span>.center);</div><div class="line">            <span class="keyword">this</span>.position.x = <span class="keyword">this</span>.center.x + <span class="built_in">Math</span>.cos(a) * md;</div><div class="line">            <span class="keyword">this</span>.position.y = <span class="keyword">this</span>.center.y + <span class="built_in">Math</span>.sin(a) * md;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">this</span>.zeroLengthCheck();</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// 'center' th sun</span></div><div class="line">    centerPos () &#123;</div><div class="line">        <span class="keyword">this</span>.position.copy(<span class="keyword">this</span>.center);</div><div class="line">        <span class="keyword">this</span>.zeroLengthCheck();</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// check for zero vector unit length and if so set a direction</span></div><div class="line">    zeroLengthCheck () &#123;</div><div class="line">        <span class="keyword">if</span>(<span class="keyword">this</span>.getLengthAlpha() === <span class="number">0</span>)&#123;</div><div class="line">            <span class="keyword">this</span>.position.x = <span class="keyword">this</span>.center.x + <span class="number">0.001</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    getLength () &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.position.clone().sub(<span class="keyword">this</span>.center).length();</div><div class="line">    &#125;</div><div class="line">    getLengthAlpha()&#123;</div><div class="line">        <span class="keyword">const</span> length_max = constant.SUNAREA_RADIUS - <span class="keyword">this</span>.radius;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.getLength() / length_max;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// set just the vector unit length of the sun position by way of an alpha value</span></div><div class="line">    setPosLength (alpha) &#123;</div><div class="line">        <span class="comment">//const a2 = 0.00001 + 0.99999 * alpha</span></div><div class="line">        <span class="keyword">const</span> length_max = constant.SUNAREA_RADIUS - <span class="keyword">this</span>.radius;</div><div class="line">        <span class="keyword">const</span> v = <span class="keyword">this</span>.position.clone().sub(<span class="keyword">this</span>.center);</div><div class="line">        v.setLength(length_max * alpha);</div><div class="line">        <span class="keyword">this</span>.position.copy(<span class="keyword">this</span>.center).add(v);</div><div class="line">        <span class="keyword">this</span>.zeroLengthCheck();</div><div class="line">    &#125;</div><div class="line">    setPosDir (radian) &#123;</div><div class="line">        <span class="keyword">const</span> v = <span class="keyword">this</span>.position.clone().sub(<span class="keyword">this</span>.center);</div><div class="line">        v.applyRadian(radian);</div><div class="line">        <span class="keyword">this</span>.position.copy(<span class="keyword">this</span>.center).add(v);</div><div class="line">        <span class="keyword">this</span>.zeroLengthCheck();</div><div class="line">    &#125;</div><div class="line">    stepLengthByIndex(index_delta, range)&#123;</div><div class="line">        <span class="keyword">const</span> a_lencurrent = <span class="keyword">this</span>.getLengthAlpha();</div><div class="line">        <span class="keyword">let</span> len_index = <span class="built_in">Math</span>.round( a_lencurrent * range );</div><div class="line">        len_index = len_index + index_delta;</div><div class="line">        len_index = len_index &gt; range ? range : len_index;</div><div class="line">        len_index = len_index &lt; <span class="number">0</span> ? <span class="number">0</span> : len_index;</div><div class="line">        <span class="keyword">let</span> alpha = len_index / range;</div><div class="line">        <span class="keyword">this</span>.setPosLength(alpha);</div><div class="line">    &#125;</div><div class="line">    stepDirByIndex(index_delta = <span class="number">0</span>, grain = <span class="number">1</span>)&#123;</div><div class="line">        <span class="keyword">const</span> len = constant.LAND_OBJECT_COUNT * grain;</div><div class="line">        <span class="keyword">const</span> dir = <span class="keyword">this</span>.position.radianTo( <span class="keyword">this</span>.center );</div><div class="line">        <span class="keyword">const</span> a = dir / ( <span class="built_in">Math</span>.PI * <span class="number">2</span> );</div><div class="line">        <span class="keyword">let</span> section_index = <span class="built_in">Math</span>.round( a * len ) % len;</div><div class="line">        section_index += index_delta;</div><div class="line">        section_index %= len;</div><div class="line">        section_index = section_index &lt; <span class="number">0</span> ? len - <span class="number">1</span> : section_index;</div><div class="line">        <span class="keyword">const</span> radian = <span class="built_in">Math</span>.PI * <span class="number">2</span> / len * section_index;</div><div class="line">        <span class="keyword">this</span>.setPosDir(radian);</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line"><span class="comment">//-------- ----------</span></div><div class="line"><span class="comment">// EXPORT</span></div><div class="line"><span class="comment">//-------- ----------</span></div><div class="line"><span class="keyword">export</span> &#123; Sun &#125;;</div></pre></td></tr></table></figure>
<h3 id="11-2-The-Land-Module"><a href="#11-2-The-Land-Module" class="headerlink" title="11.2 - The Land Module"></a>11.2 - The Land Module</h3><p>The land module then contains mostly of the code that I use to create an update the various objects that compose a land section object as well as the whole collection of these land section objects, and also the various slots of each land section as well. So there is then a main Land class, then a LandSection class, Slot class, and then a Block class.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div><div class="line">306</div><div class="line">307</div><div class="line">308</div><div class="line">309</div><div class="line">310</div><div class="line">311</div><div class="line">312</div><div class="line">313</div><div class="line">314</div><div class="line">315</div><div class="line">316</div><div class="line">317</div><div class="line">318</div><div class="line">319</div><div class="line">320</div><div class="line">321</div><div class="line">322</div><div class="line">323</div><div class="line">324</div><div class="line">325</div><div class="line">326</div><div class="line">327</div><div class="line">328</div><div class="line">329</div><div class="line">330</div><div class="line">331</div><div class="line">332</div><div class="line">333</div><div class="line">334</div><div class="line">335</div><div class="line">336</div><div class="line">337</div><div class="line">338</div><div class="line">339</div><div class="line">340</div><div class="line">341</div><div class="line">342</div><div class="line">343</div><div class="line">344</div><div class="line">345</div><div class="line">346</div><div class="line">347</div><div class="line">348</div><div class="line">349</div><div class="line">350</div><div class="line">351</div><div class="line">352</div><div class="line">353</div><div class="line">354</div><div class="line">355</div><div class="line">356</div><div class="line">357</div><div class="line">358</div><div class="line">359</div><div class="line">360</div><div class="line">361</div><div class="line">362</div><div class="line">363</div><div class="line">364</div><div class="line">365</div><div class="line">366</div><div class="line">367</div><div class="line">368</div><div class="line">369</div><div class="line">370</div><div class="line">371</div><div class="line">372</div><div class="line">373</div><div class="line">374</div><div class="line">375</div><div class="line">376</div><div class="line">377</div><div class="line">378</div><div class="line">379</div><div class="line">380</div><div class="line">381</div><div class="line">382</div><div class="line">383</div><div class="line">384</div><div class="line">385</div><div class="line">386</div><div class="line">387</div><div class="line">388</div><div class="line">389</div><div class="line">390</div><div class="line">391</div><div class="line">392</div><div class="line">393</div><div class="line">394</div><div class="line">395</div><div class="line">396</div><div class="line">397</div><div class="line">398</div><div class="line">399</div><div class="line">400</div><div class="line">401</div><div class="line">402</div><div class="line">403</div><div class="line">404</div><div class="line">405</div><div class="line">406</div><div class="line">407</div><div class="line">408</div><div class="line">409</div><div class="line">410</div><div class="line">411</div><div class="line">412</div><div class="line">413</div><div class="line">414</div><div class="line">415</div><div class="line">416</div><div class="line">417</div><div class="line">418</div><div class="line">419</div><div class="line">420</div><div class="line">421</div><div class="line">422</div><div class="line">423</div><div class="line">424</div><div class="line">425</div><div class="line">426</div><div class="line">427</div><div class="line">428</div><div class="line">429</div><div class="line">430</div><div class="line">431</div><div class="line">432</div><div class="line">433</div><div class="line">434</div><div class="line">435</div><div class="line">436</div><div class="line">437</div><div class="line">438</div><div class="line">439</div><div class="line">440</div><div class="line">441</div><div class="line">442</div><div class="line">443</div><div class="line">444</div><div class="line">445</div><div class="line">446</div><div class="line">447</div><div class="line">448</div><div class="line">449</div><div class="line">450</div><div class="line">451</div><div class="line">452</div><div class="line">453</div><div class="line">454</div><div class="line">455</div><div class="line">456</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// lands.mjs - for electronjs-example-mrsun</span></div><div class="line"><span class="keyword">import</span> &#123; Decimal &#125;  <span class="keyword">from</span> <span class="string">"../decimal/10.4.3/decimal.mjs"</span></div><div class="line"><span class="keyword">import</span> &#123; Vector2 &#125; <span class="keyword">from</span> <span class="string">'../vector2/vector2.mjs'</span></div><div class="line"><span class="keyword">import</span> &#123; canvasMod &#125; <span class="keyword">from</span> <span class="string">'../canvas/canvas.mjs'</span></div><div class="line"><span class="keyword">import</span> &#123; Sprite, SpriteSheet &#125; <span class="keyword">from</span> <span class="string">'../object2d-sprite/sprite.mjs'</span></div><div class="line"><span class="keyword">import</span> &#123; utils &#125;  <span class="keyword">from</span> <span class="string">"../mrsun-utils/utils.mjs"</span></div><div class="line"><span class="keyword">import</span> &#123; constant &#125; <span class="keyword">from</span> <span class="string">"../mrsun-constant/constant.mjs"</span></div><div class="line"><span class="comment">//-------- ----------</span></div><div class="line"><span class="comment">// Decimal</span></div><div class="line"><span class="comment">//-------- ----------</span></div><div class="line">Decimal.set(constant.DECIMAL_OPTIONS);</div><div class="line"><span class="comment">//-------- ----------</span></div><div class="line"><span class="comment">// SpriteLandSectonWorld Class ( for world state )</span></div><div class="line"><span class="comment">//-------- ----------</span></div><div class="line"><span class="comment">// draw a single texel for a single slot ( in world state )</span></div><div class="line"><span class="keyword">const</span> drawSectionSlotTexel = <span class="function">(<span class="params">ctx, slot, v2, rad_center, texelX, texelY</span>) =&gt;</span> &#123;</div><div class="line">    <span class="comment">// get block and image</span></div><div class="line">    <span class="keyword">const</span> block = slot.block;</div><div class="line">    <span class="keyword">let</span> img = constant.IMG.locked;</div><div class="line">    <span class="keyword">if</span>(!slot.locked)&#123;</div><div class="line">        img = constant.IMG[block.type];</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">const</span> rad_edge = rad_center - constant.SLOT_RADIAN_DELTA;</div><div class="line">    <span class="keyword">const</span> rad_slot_start = rad_edge + <span class="built_in">Math</span>.PI / <span class="number">180</span> * ( <span class="number">30</span> / <span class="number">10</span> * slot.x );</div><div class="line">    <span class="keyword">const</span> rad_delta_texel = constant.SLOT_RADIAN_DELTA * <span class="number">2</span> / <span class="number">10</span> / img.w;</div><div class="line">    <span class="keyword">const</span> rad_start = rad_slot_start + rad_delta_texel * texelX;</div><div class="line">    <span class="keyword">const</span> rad_end = rad_start + rad_delta_texel;</div><div class="line">    <span class="keyword">const</span> radius_slot_low = constant.LAND_RADIUS_TOCENTER - constant.LAND_RADIUS + constant.SLOT_RADIUS_DELTA  * slot.y;</div><div class="line">    <span class="keyword">const</span> radius_texel_delta = constant.SLOT_RADIUS_DELTA  / img.h;</div><div class="line">    <span class="keyword">const</span> radius_low = radius_slot_low + radius_texel_delta * texelY;</div><div class="line">    <span class="keyword">const</span> radius_high = radius_low + radius_texel_delta;</div><div class="line">    <span class="comment">// draw arcs</span></div><div class="line">    ctx.beginPath();</div><div class="line">    ctx.arc(v2.x, v2.y, radius_low, rad_start, rad_end  );</div><div class="line">    ctx.arc(v2.x, v2.y, radius_high, rad_end, rad_start, <span class="literal">true</span>  );</div><div class="line">    ctx.closePath();</div><div class="line">    <span class="comment">// get fill style, and fill</span></div><div class="line">    <span class="keyword">const</span> i_ci = texelY * img.w + texelX;</div><div class="line">    ctx.fillStyle = img.palette[ img.color_indices[ i_ci ] ];</div><div class="line">    ctx.fill();</div><div class="line">&#125;;</div><div class="line"><span class="comment">// create a render sheet for the given section object</span></div><div class="line"><span class="keyword">const</span> createSectionRenderSheet = <span class="function">(<span class="params">section, drawSectionSlot</span>) =&gt;</span> &#123;</div><div class="line">    <span class="keyword">const</span> can = canvasMod.create(&#123;</div><div class="line">        <span class="attr">size</span>: <span class="number">1024</span>,</div><div class="line">        <span class="attr">state</span>: &#123;</div><div class="line">            <span class="attr">section</span>: section</div><div class="line">        &#125;,</div><div class="line">        <span class="attr">draw</span>: <span class="function">(<span class="params">canObj, ctx, canvas, state</span>) =&gt;</span> &#123;</div><div class="line">            ctx.clearRect(<span class="number">0</span>,<span class="number">0</span>, canvas.width, canvas.height);</div><div class="line">            <span class="keyword">const</span> section = state.section;</div><div class="line">            <span class="keyword">const</span> sprite = section.sprite_world;</div><div class="line">            <span class="keyword">let</span> i = <span class="number">0</span>;</div><div class="line">            <span class="keyword">while</span>(i &lt; constant.SLOT_GRID_LEN)&#123;</div><div class="line">                <span class="keyword">const</span> bx = i % constant.SLOT_GRID_WIDTH;</div><div class="line">                <span class="keyword">const</span> by = <span class="built_in">Math</span>.floor(i / constant.SLOT_GRID_WIDTH);</div><div class="line">                <span class="keyword">const</span> i_slot = by * constant.SLOT_GRID_WIDTH + bx;</div><div class="line">                <span class="keyword">const</span> slot = section.slots[i_slot];</div><div class="line">                drawSectionSlot(ctx, section, slot)</div><div class="line">                i += <span class="number">1</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line">    <span class="keyword">const</span> sheet = <span class="keyword">new</span> SpriteSheet(can.canvas);</div><div class="line">    sheet.setCellDataToGrid( <span class="keyword">new</span> Vector2(<span class="number">128</span>, <span class="number">128</span>) );</div><div class="line">    sheet.can = can;</div><div class="line">    <span class="keyword">return</span> sheet;</div><div class="line">&#125;;</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">SpriteLandSectionWorld</span> <span class="keyword">extends</span> <span class="title">Sprite</span> </span>&#123;</div><div class="line">    <span class="keyword">constructor</span> (section) &#123;</div><div class="line">        <span class="keyword">super</span>();</div><div class="line">        <span class="keyword">this</span>.section = section;</div><div class="line">        <span class="keyword">this</span>.type = <span class="string">'SpriteLandSectonWorld'</span>;</div><div class="line">        <span class="keyword">this</span>.size.set(<span class="number">128</span>, <span class="number">128</span>);</div><div class="line">        <span class="keyword">this</span>.sheets[<span class="number">0</span>] = createSectionRenderSheet(<span class="keyword">this</span>.section, <span class="keyword">this</span>.drawSectionSlot);</div><div class="line">        <span class="keyword">this</span>.cellIndices[<span class="number">0</span>] = <span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// draw a section arc for a single slot object to be used in world state</span></div><div class="line">    drawSectionSlot (ctx, section, slot) &#123;</div><div class="line">        <span class="keyword">const</span> block = slot.block;</div><div class="line">        <span class="keyword">let</span> img = constant.IMG.locked;</div><div class="line">        <span class="keyword">if</span>(!slot.locked)&#123;</div><div class="line">            img = constant.IMG[block.type];</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">const</span> radian = <span class="built_in">Math</span>.PI + <span class="built_in">Math</span>.PI * <span class="number">2</span> / constant.LAND_OBJECT_COUNT  * section.i;</div><div class="line">        <span class="comment">// get a vector2 that is on the edge of the sun area</span></div><div class="line">        <span class="keyword">const</span> v1 = <span class="keyword">new</span> Vector2(<span class="number">64</span> + <span class="built_in">Math</span>.cos(radian) * constant.radius_land, <span class="number">64</span> + <span class="built_in">Math</span>.sin(radian) * constant.radius_land );</div><div class="line">        <span class="comment">// get a vector2 that is the center location</span></div><div class="line">        <span class="keyword">const</span> v2 = <span class="keyword">new</span> Vector2(</div><div class="line">            <span class="number">64</span> + <span class="built_in">Math</span>.cos(radian) * constant.LAND_RADIUS_TOCENTER, </div><div class="line">            <span class="number">64</span> + <span class="built_in">Math</span>.sin(radian) * constant.LAND_RADIUS_TOCENTER);</div><div class="line">        <span class="keyword">let</span> rad_center = <span class="built_in">Math</span>.PI * <span class="number">2</span> / constant.LAND_OBJECT_COUNT * section.i;</div><div class="line">        <span class="comment">// draw texels</span></div><div class="line">        <span class="keyword">const</span> len = img.w * img.h;</div><div class="line">        <span class="keyword">let</span> i_texel = <span class="number">0</span>;</div><div class="line">        <span class="keyword">while</span>(i_texel &lt; len)&#123;</div><div class="line">            <span class="keyword">const</span> x = i_texel % img.w;</div><div class="line">            <span class="keyword">const</span> y = <span class="built_in">Math</span>.floor(i_texel / img.w);</div><div class="line">            drawSectionSlotTexel(ctx, slot, v2, rad_center, x, y);</div><div class="line">            i_texel += <span class="number">1</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    update()&#123;</div><div class="line">        canvasMod.update(<span class="keyword">this</span>.sheets[<span class="number">0</span>].can);</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line"><span class="comment">//-------- ----------</span></div><div class="line"><span class="comment">// SpriteLandSectonLand Class ( for land state )</span></div><div class="line"><span class="comment">//-------- ----------</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">SpriteLandSectionLand</span> <span class="keyword">extends</span> <span class="title">Sprite</span> </span>&#123;</div><div class="line">    <span class="keyword">constructor</span>(section) &#123;</div><div class="line">        <span class="keyword">super</span>();</div><div class="line">        <span class="keyword">this</span>.section = section;</div><div class="line">        <span class="keyword">this</span>.type = <span class="string">'SpriteLandSectonLand'</span>;</div><div class="line">        <span class="keyword">this</span>.size.set(<span class="number">500</span>, <span class="number">280</span>);</div><div class="line">        <span class="keyword">this</span>.sheets[<span class="number">0</span>] = createSectionRenderSheet( <span class="keyword">this</span>.section, <span class="keyword">this</span>.drawSectionSlot );</div><div class="line">        <span class="keyword">this</span>.cellIndices[<span class="number">0</span>] = <span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// draw a single slot for the section object</span></div><div class="line">    drawSectionSlot(ctx, section, slot)&#123;</div><div class="line">        <span class="keyword">const</span> block = slot.block;</div><div class="line">        <span class="keyword">let</span> img = constant.IMG.locked;</div><div class="line">        <span class="keyword">if</span>(!slot.locked)&#123;</div><div class="line">            img = constant.IMG[block.type];</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// draw texels</span></div><div class="line">        <span class="keyword">const</span> len = img.w * img.h;</div><div class="line">        <span class="keyword">const</span> block_width = <span class="number">128</span> / <span class="number">10</span>;</div><div class="line">        <span class="keyword">const</span> block_height = <span class="number">128</span> / <span class="number">8</span>;</div><div class="line">        <span class="keyword">const</span> texel_width = block_width / img.w;</div><div class="line">        <span class="keyword">const</span> texel_height = block_height / img.h;</div><div class="line">        <span class="keyword">let</span> i_texel = <span class="number">0</span>;</div><div class="line">        <span class="keyword">while</span>(i_texel &lt; len)&#123;</div><div class="line">            <span class="keyword">const</span> texelX = i_texel % img.w;</div><div class="line">            <span class="keyword">const</span> texelY = <span class="built_in">Math</span>.floor(i_texel / img.w);</div><div class="line">            <span class="keyword">const</span> i_ci = texelY * img.w + texelX;</div><div class="line">            ctx.fillStyle = img.palette[ img.color_indices[ i_ci ] ];</div><div class="line">            ctx.fillRect(</div><div class="line">                slot.x * block_width + texel_width * texelX, </div><div class="line">                slot.y * block_height + texel_height * texelY, </div><div class="line">                texel_width, texel_height);</div><div class="line">            i_texel += <span class="number">1</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    update()&#123;</div><div class="line">        canvasMod.update(<span class="keyword">this</span>.sheets[<span class="number">0</span>].can);</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line"><span class="comment">//-------- ----------</span></div><div class="line"><span class="comment">// BLOCK CLASS</span></div><div class="line"><span class="comment">//-------- ----------</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Block</span> </span>&#123;</div><div class="line">    <span class="keyword">constructor</span>(opt) &#123;</div><div class="line">        opt = opt || &#123;&#125;;</div><div class="line">        <span class="keyword">this</span>.type = opt.type || <span class="string">'blank'</span>;</div><div class="line">        <span class="keyword">this</span>.mana_base = <span class="number">0</span>;</div><div class="line">        <span class="keyword">this</span>.mana_temp = <span class="number">0</span>;</div><div class="line">        <span class="keyword">this</span>.mana_value = <span class="literal">null</span>;</div><div class="line">        <span class="keyword">this</span>.upgradeCost = <span class="number">0</span>;</div><div class="line">        <span class="keyword">this</span>.setLevel(opt.level, <span class="keyword">this</span>.type, <span class="number">1</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// set the mana value object for this block</span></div><div class="line">    setManaValue () &#123;</div><div class="line">        <span class="keyword">const</span> mv_level = utils.addPows(<span class="number">10</span>, <span class="keyword">this</span>.level - <span class="number">1</span>);</div><div class="line">        <span class="keyword">this</span>.mana_value = &#123;</div><div class="line">           <span class="attr">mv_level</span>: <span class="keyword">new</span> Decimal(mv_level),</div><div class="line">           <span class="attr">valueOf</span>: <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">               <span class="keyword">return</span> <span class="keyword">this</span>.mv_level;</div><div class="line">            &#125;</div><div class="line">        &#125;;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// get the upgrade cost AT the given CURRENT block level</span></div><div class="line">    getUpgradeCost (level_current, level_target) &#123;</div><div class="line">        level_target === <span class="literal">undefined</span> ? level_current + <span class="number">1</span> : level_target;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Decimal( utils.addPows(<span class="number">10</span>, level_target - <span class="number">1</span>, level_current) );</div><div class="line">        <span class="comment">//return Decimal.pow(10, level_current === undefined ? this.level : level_current);</span></div><div class="line">    &#125;</div><div class="line">    getMaxLevel (mana, level_current) &#123;</div><div class="line">        level_current = level_current === <span class="literal">undefined</span> ? <span class="keyword">this</span>.level : level_current;</div><div class="line">        <span class="keyword">let</span> level_target = level_current;</div><div class="line">        <span class="keyword">let</span> mana_cost = <span class="number">0</span>;</div><div class="line">        <span class="keyword">while</span>(mana_cost &lt;= mana)&#123;</div><div class="line">            level_target += <span class="number">1</span>;</div><div class="line">            mana_cost = <span class="keyword">this</span>.getUpgradeCost(level_current, level_target).toNumber();</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> level_target - <span class="number">1</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// set mana stats without doing anything with level or type</span></div><div class="line">    setManaStats (sunspot_multi = <span class="number">1</span>) &#123;</div><div class="line">        <span class="keyword">const</span> TYPE_DEF = constant.BLOCKS[<span class="keyword">this</span>.type];</div><div class="line">        <span class="keyword">this</span>.mana_base = TYPE_DEF.mana_base * sunspot_multi * <span class="keyword">this</span>.level;</div><div class="line">        <span class="keyword">this</span>.mana_temp = <span class="built_in">Math</span>.pow(TYPE_DEF.mana_temp * sunspot_multi, <span class="keyword">this</span>.level);</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// set the current level of the block, can also change type</span></div><div class="line">    setLevel (level, type, sunspot_multi = <span class="number">1</span> ) &#123;</div><div class="line">        <span class="keyword">this</span>.level = level === <span class="literal">undefined</span> ? <span class="number">1</span> : <span class="built_in">parseInt</span>(level);</div><div class="line">        <span class="keyword">this</span>.type = type || <span class="keyword">this</span>.type;</div><div class="line">        <span class="keyword">this</span>.setManaStats(sunspot_multi);</div><div class="line">        <span class="keyword">this</span>.mana_value = <span class="literal">null</span>;</div><div class="line">        <span class="keyword">this</span>.upgradeCost = <span class="keyword">this</span>.getUpgradeCost(<span class="keyword">this</span>.level, <span class="keyword">this</span>.level + <span class="number">1</span>);</div><div class="line">        <span class="keyword">this</span>.setManaValue();</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// copy some other block to this block</span></div><div class="line">    copy (block) &#123;</div><div class="line">        <span class="keyword">this</span>.setLevel(block.level, block.type, <span class="number">1</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// clear a block to blank type</span></div><div class="line">    clear () &#123;</div><div class="line">        <span class="keyword">this</span>.setLevel(<span class="number">1</span>, <span class="string">'blank'</span>, <span class="number">1</span>);</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line"><span class="comment">//-------- ----------</span></div><div class="line"><span class="comment">// SLOT CLASS</span></div><div class="line"><span class="comment">//-------- ----------</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Slot</span> </span>&#123;</div><div class="line">    <span class="keyword">constructor</span>(opt) &#123;</div><div class="line">        opt = opt || &#123;&#125;;</div><div class="line">        <span class="keyword">this</span>.i = opt.i === <span class="literal">undefined</span> ? <span class="number">0</span> : opt.i;</div><div class="line">        <span class="keyword">this</span>.x = opt.x === <span class="literal">undefined</span> ? <span class="number">0</span> : opt.x;</div><div class="line">        <span class="keyword">this</span>.y = opt.y === <span class="literal">undefined</span> ? <span class="number">0</span> : opt.y;</div><div class="line">        <span class="keyword">this</span>.block = <span class="keyword">new</span> Block(&#123; <span class="attr">type</span>: <span class="string">'blank'</span>&#125;);</div><div class="line">        <span class="keyword">this</span>.locked = <span class="literal">true</span>;</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line"><span class="comment">//-------- ----------</span></div><div class="line"><span class="comment">// Land Section</span></div><div class="line"><span class="comment">//-------- ----------</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">LandSection</span> </span>&#123;</div><div class="line">    <span class="keyword">constructor</span>(i, cx, cy, sectionData) &#123;</div><div class="line">        sectionData = sectionData || &#123;&#125;;</div><div class="line">        <span class="keyword">this</span>.i = i;</div><div class="line">        <span class="keyword">this</span>.a = <span class="built_in">Math</span>.PI * <span class="number">2</span> * ( i / constant.LAND_OBJECT_COUNT);</div><div class="line">        <span class="comment">// use the vector2 class</span></div><div class="line">        <span class="keyword">this</span>.position = <span class="keyword">new</span> Vector2();</div><div class="line">        <span class="keyword">this</span>.position.x = cx + <span class="built_in">Math</span>.cos(<span class="keyword">this</span>.a) * ( constant.SUNAREA_RADIUS + constant.LAND_RADIUS );</div><div class="line">        <span class="keyword">this</span>.position.y = cy + <span class="built_in">Math</span>.sin(<span class="keyword">this</span>.a) * ( constant.SUNAREA_RADIUS + constant.LAND_RADIUS );</div><div class="line">        <span class="keyword">this</span>.r = constant.LAND_RADIUS;</div><div class="line">        <span class="keyword">this</span>.slots = [];</div><div class="line">        <span class="keyword">this</span>.slot_unlock_count = <span class="number">0</span>;</div><div class="line">        <span class="comment">// counts_of_block_types/next_cost_of_somehting.</span></div><div class="line">        <span class="keyword">this</span>.bt_counts = &#123;&#125;;  <span class="comment">// counts for all block types for all slots 'blank, rock, ect'</span></div><div class="line">        <span class="comment">// temp</span></div><div class="line">        <span class="keyword">this</span>.d_alpha = <span class="number">0</span>;</div><div class="line">        <span class="keyword">this</span>.temp = <span class="number">0</span>;</div><div class="line">        <span class="keyword">this</span>.createSlotGrid();</div><div class="line">        <span class="comment">// starting unlock slots</span></div><div class="line">        <span class="keyword">this</span>.applySectionData(sectionData)</div><div class="line">        <span class="comment">// update the counts</span></div><div class="line">        <span class="keyword">this</span>.setBlockTypeCounts();</div><div class="line">        <span class="comment">// world state sprite object</span></div><div class="line">        <span class="keyword">this</span>.sprite_world = <span class="keyword">new</span> SpriteLandSectionWorld(<span class="keyword">this</span>);</div><div class="line">        <span class="keyword">this</span>.sprite_world.position.set(<span class="keyword">this</span>.position.x, <span class="keyword">this</span>.position.y);</div><div class="line">        <span class="comment">// land sprite sprite object</span></div><div class="line">        <span class="keyword">this</span>.sprite_land = <span class="keyword">new</span> SpriteLandSectionLand(<span class="keyword">this</span>);</div><div class="line">        <span class="keyword">this</span>.sprite_land.position.set(<span class="number">320</span>, <span class="number">240</span>);</div><div class="line">        <span class="comment">// total mana value</span></div><div class="line">        <span class="keyword">this</span>.mana_total = <span class="keyword">new</span> Decimal(<span class="number">0</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// apply section data</span></div><div class="line">    applySectionData(sectionData)&#123;</div><div class="line">        <span class="keyword">const</span> unlock = sectionData.cols_unlock_slots;</div><div class="line">        <span class="keyword">const</span> blockdata = sectionData.cols_block_data || [];</div><div class="line">        <span class="keyword">if</span>(unlock)&#123;</div><div class="line">            <span class="keyword">let</span> x = <span class="number">0</span>;</div><div class="line">            <span class="keyword">while</span>(x &lt; constant.SLOT_GRID_WIDTH)&#123;</div><div class="line">                <span class="keyword">let</span> y = constant.SLOT_GRID_HEIGHT - <span class="number">1</span>;</div><div class="line">                <span class="keyword">let</span> ct = unlock[x];</div><div class="line">                <span class="keyword">let</span> bd = [];</div><div class="line">                <span class="keyword">if</span>(blockdata[x])&#123;</div><div class="line">                    bd = blockdata[x].split(<span class="string">';'</span>);</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">while</span>(ct &gt; <span class="number">0</span>)&#123;</div><div class="line">                    <span class="keyword">const</span> slot = <span class="keyword">this</span>.getSlot(x, y);</div><div class="line">                    slot.locked = <span class="literal">false</span>;</div><div class="line">                    <span class="keyword">const</span> i_bd = unlock[x] - ct;</div><div class="line">                    <span class="keyword">if</span>( bd[ i_bd] )&#123;</div><div class="line">                        <span class="keyword">const</span> str = bd[ i_bd];</div><div class="line">                        <span class="keyword">const</span> arr = str.split(<span class="string">','</span>);</div><div class="line">                        <span class="keyword">if</span>(arr[<span class="number">0</span>] === <span class="string">'b'</span>)&#123;</div><div class="line">                            slot.block.clear();</div><div class="line">                        &#125;</div><div class="line">                        <span class="keyword">if</span>(arr[<span class="number">0</span>] === <span class="string">'r'</span>)&#123;</div><div class="line">                            slot.block.setLevel(arr[<span class="number">1</span>], <span class="string">'rock'</span>, <span class="number">1</span>);</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                    y -= <span class="number">1</span>;</div><div class="line">                    ct -= <span class="number">1</span>;</div><div class="line">                &#125;</div><div class="line">                x += <span class="number">1</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// get a section data object used for save states</span></div><div class="line">    getSectionData()&#123;</div><div class="line">        <span class="keyword">const</span> sectionData = &#123;</div><div class="line">            <span class="attr">cols_unlock_slots</span>: [],</div><div class="line">            <span class="attr">cols_block_data</span>: []</div><div class="line">        &#125;;</div><div class="line">        <span class="keyword">let</span> x = <span class="number">0</span>;</div><div class="line">        <span class="keyword">while</span>(x &lt; constant.SLOT_GRID_WIDTH)&#123;</div><div class="line">            <span class="keyword">let</span> y = constant.SLOT_GRID_HEIGHT -  <span class="number">1</span>;</div><div class="line">            <span class="keyword">let</span> unlock_ct = <span class="number">0</span>;</div><div class="line">            <span class="keyword">let</span> bd_str = <span class="string">''</span>;</div><div class="line">            <span class="keyword">while</span>(y &gt;= <span class="number">0</span>)&#123;</div><div class="line">                <span class="keyword">const</span> slot = <span class="keyword">this</span>.getSlot(x, y);</div><div class="line">                unlock_ct = slot.locked ? unlock_ct : unlock_ct + <span class="number">1</span>;</div><div class="line">                <span class="keyword">if</span>(!slot.locked)&#123;</div><div class="line">                   <span class="keyword">if</span>(slot.block.type === <span class="string">'rock'</span>)&#123;</div><div class="line">                       bd_str += <span class="string">'r,'</span> + slot.block.level + <span class="string">';'</span></div><div class="line">                   &#125;</div><div class="line">                   <span class="keyword">if</span>(slot.block.type === <span class="string">'blank'</span>)&#123;</div><div class="line">                       bd_str += <span class="string">'b,1;'</span></div><div class="line">                   &#125;</div><div class="line">                &#125;</div><div class="line">                y -= <span class="number">1</span>;</div><div class="line">            &#125;</div><div class="line">            sectionData.cols_block_data.push( bd_str );</div><div class="line">            sectionData.cols_unlock_slots.push( unlock_ct );</div><div class="line">            x += <span class="number">1</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> sectionData;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// get a slot object by index or grid position</span></div><div class="line">    getSlot(xi, y)&#123;</div><div class="line">        <span class="keyword">let</span> i = xi;</div><div class="line">        <span class="keyword">if</span>(y != <span class="literal">undefined</span>)&#123;</div><div class="line">            i = <span class="keyword">this</span>.getSlotIndex(xi, y);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.slots[i];</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// get a slot index number if x and y are known</span></div><div class="line">    getSlotIndex(x, y)&#123;</div><div class="line">        <span class="keyword">return</span> y * constant.SLOT_GRID_WIDTH + x;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// get a slot i, x, y object when just i is known</span></div><div class="line">    getSlotXY (i) &#123;</div><div class="line">        <span class="keyword">return</span> &#123;</div><div class="line">            <span class="attr">i</span>: i,</div><div class="line">            <span class="attr">x</span>: i % constant.SLOT_GRID_WIDTH,</div><div class="line">            <span class="attr">y</span>: <span class="built_in">Math</span>.floor(i / constant.SLOT_GRID_WIDTH)</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// for each slot</span></div><div class="line">    forEachSlot(func) &#123;</div><div class="line">        <span class="keyword">let</span> i_slot = <span class="number">0</span>;</div><div class="line">        <span class="keyword">const</span> len = <span class="keyword">this</span>.slots.length;</div><div class="line">        <span class="keyword">while</span>(i_slot &lt; len)&#123;</div><div class="line">            <span class="keyword">const</span> slot = <span class="keyword">this</span>.slots[i_slot];</div><div class="line">            func.call(<span class="keyword">this</span>, slot, i_slot, <span class="keyword">this</span>);</div><div class="line">            i_slot += <span class="number">1</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// set block type counts</span></div><div class="line">    setBlockTypeCounts() &#123;</div><div class="line">        <span class="keyword">const</span> bt_counts = <span class="keyword">this</span>.bt_counts = <span class="built_in">Object</span>.keys(constant.BLOCKS).reduce( <span class="function">(<span class="params">acc, typeKey</span>) =&gt;</span> &#123;</div><div class="line">            acc[typeKey] = <span class="number">0</span>;</div><div class="line">            <span class="keyword">return</span> acc;</div><div class="line">        &#125;, &#123;&#125;);</div><div class="line">        <span class="keyword">let</span> slot_unlock_count = <span class="number">0</span>;</div><div class="line">        <span class="keyword">this</span>.forEachSlot( <span class="function">(<span class="params">slot</span>) =&gt;</span> &#123;</div><div class="line">            <span class="keyword">const</span> ct = bt_counts[ slot.block.type ];</div><div class="line">            bt_counts[ slot.block.type ] = ct === <span class="literal">undefined</span> ? <span class="number">1</span> : ct + <span class="number">1</span>;</div><div class="line">            slot_unlock_count += slot.locked ? <span class="number">0</span> : <span class="number">1</span>;</div><div class="line">        &#125;);</div><div class="line">        <span class="keyword">this</span>.slot_unlock_count = slot_unlock_count;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// create the Slot Grid</span></div><div class="line">    createSlotGrid() &#123;</div><div class="line">        <span class="keyword">let</span> i_slot = <span class="number">0</span>;</div><div class="line">        <span class="keyword">this</span>.slots = [];</div><div class="line">        <span class="keyword">while</span>(i_slot &lt; constant.SLOT_GRID_LEN)&#123;</div><div class="line">            <span class="keyword">const</span> slot = <span class="keyword">new</span> Slot( <span class="keyword">this</span>.getSlotXY(i_slot) );</div><div class="line">            <span class="keyword">this</span>.slots.push(slot);</div><div class="line">            i_slot += <span class="number">1</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// drop down blocks at a given slot</span></div><div class="line">    dropDownBlocks(slot) &#123;</div><div class="line">        <span class="keyword">let</span> y = slot.y;</div><div class="line">        <span class="keyword">while</span>(y &gt;= <span class="number">1</span>)&#123;</div><div class="line">            <span class="keyword">const</span> slot_current = <span class="keyword">this</span>.slots[ <span class="keyword">this</span>.getSlotIndex( slot.x, y ) ];</div><div class="line">            <span class="keyword">const</span> slot_up = <span class="keyword">this</span>.slots[ <span class="keyword">this</span>.getSlotIndex( slot.x, y - <span class="number">1</span> ) ];</div><div class="line">            <span class="keyword">if</span>(slot_up.block.type != <span class="string">'blank'</span>)&#123;</div><div class="line">                slot_current.block.copy(slot_up.block);</div><div class="line">                slot_up.block.clear();</div><div class="line">            &#125;</div><div class="line">            y -= <span class="number">1</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line"><span class="comment">//-------- ----------</span></div><div class="line"><span class="comment">// Lands Class</span></div><div class="line"><span class="comment">//-------- ----------</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Lands</span> </span>&#123;</div><div class="line">    <span class="keyword">constructor</span>(opt) &#123;</div><div class="line">        opt = opt || &#123;&#125;;</div><div class="line">        opt = <span class="built_in">Object</span>.assign(&#123;&#125;, &#123; <span class="attr">sectionData</span>: [] &#125;, opt);</div><div class="line">        <span class="keyword">this</span>.sections = [];</div><div class="line">        <span class="keyword">this</span>.bt_counts = &#123;&#125;; <span class="comment">// block type grand total counts</span></div><div class="line">        <span class="keyword">this</span>.slot_unlock_cost = <span class="number">0</span>;</div><div class="line">        <span class="keyword">this</span>.slot_unlock_count = <span class="number">0</span>;</div><div class="line">        <span class="keyword">this</span>.slot_total = constant.SLOT_GRID_LEN * constant.LAND_OBJECT_COUNT;</div><div class="line">        <span class="comment">// total mana value</span></div><div class="line">        <span class="keyword">this</span>.mana_total = <span class="keyword">new</span> Decimal(<span class="number">0</span>);</div><div class="line">        <span class="keyword">let</span> i = <span class="number">0</span>;</div><div class="line">        <span class="keyword">while</span>(i &lt; constant.LAND_OBJECT_COUNT)&#123;</div><div class="line">            <span class="keyword">const</span> sectionData = opt.sectionData[i] || &#123;&#125;;</div><div class="line">            <span class="keyword">const</span> section = <span class="keyword">new</span> LandSection(i, constant.SUN_CENTER.x, constant.SUN_CENTER.y, sectionData);</div><div class="line">            <span class="keyword">this</span>.sections.push(section);</div><div class="line">            i += <span class="number">1</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">this</span>.setBlockTypeCounts();</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// call a function for each slot, of each land Section</span></div><div class="line">    forEachSection (func) &#123;</div><div class="line">        <span class="keyword">let</span> si = <span class="number">0</span>;</div><div class="line">        <span class="keyword">const</span> len = <span class="keyword">this</span>.sections.length;</div><div class="line">        <span class="keyword">while</span>(si &lt; len)&#123;</div><div class="line">            <span class="keyword">const</span> section = <span class="keyword">this</span>.sections[si];</div><div class="line">            func.call(<span class="keyword">this</span>, section, si, <span class="keyword">this</span>);</div><div class="line">            si += <span class="number">1</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    getSectionDataArray()&#123;</div><div class="line">        <span class="keyword">const</span> array = [];</div><div class="line">        <span class="keyword">this</span>.forEachSection( <span class="function">(<span class="params">section</span>) =&gt;</span> &#123;</div><div class="line">           array.push(section.getSectionData());</div><div class="line">        &#125;);</div><div class="line">        <span class="keyword">return</span> array;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// set grand total block type counts, slot unlock counts, and update slot unlock cost</span></div><div class="line">    setBlockTypeCounts() &#123;</div><div class="line">        <span class="keyword">const</span> bt_counts = <span class="keyword">this</span>.bt_counts = <span class="built_in">Object</span>.keys(constant.BLOCKS).reduce( <span class="function">(<span class="params">acc, typeKey</span>) =&gt;</span> &#123;</div><div class="line">            acc[typeKey] = <span class="number">0</span>;</div><div class="line">            <span class="keyword">return</span> acc;</div><div class="line">        &#125;, &#123;&#125;);</div><div class="line">        <span class="keyword">let</span> slot_unlock_count = <span class="number">0</span>;</div><div class="line">        <span class="keyword">this</span>.forEachSection( <span class="function">(<span class="params">section</span>) =&gt;</span> &#123;</div><div class="line">            section.setBlockTypeCounts();</div><div class="line">            <span class="built_in">Object</span>.keys(constant.BLOCKS).forEach(<span class="function">(<span class="params">typeKey</span>)=&gt;</span>&#123;</div><div class="line">                bt_counts[typeKey] += section.bt_counts[typeKey];</div><div class="line">            &#125;);</div><div class="line">            slot_unlock_count += section.slot_unlock_count;</div><div class="line">        &#125;);</div><div class="line">        <span class="keyword">this</span>.slot_unlock_count = slot_unlock_count;</div><div class="line">        <span class="comment">// update slot unlock cost</span></div><div class="line">        <span class="keyword">const</span> n = <span class="keyword">this</span>.slot_unlock_count;</div><div class="line">        <span class="keyword">const</span> d = <span class="keyword">this</span>.slot_total;</div><div class="line">        <span class="keyword">this</span>.slot_unlock_cost = Decimal.pow(<span class="number">10</span>, constant.SLOT_UNLOCK_MAXEXP * ( n / d ) ).ceil().sub(<span class="number">1</span>);</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="comment">//-------- ----------</span></div><div class="line"><span class="comment">// EXPORT</span></div><div class="line"><span class="comment">//-------- ----------</span></div><div class="line"><span class="keyword">export</span> &#123; Lands, LandSection, Slot, Block &#125;;</div></pre></td></tr></table></figure>
<h3 id="11-3-The-game-module"><a href="#11-3-The-game-module" class="headerlink" title="11.3 - The game module"></a>11.3 - The game module</h3><p>The main game module then makes use of the sun and land modules as well as the constant module and is thus what I use to create a game state object as well as update it over time. There is the main create method that I call in the init state, and then also with a supernova event in my supernova state. More on all of this in my section on the state machine.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div><div class="line">306</div><div class="line">307</div><div class="line">308</div><div class="line">309</div><div class="line">310</div><div class="line">311</div><div class="line">312</div><div class="line">313</div><div class="line">314</div><div class="line">315</div><div class="line">316</div><div class="line">317</div><div class="line">318</div><div class="line">319</div><div class="line">320</div><div class="line">321</div><div class="line">322</div><div class="line">323</div><div class="line">324</div><div class="line">325</div><div class="line">326</div><div class="line">327</div><div class="line">328</div><div class="line">329</div><div class="line">330</div><div class="line">331</div><div class="line">332</div><div class="line">333</div><div class="line">334</div><div class="line">335</div><div class="line">336</div><div class="line">337</div><div class="line">338</div><div class="line">339</div><div class="line">340</div><div class="line">341</div><div class="line">342</div><div class="line">343</div><div class="line">344</div><div class="line">345</div><div class="line">346</div><div class="line">347</div><div class="line">348</div><div class="line">349</div><div class="line">350</div><div class="line">351</div><div class="line">352</div><div class="line">353</div><div class="line">354</div><div class="line">355</div><div class="line">356</div><div class="line">357</div><div class="line">358</div><div class="line">359</div><div class="line">360</div><div class="line">361</div><div class="line">362</div><div class="line">363</div><div class="line">364</div><div class="line">365</div><div class="line">366</div><div class="line">367</div><div class="line">368</div><div class="line">369</div><div class="line">370</div><div class="line">371</div><div class="line">372</div><div class="line">373</div><div class="line">374</div><div class="line">375</div><div class="line">376</div><div class="line">377</div><div class="line">378</div><div class="line">379</div><div class="line">380</div><div class="line">381</div><div class="line">382</div><div class="line">383</div><div class="line">384</div><div class="line">385</div><div class="line">386</div><div class="line">387</div><div class="line">388</div><div class="line">389</div><div class="line">390</div><div class="line">391</div><div class="line">392</div><div class="line">393</div><div class="line">394</div><div class="line">395</div><div class="line">396</div><div class="line">397</div><div class="line">398</div><div class="line">399</div><div class="line">400</div><div class="line">401</div><div class="line">402</div><div class="line">403</div><div class="line">404</div><div class="line">405</div><div class="line">406</div><div class="line">407</div><div class="line">408</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// game.mjs - for electronjs-example-mrsun</span></div><div class="line"><span class="comment">// create and update a game state object</span></div><div class="line"><span class="keyword">import</span> &#123; Decimal &#125;  <span class="keyword">from</span> <span class="string">'../decimal/10.4.3/decimal.mjs'</span></div><div class="line"><span class="keyword">import</span> &#123; LZString &#125;  <span class="keyword">from</span> <span class="string">'../lz-string/1.4.4/lz-string.mjs'</span></div><div class="line"><span class="keyword">import</span> &#123; EventDispatcher &#125; <span class="keyword">from</span> <span class="string">'../event-dispatcher/EventDispatcher.mjs'</span></div><div class="line"><span class="keyword">import</span> &#123; Vector2 &#125; <span class="keyword">from</span> <span class="string">'../vector2/vector2.mjs'</span></div><div class="line"><span class="keyword">import</span> &#123; canvasMod &#125; <span class="keyword">from</span> <span class="string">'../canvas/canvas.mjs'</span></div><div class="line"><span class="keyword">import</span> &#123; Sprite, SpriteSheet &#125; <span class="keyword">from</span> <span class="string">'../object2d-sprite/sprite.mjs'</span></div><div class="line"><span class="keyword">import</span> &#123; utils &#125;  <span class="keyword">from</span> <span class="string">'../mrsun-utils/utils.mjs'</span></div><div class="line"><span class="keyword">import</span> &#123; constant &#125; <span class="keyword">from</span> <span class="string">'../mrsun-constant/constant.mjs'</span></div><div class="line"><span class="keyword">import</span> &#123; Lands &#125; <span class="keyword">from</span> <span class="string">'./lands.mjs'</span></div><div class="line"><span class="keyword">import</span> &#123; Sun &#125; <span class="keyword">from</span> <span class="string">'./sun.mjs'</span></div><div class="line"><span class="comment">//-------- ----------</span></div><div class="line"><span class="comment">// Decimal</span></div><div class="line"><span class="comment">//-------- ----------</span></div><div class="line">Decimal.set(constant.DECIMAL_OPTIONS);</div><div class="line"><span class="comment">//-------- ----------</span></div><div class="line"><span class="comment">// MAIN GAME MOD OBJECT TO EXPORT</span></div><div class="line"><span class="comment">//-------- ----------</span></div><div class="line"><span class="keyword">const</span> gameMod = &#123;&#125;;</div><div class="line"><span class="comment">//-------- ----------</span></div><div class="line"><span class="comment">// GAME EVENTS</span></div><div class="line"><span class="comment">//-------- ----------</span></div><div class="line"><span class="keyword">const</span> GAME_EVENTS = <span class="keyword">new</span> EventDispatcher();</div><div class="line"><span class="comment">// The mana_total_zero event will fire if a player has 0 mana and 0 mana per tick income</span></div><div class="line">GAME_EVENTS.addEventListener(<span class="string">'mana_total_zero'</span>, (evnt) =&gt; &#123;</div><div class="line">    evnt.game.mana = evnt.game.mana.add(constant.MANA_START);</div><div class="line">&#125;);</div><div class="line"><span class="comment">// autosave delay event</span></div><div class="line">GAME_EVENTS.addEventListener(<span class="string">'autosave_delay'</span>, (evnt) =&gt; &#123;</div><div class="line">    evnt.game.autosave_ticks = <span class="number">3</span>;</div><div class="line">&#125;);</div><div class="line"><span class="comment">//-------- ----------</span></div><div class="line"><span class="comment">// HELPERS</span></div><div class="line"><span class="comment">//-------- ----------</span></div><div class="line"><span class="comment">// get the current mana cap value for a game object, or a cap value for the given level</span></div><div class="line"><span class="keyword">const</span> getManaCap = <span class="function">(<span class="params">a</span>) =&gt;</span> &#123;</div><div class="line">    <span class="keyword">let</span> mana_level = <span class="number">1</span>;</div><div class="line">    <span class="keyword">if</span>(<span class="keyword">typeof</span> a === <span class="string">'number'</span>)&#123;</div><div class="line">       mana_level = a;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span>(<span class="keyword">typeof</span> a === <span class="string">'object'</span> &amp;&amp; a != <span class="literal">null</span>)&#123;</div><div class="line">       mana_level = a.mana_level;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span>( Decimal.isDecimal(a) )&#123;</div><div class="line">       mana_level = a.round();</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> Decimal.pow(<span class="number">10</span>, <span class="number">3</span> + (mana_level - <span class="number">1</span>) );</div><div class="line">&#125;;</div><div class="line"><span class="comment">// credit a mana delta to game.mana, upgrade mana level if cap is </span></div><div class="line"><span class="comment">// reached as long as then next cap is below MAX MANA const</span></div><div class="line"><span class="keyword">const</span> manaCredit = <span class="function">(<span class="params">game, mana_delta </span>) =&gt;</span> &#123;</div><div class="line">    game.mana = game.mana.add( mana_delta );</div><div class="line">    <span class="keyword">if</span>( game.mana.gte(game.mana_cap) )&#123;</div><div class="line">        <span class="keyword">const</span> new_level = game.mana_level + <span class="number">1</span>;</div><div class="line">        <span class="keyword">const</span> new_cap = getManaCap( new_level );</div><div class="line">        <span class="keyword">if</span>( new_cap.lt( constant.MANA_MAX ) )&#123;</div><div class="line">            game.mana_level = new_level;</div><div class="line">            game.mana_cap = new_cap;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    game.mana = game.mana.gt(game.mana_cap) ?  <span class="keyword">new</span> Decimal( game.mana_cap ) : game.mana;</div><div class="line">&#125;;</div><div class="line"><span class="comment">// debit game.mana</span></div><div class="line"><span class="keyword">const</span> manaDebit = <span class="function">(<span class="params">game, mana_delta</span>) =&gt;</span> &#123;</div><div class="line">    game.mana = game.mana.sub( mana_delta );</div><div class="line">    game.mana_spent = game.mana_spent.add(mana_delta);</div><div class="line">    <span class="comment">//game.mana = game.mana.lt(0) ? new Decimal(0) : game.mana;</span></div><div class="line">    <span class="comment">// test for mana and mana per tick === 0</span></div><div class="line">    <span class="keyword">if</span>( game.mana_per_tick.eq(<span class="number">0</span>) &amp;&amp; game.mana.eq(<span class="number">0</span>))&#123;</div><div class="line">        <span class="comment">// do an update</span></div><div class="line">        gameMod.updateByTickDelta(game, <span class="number">0</span>, <span class="literal">true</span>);</div><div class="line">        <span class="comment">// if income is still 0, fire a mana_total_zero event</span></div><div class="line">        <span class="keyword">if</span>(game.mana_per_tick.eq(<span class="number">0</span>))&#123;</div><div class="line">            GAME_EVENTS.dispatchEvent(&#123;</div><div class="line">                <span class="attr">type</span>: <span class="string">'mana_total_zero'</span>,</div><div class="line">                <span class="attr">game</span>: game</div><div class="line">            &#125;);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line"><span class="comment">// get the base that is used to figure sunspot world value base</span></div><div class="line"><span class="keyword">const</span> getSunspotWorldValueBase = <span class="function">(<span class="params">world_mana_value</span>) =&gt;</span> &#123;</div><div class="line">    world_mana_value = world_mana_value &lt;= <span class="number">0</span> ? <span class="number">1</span> : world_mana_value;</div><div class="line">    <span class="keyword">const</span> base_min = constant.SUNSPOTS_WORLDVALUE_BASE_MIN;</div><div class="line">    <span class="keyword">const</span> base_max = constant.SUNSPOTS_WORLDVALUE_BASE_MAX;</div><div class="line">    <span class="keyword">let</span> alpha = <span class="built_in">Math</span>.log( world_mana_value ) / <span class="built_in">Math</span>.log( constant.SUNSPOTS_WORLDVALUE_MAXMANA);</div><div class="line">    alpha = alpha &gt; <span class="number">1</span> ? <span class="number">1</span> : alpha;</div><div class="line">    <span class="keyword">return</span> base_max - (base_max - base_min) * alpha;</div><div class="line">&#125;;</div><div class="line"><span class="comment">//-------- ----------</span></div><div class="line"><span class="comment">// PUBLIC API</span></div><div class="line"><span class="comment">//-------- ----------</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">// get the start cost of a super nova event</span></div><div class="line"><span class="keyword">const</span> getSupernovaStartcost = <span class="function">(<span class="params">supernova_count</span>) =&gt;</span> &#123;</div><div class="line">    <span class="keyword">const</span> num = constant.SUPERNOVA_STARTCOST_NUM;</div><div class="line">    <span class="keyword">const</span> base = constant.SUPERNOVA_STARTCOST_BASE;</div><div class="line">    <span class="keyword">const</span> mp = constant.SUPERNOVA_STARTCOST_MAXPOW;</div><div class="line">    <span class="keyword">let</span> pow = supernova_count &lt; mp ? supernova_count : mp;</div><div class="line">    <span class="keyword">return</span> num * <span class="built_in">Math</span>.pow(base, pow);</div><div class="line">&#125;;</div><div class="line"><span class="comment">// get the current supernova mana cost based on the count of supernova events,</span></div><div class="line"><span class="comment">// and an impact mana value that will reduce the current start cost</span></div><div class="line"><span class="comment">//gameMod.getSupernovaCost = ( supernova_count, impact_value ) =&gt; &#123;</span></div><div class="line">gameMod.getSupernovaCost = <span class="function">(<span class="params"> game </span>) =&gt;</span> &#123;</div><div class="line">    <span class="keyword">const</span> supernova_count = game.supernova_count;</div><div class="line">    <span class="keyword">const</span> impact_value = game.mana_spent.toNumber();</div><div class="line">    <span class="keyword">const</span> startcost = getSupernovaStartcost(supernova_count)</div><div class="line">    <span class="keyword">let</span> a_reduction = impact_value / startcost;</div><div class="line">    a_reduction = ( a_reduction &gt; <span class="number">1</span> ? <span class="number">1</span> : a_reduction);</div><div class="line">    <span class="keyword">const</span> cost_dec = <span class="keyword">new</span> Decimal( <span class="built_in">Math</span>.floor(startcost * ( <span class="number">1</span>  - a_reduction) ) );</div><div class="line">    <span class="keyword">return</span> &#123;</div><div class="line">        <span class="attr">startcost</span>: startcost,</div><div class="line">        <span class="attr">a_reduction</span>: a_reduction,</div><div class="line">        <span class="attr">cost</span> : cost_dec.toNumber(),</div><div class="line">        <span class="attr">cost_dec</span>: cost_dec</div><div class="line">    &#125;;</div><div class="line">&#125;;</div><div class="line"><span class="comment">// check how much time has passed and credit any away production</span></div><div class="line">gameMod.awayCheck = <span class="function">(<span class="params">game, ticks_per_sec = <span class="number">1</span></span>) =&gt;</span> &#123;</div><div class="line">    <span class="keyword">const</span> now = <span class="keyword">new</span> <span class="built_in">Date</span>();</div><div class="line">    <span class="keyword">const</span> secs = ( now - game.last_update ) / <span class="number">1000</span>;</div><div class="line">    <span class="keyword">const</span> ticks = <span class="built_in">Math</span>.ceil(ticks_per_sec * secs);</div><div class="line">    <span class="keyword">const</span> mana_delta = Decimal.mul(game.mana_per_tick, ticks);</div><div class="line">    manaCredit(game, mana_delta);</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">'********** Alway Check **********'</span>);</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">'now: '</span> + now);</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">'game.last_update: '</span> + game.last_update );</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">'secs: '</span> + secs);</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">'ticks_per_sec: '</span> + ticks_per_sec);</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">'ticks: '</span> + ticks);</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">'mana_delta: '</span> + utils.formatDecimal( mana_delta, <span class="number">4</span>) );</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">'game start date: '</span> + sm.game.start_date );</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">'game tick: '</span> + sm.game.tick );</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">'mana_spent: '</span> + utils.formatDecimal( game.mana_spent , <span class="number">4</span>) );</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">'********** *********** **********'</span>);</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="comment">// update the game by a given tick delta</span></div><div class="line">gameMod.updateByTickDelta = <span class="function">(<span class="params">game, tickDelta, force</span>) =&gt;</span> &#123;</div><div class="line">    game.tick_last = game.tick;</div><div class="line">    game.tick_frac += tickDelta;</div><div class="line">    game.tick = <span class="built_in">Math</span>.floor(game.tick_frac);</div><div class="line">    <span class="keyword">const</span> tick_delta = game.tick - game.tick_last;</div><div class="line">    <span class="keyword">if</span>(tick_delta &gt;= <span class="number">1</span> || force)&#123;</div><div class="line">        game.mana_per_tick = <span class="keyword">new</span> Decimal(<span class="number">0</span>);</div><div class="line">        <span class="comment">// update temp, block data, mana per tick, credit mana,</span></div><div class="line">        game.lands.forEachSection( <span class="function">(<span class="params">section</span>) =&gt;</span> &#123;</div><div class="line">            <span class="keyword">const</span> d_sun = section.position.distanceTo(game.sun.position);</div><div class="line">            <span class="keyword">const</span> d_adjusted = d_sun - section.r - game.sun.radius;</div><div class="line">            section.d_alpha = <span class="number">1</span> - d_adjusted / constant.SUN_DMAX;</div><div class="line">            section.temp = constant.TEMP_MAX * section.d_alpha;</div><div class="line">            section.temp = game.sun.getLengthAlpha() &lt; <span class="number">0.1</span> ? <span class="built_in">Math</span>.ceil(section.temp): <span class="built_in">Math</span>.round(section.temp);</div><div class="line">            <span class="keyword">let</span> mana_total = <span class="keyword">new</span> Decimal(<span class="number">0</span>);</div><div class="line">            section.forEachSlot( <span class="function">(<span class="params">slot </span>) =&gt;</span> &#123;</div><div class="line">                <span class="keyword">const</span> a_temp = section.temp / constant.TEMP_MAX;</div><div class="line">                <span class="keyword">const</span> block = slot.block;</div><div class="line">                <span class="keyword">if</span>(!slot.locked &amp;&amp; block.type != <span class="string">'blank'</span>)&#123;</div><div class="line">                    <span class="comment">// update block here</span></div><div class="line">                    block.setManaStats(game.sunspot_multi);</div><div class="line">                    <span class="keyword">const</span> mana_delta = <span class="built_in">Math</span>.round(block.mana_base + block.mana_temp * a_temp);</div><div class="line">                    game.mana_per_tick = game.mana_per_tick.add( mana_delta );</div><div class="line">                    mana_total = mana_total.add( block.mana_value.valueOf() );</div><div class="line">                &#125;</div><div class="line">            &#125;);</div><div class="line">            section.mana_total = mana_total;</div><div class="line">        &#125;);</div><div class="line">        <span class="comment">// lands mana total</span></div><div class="line">        <span class="keyword">let</span> mtl = <span class="keyword">new</span> Decimal(<span class="number">0</span>);</div><div class="line">        game.lands.forEachSection( <span class="function">(<span class="params">section</span>) =&gt;</span> &#123;</div><div class="line">            mtl =  mtl.add(section.mana_total);</div><div class="line">        &#125;);</div><div class="line">        game.lands.mana_total = mtl;</div><div class="line">        <span class="comment">// credit current mana per tick</span></div><div class="line">        <span class="keyword">const</span> mana_delta = Decimal.mul(game.mana_per_tick, tick_delta);</div><div class="line">        manaCredit(game, mana_delta);</div><div class="line">        <span class="comment">// auto save check</span></div><div class="line">        <span class="keyword">if</span>(game.autosave_ticks &gt; <span class="number">0</span>)&#123;</div><div class="line">            game.autosave_ticks -= tick_delta;</div><div class="line">            game.autosave_ticks = game.autosave_ticks &lt; <span class="number">0</span> ? <span class="number">0</span> : game.autosave_ticks;</div><div class="line">            <span class="keyword">if</span>(game.autosave_ticks === <span class="number">0</span>)&#123;</div><div class="line">                gameMod.saveGame(game);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// step the sun animation</span></div><div class="line">    game.sun.stepBaseAnimation();</div><div class="line">    <span class="comment">// sunspots delta</span></div><div class="line">    game.sunspots_delta_mana_level = Decimal.pow(<span class="number">2</span>, game.mana_level);</div><div class="line">    <span class="comment">//!!! sunspot world value base (1.005 to 10 maybe? )</span></div><div class="line">    <span class="comment">//const sunspot_world_value_base = 10;</span></div><div class="line">    <span class="keyword">const</span> sunspot_world_value_base = getSunspotWorldValueBase(game.lands.mana_total.add(<span class="number">1</span>));</div><div class="line">    game.sunspots_delta_world_value = Decimal.log(game.lands.mana_total.add(<span class="number">1</span>), sunspot_world_value_base).toFixed(<span class="number">4</span>);</div><div class="line">    <span class="keyword">const</span> spd = <span class="keyword">new</span> Decimal(<span class="number">0</span>);</div><div class="line">    game.sunspots_delta = spd.add(game.sunspots_delta_mana_level).add(game.sunspots_delta_world_value).round();</div><div class="line">    <span class="comment">// set last update prop used for away production</span></div><div class="line">    <span class="keyword">if</span>(!force)&#123;</div><div class="line">        game.last_update = <span class="keyword">new</span> <span class="built_in">Date</span>();</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line"><span class="comment">// get sunspot multi method</span></div><div class="line">gameMod.getSunSpotMulti = <span class="function">(<span class="params">sunspots</span>) =&gt;</span> &#123;</div><div class="line">    <span class="keyword">return</span> <span class="number">1</span> + <span class="built_in">Math</span>.log( <span class="number">1</span> + sunspots ) / <span class="built_in">Math</span>.log(<span class="number">10</span>);</div><div class="line">&#125;;</div><div class="line"><span class="comment">// create a new game state object</span></div><div class="line">gameMod.create = <span class="function">(<span class="params">opt</span>) =&gt;</span> &#123;</div><div class="line">    opt = opt || &#123;&#125;;</div><div class="line">    opt = <span class="built_in">Object</span>.assign(&#123;&#125;, constant.DEFAULT_CREATE_OPTIONS, opt);</div><div class="line">    <span class="keyword">const</span> game = &#123;</div><div class="line">       <span class="attr">start_date</span>: opt.start_date || <span class="keyword">new</span> <span class="built_in">Date</span>(),</div><div class="line">       <span class="attr">platform</span>: opt.platform || <span class="literal">null</span>,  <span class="comment">// MUST GIVE A PLATFORM FOR gameMod.saveGame to work</span></div><div class="line">       mana: <span class="keyword">new</span> Decimal(opt.mana),</div><div class="line">       <span class="attr">mana_level</span>: opt.mana_level,</div><div class="line">       <span class="attr">mana_cap</span>: <span class="number">0</span>,      <span class="comment">// set by calling getManaCap Helper</span></div><div class="line">       mana_per_tick: <span class="keyword">new</span> Decimal(<span class="number">0</span>),</div><div class="line">       <span class="attr">mana_spent</span>: <span class="keyword">new</span> Decimal(opt.mana_spent),</div><div class="line">       <span class="attr">supernova_count</span>: <span class="built_in">parseInt</span>( opt.supernova_count ),</div><div class="line">       <span class="attr">sunspots</span>: <span class="keyword">new</span> Decimal(opt.sunspots),</div><div class="line">       <span class="attr">sunspots_delta</span>: <span class="keyword">new</span> Decimal(<span class="number">0</span>),</div><div class="line">       <span class="attr">sunspots_delta_mana_level</span>: <span class="keyword">new</span> Decimal(<span class="number">0</span>),</div><div class="line">       <span class="attr">sunspots_delta_world_value</span>: <span class="keyword">new</span> Decimal(<span class="number">0</span>),</div><div class="line">       <span class="attr">sunspots_multi</span>: <span class="number">1</span>,</div><div class="line">       <span class="attr">tick_frac</span>: opt.tick_frac === <span class="literal">undefined</span> ? <span class="number">0</span> : opt.tick_frac,</div><div class="line">       <span class="attr">tick</span>: <span class="number">0</span>,           <span class="comment">// game should update by a main tick count</span></div><div class="line">       tick_last: <span class="number">0</span>,      <span class="comment">// last tick can be subtracted from tick to get a tick delta</span></div><div class="line">       last_update: opt.last_update || <span class="keyword">new</span> <span class="built_in">Date</span>(),</div><div class="line">       <span class="attr">autosave_ticks</span>: <span class="number">0</span> <span class="comment">// 1 or more ticks is the number of ticks to the next game save</span></div><div class="line">    &#125;;</div><div class="line">    game.tick = <span class="built_in">Math</span>.floor(game.tick_frac);</div><div class="line"></div><div class="line">    <span class="comment">// figure sunspots_multi once here in create</span></div><div class="line">    game.sunspot_multi = gameMod.getSunSpotMulti( game.sunspots.toNumber() );</div><div class="line">    <span class="comment">// parse last_update if string</span></div><div class="line">    <span class="keyword">if</span>(<span class="keyword">typeof</span> game.last_update === <span class="string">'string'</span>)&#123;</div><div class="line">         game.last_update = <span class="keyword">new</span> <span class="built_in">Date</span>(game.last_update);</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// create sun object</span></div><div class="line">    game.sun = <span class="keyword">new</span> Sun();</div><div class="line">    <span class="keyword">const</span> x = opt.x === <span class="literal">undefined</span> ? game.sun.center.x : opt.x;</div><div class="line">    <span class="keyword">const</span> y = opt.y === <span class="literal">undefined</span> ? game.sun.center.y : opt.y;</div><div class="line">    <span class="keyword">const</span> v2 = <span class="keyword">new</span> Vector2(x, y);</div><div class="line">    game.sun.setPosByVector2(v2);</div><div class="line"></div><div class="line">    <span class="comment">// land objects</span></div><div class="line">    game.lands = <span class="keyword">new</span> Lands(&#123;</div><div class="line">        <span class="attr">sectionData</span>: opt.sectionData</div><div class="line">    &#125;);</div><div class="line">    game.mana_cap = getManaCap(game);</div><div class="line">    gameMod.updateByTickDelta(game, <span class="number">0</span>, <span class="literal">true</span>);</div><div class="line">    <span class="keyword">return</span> game;</div><div class="line">&#125;;</div><div class="line"><span class="comment">// set the sun position</span></div><div class="line">gameMod.setSunPos = <span class="function">(<span class="params">game, pos</span>) =&gt;</span> &#123;</div><div class="line">    game.sun.setPosByVector2(pos);</div><div class="line">    GAME_EVENTS.dispatchEvent(&#123; <span class="attr">type</span>: <span class="string">'autosave_delay'</span>, <span class="attr">game</span>: game &#125;);</div><div class="line">&#125;;</div><div class="line"><span class="comment">// get land object by x, y pos or false if nothing there</span></div><div class="line">gameMod.getSectionByPos = <span class="function">(<span class="params">game, pos</span>) =&gt;</span> &#123;</div><div class="line">    <span class="keyword">let</span> i = <span class="number">0</span>;</div><div class="line">    <span class="keyword">while</span>(i &lt; constant.LAND_OBJECT_COUNT)&#123;</div><div class="line">        <span class="keyword">const</span> section = game.lands.sections[i];</div><div class="line">        <span class="keyword">const</span> d = section.position.distanceTo(pos);</div><div class="line">        <span class="keyword">if</span>(d &lt; section.r)&#123;</div><div class="line">            <span class="keyword">return</span> section;</div><div class="line">        &#125;</div><div class="line">        i += <span class="number">1</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">&#125;;</div><div class="line"><span class="comment">// unlock a slot</span></div><div class="line">gameMod.unlockSlot = <span class="function">(<span class="params">game, i_section, i_slot</span>) =&gt;</span> &#123;</div><div class="line">    <span class="keyword">const</span> section = game.lands.sections[i_section];</div><div class="line">    <span class="keyword">const</span> slot_clicked = section.slots[i_slot];</div><div class="line">    <span class="keyword">const</span> x = slot_clicked.x;</div><div class="line">    <span class="keyword">let</span> y = constant.SLOT_GRID_HEIGHT;</div><div class="line">    <span class="keyword">while</span>(y--)&#123;</div><div class="line">        <span class="keyword">const</span> slot = section.getSlot(x, y);</div><div class="line">        <span class="comment">// is the block locked?</span></div><div class="line">        <span class="keyword">if</span>(slot.locked)&#123;</div><div class="line">            <span class="keyword">if</span>( game.mana.gte( game.lands.slot_unlock_cost ) )&#123;</div><div class="line">                manaDebit(game, game.lands.slot_unlock_cost);</div><div class="line">                slot.locked = <span class="literal">false</span>;</div><div class="line">                game.lands.setBlockTypeCounts();</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    GAME_EVENTS.dispatchEvent(&#123; <span class="attr">type</span>: <span class="string">'autosave_delay'</span>, <span class="attr">game</span>: game &#125;);</div><div class="line">&#125;;</div><div class="line"><span class="comment">// buy a block for the given land section and slot indices</span></div><div class="line">gameMod.createBlock = <span class="function">(<span class="params">game, i_section, i_slot, level</span>) =&gt;</span> &#123;</div><div class="line">    <span class="keyword">const</span> section = game.lands.sections[i_section];</div><div class="line">    <span class="keyword">const</span> slot_clicked = section.slots[i_slot];</div><div class="line">    <span class="keyword">const</span> x = slot_clicked.x;</div><div class="line">    <span class="keyword">let</span> y = constant.SLOT_GRID_HEIGHT;</div><div class="line">    <span class="keyword">while</span>(y--)&#123;</div><div class="line">        <span class="keyword">const</span> slot = section.getSlot(x, y);</div><div class="line">        <span class="comment">// check if the unlocked slot is blank</span></div><div class="line">        <span class="keyword">if</span>(!slot.locked &amp;&amp; slot.block.type === <span class="string">'blank'</span>)&#123;</div><div class="line">            <span class="keyword">const</span> block = slot.block;</div><div class="line">            <span class="keyword">const</span> blockCost = <span class="number">1</span>;</div><div class="line">            gameMod.updateByTickDelta(game, <span class="number">0</span>, <span class="literal">true</span>);</div><div class="line">            <span class="keyword">if</span>(section.bt_counts.rock &lt; constant.BLOCK_LAND_MAX)&#123;</div><div class="line">                <span class="keyword">if</span>(game.mana.gte( blockCost ))&#123;</div><div class="line">                    slot.block.setLevel(level, <span class="string">'rock'</span>, <span class="number">1</span>);</div><div class="line">                    game.lands.setBlockTypeCounts();</div><div class="line">                    manaDebit(game, blockCost);</div><div class="line">                    GAME_EVENTS.dispatchEvent(&#123; <span class="attr">type</span>: <span class="string">'autosave_delay'</span>, <span class="attr">game</span>: game &#125;);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">'all slots are locked, there is no blank slots, or there is no mana.'</span>);</div><div class="line">&#125;;</div><div class="line"><span class="comment">// upgrade block</span></div><div class="line">gameMod.upgradeBlock = <span class="function">(<span class="params">game, i_section, i_slot, level_delta</span>) =&gt;</span> &#123;</div><div class="line">    level_delta = level_delta === <span class="literal">undefined</span> ? <span class="number">1</span> : level_delta;</div><div class="line">    <span class="keyword">const</span> section = game.lands.sections[i_section];</div><div class="line">    <span class="keyword">const</span> slot = section.slots[i_slot];</div><div class="line">    <span class="keyword">const</span> block = slot.block;</div><div class="line">    <span class="keyword">if</span>( level_delta === <span class="string">'max'</span> )&#123;</div><div class="line">        level_delta = block.getMaxLevel(game.mana) - block.level;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span>( <span class="built_in">String</span>(level_delta).match(<span class="regexp">/mod/</span>))&#123;</div><div class="line">        <span class="keyword">const</span> m = <span class="built_in">parseInt</span>(level_delta.split(<span class="string">'mod'</span>)[<span class="number">1</span>]);</div><div class="line">        level_delta =  <span class="built_in">Math</span>.round(m - m * ( (block.level / m % m) % <span class="number">1</span> ));</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// might not need this as long as I use this method as I should</span></div><div class="line">    <span class="keyword">if</span>(<span class="keyword">typeof</span> level_delta === <span class="string">'string'</span>)&#123;</div><div class="line">        <span class="built_in">console</span>.log(<span class="string">'level delta is still a string!? that is a problem.'</span>);</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">let</span> level_target = block.level + level_delta;</div><div class="line">    <span class="keyword">const</span> upgrade_cost = block.getUpgradeCost(block.level, level_target);</div><div class="line">    <span class="keyword">if</span>(slot.locked)&#123;</div><div class="line">        <span class="built_in">console</span>.log(<span class="string">'slot is locked can not upgrade.'</span>);</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span>( game.mana.lt( upgrade_cost ) )&#123;</div><div class="line">        <span class="built_in">console</span>.log( <span class="string">'Not Enough mana to upgrade.'</span> );</div><div class="line">        <span class="built_in">console</span>.log( <span class="string">'mana: '</span> + game.mana.toNumber() );</div><div class="line">        <span class="built_in">console</span>.log( <span class="string">'upgrade cost: '</span> + ( utils.formatDecimal( <span class="keyword">new</span> Decimal(upgrade_cost) ) ) );</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span>(block.type === <span class="string">'rock'</span> &amp;&amp; block.level &lt; constant.BLOCK_MAX_LEVEL &amp;&amp; game.mana.gte( upgrade_cost ) )&#123;</div><div class="line">        manaDebit(game, upgrade_cost );</div><div class="line">        block.setLevel(level_target, <span class="string">'rock'</span>, <span class="number">1</span>);</div><div class="line">        GAME_EVENTS.dispatchEvent(&#123; <span class="attr">type</span>: <span class="string">'autosave_delay'</span>, <span class="attr">game</span>: game &#125;);</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line"><span class="comment">// set the given land and block index back to blank, and absorb the mana value to game.mana</span></div><div class="line">gameMod.absorbBlock = <span class="function">(<span class="params">game, i_section, i_slot</span>) =&gt;</span> &#123;</div><div class="line">    <span class="keyword">const</span> section = game.lands.sections[i_section];</div><div class="line">    <span class="keyword">const</span> slot = section.slots[i_slot];</div><div class="line">    <span class="keyword">const</span> block = slot.block;</div><div class="line">    <span class="keyword">if</span>(slot.locked)&#123;</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span>(block.type != <span class="string">'blank'</span>)&#123;</div><div class="line">        manaCredit(game, block.mana_value.valueOf());</div><div class="line">        block.clear();</div><div class="line">        section.dropDownBlocks(slot);</div><div class="line">        game.lands.setBlockTypeCounts();</div><div class="line">    &#125;</div><div class="line">    GAME_EVENTS.dispatchEvent(&#123; <span class="attr">type</span>: <span class="string">'autosave_delay'</span>, <span class="attr">game</span>: game &#125;);</div><div class="line">&#125;;</div><div class="line"><span class="comment">// create a save string</span></div><div class="line">gameMod.createSaveString = <span class="function">(<span class="params">game</span>) =&gt;</span> &#123;</div><div class="line">    <span class="keyword">const</span> save = &#123;&#125;;</div><div class="line">    save.mana = game.mana.toString();</div><div class="line">    save.mana_spent = game.mana_spent.toString();</div><div class="line">    save.mana_level = game.mana_level;</div><div class="line">    save.supernova_count = game.supernova_count;</div><div class="line">    save.sunspots = game.sunspots.toString();</div><div class="line">    save.x = game.sun.position.x;</div><div class="line">    save.y = game.sun.position.y;</div><div class="line">    save.sectionData = game.lands.getSectionDataArray();</div><div class="line">    save.last_update = game.last_update;</div><div class="line">    save.start_date = game.start_date.toString();</div><div class="line">    save.tick_frac = game.tick_frac;</div><div class="line">    <span class="keyword">const</span> text_json = <span class="built_in">JSON</span>.stringify(save);</div><div class="line">    <span class="keyword">const</span> text_lz = LZString.compressToBase64(text_json);</div><div class="line">    <span class="keyword">return</span> text_lz</div><div class="line">&#125;;</div><div class="line"><span class="comment">// save game method using whatever MS.auto_save is...</span></div><div class="line">gameMod.saveGame = <span class="function">(<span class="params">game</span>) =&gt;</span> &#123;</div><div class="line">    <span class="keyword">if</span>(game.platform)&#123;</div><div class="line">        <span class="keyword">return</span> game.platform.auto_save( gameMod.createSaveString( game ) );</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</div><div class="line">&#125;;</div><div class="line"><span class="comment">// parse a save string into an options object</span></div><div class="line">gameMod.parseSaveString = <span class="function">(<span class="params">text_lz</span>) =&gt;</span> &#123;</div><div class="line">    <span class="keyword">if</span>(!text_lz)&#123;</div><div class="line">        <span class="built_in">console</span>.log(<span class="string">'looks like the save string is not valid!'</span>);</div><div class="line">        <span class="keyword">return</span> &#123;&#125;;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">const</span> text_json = LZString.decompressFromBase64(text_lz);</div><div class="line">    <span class="keyword">const</span> opt = <span class="built_in">JSON</span>.parse(text_json);</div><div class="line">    <span class="keyword">return</span> opt;</div><div class="line">&#125;;</div><div class="line"><span class="comment">//-------- ----------</span></div><div class="line"><span class="comment">// EXPORT</span></div><div class="line"><span class="comment">//-------- ----------</span></div><div class="line"><span class="keyword">export</span> &#123; gameMod &#125;;</div></pre></td></tr></table></figure>
<h2 id="12-Mrsun-statemachine"><a href="#12-Mrsun-statemachine" class="headerlink" title="12 - Mrsun-statemachine"></a>12 - Mrsun-statemachine</h2><p>One major component of a game, or most applications in general is to have something to serve as a <a href="https://en.wikipedia.org/wiki/Finite-state_machine" target="_blank" rel="external">state machine</a>. Simply put there is not just having a single update method called in a loop, but rather a collection of update methods to which only a single one is called at any given moment. While we are at it there is also not just having a collection of update methods but also input event handers, render functions, and additional hook functions also. In MrSun I have a main state machine module, and then also a collection of state objects for several states of the over all game.</p>
<h3 id="12-1-The-Main-state-machine-module"><a href="#12-1-The-Main-state-machine-module" class="headerlink" title="12.1 - The Main state machine module"></a>12.1 - The Main state machine module</h3><p>This is what I have together for my main state machine module for the game. This then contains that main update loop for the over all game, as well as the various functions that compose what the uniform logic is that will apply to all state objects. Speaking of the state objects I thus far have an init state, world state, and a supernova state that is the start of the Prestige mechanic of this idle game.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// sm.mjs - for electronjs-example-mrsun - The main state machine module</span></div><div class="line"><span class="keyword">import</span> &#123; gameMod &#125;  <span class="keyword">from</span> <span class="string">"../mrsun-game/game.mjs"</span></div><div class="line"><span class="keyword">import</span> &#123; utils &#125;  <span class="keyword">from</span> <span class="string">"../mrsun-utils/utils.mjs"</span></div><div class="line"><span class="keyword">import</span> &#123; Vector2 &#125; <span class="keyword">from</span> <span class="string">'../vector2/vector2.mjs'</span></div><div class="line"><span class="keyword">import</span> &#123; constant &#125; <span class="keyword">from</span> <span class="string">"../mrsun-constant/constant.mjs"</span></div><div class="line"><span class="comment">//-------- ----------</span></div><div class="line"><span class="comment">// STATE OBJECTS</span></div><div class="line"><span class="comment">//-------- ----------</span></div><div class="line"><span class="keyword">import</span> &#123; state_init &#125; <span class="keyword">from</span> <span class="string">"./state_init.mjs"</span>;</div><div class="line"><span class="keyword">import</span> &#123; state_world &#125; <span class="keyword">from</span> <span class="string">"./state_world.mjs"</span>;</div><div class="line"><span class="keyword">import</span> &#123; state_land &#125; <span class="keyword">from</span> <span class="string">"./state_land.mjs"</span>;</div><div class="line"><span class="keyword">import</span> &#123; state_supernova &#125; <span class="keyword">from</span> <span class="string">"./state_supernova.mjs"</span>;</div><div class="line"><span class="comment">//-------- ----------</span></div><div class="line"><span class="comment">// DEFAULT "NOOP" PLATFORM OBJECT</span></div><div class="line"><span class="comment">//-------- ----------</span></div><div class="line"><span class="keyword">const</span> PLATFORM_NOOP = &#123;&#125;;</div><div class="line"><span class="comment">// dummy auto load</span></div><div class="line">PLATFORM_NOOP.auto_load = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</div><div class="line">  <span class="keyword">const</span> err = <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'No auto load feature with this dummy MS API'</span>);</div><div class="line">  <span class="keyword">return</span> <span class="built_in">Promise</span>.reject(err)</div><div class="line">&#125;;</div><div class="line">PLATFORM_NOOP.auto_save = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</div><div class="line">    <span class="keyword">const</span> err = <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'No auto save feature with this dummy MS API'</span>);</div><div class="line">    <span class="keyword">return</span> <span class="built_in">Promise</span>.reject(err);</div><div class="line">&#125;;</div><div class="line">PLATFORM_NOOP.log = <span class="function">(<span class="params">mess</span>) =&gt;</span> &#123;&#125;;</div><div class="line"><span class="comment">//-------- ---------</span></div><div class="line"><span class="comment">// HELPER FUNCTIONS</span></div><div class="line"><span class="comment">//-------- ---------</span></div><div class="line"><span class="keyword">const</span> getPointerPos = <span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</div><div class="line">    <span class="keyword">const</span> canvas = e.target;</div><div class="line">    <span class="keyword">const</span> bx = canvas.getBoundingClientRect();</div><div class="line">    <span class="keyword">const</span> pos = <span class="keyword">new</span> Vector2(e.clientX - bx.left, e.clientY - bx.top);</div><div class="line">    pos.x = <span class="built_in">Math</span>.floor((pos.x / canvas.scrollWidth) * canvas.width);</div><div class="line">    pos.y = <span class="built_in">Math</span>.floor((pos.y / canvas.scrollHeight) * canvas.height);</div><div class="line">    <span class="keyword">return</span> pos</div><div class="line">&#125;;</div><div class="line"><span class="keyword">const</span> commonPointerAction = <span class="function">(<span class="params">sm, type, e</span>) =&gt;</span> &#123;</div><div class="line">    sm.position = getPointerPos(e);</div><div class="line">    <span class="keyword">if</span>(sm.currentState)&#123;</div><div class="line">        <span class="keyword">const</span> events = sm.currentState.events;</div><div class="line">        <span class="keyword">if</span>(events)&#123;</div><div class="line">            <span class="keyword">if</span>(events[type])&#123;</div><div class="line">                events[type](sm, sm.position, e, sm.currentState.data);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line"><span class="comment">// what to do for any keyboard action</span></div><div class="line"><span class="keyword">const</span> commonKeyboardAction = <span class="function">(<span class="params">sm, type, e</span>) =&gt;</span> &#123;</div><div class="line">    sm.keydown = type === <span class="string">'keydown'</span> ? <span class="literal">true</span> : <span class="literal">false</span>;</div><div class="line">    <span class="keyword">let</span> events = <span class="literal">null</span>;</div><div class="line">    <span class="keyword">if</span>(sm.currentState)&#123;</div><div class="line">        <span class="keyword">const</span> obj = sm.currentState.events;</div><div class="line">        <span class="keyword">if</span>(obj)&#123;</div><div class="line">            events = obj;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span>(e.key != sm.key)&#123;</div><div class="line">        sm.key = e.key;</div><div class="line">        <span class="keyword">if</span>(events.onkeyfirst)&#123;</div><div class="line">            events.onkeyfirst(sm, sm.key, sm.keydown, e, sm.currentState.data );</div><div class="line">        &#125;</div><div class="line">    &#125;<span class="keyword">else</span>&#123;</div><div class="line">        <span class="keyword">if</span>(events.onkeyrepeat)&#123;</div><div class="line">            events.onkeyrepeat(sm, sm.key, sm.keydown, e, sm.currentState.data );</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span>(events.onkey)&#123;</div><div class="line">        events.onkey(sm, sm.key, sm.keydown, e, sm.currentState.data );</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">&#125;;</div><div class="line"><span class="comment">//-------- ---------</span></div><div class="line"><span class="comment">// PUBLIC API</span></div><div class="line"><span class="comment">//-------- ---------</span></div><div class="line"><span class="keyword">const</span> StateMachine = &#123;&#125;;</div><div class="line"><span class="comment">// create and return an sm object</span></div><div class="line">StateMachine.create = <span class="function">(<span class="params">opt_create</span>) =&gt;</span> &#123;</div><div class="line">    opt_create = opt_create || &#123;&#125;;</div><div class="line">    <span class="keyword">const</span> canvas = <span class="built_in">document</span>.createElement(<span class="string">'canvas'</span>);</div><div class="line">    <span class="keyword">const</span> ctx = canvas.getContext(<span class="string">'2d'</span>);</div><div class="line">    <span class="keyword">let</span> container = <span class="built_in">document</span>.body;</div><div class="line">    <span class="keyword">if</span>(<span class="keyword">typeof</span> opt_create.el === <span class="string">'string'</span>)&#123;</div><div class="line">        container = <span class="built_in">document</span>.querySelector(opt_create.el)</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span>(<span class="keyword">typeof</span> opt_create.el === <span class="string">'object'</span>)&#123;</div><div class="line">        container = opt_create.el;</div><div class="line">    &#125;</div><div class="line">    container.appendChild(canvas);</div><div class="line">    canvas.width = <span class="number">640</span>;</div><div class="line">    canvas.height = <span class="number">480</span>;</div><div class="line">    <span class="keyword">const</span> sm = &#123;</div><div class="line">        <span class="attr">platform</span>: opt_create.PLATFORM || PLATFORM_NOOP,</div><div class="line">        <span class="attr">canvas</span>: canvas,</div><div class="line">        <span class="attr">ctx</span>: ctx,</div><div class="line">        <span class="attr">game</span>: <span class="literal">null</span>,</div><div class="line">        <span class="attr">currentStateKey</span>: <span class="string">''</span>,</div><div class="line">        <span class="attr">currentState</span>: <span class="literal">null</span>,</div><div class="line">        <span class="attr">states</span>: &#123;&#125;,</div><div class="line">        <span class="attr">fps_target</span>: <span class="number">12</span>,</div><div class="line">        <span class="attr">now</span>: <span class="literal">null</span>,</div><div class="line">        <span class="attr">pointer</span>: <span class="keyword">new</span> Vector2(<span class="number">0</span>, <span class="number">0</span>),</div><div class="line">        <span class="attr">keydown</span>: <span class="literal">false</span>,</div><div class="line">        <span class="attr">key</span>: <span class="string">''</span>,</div><div class="line">        <span class="attr">landIndex</span>: <span class="number">0</span>,</div><div class="line">        <span class="attr">ticksPerSec</span>: <span class="number">1</span>,    <span class="comment">// game speed is something that I think should be set here</span></div><div class="line">        secs: <span class="number">0</span>,           <span class="comment">// secs and lt are just used as a way to update game.tick count</span></div><div class="line">        lt: <span class="keyword">new</span> <span class="built_in">Date</span>()</div><div class="line">    &#125;;</div><div class="line">    <span class="comment">// Methods</span></div><div class="line">    sm.setState = <span class="function"><span class="keyword">function</span>(<span class="params">key, opt</span>) </span>&#123;</div><div class="line">        opt = opt || &#123;&#125;;</div><div class="line">        sm.currentStateKey = key;</div><div class="line">        <span class="keyword">const</span> state = sm.currentState = sm.states[sm.currentStateKey];</div><div class="line">        state.start(sm, opt, state.data);</div><div class="line">    &#125;;</div><div class="line">    <span class="comment">// APPEND STATE OBJECTS</span></div><div class="line">    sm.states.init = state_init;</div><div class="line">    sm.states.world = state_world;</div><div class="line">    sm.states.land = state_land;</div><div class="line">    sm.states.supernova = state_supernova;</div><div class="line">    <span class="comment">// POINTER EVENTS</span></div><div class="line">    sm.canvas.addEventListener(<span class="string">'pointerdown'</span>, (e) =&gt; &#123;</div><div class="line">        commonPointerAction(sm, <span class="string">'pointerdown'</span>, e);</div><div class="line">    &#125;);</div><div class="line">    sm.canvas.addEventListener(<span class="string">'pointermove'</span>, (e) =&gt; &#123;</div><div class="line">        commonPointerAction(sm, <span class="string">'pointermove'</span>, e);</div><div class="line">    &#125;);</div><div class="line">    sm.canvas.addEventListener(<span class="string">'pointerup'</span>, (e) =&gt; &#123;</div><div class="line">        commonPointerAction(sm, <span class="string">'pointerup'</span>, e);</div><div class="line">    &#125;);</div><div class="line">    <span class="comment">// document events</span></div><div class="line">    <span class="comment">// VISIBILITY CHANGE EVENT</span></div><div class="line">    <span class="comment">// https://developer.mozilla.org/en-US/docs/Web/API/Document/visibilitychange_event</span></div><div class="line">    <span class="built_in">document</span>.addEventListener(<span class="string">"visibilitychange"</span>, (evnt) =&gt; &#123;</div><div class="line">        <span class="comment">// final save on quit, or any visibilitychange event</span></div><div class="line">        <span class="keyword">if</span>(sm.game)&#123;</div><div class="line">            gameMod.saveGame(sm.game);</div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line">    <span class="comment">// WINDOW EVENTS</span></div><div class="line">    <span class="comment">// canvas resize</span></div><div class="line">    <span class="keyword">const</span> setCanvasScale = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</div><div class="line">        <span class="keyword">const</span> w = <span class="built_in">window</span>.innerWidth;</div><div class="line">        <span class="keyword">const</span> h = <span class="built_in">window</span>.innerHeight;</div><div class="line">        <span class="keyword">if</span>(w / <span class="number">4</span> &lt; h / <span class="number">3</span>)&#123;</div><div class="line">            sm.canvas.style.width = w + <span class="string">'px'</span>;</div><div class="line">            sm.canvas.style.height = <span class="built_in">Math</span>.floor(<span class="number">3</span> * w / <span class="number">4</span>) + <span class="string">'px'</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span>(w / <span class="number">4</span> &gt; h / <span class="number">3</span>)&#123;</div><div class="line">            sm.canvas.style.width = <span class="built_in">Math</span>.floor(h / <span class="number">3</span> * <span class="number">4</span>) + <span class="string">'px'</span>;</div><div class="line">            sm.canvas.style.height = h + <span class="string">'px'</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line">    setCanvasScale();</div><div class="line">    <span class="built_in">window</span>.addEventListener(<span class="string">'resize'</span>, (e) =&gt; &#123;</div><div class="line">        setCanvasScale();</div><div class="line">    &#125;);</div><div class="line">    <span class="built_in">window</span>.addEventListener(<span class="string">'keydown'</span>, (e) =&gt; &#123;</div><div class="line">        commonKeyboardAction(sm, <span class="string">'keydown'</span>, e);</div><div class="line">    &#125;);</div><div class="line">    <span class="built_in">window</span>.addEventListener(<span class="string">'keyup'</span>, (e) =&gt; &#123;</div><div class="line">        commonKeyboardAction(sm, <span class="string">'keyup'</span>, e);</div><div class="line">    &#125;);</div><div class="line">    <span class="comment">// MAIN APP LOOP</span></div><div class="line">    sm.loop = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</div><div class="line">        sm.now = <span class="keyword">new</span> <span class="built_in">Date</span>();</div><div class="line">        sm.secs = ( sm.now - sm.lt ) / <span class="number">1000</span>;</div><div class="line">        requestAnimationFrame(sm.loop);</div><div class="line">        <span class="keyword">if</span>(sm.secs &gt; <span class="number">1</span> / sm.fps_target)&#123;</div><div class="line">           <span class="keyword">const</span> state = sm.currentState;</div><div class="line">           <span class="keyword">const</span> data = state.data;</div><div class="line">           state.update(sm, sm.secs, data);</div><div class="line">           state.render(sm, sm.ctx, sm.canvas, data);</div><div class="line">           sm.lt = sm.now;</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line">    <span class="keyword">return</span> sm;</div><div class="line">&#125;;</div><div class="line"><span class="comment">// start the state machine</span></div><div class="line">StateMachine.start = <span class="function">(<span class="params">sm</span>) =&gt;</span> &#123;</div><div class="line">    <span class="built_in">Object</span>.keys(sm.states).forEach( <span class="function">(<span class="params">stateKey</span>) =&gt;</span> &#123;</div><div class="line">        <span class="keyword">const</span> state = sm.states[stateKey];</div><div class="line">        <span class="keyword">if</span>(state.init)&#123;</div><div class="line">             state.init.call(state, sm, state.data, state)</div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line">    sm.setState(<span class="string">'init'</span>, &#123;&#125;);</div><div class="line">    sm.loop();</div><div class="line">&#125;;</div><div class="line"><span class="comment">//-------- ----------</span></div><div class="line"><span class="comment">// EXPORT</span></div><div class="line"><span class="comment">//-------- ----------</span></div><div class="line"><span class="keyword">export</span> &#123; StateMachine &#125;;</div></pre></td></tr></table></figure>
<h3 id="12-2-The-init-state"><a href="#12-2-The-init-state" class="headerlink" title="12.2 - The init state"></a>12.2 - The init state</h3><p>The init state is what will be used just once when the game starts up for the very first time. In this state I do things like check if there is a save state, and if not start a new game. Once the init state is done with what it needs to do I then just start the main world state.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// state_init.mjs - for electronjs-example-mrsun</span></div><div class="line"><span class="keyword">import</span> &#123; gameMod &#125;  <span class="keyword">from</span> <span class="string">"../mrsun-game/game.mjs"</span></div><div class="line"><span class="keyword">import</span> &#123; constant &#125; <span class="keyword">from</span> <span class="string">"../mrsun-constant/constant.mjs"</span></div><div class="line"><span class="comment">//-------- ----------</span></div><div class="line"><span class="comment">// HELPER FUNCTIONS</span></div><div class="line"><span class="comment">//-------- ----------</span></div><div class="line"><span class="keyword">const</span> load_game = <span class="function">(<span class="params">sm</span>) =&gt;</span> &#123;</div><div class="line">    <span class="keyword">return</span> sm.platform.auto_load()</div><div class="line">    .then( <span class="function">(<span class="params">text_lz</span>) =&gt;</span> &#123;</div><div class="line">        <span class="built_in">console</span>.log(<span class="string">'Autoload worked, looks like we have a string to parse...'</span>);</div><div class="line">        <span class="keyword">const</span> opt_game = gameMod.parseSaveString(text_lz);</div><div class="line">        sm.game = gameMod.create(<span class="built_in">Object</span>.assign(opt_game, &#123; <span class="attr">platform</span>: sm.platform &#125;));</div><div class="line">        gameMod.awayCheck(sm.game, sm.ticksPerSec);</div><div class="line">        sm.setState(<span class="string">'world'</span>, &#123;&#125;);</div><div class="line">    &#125;)</div><div class="line">    .catch(<span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</div><div class="line">        <span class="built_in">console</span>.log(<span class="string">'Error with autoload. Starting new game.'</span>);</div><div class="line">        <span class="built_in">console</span>.log(<span class="string">'message: '</span> + e.message);</div><div class="line">        <span class="keyword">const</span> opt_game = gameMod.parseSaveString(constant.SAVE_STRING);</div><div class="line">        sm.game = gameMod.create(<span class="built_in">Object</span>.assign(opt_game, &#123; <span class="attr">platform</span>: sm.platform &#125;));</div><div class="line">        sm.setState(<span class="string">'world'</span>, &#123;&#125;);</div><div class="line">    &#125;);</div><div class="line">&#125;</div><div class="line"><span class="comment">//-------- ----------</span></div><div class="line"><span class="comment">// STATE OBJECT FOR INIT</span></div><div class="line"><span class="comment">//-------- ----------</span></div><div class="line"><span class="keyword">const</span> state_init = &#123;</div><div class="line">    <span class="attr">data</span>: &#123;</div><div class="line">        <span class="attr">stuck_ct</span>: <span class="number">0</span></div><div class="line">    &#125;,</div><div class="line">    <span class="attr">start</span>: <span class="function">(<span class="params">sm, opt</span>) =&gt;</span> &#123;</div><div class="line">       <span class="built_in">console</span>.log(<span class="string">'init of mr sun.'</span>);</div><div class="line">       load_game(sm);</div><div class="line">    &#125;,</div><div class="line">    <span class="attr">update</span>: <span class="function">(<span class="params">sm, secs</span>) =&gt;</span> &#123;</div><div class="line">        <span class="keyword">const</span> data = sm.states.init.data;</div><div class="line">        <span class="keyword">if</span>(!sm.game)&#123;</div><div class="line">            data.stuck_ct += <span class="number">1</span>;</div><div class="line">            <span class="keyword">if</span>(data.stuck_ct &gt;= <span class="number">20</span>)&#123;</div><div class="line">               <span class="built_in">console</span>.log(<span class="string">'stuck in init state for some reason...'</span>);</div><div class="line">               data.stuck_ct = <span class="number">0</span>;</div><div class="line">            &#125;<span class="keyword">else</span>&#123;</div><div class="line">                <span class="comment">//console.log(data.stuck_ct);</span></div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;,</div><div class="line">    <span class="attr">render</span>: <span class="function">(<span class="params">sm, ctx, canvas</span>) =&gt;</span> &#123;</div><div class="line">        ctx.fillStyle = <span class="string">'black'</span>;</div><div class="line">        ctx.fillRect(<span class="number">0</span>,<span class="number">0</span>, canvas.width, canvas.height);</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line"><span class="comment">//-------- ----------</span></div><div class="line"><span class="comment">// EXPORT</span></div><div class="line"><span class="comment">//-------- ----------</span></div><div class="line"><span class="keyword">export</span> &#123; state_init &#125;;</div></pre></td></tr></table></figure>
<h3 id="12-3-The-world-state"><a href="#12-3-The-world-state" class="headerlink" title="12.3 - The world state"></a>12.3 - The world state</h3><p>The world state is where I can change the position of the sun relative to the other land sections objects that are around it. It is also where I can get an over all view of each land state object, but in order to do anything with a given land state object I must switch to the land state.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// state_world.mjs - for electronjs-example-mrsun</span></div><div class="line"><span class="keyword">import</span> &#123; gameMod &#125;  <span class="keyword">from</span> <span class="string">"../mrsun-game/game.mjs"</span></div><div class="line"><span class="keyword">import</span> &#123; utils &#125;  <span class="keyword">from</span> <span class="string">"../mrsun-utils/utils.mjs"</span></div><div class="line"><span class="keyword">import</span> &#123; Vector2 &#125; <span class="keyword">from</span> <span class="string">'../vector2/vector2.mjs'</span></div><div class="line"><span class="keyword">import</span> &#123; constant &#125; <span class="keyword">from</span> <span class="string">"../mrsun-constant/constant.mjs"</span></div><div class="line"><span class="comment">//-------- ----------</span></div><div class="line"><span class="comment">// RENDER FUNCTIONS </span></div><div class="line"><span class="comment">//-------- ----------</span></div><div class="line"><span class="comment">// render the background</span></div><div class="line"><span class="keyword">const</span> render_background = <span class="function">(<span class="params">sm, ctx, canvas, data</span>) =&gt;</span> &#123;</div><div class="line">    ctx.lineWidth = <span class="number">1</span>;</div><div class="line">    ctx.font = <span class="string">'15px arial'</span>;</div><div class="line">    ctx.fillStyle = <span class="string">'#000000'</span>;</div><div class="line">    ctx.fillRect(<span class="number">0</span>,<span class="number">0</span>, canvas.width, canvas.height);</div><div class="line">&#125;;</div><div class="line"><span class="comment">// render the sunarea</span></div><div class="line"><span class="keyword">const</span> render_sunarea = <span class="function">(<span class="params">sm, ctx, canvas, data</span>) =&gt;</span> &#123;</div><div class="line">    <span class="keyword">const</span> sun = sm.game.sun;</div><div class="line">    <span class="comment">// sun area</span></div><div class="line">    <span class="keyword">const</span> md = constant.SUNAREA_RADIUS;</div><div class="line">    ctx.fillStyle = <span class="string">'cyan'</span>;</div><div class="line">    ctx.beginPath();</div><div class="line">    ctx.arc(sun.center.x, sun.center.y, md, <span class="number">0</span>, <span class="built_in">Math</span>.PI * <span class="number">2</span>);</div><div class="line">    ctx.fill();</div><div class="line">    <span class="comment">// sun back</span></div><div class="line">    ctx.fillStyle = <span class="string">'rgba(255,255,0,0.5)'</span>;</div><div class="line">    ctx.beginPath();</div><div class="line">    ctx.arc(sun.position.x, sun.position.y, sun.radius, <span class="number">0</span>, <span class="built_in">Math</span>.PI * <span class="number">2</span>);</div><div class="line">    ctx.fill();</div><div class="line">&#125;;</div><div class="line"><span class="comment">// render the world state display</span></div><div class="line"><span class="keyword">const</span> render_display = <span class="function">(<span class="params">sm, ctx, canvas, data</span>) =&gt;</span> &#123;</div><div class="line">    <span class="comment">// disp</span></div><div class="line">    utils.drawCommonDisp(sm, ctx, canvas);</div><div class="line">    <span class="comment">// world disp</span></div><div class="line">    ctx.font = <span class="string">'9px monospace'</span>;</div><div class="line">    <span class="keyword">const</span> sx = <span class="number">10</span>, sy = <span class="number">45</span>, yd = <span class="number">9</span>;</div><div class="line">    ctx.textAlign = <span class="string">'left'</span>;</div><div class="line">    ctx.textBaseline = <span class="string">'top'</span>;</div><div class="line">    ctx.fillText(<span class="string">'rocks: '</span> + sm.game.lands.bt_counts.rock, sx, sy);</div><div class="line">    ctx.fillText(<span class="string">'slots unlocked: '</span> + sm.game.lands.slot_unlock_count + <span class="string">'/'</span> + sm.game.lands.slot_total,sx, sy + yd * <span class="number">1</span>);</div><div class="line">    ctx.fillText(<span class="string">'mana level: '</span> + sm.game.mana_level, sx, sy + yd * <span class="number">2</span>);</div><div class="line">    ctx.fillText(<span class="string">'world mana total: '</span> + utils.formatDecimal(sm.game.lands.mana_total), sx, sy + yd * <span class="number">3</span>);</div><div class="line">    ctx.fillText(<span class="string">'ss mana  : '</span> + sm.game.sunspots_delta_mana_level, sx, sy + yd * <span class="number">4</span>);</div><div class="line">    ctx.fillText(<span class="string">'ss value : '</span> + sm.game.sunspots_delta_world_value, sx, sy + yd * <span class="number">5</span>);</div><div class="line">    ctx.fillText(<span class="string">'ss delta : '</span> + sm.game.sunspots_delta, sx, sy + yd * <span class="number">6</span>);</div><div class="line">    utils.drawButton(sm, data.button_supernova, sm.ctx, sm.canvas);</div><div class="line">&#125;;</div><div class="line"><span class="comment">// render just the text for the given land section object</span></div><div class="line"><span class="keyword">const</span> render_section_text = <span class="function">(<span class="params">ctx, section</span>) =&gt;</span> &#123;</div><div class="line">    ctx.font = <span class="string">'bold 30px arial'</span>;</div><div class="line">    ctx.fillStyle = <span class="string">'white'</span>;</div><div class="line">    ctx.strokeStyle = <span class="string">'black'</span>;</div><div class="line">    ctx.textBaseline = <span class="string">'middle'</span>;</div><div class="line">    ctx.textAlign = <span class="string">'center'</span>;</div><div class="line">    ctx.fillText(section.temp, section.position.x, section.position.y);</div><div class="line">    ctx.strokeText(section.temp, section.position.x, section.position.y);</div><div class="line">&#125;;</div><div class="line"><span class="comment">// RENDER BASIC AND DETAIL</span></div><div class="line"><span class="keyword">const</span> render_basic = <span class="function">(<span class="params">sm, ctx, canvas, data</span>) =&gt;</span> &#123;</div><div class="line">    render_background(sm, ctx, canvas, data);</div><div class="line">    render_sunarea(sm, ctx, canvas, data);</div><div class="line">    sm.game.lands.sections.forEach(<span class="function">(<span class="params">section, i</span>) =&gt;</span> &#123;</div><div class="line">        render_section_text(ctx, section);</div><div class="line">    &#125;);</div><div class="line">    render_display(sm, ctx, canvas, data)</div><div class="line">&#125;;</div><div class="line"><span class="keyword">const</span> render_detail = <span class="function">(<span class="params">sm, ctx, canvas, data</span>) =&gt;</span> &#123;</div><div class="line">    render_background(sm, ctx, canvas, data);</div><div class="line">    render_sunarea(sm, ctx, canvas, data);</div><div class="line">    utils.drawSprite(sm.game.sun, ctx, canvas);</div><div class="line">    sm.game.lands.sections.forEach(<span class="function">(<span class="params">section, i</span>) =&gt;</span> &#123;</div><div class="line">        <span class="comment">//section.sprite_world.update();</span></div><div class="line">        utils.drawSprite(section.sprite_world, ctx, canvas);</div><div class="line">        render_section_text(ctx, section);</div><div class="line">    &#125;);</div><div class="line">    render_display(sm, ctx, canvas, data)</div><div class="line">&#125;;</div><div class="line"><span class="comment">//-------- ----------</span></div><div class="line"><span class="comment">// STATE OBJECT FOR WORLD </span></div><div class="line"><span class="comment">//-------- ----------</span></div><div class="line"><span class="keyword">const</span> state_world = &#123;</div><div class="line">    <span class="attr">data</span>: &#123;</div><div class="line">        <span class="attr">button_supernova</span> : &#123;  <span class="attr">desc</span>: <span class="string">'Supernova'</span>, <span class="attr">position</span>: <span class="keyword">new</span> Vector2(<span class="number">580</span>, <span class="number">420</span>), <span class="attr">r</span>: <span class="number">40</span> &#125;,</div><div class="line">    &#125;,</div><div class="line">    <span class="attr">start</span>: <span class="function">(<span class="params">sm, opt</span>) =&gt;</span> &#123;</div><div class="line">        <span class="keyword">const</span> sun = sm.game.sun;</div><div class="line">        <span class="comment">// as long as I do not have to update on a tick by tick basis</span></div><div class="line">        <span class="comment">// I can call the sprite_world update method here in the start hook</span></div><div class="line">        sm.game.lands.sections.forEach(<span class="function">(<span class="params">section, i</span>) =&gt;</span> &#123;</div><div class="line">            section.sprite_world.update();</div><div class="line">        &#125;);</div><div class="line">    &#125;,</div><div class="line">    <span class="attr">update</span>: <span class="function">(<span class="params">sm, secs</span>) =&gt;</span> &#123;</div><div class="line">       gameMod.updateByTickDelta(sm.game, sm.ticksPerSec * secs, <span class="literal">false</span>);</div><div class="line">    &#125;,</div><div class="line">    <span class="attr">render</span>: <span class="function">(<span class="params">sm, ctx, canvas, data</span>) =&gt;</span> &#123;</div><div class="line">        render_detail(sm, ctx, canvas, data);</div><div class="line">    &#125;,</div><div class="line">    <span class="attr">events</span>: &#123;</div><div class="line"></div><div class="line">        <span class="attr">pointerdown</span> : <span class="function">(<span class="params">sm, pos, e, data</span>) =&gt;</span> &#123;</div><div class="line">            <span class="keyword">const</span> sun = sm.game.sun;</div><div class="line">            <span class="keyword">const</span> d = pos.distanceTo(sun.center);</div><div class="line">            <span class="comment">// clicked in the sun area?</span></div><div class="line">            <span class="keyword">if</span>(d &lt; constant.SUNAREA_RADIUS)&#123;</div><div class="line">                gameMod.setSunPos(sm.game, pos);</div><div class="line">                <span class="keyword">return</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="comment">// clicked land object?</span></div><div class="line">            <span class="keyword">const</span> land = gameMod.getSectionByPos(sm.game, pos);</div><div class="line">            <span class="keyword">if</span>(land)&#123;</div><div class="line">                sm.landIndex = land.i;</div><div class="line">                sm.setState(<span class="string">'land'</span>, &#123;&#125;);</div><div class="line">                <span class="keyword">return</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="comment">// was supernova button clicked?</span></div><div class="line">            utils.button_check(data, <span class="string">'button_supernova'</span>, pos, () =&gt; &#123;</div><div class="line">                sm.setState(<span class="string">'supernova'</span>, &#123;&#125;);</div><div class="line">            &#125;);</div><div class="line">        &#125;,</div><div class="line">        <span class="attr">onkey</span>: <span class="function">(<span class="params">sm, key, down, e, data</span>) =&gt;</span> &#123;</div><div class="line">            <span class="keyword">const</span> sun = sm.game.sun;</div><div class="line">            <span class="keyword">if</span>(down)&#123;</div><div class="line">                <span class="keyword">const</span> a_lencurrent = sun.getLengthAlpha();</div><div class="line">                <span class="keyword">if</span>(key ===<span class="string">'ArrowRight'</span>)&#123;</div><div class="line">                    sun.stepDirByIndex(<span class="number">1</span>, <span class="number">1</span>);</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">if</span>(key ===<span class="string">'ArrowLeft'</span>)&#123;</div><div class="line">                    sun.stepDirByIndex(<span class="number">-1</span>, <span class="number">1</span>);</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">if</span>(key ===<span class="string">'ArrowUp'</span>)&#123;</div><div class="line">                    sun.stepLengthByIndex(<span class="number">1</span>, <span class="number">10</span>);</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">if</span>(key ===<span class="string">'ArrowDown'</span>)&#123;</div><div class="line">                    sun.stepLengthByIndex(<span class="number">-1</span>, <span class="number">10</span>);</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">if</span>(key.toLowerCase() ===<span class="string">'c'</span>)&#123;</div><div class="line">                    sun.centerPos();</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;,</div><div class="line">        <span class="attr">onkeyfirst</span>: <span class="function">(<span class="params">sm, key, down, e, data</span>) =&gt;</span> &#123;&#125;,</div><div class="line">        <span class="attr">onkeyrepeat</span>: <span class="function">(<span class="params">sm, key, down, e, data</span>) =&gt;</span> &#123;&#125;</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line"><span class="comment">//-------- ----------</span></div><div class="line"><span class="comment">// EXPORT</span></div><div class="line"><span class="comment">//-------- ----------</span></div><div class="line"><span class="keyword">export</span> &#123; state_world &#125;;</div></pre></td></tr></table></figure>
<h3 id="12-4-The-land-state"><a href="#12-4-The-land-state" class="headerlink" title="12.4 - The land state"></a>12.4 - The land state</h3><p>The land state is where I can get into the world building aspect of this game that I have in mind. Here I can unlock slot objects, and when doing so I can create or absorb a rock type block. These blocks are then what will generate mana which is the main currency of interest in this. The rate at which mana is gained is then impacted by the position of the sun with respect to a temperature mana gain value.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// state_land.mjs - for electronjs-example-mrsun</span></div><div class="line"><span class="keyword">import</span> &#123; gameMod &#125;  <span class="keyword">from</span> <span class="string">"../mrsun-game/game.mjs"</span></div><div class="line"><span class="keyword">import</span> &#123; utils &#125;  <span class="keyword">from</span> <span class="string">"../mrsun-utils/utils.mjs"</span></div><div class="line"><span class="keyword">import</span> &#123; Vector2 &#125; <span class="keyword">from</span> <span class="string">'../vector2/vector2.mjs'</span></div><div class="line"><span class="keyword">import</span> &#123; constant &#125; <span class="keyword">from</span> <span class="string">"../mrsun-constant/constant.mjs"</span></div><div class="line"><span class="comment">//-------- ----------</span></div><div class="line"><span class="comment">// STATE OBJECT FOR LAND</span></div><div class="line"><span class="comment">//-------- ----------</span></div><div class="line"><span class="keyword">const</span> state_land = &#123;</div><div class="line">    <span class="attr">data</span>: &#123;</div><div class="line">        <span class="attr">block_mode</span>: <span class="string">'unlock'</span>,    <span class="comment">// 'unlock', 'create', 'absorb', 'upgrade', and 'info' modes</span></div><div class="line">        block_info_disp: <span class="literal">false</span>,  <span class="comment">// display block info or not?</span></div><div class="line">        block: <span class="literal">null</span>,</div><div class="line">        <span class="attr">button_back</span> : &#123;  <span class="attr">desc</span>: <span class="string">'Back'</span>, <span class="attr">position</span>: <span class="keyword">new</span> Vector2(<span class="number">600</span>, <span class="number">38</span>), <span class="attr">r</span>: <span class="number">32</span> &#125;,</div><div class="line">        <span class="attr">button_next</span> : &#123;  <span class="attr">desc</span>: <span class="string">'Next'</span>, <span class="attr">position</span>: <span class="keyword">new</span> Vector2(<span class="number">640</span> - <span class="number">60</span>, <span class="number">430</span>), <span class="attr">r</span>: <span class="number">30</span> &#125;,</div><div class="line">        <span class="attr">button_last</span> : &#123;  <span class="attr">desc</span>: <span class="string">'Last'</span>, <span class="attr">position</span>: <span class="keyword">new</span> Vector2(<span class="number">60</span>, <span class="number">430</span>), <span class="attr">r</span>: <span class="number">30</span> &#125;,</div><div class="line">        <span class="comment">// 'Block Mode' buttons</span></div><div class="line">        button_bm_unlock :  &#123;  <span class="attr">active</span>: <span class="literal">true</span>, <span class="attr">desc</span>: <span class="string">'Unlock'</span>, <span class="attr">position</span>: <span class="keyword">new</span> Vector2(<span class="number">35</span>, <span class="number">125</span>), <span class="attr">r</span>: <span class="number">25</span> &#125;,</div><div class="line">        <span class="attr">button_bm_create</span> :  &#123;  <span class="attr">active</span>: <span class="literal">false</span>, <span class="attr">desc</span>: <span class="string">'Create'</span>, <span class="attr">position</span>: <span class="keyword">new</span> Vector2(<span class="number">35</span>, <span class="number">180</span>), <span class="attr">r</span>: <span class="number">25</span> &#125;,</div><div class="line">        <span class="attr">button_bm_absorb</span> :  &#123;  <span class="attr">active</span>: <span class="literal">false</span>, <span class="attr">desc</span>: <span class="string">'Absorb'</span>, <span class="attr">position</span>: <span class="keyword">new</span> Vector2(<span class="number">35</span>, <span class="number">235</span>), <span class="attr">r</span>: <span class="number">25</span> &#125;,</div><div class="line">        <span class="attr">button_bm_upgrade</span> : &#123;  <span class="attr">active</span>: <span class="literal">false</span>, </div><div class="line">                               <span class="attr">options</span>: [<span class="string">'1x'</span>, <span class="string">'2x'</span>, <span class="string">'5x'</span>, <span class="string">'mod5'</span>, <span class="string">'max'</span>],</div><div class="line">                               <span class="attr">i_option</span>: <span class="number">3</span>,</div><div class="line">                               <span class="attr">desc</span>: <span class="string">'Upgrade'</span>,</div><div class="line">                               <span class="attr">position</span>: <span class="keyword">new</span> Vector2(<span class="number">35</span>, <span class="number">290</span>), <span class="attr">r</span>: <span class="number">25</span> &#125;,</div><div class="line">        <span class="attr">button_bm_info</span> :    &#123;  <span class="attr">active</span>: <span class="literal">false</span>, <span class="attr">desc</span>: <span class="string">'Info'</span>, <span class="attr">position</span>: <span class="keyword">new</span> Vector2(<span class="number">35</span>, <span class="number">345</span>), <span class="attr">r</span>: <span class="number">25</span> &#125;,</div><div class="line">        <span class="attr">grid_cx</span>: <span class="number">320</span>,</div><div class="line">        <span class="attr">grid_cy</span>: <span class="number">240</span>,</div><div class="line">        <span class="attr">grid_w</span>: <span class="number">0</span>, <span class="attr">grid_h</span>:<span class="number">0</span>,</div><div class="line">        <span class="attr">block_width</span>: <span class="number">50</span>,</div><div class="line">        <span class="attr">block_height</span>: <span class="number">35</span>,</div><div class="line">        <span class="attr">grid_radian</span>: <span class="number">0</span>,</div><div class="line">        <span class="attr">block_infodisp</span>: <span class="literal">true</span></div><div class="line">    &#125;,</div><div class="line">    <span class="comment">// the init hook will ONLY BE CALLED ONCE when the state machine is started</span></div><div class="line">    init: <span class="function">(<span class="params">sm, data</span>) =&gt;</span> &#123;</div><div class="line">        <span class="built_in">console</span>.log(<span class="string">'init hook for land state'</span>);</div><div class="line">        data.grid_w = data.block_width * constant.SLOT_GRID_WIDTH;</div><div class="line">        data.grid_h = data.block_height * constant.SLOT_GRID_HEIGHT;</div><div class="line">    &#125;,</div><div class="line">    <span class="comment">// the start hook will be called each time this state is started</span></div><div class="line">    start: <span class="function">(<span class="params">sm, opt, data</span>) =&gt;</span> &#123;</div><div class="line">        <span class="built_in">console</span>.log(<span class="string">'land state start...'</span>);</div><div class="line">        <span class="keyword">const</span> lands = sm.game.lands;</div><div class="line">        <span class="keyword">const</span> bt_counts = sm.game.lands.bt_counts;</div><div class="line">        utils.button_set(data, <span class="string">'unlock'</span>);</div><div class="line">        <span class="keyword">if</span>(lands.slot_unlock_count &gt; <span class="number">0</span> &amp;&amp; bt_counts.rock === <span class="number">0</span> )&#123;</div><div class="line">            <span class="built_in">console</span>.log(<span class="string">'more than zero slots unlocked, but no rocks? So create then yes.'</span>);</div><div class="line">            utils.button_set(data, <span class="string">'create'</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span>(bt_counts.rock &gt; <span class="number">0</span>)&#123;</div><div class="line">            <span class="built_in">console</span>.log(<span class="string">'more than 1 rock, so upgrade then maybe.'</span>);</div><div class="line">            utils.button_set(data, <span class="string">'upgrade'</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;,</div><div class="line">    <span class="comment">// update called in main app loop function</span></div><div class="line">    update: <span class="function">(<span class="params">sm, secs, data</span>) =&gt;</span> &#123;</div><div class="line">        gameMod.updateByTickDelta(sm.game, sm.ticksPerSec * secs, <span class="literal">false</span>);</div><div class="line">    &#125;,</div><div class="line">    <span class="attr">render</span>: <span class="function">(<span class="params">sm, ctx, canvas, data</span>) =&gt;</span> &#123;</div><div class="line">        ctx.lineWidth = <span class="number">1</span>;</div><div class="line">        <span class="keyword">const</span> sun = sm.game.sun;</div><div class="line">        <span class="keyword">const</span> section = sm.game.lands.sections[sm.landIndex];</div><div class="line">        ctx.fillStyle = <span class="string">'black'</span>;</div><div class="line">        ctx.fillRect(<span class="number">0</span>,<span class="number">0</span>, canvas.width, canvas.height);</div><div class="line">        <span class="comment">// the sprite object for land state</span></div><div class="line">        section.sprite_land.update();</div><div class="line">        utils.drawSprite(section.sprite_land, ctx, canvas);</div><div class="line">        <span class="comment">// render blocks</span></div><div class="line">        <span class="comment">//ctx.globalAlpha = 1;</span></div><div class="line">        utils.drawLandSection(sm, ctx, canvas, section, data);</div><div class="line">        <span class="comment">//ctx.globalAlpha = 1;</span></div><div class="line">        <span class="comment">// buttons</span></div><div class="line">        utils.drawButton(sm, data.button_back, sm.ctx, sm.canvas);</div><div class="line">        utils.drawButton(sm, data.button_next, sm.ctx, sm.canvas);</div><div class="line">        utils.drawButton(sm, data.button_last, sm.ctx, sm.canvas);</div><div class="line">        utils.drawButton(sm, data.button_bm_unlock, sm.ctx, sm.canvas);</div><div class="line">        utils.drawButton(sm, data.button_bm_create, sm.ctx, sm.canvas);</div><div class="line">        utils.drawButton(sm, data.button_bm_absorb, sm.ctx, sm.canvas);</div><div class="line">        utils.drawButton(sm, data.button_bm_upgrade, sm.ctx, sm.canvas);</div><div class="line">        utils.drawButton(sm, data.button_bm_info, sm.ctx, sm.canvas);</div><div class="line">        <span class="comment">// common disp</span></div><div class="line">        utils.drawCommonDisp(sm, ctx, canvas);</div><div class="line">        <span class="comment">// land disp</span></div><div class="line">        ctx.font = <span class="string">'10px arial'</span>;</div><div class="line">        ctx.textAlign = <span class="string">'left'</span>;</div><div class="line">        ctx.textBaseline = <span class="string">'top'</span>;</div><div class="line">        ctx.fillText(<span class="string">'temp: '</span> + section.temp, <span class="number">15</span>, <span class="number">45</span>);</div><div class="line">        ctx.fillText(<span class="string">'rocks: '</span> + section.bt_counts.rock, <span class="number">15</span>, <span class="number">55</span>);</div><div class="line">        ctx.fillText(<span class="string">'slot unlock cost: '</span> + utils.formatDecimal(sm.game.lands.slot_unlock_cost, <span class="number">4</span>), <span class="number">15</span>, <span class="number">65</span>);</div><div class="line">        ctx.fillText(<span class="string">'section mana value: '</span> +  utils.formatDecimal(section.mana_total) +</div><div class="line">                     <span class="string">', sunspots delta world value: '</span> + sm.game.sunspots_delta_world_value + <span class="string">''</span>, <span class="number">15</span>, <span class="number">75</span>);</div><div class="line">        <span class="comment">// current land index</span></div><div class="line">        ctx.font = <span class="string">'50px arial'</span>;</div><div class="line">        ctx.textAlign = <span class="string">'center'</span>;</div><div class="line">        ctx.textBaseline = <span class="string">'middle'</span>;</div><div class="line">        ctx.fillText(<span class="string">'LAND '</span> + sm.landIndex, <span class="number">320</span>, <span class="number">430</span>);</div><div class="line">        <span class="keyword">if</span>(data.block_info_disp)&#123;</div><div class="line">            <span class="keyword">const</span> sx = <span class="number">320</span> - <span class="number">150</span>, sy = <span class="number">240</span> - <span class="number">100</span>;</div><div class="line">            <span class="keyword">const</span> block = data.block;</div><div class="line">            ctx.fillStyle = <span class="string">'rgba(0,0,0, 0.5)'</span>;</div><div class="line">            ctx.fillRect(<span class="number">0</span>,<span class="number">0</span>, canvas.width, canvas.height);</div><div class="line">            ctx.fillStyle = <span class="string">'white'</span>;</div><div class="line">            ctx.fillRect(sx, sy, <span class="number">300</span>, <span class="number">200</span>)</div><div class="line">            ctx.font = <span class="string">'20px arial'</span>;</div><div class="line">            ctx.textAlign = <span class="string">'center'</span>;</div><div class="line">            ctx.textBaseline = <span class="string">'middle'</span>;</div><div class="line">            ctx.fillStyle = <span class="string">'black'</span>;</div><div class="line">            ctx.fillText(<span class="string">'type: '</span> + block.type, <span class="number">320</span>, sy + <span class="number">20</span>);</div><div class="line">            ctx.fillText(<span class="string">'mana_value: '</span> + utils.formatDecimal(block.mana_value.valueOf(), <span class="number">4</span>),<span class="number">320</span>, sy + <span class="number">40</span>   );</div><div class="line">            ctx.fillText(<span class="string">'mana_base: '</span> + block.mana_base.toFixed(<span class="number">2</span>), <span class="number">320</span>, sy + <span class="number">60</span>   );</div><div class="line">            ctx.fillText(<span class="string">'mana_temp: '</span> + block.mana_temp.toFixed(<span class="number">2</span>), <span class="number">320</span>, sy + <span class="number">80</span>   );</div><div class="line">        &#125;</div><div class="line">    &#125;,</div><div class="line">    <span class="attr">events</span>: &#123;</div><div class="line">        <span class="attr">pointerdown</span>: <span class="function">(<span class="params">sm, pos, e, data</span>) =&gt;</span> &#123;</div><div class="line">            <span class="keyword">const</span> section = sm.game.lands.sections[sm.landIndex];</div><div class="line">            <span class="keyword">if</span>(data.block_info_disp)&#123;</div><div class="line">                data.block_info_disp = <span class="literal">false</span>;</div><div class="line">            &#125;<span class="keyword">else</span>&#123;</div><div class="line">                <span class="comment">// check buttons</span></div><div class="line">                utils.button_check(data, <span class="string">'button_back'</span>, pos, () =&gt; &#123;</div><div class="line">                    sm.setState(<span class="string">'world'</span>, &#123;&#125;);</div><div class="line">                &#125;);</div><div class="line">                utils.button_check(data, <span class="string">'button_next'</span>, pos, () =&gt; &#123;</div><div class="line">                    sm.landIndex = (sm.landIndex + <span class="number">1</span>) % <span class="number">12</span>;</div><div class="line">                &#125;);</div><div class="line">                utils.button_check(data, <span class="string">'button_last'</span>, pos, () =&gt; &#123;</div><div class="line">                    <span class="keyword">let</span> n = sm.landIndex - <span class="number">1</span>;</div><div class="line">                    n = n &lt; <span class="number">0</span> ? <span class="number">11</span> : n;</div><div class="line">                    sm.landIndex = n;</div><div class="line">                &#125;);</div><div class="line">                utils.button_check_blockmode(data, <span class="string">'unlock'</span>, pos);</div><div class="line">                utils.button_check_blockmode(data, <span class="string">'create'</span>, pos);</div><div class="line">                utils.button_check_blockmode(data, <span class="string">'absorb'</span>, pos);</div><div class="line">                utils.button_check_blockmode(data, <span class="string">'upgrade'</span>, pos);</div><div class="line">                utils.button_check_blockmode(data, <span class="string">'info'</span>, pos);</div><div class="line">                <span class="comment">// grid clicked?</span></div><div class="line">                <span class="keyword">const</span> sx = data.grid_cx - data.grid_w / <span class="number">2</span>;</div><div class="line">                <span class="keyword">const</span> sy = data.grid_cy - data.grid_h / <span class="number">2</span>;</div><div class="line">                <span class="keyword">if</span>( utils.boundingBox(pos.x, pos.y, <span class="number">1</span>, <span class="number">1</span>, sx, sy, data.grid_w, data.grid_h) )&#123;</div><div class="line">                    <span class="keyword">const</span> bx = <span class="built_in">Math</span>.floor( ( pos.x - sx - <span class="number">0.01</span>) / data.block_width );</div><div class="line">                    <span class="keyword">const</span> by = <span class="built_in">Math</span>.floor( ( pos.y - sy - <span class="number">0.01</span>) / data.block_height );</div><div class="line">                    <span class="keyword">const</span> i = by * constant.SLOT_GRID_WIDTH + bx;</div><div class="line">                    <span class="keyword">const</span> slot = section.slots[i];</div><div class="line">                    <span class="keyword">const</span> block = slot.block;</div><div class="line">                    <span class="comment">// action will differ based on block mode</span></div><div class="line">                    <span class="keyword">if</span>(data.block_mode === <span class="string">'unlock'</span>)&#123;</div><div class="line">                        gameMod.unlockSlot(sm.game, sm.landIndex, i);</div><div class="line">                    &#125;</div><div class="line">                    <span class="keyword">if</span>(data.block_mode === <span class="string">'create'</span>)&#123;</div><div class="line">                        gameMod.createBlock(sm.game, sm.landIndex, i, <span class="number">1</span>);</div><div class="line">                    &#125;</div><div class="line">                    <span class="keyword">if</span>(data.block_mode === <span class="string">'absorb'</span>)&#123;</div><div class="line">                        gameMod.absorbBlock(sm.game, sm.landIndex, i);</div><div class="line">                    &#125;</div><div class="line">                    <span class="keyword">if</span>(data.block_mode === <span class="string">'upgrade'</span>)&#123;</div><div class="line">                        <span class="keyword">const</span> button = data.button_bm_upgrade;</div><div class="line">                        <span class="keyword">if</span>(button.i_option === <span class="number">0</span>)&#123;</div><div class="line">                            <span class="built_in">console</span>.log(<span class="string">'1x upgrade'</span>);</div><div class="line">                            gameMod.upgradeBlock(sm.game, sm.landIndex, i, <span class="number">1</span>);</div><div class="line">                        &#125;</div><div class="line">                        <span class="keyword">if</span>(button.i_option === <span class="number">1</span>)&#123;</div><div class="line">                            <span class="built_in">console</span>.log(<span class="string">'2x upgrade'</span>);</div><div class="line">                            gameMod.upgradeBlock(sm.game, sm.landIndex, i, <span class="number">2</span>);</div><div class="line">                        &#125;</div><div class="line">                        <span class="keyword">if</span>(button.i_option === <span class="number">2</span>)&#123;</div><div class="line">                            <span class="built_in">console</span>.log(<span class="string">'5x upgrade'</span>);</div><div class="line">                            gameMod.upgradeBlock(sm.game, sm.landIndex, i, <span class="number">5</span>);</div><div class="line">                        &#125;</div><div class="line">                        <span class="keyword">if</span>(button.i_option === <span class="number">3</span>)&#123;</div><div class="line">                            <span class="built_in">console</span>.log(<span class="string">'mod5 upgrade'</span>);</div><div class="line">                            gameMod.upgradeBlock(sm.game, sm.landIndex, i, <span class="string">'mod5'</span>);</div><div class="line">                        &#125;</div><div class="line">                        <span class="keyword">if</span>(button.i_option === <span class="number">4</span>)&#123;</div><div class="line">                            <span class="built_in">console</span>.log(<span class="string">'Max Upgrade!'</span>);</div><div class="line">                            gameMod.upgradeBlock(sm.game, sm.landIndex, i, <span class="string">'max'</span>);</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                    <span class="keyword">if</span>(data.block_mode === <span class="string">'info'</span>)&#123;</div><div class="line">                        data.block_info_disp = <span class="literal">true</span>;</div><div class="line">                        data.block = block;</div><div class="line">                        gameMod.saveGame(sm.game);</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line"><span class="comment">//-------- ----------</span></div><div class="line"><span class="comment">// EXPORT</span></div><div class="line"><span class="comment">//-------- ----------</span></div><div class="line"><span class="keyword">export</span> &#123; state_land &#125;;</div></pre></td></tr></table></figure>
<h3 id="12-5-The-super-nova-state-Prestige-mechanic"><a href="#12-5-The-super-nova-state-Prestige-mechanic" class="headerlink" title="12.5 - The super nova state ( Prestige mechanic )"></a>12.5 - The super nova state ( Prestige mechanic )</h3><p>A common mechanic to have in idle games is something that is often referred to as a <a href="https://www.youtube.com/watch?v=aYFHUq-8gPY" target="_blank" rel="external">Prestige mechanic</a>. For my Mr Sun electronjs example prototype I am calling this kind of mechanic a <a href="https://en.wikipedia.org/wiki/Supernova" target="_blank" rel="external">supernova event</a> which just strikes me as a good name for it with respect to the over all theme of this project.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// state_supernova.mjs - for electronjs-example-mrsun</span></div><div class="line"><span class="keyword">import</span> &#123; gameMod &#125;  <span class="keyword">from</span> <span class="string">"../mrsun-game/game.mjs"</span></div><div class="line"><span class="keyword">import</span> &#123; utils &#125;  <span class="keyword">from</span> <span class="string">"../mrsun-utils/utils.mjs"</span></div><div class="line"><span class="keyword">import</span> &#123; Vector2 &#125; <span class="keyword">from</span> <span class="string">'../vector2/vector2.mjs'</span></div><div class="line"><span class="keyword">import</span> &#123; constant &#125; <span class="keyword">from</span> <span class="string">"../mrsun-constant/constant.mjs"</span></div><div class="line"><span class="comment">//-------- ----------</span></div><div class="line"><span class="comment">// RENDER FUNCTIONS </span></div><div class="line"><span class="comment">//-------- ----------</span></div><div class="line"><span class="comment">// render the background</span></div><div class="line"><span class="keyword">const</span> render_background = <span class="function">(<span class="params">sm, ctx, canvas, data</span>) =&gt;</span> &#123;</div><div class="line">    ctx.lineWidth = <span class="number">1</span>;</div><div class="line">    ctx.font = <span class="string">'15px arial'</span>;</div><div class="line">    ctx.fillStyle = <span class="string">'#000000'</span>;</div><div class="line">    ctx.fillRect(<span class="number">0</span>,<span class="number">0</span>, canvas.width, canvas.height);</div><div class="line">&#125;;</div><div class="line"><span class="comment">//-------- ----------</span></div><div class="line"><span class="comment">// STATE OBJECT FOR SUPERNOVA</span></div><div class="line"><span class="comment">//-------- ----------</span></div><div class="line"><span class="keyword">const</span> state_supernova = &#123;</div><div class="line">    <span class="attr">data</span>: &#123;</div><div class="line">        <span class="attr">button_back</span> : &#123;  <span class="attr">desc</span>: <span class="string">'Back'</span>, <span class="attr">position</span>: <span class="keyword">new</span> Vector2(<span class="number">600</span>, <span class="number">38</span>), <span class="attr">r</span>: <span class="number">32</span> &#125;,</div><div class="line">        <span class="attr">button_newgame</span> : &#123;  <span class="attr">desc</span>: <span class="string">'New Game'</span>, <span class="attr">position</span>: <span class="keyword">new</span> Vector2(<span class="number">580</span>, <span class="number">420</span>), <span class="attr">r</span>: <span class="number">40</span> &#125;</div><div class="line">    &#125;,</div><div class="line">    <span class="attr">start</span>: <span class="function">(<span class="params">sm, opt</span>) =&gt;</span> &#123;&#125;,</div><div class="line">    <span class="attr">update</span>: <span class="function">(<span class="params">sm, secs</span>) =&gt;</span> &#123;</div><div class="line">       gameMod.updateByTickDelta(sm.game, sm.ticksPerSec * secs, <span class="literal">false</span>);</div><div class="line">    &#125;,</div><div class="line">    <span class="attr">render</span>: <span class="function">(<span class="params">sm, ctx, canvas, data</span>) =&gt;</span> &#123;</div><div class="line">        <span class="comment">// super nova cost object</span></div><div class="line">        <span class="keyword">const</span> snc = gameMod.getSupernovaCost(sm.game);</div><div class="line">        <span class="comment">// background</span></div><div class="line">        render_background(sm, ctx, canvas, data);</div><div class="line">        utils.drawButton(sm, data.button_back, sm.ctx, sm.canvas);</div><div class="line">        utils.drawButton(sm, data.button_newgame, sm.ctx, sm.canvas);</div><div class="line">        <span class="comment">// disp</span></div><div class="line">        utils.drawCommonDisp(sm, ctx, canvas);</div><div class="line">        <span class="keyword">const</span> sx = <span class="number">10</span>, sy = <span class="number">100</span>, yd = <span class="number">25</span>;</div><div class="line">        ctx.textAlign = <span class="string">'left'</span>;</div><div class="line">        ctx.textBaseline = <span class="string">'top'</span>;</div><div class="line">        ctx.font = <span class="string">'20px monospace'</span>;</div><div class="line">        ctx.fillText(<span class="string">'current sunspots : '</span> + utils.formatDecimal(sm.game.sunspots, <span class="number">4</span>), sx, sy);</div><div class="line">        ctx.fillText(<span class="string">'sunspots delta   : '</span> + utils.formatDecimal(sm.game.sunspots_delta, <span class="number">4</span>), sx, sy + yd * <span class="number">1</span>);</div><div class="line">        <span class="keyword">const</span> dec = sm.game.sunspots.add( sm.game.sunspots_delta );</div><div class="line">        <span class="keyword">const</span> m = gameMod.getSunSpotMulti( dec.toNumber() );</div><div class="line">        ctx.fillText(<span class="string">'new sunspots   : '</span> + utils.formatDecimal(dec, <span class="number">4</span>), sx, sy + yd * <span class="number">4</span> );</div><div class="line">        ctx.fillText(<span class="string">'new multiplier   : '</span> + m.toFixed(<span class="number">4</span>) + <span class="string">'x'</span>, sx, sy + yd * <span class="number">5</span> );</div><div class="line">        <span class="keyword">const</span> ts = utils.formatDecimal(sm.game.mana_spent, <span class="number">2</span>)</div><div class="line">        ctx.fillText(<span class="string">'total mana spent   : '</span> + ts, sx, sy + yd * <span class="number">6</span> );</div><div class="line">        ctx.fillText(<span class="string">'supernova count   : '</span> + sm.game.supernova_count, sx, sy + yd * <span class="number">7</span> );</div><div class="line">        ctx.fillText(<span class="string">'supernova cost   : '</span> + utils.formatDecimal(snc.cost_dec, <span class="number">2</span>), sx, sy + yd * <span class="number">8</span> );</div><div class="line">    &#125;,</div><div class="line">    <span class="attr">events</span>: &#123;</div><div class="line">        <span class="attr">pointerdown</span> : <span class="function">(<span class="params">sm, pos, e, data</span>) =&gt;</span> &#123;</div><div class="line">            <span class="comment">// was the back button clicked?</span></div><div class="line">            utils.button_check(data, <span class="string">'button_back'</span>, pos, () =&gt; &#123;</div><div class="line">                sm.setState(<span class="string">'world'</span>, &#123;&#125;);</div><div class="line">            &#125;);</div><div class="line">            <span class="comment">// was supernova button clicked?</span></div><div class="line">            utils.button_check(data, <span class="string">'button_newgame'</span>, pos, () =&gt; &#123;</div><div class="line">                <span class="keyword">const</span> snc = gameMod.getSupernovaCost(sm.game);</div><div class="line">                <span class="keyword">if</span>( sm.game.mana.gte( snc.cost_dec ) )&#123;</div><div class="line">                    <span class="keyword">const</span> sp = sm.game.sunspots.add(sm.game.sunspots_delta);</div><div class="line">                    <span class="keyword">const</span> start_date = sm.game.start_date;</div><div class="line">                    sm.game = gameMod.create(&#123; </div><div class="line">                        <span class="attr">platform</span>: sm.platform,</div><div class="line">                        <span class="attr">supernova_count</span>: <span class="built_in">parseInt</span>(sm.game.supernova_count) + <span class="number">1</span>,</div><div class="line">                        <span class="attr">sunspots</span>: sp.toString(),</div><div class="line">                        <span class="attr">start_date</span>: start_date</div><div class="line">                    &#125;);</div><div class="line">                    <span class="built_in">console</span>.log(<span class="string">'starting a new game with: '</span>);</div><div class="line">                    <span class="built_in">console</span>.log( sm.game.sunspots );</div><div class="line">                    <span class="built_in">console</span>.log( sm.game.start_date );</div><div class="line">                    sm.setState(<span class="string">'world'</span>, &#123;&#125;);</div><div class="line">                &#125;<span class="keyword">else</span>&#123;</div><div class="line">                    <span class="built_in">console</span>.log(<span class="string">'not enough mana!'</span>);</div><div class="line">                &#125;</div><div class="line">            &#125;);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line"><span class="comment">//-------- ----------</span></div><div class="line"><span class="comment">// EXPORT</span></div><div class="line"><span class="comment">//-------- ----------</span></div><div class="line"><span class="keyword">export</span> &#123; state_supernova &#125;;</div></pre></td></tr></table></figure>
<h2 id="13-mrsun-utils"><a href="#13-mrsun-utils" class="headerlink" title="13 - mrsun-utils"></a>13 - mrsun-utils</h2><p>I have a general utilities module which is where I just pack all kinds of methods that I might use more than once across a bunch of files, but can not think of any other place to park it. Seems that lots of popular libraries have a module such as this that is just a function junk drawer.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// utils.js - for electronjs-example-mrsun</span></div><div class="line"><span class="keyword">import</span> &#123; Decimal &#125;  <span class="keyword">from</span> <span class="string">"../decimal/10.4.3/decimal.mjs"</span></div><div class="line"><span class="keyword">import</span> &#123; constant &#125; <span class="keyword">from</span> <span class="string">"../mrsun-constant/constant.mjs"</span></div><div class="line"><span class="comment">//-------- ----------</span></div><div class="line"><span class="comment">// MAIN UTILS PUBLIC OBJECT</span></div><div class="line"><span class="comment">//-------- ----------</span></div><div class="line"><span class="keyword">const</span> utils = &#123;&#125;;</div><div class="line"><span class="comment">//-------- ----------</span></div><div class="line"><span class="comment">// BUTTON METHODS</span></div><div class="line"><span class="comment">//-------- ----------</span></div><div class="line"><span class="comment">// set the current button by mode string</span></div><div class="line">utils.button_set = <span class="function">(<span class="params">data, mode</span>) =&gt;</span> &#123;</div><div class="line">    <span class="keyword">const</span> key = <span class="string">'button_bm_'</span> + mode;</div><div class="line">    <span class="keyword">const</span> button = data[key];</div><div class="line">    data[<span class="string">'button_bm_'</span> + data.block_mode].active = <span class="literal">false</span>;</div><div class="line">    button.active = <span class="literal">true</span>;</div><div class="line">    data.block_mode = mode;</div><div class="line">&#125;;</div><div class="line">utils.button_check = <span class="function">(<span class="params">data, key, pos, onClick</span>) =&gt;</span> &#123;</div><div class="line">    <span class="keyword">const</span> button = data[key];</div><div class="line">    <span class="keyword">if</span>( button.position.distanceTo( pos ) &lt;= button.r )&#123;</div><div class="line">        onClick(button, data, key, pos);</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line">utils.button_check_blockmode = <span class="function">(<span class="params">data, new_block_mode, pos</span>) =&gt;</span> &#123;</div><div class="line">    <span class="keyword">const</span> key = <span class="string">'button_bm_'</span> + new_block_mode;</div><div class="line">    utils.button_check(data, key, pos, (button) =&gt; &#123;</div><div class="line">        <span class="keyword">const</span> button_bm_current = data[<span class="string">'button_bm_'</span> + data.block_mode];</div><div class="line">        <span class="keyword">if</span>(button_bm_current === button)&#123;</div><div class="line">            <span class="built_in">console</span>.log(<span class="string">'block mode button all ready selected.'</span>);</div><div class="line">            <span class="keyword">if</span>(button.options)&#123;</div><div class="line">                <span class="built_in">console</span>.log(<span class="string">'we have options though. I can step that.'</span>);</div><div class="line">                button.i_option += <span class="number">1</span>;</div><div class="line">                button.i_option %= button.options.length;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span>(button_bm_current != button)&#123;</div><div class="line">            <span class="built_in">console</span>.log(<span class="string">'block mode switch'</span>);</div><div class="line">            button_bm_current.active = <span class="literal">false</span>;</div><div class="line">            button.active = <span class="literal">true</span>;</div><div class="line">            data.block_mode = new_block_mode;</div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line">&#125;;</div><div class="line"><span class="comment">//-------- ----------</span></div><div class="line"><span class="comment">// MATH UTILIES</span></div><div class="line"><span class="comment">//-------- ----------</span></div><div class="line">utils.logOnce = (<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">    <span class="keyword">let</span> count = <span class="number">0</span>;</div><div class="line">    <span class="keyword">return</span> <span class="function">(<span class="params">mess</span>) =&gt;</span> &#123;</div><div class="line">       <span class="keyword">if</span>(count &lt; <span class="number">1</span>)&#123;</div><div class="line">           <span class="built_in">console</span>.log(mess)</div><div class="line">       &#125;</div><div class="line">       count += <span class="number">1</span>;</div><div class="line">    &#125;;</div><div class="line">&#125;());</div><div class="line"><span class="comment">// bounding box</span></div><div class="line">utils.boundingBox = <span class="function"><span class="keyword">function</span> (<span class="params">x1, y1, w1, h1, x2, y2, w2, h2</span>) </span>&#123;</div><div class="line">    <span class="keyword">return</span> !(</div><div class="line">        (y1 + h1) &lt; y2 ||</div><div class="line">        y1 &gt; (y2 + h2) ||</div><div class="line">        (x1 + w1) &lt; x2 ||</div><div class="line">        x1 &gt; (x2 + w2));</div><div class="line">&#125;;</div><div class="line"><span class="comment">// format a decimal object</span></div><div class="line">utils.formatDecimal = (<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">    <span class="keyword">const</span> NAMES = [ <span class="string">'K'</span>, <span class="string">'M'</span>, <span class="string">'B'</span>, <span class="string">'T'</span>, <span class="string">'Qa'</span>, <span class="string">'Qi'</span>, <span class="string">'Sx'</span>, <span class="string">'Sp'</span>, <span class="string">'Oc'</span>, <span class="string">'No'</span>, <span class="string">'Dc'</span> ];</div><div class="line">    <span class="keyword">return</span> <span class="function">(<span class="params">n, dp</span>) =&gt;</span> &#123;</div><div class="line">        dp = dp === <span class="literal">undefined</span> ? <span class="number">2</span> : dp;</div><div class="line">        <span class="keyword">if</span>(n.e &lt; <span class="number">3</span>)&#123;</div><div class="line">            <span class="keyword">return</span> n.toString();</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">const</span> er = n.e % <span class="number">3</span>;</div><div class="line">        <span class="keyword">const</span> i_name = <span class="built_in">Math</span>.floor( n.e / <span class="number">3</span> ) - <span class="number">1</span>;</div><div class="line">        <span class="keyword">const</span> a = <span class="built_in">parseFloat</span>( n.toExponential(dp, Decimal.ROUND_DOWN).split(<span class="string">'e'</span>)[<span class="number">0</span>] );</div><div class="line">        <span class="keyword">if</span>(i_name &lt; NAMES.length)&#123;</div><div class="line">            <span class="keyword">let</span> dp2 = dp - er;</div><div class="line">            dp2 = dp2 &lt; <span class="number">0</span> ? <span class="number">0</span>: dp2;</div><div class="line">            <span class="keyword">return</span> (a * <span class="built_in">Math</span>.pow( <span class="number">10</span>, er ) ).toFixed( dp2 ) + <span class="string">''</span> + NAMES[i_name];</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> n.toExponential(dp);</div><div class="line">    &#125;;</div><div class="line">&#125;());</div><div class="line"><span class="comment">// add up pows from start exp down to zero</span></div><div class="line">utils.addPows = <span class="function">(<span class="params">base, exp_start, exp_end</span>) =&gt;</span> &#123;</div><div class="line">    exp_end = exp_end === <span class="literal">undefined</span> ? <span class="number">0</span> : exp_end;</div><div class="line">    <span class="keyword">let</span> e = exp_start;</div><div class="line">    <span class="keyword">let</span> n = <span class="number">0</span>;</div><div class="line">    <span class="keyword">while</span>(e &gt;= exp_end)&#123;</div><div class="line">        <span class="keyword">const</span> p = <span class="built_in">Math</span>.pow(base, e);</div><div class="line">        n += p;</div><div class="line">        e -= <span class="number">1</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> n;</div><div class="line">&#125;;</div><div class="line"><span class="comment">//-------- ----------</span></div><div class="line"><span class="comment">// RENDER UTILIES</span></div><div class="line"><span class="comment">//-------- ----------</span></div><div class="line"><span class="comment">// draw a button</span></div><div class="line">utils.drawButton = <span class="function">(<span class="params"> sm, button, ctx, canvas </span>) =&gt;</span> &#123;</div><div class="line">    ctx.fillStyle = button.active ? <span class="string">'#004400'</span> : <span class="string">'#444444'</span>;</div><div class="line">    ctx.strokeStyle = <span class="string">'#ffffff'</span>;</div><div class="line">    ctx.lineWidth = <span class="number">2</span>;</div><div class="line">    ctx.beginPath();</div><div class="line">    ctx.arc(button.position.x, button.position.y, button.r, <span class="number">0</span>, <span class="built_in">Math</span>.PI * <span class="number">2</span>);</div><div class="line">    ctx.fill();</div><div class="line">    ctx.stroke();</div><div class="line">    <span class="comment">// desc</span></div><div class="line">    ctx.fillStyle = <span class="string">'white'</span>;</div><div class="line">    ctx.font = <span class="string">'12px arial'</span>;</div><div class="line">    ctx.textBaseline = <span class="string">'middle'</span>;</div><div class="line">    ctx.textAlign = <span class="string">'center'</span>;</div><div class="line">    ctx.fillText(button.desc || <span class="string">'foo'</span>, button.position.x, button.position.y);</div><div class="line">    <span class="comment">// if options draw text for current option</span></div><div class="line">    <span class="keyword">if</span>(button.options)&#123;</div><div class="line">        ctx.font = <span class="string">'10px arial'</span>;</div><div class="line">        <span class="keyword">const</span> str = button.options[button.i_option];</div><div class="line">        ctx.fillText(str, button.position.x, button.position.y + <span class="number">14</span>);</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line">utils.drawSprite = <span class="function">(<span class="params">sprite, ctx, canvas</span>) =&gt;</span> &#123;</div><div class="line">    ctx.strokeStyle = <span class="string">'#00ff00'</span>;</div><div class="line">    ctx.save();</div><div class="line">    ctx.translate( sprite.position.x, sprite.position.y );</div><div class="line">    <span class="keyword">if</span>(sprite.sheets)&#123;</div><div class="line">        <span class="keyword">let</span> i_sheet = <span class="number">0</span>, len = sprite.sheets.length;</div><div class="line">        <span class="keyword">while</span>(i_sheet &lt; len)&#123;</div><div class="line">            <span class="keyword">const</span> source = sprite.getCell(i_sheet);</div><div class="line">            ctx.drawImage(sprite.sheets[i_sheet].image, </div><div class="line">                source.sx, source.sy, source.sw, source.sh,</div><div class="line">                sprite.size.x / <span class="number">2</span> * <span class="number">-1</span>, sprite.size.y / <span class="number">2</span> * <span class="number">-1</span>, sprite.size.x, sprite.size.y </div><div class="line">            );</div><div class="line">            i_sheet += <span class="number">1</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span>(sprite.sheets.length === <span class="number">0</span>)&#123;</div><div class="line">        ctx.beginPath();</div><div class="line">        ctx.rect(sprite.size.x / <span class="number">2</span> * <span class="number">-1</span>, sprite.size.y / <span class="number">2</span> * <span class="number">-1</span>, sprite.size.x, sprite.size.y);</div><div class="line">        ctx.stroke();</div><div class="line">    &#125;</div><div class="line">    ctx.restore();</div><div class="line">&#125;;</div><div class="line"><span class="comment">// draw a common display that you would want to have over all states</span></div><div class="line">utils.drawCommonDisp = <span class="function">(<span class="params">sm, ctx, canvas</span>) =&gt;</span> &#123;</div><div class="line">    ctx.fillStyle = <span class="string">'white'</span>;</div><div class="line">    ctx.font = <span class="string">'15px arial'</span>;</div><div class="line">    ctx.textBaseline = <span class="string">'top'</span>;</div><div class="line">    ctx.textAlign = <span class="string">'left'</span>;</div><div class="line">    <span class="comment">// mana bar</span></div><div class="line">    ctx.fillStyle = <span class="string">'#2a2a2a'</span>;</div><div class="line">    ctx.fillRect(<span class="number">10</span>, <span class="number">4</span>, <span class="number">250</span>, <span class="number">17</span>);</div><div class="line">    ctx.fillStyle = <span class="string">'#0044dd'</span>;</div><div class="line">    <span class="keyword">const</span> a_mana = sm.game.mana.div(sm.game.mana_cap);</div><div class="line">    ctx.fillRect(<span class="number">10</span>, <span class="number">4</span>, <span class="number">250</span> * a_mana, <span class="number">17</span>);</div><div class="line">    ctx.fillStyle = <span class="string">'#ffffff'</span>;</div><div class="line">    ctx.fillText(<span class="string">'mana: '</span> + utils.formatDecimal(sm.game.mana, <span class="number">2</span>) + <span class="string">' / '</span> +</div><div class="line">         utils.formatDecimal(sm.game.mana_cap, <span class="number">2</span>) + </div><div class="line">         <span class="string">' (+'</span> + utils.formatDecimal(sm.game.mana_per_tick, <span class="number">4</span>) + <span class="string">') '</span>, <span class="number">15</span>, <span class="number">5</span>);</div><div class="line">    <span class="comment">// sunspots count</span></div><div class="line">    ctx.fillStyle = <span class="string">'#888888'</span>;</div><div class="line">    ctx.fillText(<span class="string">'sunspots: '</span> + utils.formatDecimal( sm.game.sunspots, <span class="number">2</span> ) + <span class="string">' ('</span> + sm.game.sunspot_multi.toFixed(<span class="number">2</span>) + <span class="string">'X)'</span>, <span class="number">275</span>, <span class="number">5</span>);</div><div class="line">    <span class="comment">// tick count</span></div><div class="line">    ctx.fillText(<span class="string">'tick: '</span> + sm.game.tick, <span class="number">10</span>, <span class="number">25</span>);</div><div class="line">&#125;;</div><div class="line"><span class="comment">// draw the state of a given LandSection object</span></div><div class="line">utils.drawLandSection = <span class="function">(<span class="params">sm, ctx, canvas, section, opt </span>) =&gt;</span> &#123;</div><div class="line">    opt = opt || &#123;&#125;;</div><div class="line">    opt.block_infodisp = opt.block_infodisp || <span class="literal">false</span>;</div><div class="line">    ctx.save();</div><div class="line">    ctx.translate(opt.grid_cx , opt.grid_cy);</div><div class="line">    ctx.rotate(opt.grid_radian);</div><div class="line">    <span class="keyword">const</span> sx = opt.grid_w / <span class="number">2</span> * <span class="number">-1</span>;</div><div class="line">    <span class="keyword">const</span> sy = opt.grid_h / <span class="number">2</span> * <span class="number">-1</span>;</div><div class="line">    <span class="keyword">let</span> i = <span class="number">0</span>;</div><div class="line">    ctx.font = <span class="string">'10px arial'</span>;</div><div class="line">    ctx.textAlign = <span class="string">'left'</span>;</div><div class="line">    ctx.textBaseline = <span class="string">'top'</span>;</div><div class="line">    <span class="keyword">while</span>(i &lt; constant.SLOT_GRID_LEN)&#123;</div><div class="line">        <span class="keyword">const</span> bx = i % constant.SLOT_GRID_WIDTH;</div><div class="line">        <span class="keyword">const</span> by = <span class="built_in">Math</span>.floor(i / constant.SLOT_GRID_WIDTH);</div><div class="line">        <span class="keyword">const</span> i_slot = by * constant.SLOT_GRID_WIDTH + bx;</div><div class="line">        <span class="keyword">const</span> slot = section.slots[i_slot];</div><div class="line">        <span class="keyword">const</span> block = slot.block;</div><div class="line">        ctx.fillStyle = <span class="string">'cyan'</span>;</div><div class="line">        <span class="keyword">if</span>(!slot.locked)&#123;</div><div class="line">            ctx.fillStyle = block.type === <span class="string">'blank'</span> ? <span class="string">'black'</span> : <span class="string">'red'</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// render a block</span></div><div class="line">        ctx.strokeStyle = <span class="string">'white'</span>;</div><div class="line">        ctx.beginPath();</div><div class="line">        <span class="keyword">const</span> x = sx + opt.block_width * bx;</div><div class="line">        <span class="keyword">const</span> y = sy + opt.block_height * by;</div><div class="line">        ctx.rect(x, y, opt.block_width, opt.block_height);</div><div class="line">        <span class="comment">//ctx.fill();</span></div><div class="line">        ctx.stroke();</div><div class="line">        <span class="comment">// level text</span></div><div class="line">        <span class="keyword">if</span>(block.type === <span class="string">'rock'</span> &amp;&amp; opt.block_infodisp)&#123;</div><div class="line">            ctx.fillStyle = <span class="string">'white'</span>;</div><div class="line">            ctx.fillText(block.level, x + <span class="number">5</span>, y + <span class="number">5</span>);</div><div class="line">        &#125;</div><div class="line">        i += <span class="number">1</span>;</div><div class="line">    &#125;</div><div class="line">    ctx.restore();</div><div class="line">&#125;;</div><div class="line"><span class="comment">//-------- ----------</span></div><div class="line"><span class="comment">// FORMAT DECIMAL TEST</span></div><div class="line"><span class="comment">//-------- ----------</span></div><div class="line"><span class="comment">/*</span></div><div class="line">const total = 960;</div><div class="line">let unlock_count = 0;</div><div class="line">while(unlock_count &lt; total)&#123;</div><div class="line">    const n = Decimal.pow(10, 30 * ( unlock_count / total ) ).ceil().sub(1);</div><div class="line">    console.log( unlock_count, utils.formatDecimal(n, 2), n.toExponential(8) );</div><div class="line">    unlock_count += 1;</div><div class="line">&#125;</div><div class="line">*/</div><div class="line"><span class="comment">//-------- ----------</span></div><div class="line"><span class="comment">// EXPORT</span></div><div class="line"><span class="comment">//-------- ----------</span></div><div class="line"><span class="keyword">export</span> &#123; utils &#125;;</div></pre></td></tr></table></figure>
<h2 id="14-main-electronjs"><a href="#14-main-electronjs" class="headerlink" title="14 - main electronjs"></a>14 - main electronjs</h2><p>I then just have one main module where I create a main state machine object, and then just start that object once I have that. For now with this prototype I just have this working as an Electronjs application. However when I do start to work on the final project of this I am going to want to at least have a Browser version of the game as well. This is why I pass a PLATFROM option when calling the main state machine create method. For electronjs this is the API that I define in my preload.js file, but with a Browser version I am going to what to have another platform that will be a pure web only version of that API. </p>
<p>I can also if need be make more that one preload.js file if need be for certain Operating systems that might prove to be problematic allowing me to make one that will work well with that platform without breaking something that works fine for others.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> &#123; StateMachine &#125;  <span class="keyword">from</span> <span class="string">"./js/mrsun-statemachine/sm.mjs"</span></div><div class="line"><span class="comment">// create sm object that will use PLATFORM_ELECTRON</span></div><div class="line"><span class="keyword">const</span> sm = <span class="built_in">window</span>.sm = StateMachine.create(&#123;</div><div class="line">    <span class="attr">el</span>: <span class="built_in">document</span>.getElementById(<span class="string">'wrap_main'</span>),</div><div class="line">    <span class="attr">PLATFORM</span>: PLATFORM_ELECTRON</div><div class="line">&#125;);</div><div class="line"><span class="comment">// start it up</span></div><div class="line">StateMachine.start(sm);</div></pre></td></tr></table></figure>
<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>So that is the general overview for this electronjs project example of an idle game. I really put a whole lot of time into this one so it is safe to say that I will be treating this example the same way as I have with my <a href="/2022/03/10/electronjs-example-videoground">video creation tool project example</a>. Simply put this means that it is going to get its own repo and I am going to containing working on it a little more now and then which is not always the case with some of these electronjs example projects that I have made thus far. Many of them are just prototypes, but some of them I continue working on if they are software tools that I use everyday, or enough people start to show interest. This game might prove to be one of those projects as I find myself getting addicted to my own game Tony Montana style.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://dustinpfister.github.io/2023/04/28/electronjs-example-game-mrsun/" data-id="cliqa0bop038ibwv1pi0o6lo8" class="article-share-link">Share</a>
      
        <a href="https://dustinpfister.github.io/2023/04/28/electronjs-example-game-mrsun/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/electronjs/">electronjs</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2023/05/05/threejs-examples-timeline/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          Timeline module threejs example
        
      </div>
    </a>
  
  
    <a href="/2023/04/14/threejs-quaternion-slerp/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Quaternion slerp method</div>
    </a>
  
</nav>

  
</article>



<section id="comments">

<div id="disqus_thread"></div>
<script>

var disqus_config = function () {
    this.page.url = 'https://dustinpfister.github.io/2023/04/28/electronjs-example-game-mrsun/index.html';
    this.page.identifier = '1037';
    this.page.title = 'Idle Game Electronjs project example - MrSun Idle prototype';
};

(function() {
var d = document, s = d.createElement('script');
s.src = 'https://dustinpfister-github-io.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</section>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/angular/">angular</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/api/">api</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/backbone/">backbone</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/blog/">blog</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/canvas/">canvas</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/discovery/">discovery</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/electronjs/">electronjs</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/express/">express</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/games/">games</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/git/">git</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/grunt/">grunt</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/hapi/">hapi</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/heroku/">heroku</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/hexo/">hexo</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/jquery/">jquery</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/js/">js</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/linux/">linux</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/lodash/">lodash</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/mongodb/">mongodb</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/node-js/">node.js</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/phaser/">phaser</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/python/">python</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/statistics/">statistics</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/three-js/">three.js</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/vuejs/">vuejs</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/JSON/">JSON</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SEO/">SEO</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/angular/">angular</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/animation/">animation</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/automation/">automation</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/backbone/">backbone</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/blog/">blog</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/canvas/">canvas</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/corejs/">corejs</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/deterministic/">deterministic</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/discovery/">discovery</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ejs/">ejs</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/electronjs/">electronjs</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/express/">express</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/games/">games</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/git/">git</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/grunt/">grunt</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hapi/">hapi</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/heroku/">heroku</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hexo/">hexo</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/jimp/">jimp</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/jquery/">jquery</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/js/">js</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/js13k/">js13k</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux/">linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/lodash/">lodash</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/math/">math</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mongodb/">mongodb</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/node-js/">node.js</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/phaser/">phaser</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/python/">python</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/statistics/">statistics</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/structured-data/">structured-data</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/themes/">themes</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/three-js/">three.js</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vuejs/">vuejs</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/JSON/" style="font-size: 12.27px;">JSON</a> <a href="/tags/SEO/" style="font-size: 10.45px;">SEO</a> <a href="/tags/angular/" style="font-size: 13.18px;">angular</a> <a href="/tags/animation/" style="font-size: 11.82px;">animation</a> <a href="/tags/automation/" style="font-size: 11.82px;">automation</a> <a href="/tags/backbone/" style="font-size: 12.27px;">backbone</a> <a href="/tags/blog/" style="font-size: 15.45px;">blog</a> <a href="/tags/canvas/" style="font-size: 18.64px;">canvas</a> <a href="/tags/corejs/" style="font-size: 12.73px;">corejs</a> <a href="/tags/deterministic/" style="font-size: 10px;">deterministic</a> <a href="/tags/discovery/" style="font-size: 10.91px;">discovery</a> <a href="/tags/ejs/" style="font-size: 11.36px;">ejs</a> <a href="/tags/electronjs/" style="font-size: 13.64px;">electronjs</a> <a href="/tags/express/" style="font-size: 16.82px;">express</a> <a href="/tags/games/" style="font-size: 17.27px;">games</a> <a href="/tags/git/" style="font-size: 13.64px;">git</a> <a href="/tags/grunt/" style="font-size: 10px;">grunt</a> <a href="/tags/hapi/" style="font-size: 15px;">hapi</a> <a href="/tags/heroku/" style="font-size: 11.82px;">heroku</a> <a href="/tags/hexo/" style="font-size: 14.55px;">hexo</a> <a href="/tags/jimp/" style="font-size: 10.45px;">jimp</a> <a href="/tags/jquery/" style="font-size: 11.36px;">jquery</a> <a href="/tags/js/" style="font-size: 20px;">js</a> <a href="/tags/js13k/" style="font-size: 10px;">js13k</a> <a href="/tags/linux/" style="font-size: 17.73px;">linux</a> <a href="/tags/lodash/" style="font-size: 18.64px;">lodash</a> <a href="/tags/math/" style="font-size: 10px;">math</a> <a href="/tags/mongodb/" style="font-size: 14.55px;">mongodb</a> <a href="/tags/node-js/" style="font-size: 19.55px;">node.js</a> <a href="/tags/phaser/" style="font-size: 18.18px;">phaser</a> <a href="/tags/python/" style="font-size: 15.91px;">python</a> <a href="/tags/statistics/" style="font-size: 14.09px;">statistics</a> <a href="/tags/structured-data/" style="font-size: 10px;">structured-data</a> <a href="/tags/themes/" style="font-size: 10px;">themes</a> <a href="/tags/three-js/" style="font-size: 19.09px;">three.js</a> <a href="/tags/vuejs/" style="font-size: 16.36px;">vuejs</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/07/">July 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/06/">June 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/05/">May 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/04/">April 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/03/">March 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/02/">February 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/01/">January 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/12/">December 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/11/">November 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/10/">October 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/09/">September 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/08/">August 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/07/">July 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/06/">June 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/05/">May 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/04/">April 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/03/">March 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/02/">February 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/01/">January 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/12/">December 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/11/">November 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/10/">October 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/09/">September 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/08/">August 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/07/">July 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/06/">June 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/05/">May 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/04/">April 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/03/">March 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/02/">February 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/01/">January 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/12/">December 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/11/">November 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/10/">October 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/09/">September 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/08/">August 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/07/">July 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/06/">June 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/05/">May 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/04/">April 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">March 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/02/">February 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/01/">January 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">December 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">November 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">October 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">September 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">August 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">July 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/06/">June 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">May 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/04/">April 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">March 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/02/">February 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">January 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">December 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">November 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/10/">October 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/09/">September 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">August 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">July 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">June 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">May 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">April 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">March 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/02/">February 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/">January 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/">December 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/11/">November 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/10/">October 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">September 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">August 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/07/">July 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/06/">June 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/05/">May 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">April 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">March 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/02/">February 2017</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2023/07/23/threejs-lathe-geometry/">Lathe Geometry in threejs</a>
          </li>
        
          <li>
            <a href="/2023/06/09/threejs-vector2/">The Vector2 class for 2D curves, mouse pointers, ect</a>
          </li>
        
          <li>
            <a href="/2023/06/08/linux-dd/">Linux dd command and files</a>
          </li>
        
          <li>
            <a href="/2023/06/06/linux-sysbench/">Linux sysbench command for benchmarking a file system</a>
          </li>
        
          <li>
            <a href="/2023/06/02/threejs-tube-geometry/">Tube Geometry in threejs</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2023 Dustin Pfister<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a><br>
      <br>
      <a href="/privacy.html" target="_blank">Privacy Policy</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
    <a href="/2021/02/19/threejs-examples/" class="mobile-nav-link">ThreeJS</a>
  
    <a href="/2020/03/23/canvas-example/" class="mobile-nav-link">Canvas</a>
  
    <a href="https://www.youtube.com/user/javaweaver" class="mobile-nav-link">Youtube</a>
  
    <a href="https://github.com/dustinpfister" class="mobile-nav-link">Github</a>
  
    <a href="/about" class="mobile-nav-link">About</a>
  
</nav>
    
<script>
  var disqus_shortname = 'dustinpfister-github-io';
  
  var disqus_url = 'https://dustinpfister.github.io/2023/04/28/electronjs-example-game-mrsun/';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>


  </div>
</body>
</html>
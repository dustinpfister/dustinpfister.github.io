<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  
  <title>Canvas example of a cross hairs game | Dustin John Pfister at github pages</title>
  
  <!-- no index tag or blank here -->
  
  
  <link rel="canonical" href="https://dustinpfister.github.io/2020/07/29/canvas-example-game-crosshairs/" />

  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="For this weeks canvas example post I made a quick little cross hairs type game idea that just popped into my head one day. This is a game where I just use the mouse or touch events to move a cross hai">
<meta property="og:type" content="article">
<meta property="og:title" content="Canvas example of a cross hairs game">
<meta property="og:url" content="https://dustinpfister.github.io/2020/07/29/canvas-example-game-crosshairs/index.html">
<meta property="og:site_name" content="Dustin John Pfister at github pages">
<meta property="og:description" content="For this weeks canvas example post I made a quick little cross hairs type game idea that just popped into my head one day. This is a game where I just use the mouse or touch events to move a cross hai">
<meta property="og:updated_time" content="2020-10-12T13:45:47.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Canvas example of a cross hairs game">
<meta name="twitter:description" content="For this weeks canvas example post I made a quick little cross hairs type game idea that just popped into my head one day. This is a game where I just use the mouse or touch events to move a cross hai">
  
    <link rel="alternate" href="/atom.xml" title="Dustin John Pfister at github pages" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.ico">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  
<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-83195184-1', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->


  <!-- structured data set in structured-data.ejs -->
<script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "Person",
    "email": "distin.pfister@gmail.com",
    "givenName": "Dustin",
    "familyName" : "Pfister",
    "additionalName": "John",
    "name": "Dustin John Pfister",
    "gender": "Male"
}
</script>
<!-- end structured data -->
  
  <!-- adsense if indexed -->
  
  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
  (adsbygoogle = window.adsbygoogle || []).push({
    google_ad_client: "ca-pub-1658284027672315",
    enable_page_level_ads: true
  });
  </script>
  
  
</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <!-- added the image-->
        <div class="selfimage"></div>
        <!--<a href="/" id="logo">Dustin John Pfister at github pages</a>-->
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
          <a class="main-nav-link" href="/2020/03/23/canvas-example/">Canvas-Examples</a>
        
          <a class="main-nav-link" href="https://github.com/dustinpfister">Github</a>
        
          <a class="main-nav-link" href="/about">About</a>
        
      </nav>
      <nav id="sub-nav">
        <!-- removed rss link-->
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://dustinpfister.github.io"></form>
      </div>
    </div>
  </div>
</header>

<!-- adding my canvas thing ( Dustin ) -->
<script src="/js/the_matrix.js"></script>
      <div class="outer">
        <section id="main"><article itemscope itemtype="http://schema.org/Blog" id="post-canvas-example-game-crosshairs" class="article article-type-post" itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/07/29/canvas-example-game-crosshairs/" class="article-date"> Published:
  <time datetime="2020-07-29T19:44:00.000Z" itemprop="datePublished">2020-07-29</time>
</a>

    <!-- other info (dustin) -->
    <a href="/2020/07/29/canvas-example-game-crosshairs/" class="article-date"> Modified:
  <time datetime="2020-10-12T13:45:47.000Z" itemprop="dateModified">2020-10-12</time>
</a>

    <span class="article-date">V1.34</span>

    
  <div class="article-category">
    <a class="article-category-link" href="/categories/canvas/">canvas</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Canvas example of a cross hairs game
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="text">
      
        <p>For this weeks <a href="/2020/03/23/canvas-example/">canvas example</a> post I made a quick little cross hairs type game idea that just popped into my head one day. This is a game where I just use the mouse or touch events to move a cross hairs or <a href="https://en.wikipedia.org/wiki/Reticle" target="_blank" rel="external">Reticle</a> if you prefer around the canvas, and depending on where the cross hairs is located will result in panning movement around a map, or firing of the current weapon at some map cells. That is the basic idea at least, but I have added much more to it then just that at this point when it comes to choosing this example as something to continue working on at least a little each day, or at least fairly often.</p>
<p>At the time that I started this not much thought went into the other aspects of this that can help turn the game into something that is a little fun, interesting, or just simply addictive. I think that it might be fun to have a game where you just go around and shoot at stuff below me, and just rack up a whole lot of damage on what there is below in a top down perspective. So far that is more or less what this is, but it could still use a little something more that I have not yet hammered down thus far I think. Maybe put some things in the map that fire back for one thing, so that it is a kind of game where it is possible to, you know, loose. </p>
<p>However another thought was to make this just some kind of idle game where there are no such enemies that fight back, I am just blowing stuff up, and it keeps growing back. I all ready have some code worked out that automates the process of playing that I have enabled by default that will kick in after a moment of inactivity, but at any time the player can just take over and start playing. This is a kind of feature that I find myself enjoying when it comes to where I am at when it comes to playing video games, I can not say that I am that interested in playing them any more, but I sure have not lost interest in making them. The act of making the game has become the game sort of speak. So I seem to like games that involve things like away production, and games that to one extent or another play themselves.</p>
<p>So in this post I will be wring about all of the source code for the game thus far, so this will likely be a pretty lengthy post as it is over 1500 lines of code thus far. There are all ready a few modules, and I keep expanding them, and writing more modules as I keep adding features.</p>
<a id="more"></a>
<p><div id="canvas-app" style="width:320px;height:240px;margin-left:auto;margin-right:auto;"></div></p>
<script>var utils={};utils.distance=function(x1,y1,x2,y2){return Math.sqrt(Math.pow(x1-x2,2)+Math.pow(y1-y2,2));};utils.getCanvasRelative=function(e){var canvas=e.target,bx=canvas.getBoundingClientRect();return{x:(e.changedTouches?e.changedTouches[0].clientX:e.clientX)-bx.left,y:(e.changedTouches?e.changedTouches[0].clientY:e.clientY)-bx.top,bx:bx};};utils.logPer=function(per,high){high=high===undefined?2:high;per=per<0?0:per;per=per>1?1:per;return Math.log((1+high-2)+per)/Math.log(high);};var XP=(function(){var DEFAULTS={level:1,xp:0,cap:30,deltaNext:50};var set=function(xp,deltaNext){return(1+Math.sqrt(1+8*xp/deltaNext))/2;};var getXPtoLevel=function(level,deltaNext){return((Math.pow(level,2)-level)*deltaNext)/2;};var parseByXP=function(xp,cap,deltaNext){xp=xp===undefined?DEFAULTS.xp:xp;cap=cap===undefined?DEFAULTS.cap:cap;deltaNext=deltaNext===undefined?DEFAULTS.deltaNext:deltaNext;var l=set(xp,deltaNext);l=l>cap?cap:l;var level=Math.floor(l),forNext=getXPtoLevel(level+1,deltaNext);forNext=l===cap?Infinity:forNext;var toNext=l===cap?Infinity:forNext-xp;var forLast=getXPtoLevel(level,deltaNext);return{level:level,levelFrac:l,xp:xp,per:(xp-forLast)/(forNext-forLast),forNext:forNext,toNext:toNext,forLast:forLast};};return{parseByLevel:function(l,cap,deltaNext){l=l===undefined?DEFAULTS.level:l;deltaNext=deltaNext===undefined?DEFAULTS.deltaNext:deltaNext;var xp=getXPtoLevel(l,deltaNext);console.log(xp);return parseByXP(xp,cap,deltaNext);},parseByXP:parseByXP};} ());var crossMod=(function(){var isInInner=function(cross){var ch=cross.crosshairs,center=cross.center;return utils.distance(ch.x,ch.y,center.x,center.y)<cross.radiusInner;};var isInOuter=function(cross){var ch=cross.crosshairs,center=cross.center;return utils.distance(ch.x,ch.y,center.x,center.y)>=cross.radiusInner;};var isOutOfBounds=function(cross){var ch=cross.crosshairs,center=cross.center;return utils.distance(ch.x,ch.y,center.x,center.y)>=cross.radiusOuter;};var moveOffset=function(cross,secs){var ch=cross.crosshairs,center=cross.center,per={min:0.1,max:1,current:0.1},d=utils.distance(ch.x,ch.y,center.x,center.y)-cross.radiusInner;per.current=per.min+(per.max-per.min)*(d/cross.radiusDiff);cross.offset.x+=Math.cos(ch.heading)*cross.offset.pps*per.current*secs;cross.offset.y+=Math.sin(ch.heading)*cross.offset.pps*per.current*secs;};return{isInInner:isInInner,isInOuter:isInOuter,create:function(opt){opt=opt||{};var cross={userDown:false,moveBackEnabled:false,pps:opt.pps||128,radiusInner:opt.radiusInner||(240/4),radiusOuter:opt.radiusOuter||(240/2.125),radiusDiff:0,center:{x:opt.cx||(320/2),y:opt.cy||(240/2)},crosshairs:{x:320/2,y:240/2,heading:0,radius:16},offset:{x:opt.offsetX||0,y:opt.offsetY||0,pps:256}};cross.radiusDiff=cross.radiusOuter-cross.radiusInner;return cross;},update:function(cross,secs){secs=secs||0;var ch=cross.crosshairs,center=cross.center;ch.heading=Math.atan2(center.y-ch.y,center.x-ch.x);if(isOutOfBounds(cross)){ch.x=center.x;ch.y=center.y;cross.userDown=false;} if(isInOuter(cross)){if(!cross.userDown&&cross.moveBackEnabled){ch.x+=Math.cos(ch.heading)*cross.pps*secs;ch.y+=Math.sin(ch.heading)*cross.pps*secs;} moveOffset(cross,secs);}},userAction:function(cross,eventType,e){var pos=utils.getCanvasRelative(e),ch=cross.crosshairs;if(eventType==='start'){cross.userDown=true;ch.x=pos.x;ch.y=pos.y;} if(eventType==='end'){cross.userDown=false;} if(eventType==='move'){if(cross.userDown){ch.x=pos.x;ch.y=pos.y;}}}}} ());var mapMod=(function(){var cellTypes=[{i:0,type:'grass',HP:{min:5,max:10,base:1.05},autoHeal:{rate:0.5,amount:1}},{i:1,type:'tree',HP:{min:20,max:30,base:1.08},autoHeal:{rate:1,amount:5}},{i:2,type:'rock',HP:{min:35,max:50,base:1.15},autoHeal:{rate:3,amount:50}},];var setCellType=function(cell,typeIndex,opt){var level=cell.levelObj.level,min,max;opt=opt||{};cell.type=cellTypes[typeIndex];cell.typeIndex=typeIndex;cell.active=opt.active===undefined?true:opt.active;min=Math.pow(level,cell.type.HP.base)*cell.type.HP.min;max=Math.pow(level,cell.type.HP.base)*cell.type.HP.max;cell.maxHP=min+Math.round((max-min)*Math.random());cell.HP=opt.HP===undefined?cell.maxHP:opt.HP;cell.autoHeal.rate=cell.type.autoHeal.rate;cell.autoHeal.amount=cell.type.autoHeal.amount;};var getHighestDamageCell=function(map){return Math.max.apply(null,map.cells.map(function(cell){return cell.damage;}));};var get=function(map,x,y){if(x<0||y<0){return undefined;} if(x>=map.cellWidth||y>=map.cellHeight){return undefined;} return map.cells[y*map.cellWidth+x];};var autoHeal=function(cell,secs){cell.autoHeal.secs+=secs;if(cell.autoHeal.secs>=cell.autoHeal.rate){cell.autoHeal.secs%=cell.autoHeal.rate;cell.HP+=cell.autoHeal.amount;cell.HP=cell.HP>cell.maxHP?cell.maxHP:cell.HP;}};var getBorderCells=function(map,cell){var i=8,borderCell,cells=[],r,x,y;if(!cell){return[];} while(i--){r=Math.PI*2/8*i;x=Math.round(cell.x+Math.cos(r));y=Math.round(cell.y+Math.sin(r));borderCell=get(map,x,y);if(borderCell){cells.push(borderCell);}} return cells;};var getBorderCellsActiveCount=function(map,cell,active){active===undefined?true:active;var borderCells=getBorderCells(map,cell);return borderCells.reduce(function(acc,cell){acc=typeof acc==='object'?Number(acc.active===active):acc;return acc+=Number(cell.active==active);});};var getAllCellActiveState=function(map,active,condition){active=active===undefined?true:active;condition=condition===undefined?function(cell){return true;}:condition;return map.cells.filter(function(cell){if(cell.active===active&&condition(map,cell)){return true;} return false;});};var condition_gen_cell=function(map,cell){var borderCells=getBorderCells(map,cell);return getBorderCellsActiveCount(map,cell,true)>=1;};var getGenCells=function(map){return getAllCellActiveState(map,false,condition_gen_cell);};var popRandomCell=function(cells){var i=Math.floor(Math.random()*cells.length);return cells.splice(i,1)[0];};var gen=function(map,secs){var cells,cell,i;map.gen.secs+=secs;if(map.gen.secs>=map.gen.rate){map.gen.secs%=map.gen.rate;cells=getGenCells(map);i=map.gen.count;if(cells.length-i<0){i=cells.length;} if(i>0){while(i--){cell=popRandomCell(cells);setCellType(cell,Math.round(cell.damagePer*(cellTypes.length-1)));}}else{cells=getAllCellActiveState(map,true);if(cells.length===0){cell=map.cells[map.gen.startCells[Math.floor(Math.random()*map.gen.startCells.length)]];setCellType(cell,0);}}}};return{getAllCellActiveState:getAllCellActiveState,create:function(){var map={cellSize:32,cellWidth:8,cellHeight:8,cells:[],cellLevel:{cap:5,deltaNext:200},percentRemain:1,gen:{rate:1,secs:0,count:2,startCells:[27,28,35,36,0,63,56,7]},highDamageCell:0};var i=0,cell,x,y,len=map.cellWidth*map.cellHeight;while(i<len){cell={i:i,x:i%map.cellWidth,y:Math.floor(i/map.cellWidth),HP:50,maxHP:100,active:true,typeIndex:0,typeName:cellTypes[0].name,type:cellTypes[0],autoHeal:{rate:1,amount:5,secs:0},damage:0,damagePer:0,levelObj:XP.parseByXP(0,map.cellLevel.cap,map.cellLevel.deltaNext)};setCellType(cell,0);map.cells.push(cell);i+=1;} return map;},clampOffset:function(map,offset){offset.x=offset.x>0?0:offset.x;offset.y=offset.y>0?0:offset.y;offset.x=offset.x<map.cellWidth*map.cellSize* -1?map.cellWidth*map.cellSize* -1:offset.x;offset.y=offset.y<map.cellHeight*map.cellSize* -1?map.cellHeight*map.cellSize* -1:offset.y;},getAllFromPointAndRadius:function(map,x,y,r){var i=map.cells.length,d,cell,cells=[],dists=[];while(i--){cell=map.cells[i];d=utils.distance(cell.x,cell.y,x,y);if(d<=r){cells.push(cell);dists.push(d);}} return{cells:cells,dists:dists};},getWithCanvasPointAndOffset:function(map,canvasX,canvasY,offsetX,offsetY){var x=canvasX-160+Math.abs(offsetX),y=canvasY-120+Math.abs(offsetY);return get(map,Math.floor(x/map.cellSize),Math.floor(y/map.cellSize));},update:function(map,secs){var i,cell;map.highDamageCell=getHighestDamageCell(map);map.percentRemain=0;i=map.cells.length;while(i--){cell=map.cells[i];if(cell.HP<=0){cell.active=false;} if(cell.active){autoHeal(cell,secs);map.percentRemain+=cell.HP/cell.maxHP;} if(cell.damage!=0){cell.damagePer=cell.damage/map.highDamageCell;} cell.levelObj=XP.parseByXP(cell.damage,map.cellLevel.cap,map.cellLevel.deltaNext);} map.percentRemain/=map.cells.length;gen(map,secs);}}} ());var poolMod=(function(){return{create:function(opt){opt=opt||{};opt.count=opt.count||10;var i=0,pool=[];while(i<opt.count){pool.push({active:false,x:0,y:0,radius:8,heading:0,pps:32,lifespan:opt.lifespan||3,data:{},spawn:opt.spawn||function(obj,state){obj.active=true;},purge:opt.purge||function(obj,state){},update:opt.update||function(obj,state,secs){obj.x+=obj.pps*secs;obj.lifespan-=secs;}});i+=1;} return pool;},spawn:function(pool,game,opt){var i=pool.length,obj;while(i--){obj=pool[i];if(!obj.active){obj.active=true;obj.spawn.call(obj,obj,game,opt);break;}}},update:function(pool,state,secs){var i=pool.length,obj;while(i--){obj=pool[i];if(obj.active){obj.update(obj,state,secs);obj.lifespan=obj.lifespan<0?0:obj.lifespan;if(obj.lifespan===0){obj.active=false;obj.purge.call(obj,obj,state);}}}}}} ());var gameMod=(function(){var hardSet={maxSecs:0.25,deltaNext:10000,levelCap:100};var Weapons=[{name:'Blaster',pps:256,shotRate:0.125,blastRadius:1,maxDPS:10,accuracy:0.75,hitRadius:64,gunCount:1,level:{maxDPS_base:10,maxDPS_perLevel:5}},{name:'Assault Blaster',pps:512,shotRate:0.125,blastRadius:2,maxDPS:5,accuracy:0.5,hitRadius:64,gunCount:4,level:{maxDPS_base:5,maxDPS_perLevel:6}},{name:'Cannon',pps:256,shotRate:0.5,blastRadius:3,maxDPS:20,accuracy:0.25,hitRadius:32,gunCount:2,level:{maxDPS_base:15,maxDPS_perLevel:10}},{name:'Atom',pps:256,shotRate:1,blastRadius:10,maxDPS:75,accuracy:0.9,hitRadius:64,gunCount:1,level:{maxDPS_base:75,maxDPS_perLevel:50}}];var setWeaponsToLevel=function(game){var level=game.levelObj.level;Weapons.forEach(function(weapon){var lv=weapon.level;weapon.maxDPS=lv.maxDPS_base+lv.maxDPS_perLevel*level;weapon.accuracy=0.95-0.9*(1-level/hardSet.levelCap);});};var shotOptions={count:20,spawn:function(shot,game,radian){var offset=game.cross.offset,w=Weapons[game.weaponIndex],ch=game.cross.crosshairs,r=Math.random()*(Math.PI*2),d=w.hitRadius*(1-w.accuracy)*Math.random(),x=ch.x+Math.cos(r)*d,y=ch.y+Math.sin(r)*d,d;shot.x=x+Math.cos(radian)*game.canvas.width;shot.y=y+Math.sin(radian)*game.canvas.width;shot.heading=Math.atan2(y-shot.y,x-shot.x);d=utils.distance(shot.x,shot.y,x,y);shot.pps=w.pps;shot.lifespan=d/shot.pps;shot.offset=offset;},purge:function(shot,game){poolMod.spawn(game.explosions,game,shot);},update:function(shot,game,secs){shot.x+=Math.cos(shot.heading)*shot.pps*secs;shot.y+=Math.sin(shot.heading)*shot.pps*secs;shot.lifespan-=secs;}};var explosionOptions={count:20,spawn:function(ex,game,shot){var w=Weapons[game.weaponIndex];ex.x=shot.x;ex.y=shot.y;ex.data.offset={x:shot.offset.x,y:shot.offset.y};ex.data.radiusEnd=game.map.cellSize*w.blastRadius;ex.data.explosionTime=0.6;ex.data.maxDPS=w.maxDPS;;ex.lifespan=ex.data.explosionTime;ex.per=0;},purge:function(ex,game){},update:function(ex,game,secs){ex.per=(ex.data.explosionTime-ex.lifespan)/ex.data.explosionTime;ex.radius=ex.data.radiusEnd*ex.per;var cell=mapMod.getWithCanvasPointAndOffset(game.map,ex.x,ex.y,ex.data.offset.x,ex.data.offset.y),blastRadius=Math.ceil((ex.radius+0.01)/game.map.cellSize);if(cell){var targets=mapMod.getAllFromPointAndRadius(game.map,cell.x,cell.y,blastRadius);targets.cells.forEach(function(cell,i){var damage=ex.data.maxDPS*(1-(targets.dists[i]/blastRadius))*secs;if(cell.active){game.totalDamage+=damage;cell.HP-=damage;cell.HP=cell.HP<0?0:cell.HP;} cell.damage+=damage;});} ex.lifespan-=secs;}};var shoot=function(game){var w=Weapons[game.weaponIndex];if(game.shotSecs>=game.shotRate){var i=0,radian;while(i<w.gunCount){radian=Math.PI*2/4*i+Math.PI/4;poolMod.spawn(game.shots,game,radian);i+=1;} game.shotSecs=0;}};var autoPlay={setRandomTarget:function(game){var ch=game.cross.crosshairs,os=game.cross.offset,ap=game.autoPlay,map=game.map,activeCells=mapMod.getAllCellActiveState(map,true),x=Math.floor(map.cellWidth*Math.random()),y=Math.floor(map.cellHeight*Math.random());if(activeCells.length>=1){var cell=activeCells[Math.floor(activeCells.length*Math.random())];x=cell.x;y=cell.y;} ap.target.x=(map.cellSize/2+(map.cellSize*x))* -1;ap.target.y=(map.cellSize/2+(map.cellSize*y))* -1;},setByPercentRemain:function(game){var map=game.map,ap=game.autoPlay;game.weaponIndex=0;if(ap.behavior==='cannon'){game.weaponIndex=2;ap.maxShootTime=3;} if(ap.behavior==='total-kill'){game.weaponIndex=Weapons.length-1;ap.stopAtPercentRemain=0;} if(ap.behavior==='weapon-switch'){game.weaponIndex=Math.floor((Weapons.length)*utils.logPer(map.percentRemain,2));} game.weaponIndex=game.weaponIndex>=Weapons.length?Weapons.length-1:game.weaponIndex;if(map.percentRemain<ap.stopAtPercentRemain){ap.mode='move';}},modes:{move:function(game,secs){var ch=game.cross.crosshairs,os=game.cross.offset,ap=game.autoPlay,map=game.map,a=Math.atan2(os.y-ap.target.y,os.x-ap.target.x),cross=game.cross,d=utils.distance(os.x,os.y,ap.target.x,ap.target.y),delta=game.cross.radiusOuter-1;maxDelta=cross.radiusInner+cross.radiusDiff-1,minDelta=cross.radiusInner+5,slowDownDist=map.cellSize*4,minDist=map.cellSize/2,per=0;if(d<slowDownDist){per=1-d/slowDownDist;} ap.target.d=d;delta=maxDelta-(maxDelta-minDelta)*per;if(d<minDist){os.x=ap.target.x;os.y=ap.target.y;ap.shootTime=ap.maxShootTime;autoPlay.setRandomTarget(game);ap.mode='shoot';}else{ch.x=game.cross.center.x+Math.cos(a)*delta;ch.y=game.cross.center.y+Math.sin(a)*delta;}},shoot:function(game,secs){var ch=game.cross.crosshairs,os=game.cross.offset,ap=game.autoPlay,map=game.map;ch.x=game.cross.center.x;ch.y=game.cross.center.y;shoot(game);ap.shootTime-=secs;if(ap.shootTime<=0){ap.mode='move';autoPlay.setRandomTarget(game);}}},update:function(game,secs){if(game.autoPlay.enabled){var ch=game.cross.crosshairs,os=game.cross.offset,ap=game.autoPlay,map=game.map;game.autoPlay.delay-=secs;if(game.userDown){game.autoPlay.delay=game.autoPlay.maxDelay;} game.autoPlay.delay=game.autoPlay.delay<0?0:game.autoPlay.delay;if(game.autoPlay.delay===0){game.cross.moveBackEnabled=false;autoPlay.setByPercentRemain(game);autoPlay.modes[ap.mode](game,secs);}}}};return{Weapons:Weapons,create:function(opt){opt=opt||{};var game={levelObj:{},canvas:opt.canvas,map:mapMod.create(),cross:{},shots:poolMod.create(shotOptions),explosions:poolMod.create(explosionOptions),shotRate:1,shotSecs:0,weaponIndex:3,totalDamage:0,userDown:false,autoPlay:{enabled:true,behavior:'cannon',stopAtPercentRemain:0,delay:5,maxDelay:5,mode:'move',shootTime:5,maxShootTime:5,target:{x:-16,y:-16,d:0}}};game.levelObj=XP.parseByXP(game.totalDamage,hardSet.levelCap,hardSet.deltaNext);autoPlay.setRandomTarget(game);game.cross=crossMod.create({offsetX:game.map.cellWidth*game.map.cellSize/2* -1,offsetY:game.map.cellHeight*game.map.cellSize/2* -1,});return game;},update:function(game,secs){secs=secs>hardSet.maxSecs?hardSet.maxSecs:secs;game.shotRate=Weapons[game.weaponIndex].shotRate;crossMod.update(game.cross,secs);mapMod.clampOffset(game.map,game.cross.offset);mapMod.update(game.map,secs);poolMod.update(game.shots,game,secs);poolMod.update(game.explosions,game,secs);game.shotSecs+=secs;game.shotSecs=game.shotSecs>=game.shotRate?game.shotRate:game.shotSecs;if(crossMod.isInInner(game.cross)&&game.cross.userDown){shoot(game);} autoPlay.update(game,secs);game.levelObj=XP.parseByXP(game.totalDamage,hardSet.levelCap,hardSet.deltaNext);setWeaponsToLevel(game);}}} ());var genSheets=(function(){var createSheet=function(cellSize,cw,ch){var sheet={},canvas=document.createElement('canvas'),ctx=canvas.getContext('2d');canvas.width=cellSize*cw;canvas.height=cellSize*ch;ctx.translate(0.5,0.5);sheet.canvas=canvas;sheet.ctx=ctx;sheet.cellWidth=cw;sheet.cellHeight=ch;sheet.cellSize=cellSize;return sheet;};var drawBasicBox=function(sheet,fill,stroke){var canvas=sheet.canvas,ctx=sheet.ctx;ctx.fillStyle=fill||'#008800';ctx.fillRect(-1,-1,canvas.width+1,canvas.height+1);ctx.strokeStyle=stroke||'lime';var i=0,s;while(i<sheet.cellWidth){ctx.save();ctx.translate(16+32*i,16);s=28-14*(i/sheet.cellWidth);ctx.beginPath();ctx.rect(-14,-14,s,s);ctx.stroke();ctx.restore();i+=1;}};var sheets=[];['#005500','#000088','#880000'].forEach(function(fill){var sheet=createSheet(32,10,1),canvas=sheet.canvas,ctx=sheet.ctx;drawBasicBox(sheet,fill,'#000000');sheets.push(sheet);});return{sheets:sheets};} ());var draw=(function(){var hpColors=['red','orange','lime'];var getHpColor=function(per){return hpColors[Math.floor((hpColors.length-0.01)*per)];};var drawBar=function(ctx,game,per,rStart,rLength,fill){var cross=game.cross,center=cross.center;ctx.lineWidth=3;ctx.strokeStyle='gray';ctx.beginPath();ctx.arc(center.x,center.y,cross.radiusInner+5,rStart,rStart+rLength);ctx.stroke();ctx.strokeStyle=fill||'lime';ctx.beginPath();ctx.arc(center.x,center.y,cross.radiusInner+5,rStart,rStart+rLength*per);ctx.stroke();};var drawCrossCircles=function(ctx,cross){ctx.strokeStyle='rgba(255,255,255,0.4)';ctx.fillStyle='rgba(255,0,0,0.4)';ctx.lineWidth=1;ctx.beginPath();ctx.arc(cross.center.x,cross.center.y,cross.radiusInner,0,Math.PI*2);ctx.stroke();ctx.fill();ctx.fillStyle='rgba(0,0,0,0.2)';ctx.beginPath();ctx.arc(cross.center.x,cross.center.y,cross.radiusOuter,0,Math.PI*2);ctx.stroke();ctx.fill();ctx.beginPath();ctx.arc(cross.crosshairs.x,cross.crosshairs.y,cross.crosshairs.radius,0,Math.PI*2);ctx.stroke();};var drawCrossHairs=function(ctx,cross){var ch=cross.crosshairs;ctx.strokeStyle='rgba(200,0,0,0.5)';ctx.lineWidth=2;ctx.beginPath();ctx.moveTo(ch.x,ch.y-ch.radius*1.5);ctx.lineTo(ch.x,ch.y+ch.radius*1.5);ctx.stroke();ctx.beginPath();ctx.moveTo(ch.x-ch.radius*1.5,ch.y);ctx.lineTo(ch.x+ch.radius*1.5,ch.y);ctx.stroke();};var drawPercentRemainBar=function(ctx,game){var cross=game.cross,center=cross.center,map=game.map;drawBar(ctx,game,map.percentRemain,Math.PI,Math.PI/2,getHpColor(map.percentRemain));};var drawAutoPlayDelayBar=function(ctx,game){var ap=game.autoPlay;drawBar(ctx,game,ap.delay/ap.maxDelay,0,Math.PI/4,'cyan');};var drawWeaponInfo=function(ctx,game){var center=game.cross.center;var w=gameMod.Weapons[game.weaponIndex];ctx.fillStyle='#ff6060';ctx.font='10px courier';ctx.textAlign='center';ctx.fillText('Weapon: '+w.name,center.x,center.y+75);ctx.fillText('maxDPS: '+w.maxDPS,center.x,center.y+85);};var drawCellHealthBar=function(ctx,map,cell,cross){var x=cell.x*map.cellSize+cross.offset.x+(320/2),y=cell.y*map.cellSize+cross.offset.y+(240/2);ctx.fillStyle=getHpColor(cell.HP/cell.maxHP);ctx.globalAlpha=0.5;ctx.fillRect(x,y,map.cellSize*(cell.HP/cell.maxHP),5);ctx.globalAlpha=1;};var setupDebug=function(ctx,game){ctx.fillStyle='rgba(0,0,0,0.4)';ctx.textBaseline='top';ctx.textAlign='left';ctx.fillRect(0,0,game.canvas.width,game.canvas.height);ctx.fillStyle='yellow';ctx.textBaseline='top';ctx.font='10px courier';};var cellLevel=function(ctx,cell,x,y){if(cell.active){ctx.fillStyle='rgba(255,255,255,0.5)';ctx.font='7px courier';ctx.fillText('L'+Math.floor(cell.levelObj.level),x+3,y+3);}};var debugModes={none:function(sm){},general:function(sm){var ctx=sm.ctx,canvas=sm.canvas,game=sm.game;setupDebug(ctx,sm.game);ctx.fillText('pos: '+game.cross.offset.x.toFixed(2)+','+game.cross.offset.y.toFixed(2),10,10);ctx.fillText('percent remain: '+Number(game.map.percentRemain*100).toFixed(2),10,20);ctx.fillText('weapon: '+gameMod.Weapons[game.weaponIndex].name,10,30);ctx.fillText('damage: '+Math.floor(game.totalDamage),10,40);ctx.fillText('high damage cell: '+Math.floor(game.map.highDamageCell),10,50);},weapon:function(sm){var ctx=sm.ctx;setupDebug(ctx,sm.game);var w=gameMod.Weapons[sm.game.weaponIndex];ctx.fillText('Current weapon: ',10,10);ctx.fillText('name: '+w.name,10,20);ctx.fillText('maxDPS: '+w.maxDPS,10,30);ctx.fillText('accuracy: '+w.accuracy.toFixed(2),10,40);},level:function(sm){var ctx=sm.ctx,lv=sm.game.levelObj;setupDebug(ctx,sm.game);ctx.fillText('Current level: '+lv.level,10,10);ctx.fillText('xp: '+lv.xp,10,20);ctx.fillText('forNext level: '+lv.forNext,10,30);ctx.fillText('toNext level: '+lv.toNext,10,40);ctx.fillText('per: '+lv.per.toFixed(2),10,50);ctx.fillText('forLast: '+lv.forLast,10,60);},map:function(sm){var ctx=sm.ctx,map=sm.game.map;setupDebug(ctx,sm.game);ctx.fillText('map.percentRemain: '+map.percentRemain,10,10);}};var cellTypeColors=['green','blue','red'],sheets=genSheets.sheets;return{back:function(ctx,canvas){ctx.fillStyle='black';ctx.fillRect(0,0,canvas.width,canvas.height);},cross:function(ctx,game){drawCrossCircles(ctx,game.cross);drawPercentRemainBar(ctx,game);drawAutoPlayDelayBar(ctx,game);drawBar(ctx,game,game.shotSecs/game.shotRate,Math.PI*0.33,Math.PI*0.33,'red');drawBar(ctx,game,game.levelObj.per,Math.PI*1.69,Math.PI*0.3,'blue');drawWeaponInfo(ctx,game);var cross=game.cross,map=game.map,ch=game.cross.crosshairs,cell=mapMod.getWithCanvasPointAndOffset(game.map,ch.x,ch.y,cross.offset.x,cross.offset.y),x=cross.center.x+cross.radiusOuter-45,y=cross.center.y;ctx.fillStyle='white';ctx.textBaseline='top';ctx.textAlign='left';ctx.font='8px arial';ctx.fillText('level: '+game.levelObj.level,x,y-40);ctx.fillText('xp: '+Math.floor(game.levelObj.xp),x,y-30);ctx.fillText('next: '+Math.floor(game.levelObj.toNext),x,y-20);if(cell){ctx.fillText('pos: '+cell.i+' ('+cell.x+','+cell.y+')',x,y);ctx.fillText('lv:'+cell.levelObj.level,x,y+10);ctx.fillText('hp:'+Math.floor(cell.HP)+'/'+Math.floor(cell.maxHP),x,y+20);ctx.fillText('dam: '+Math.floor(cell.damage)+' ('+Math.round(cell.damagePer*100)+'%)',x,y+30);ctx.strokeStyle='rgba(255,255,255,0.4)';ctx.lineWidth=3;ctx.strokeRect(cell.x*map.cellSize+cross.offset.x+(320/2),cell.y*map.cellSize+cross.offset.y+(240/2),map.cellSize,map.cellSize);} drawCrossHairs(ctx,game.cross);},map:function(ctx,map,cross){ctx.strokeStyle='grey';ctx.lineWidth=3;map.cells.forEach(function(cell){var x=cell.x*map.cellSize+cross.offset.x+(320/2),y=cell.y*map.cellSize+cross.offset.y+(240/2),per=cell.HP/cell.maxHP;if(cell.active){ctx.drawImage(sheets[cell.typeIndex].canvas,32*Math.floor(9-cell.HP/cell.maxHP*9),0,32,32,x,y,map.cellSize,map.cellSize);if(per<1){drawCellHealthBar(ctx,map,cell,cross);}}else{ctx.lineWidth=1;var c=50+Math.round(200*cell.damagePer);ctx.strokeStyle='rgba(0,128,128, 0.4)';ctx.fillStyle='rgba(0,'+c+','+c+', 0.7)';ctx.beginPath();ctx.rect(x,y,map.cellSize,map.cellSize);ctx.fill();ctx.stroke();} cellLevel(ctx,cell,x,y);});},shots:function(ctx,game){var shots=game.shots,i=shots.length,shot;while(i--){shot=shots[i];ctx.fillStyle='white';ctx.strokeStyle='black';if(shot.active){ctx.beginPath();ctx.arc(shot.x,shot.y,shot.radius,0,Math.PI*2);ctx.fill();ctx.stroke();}}},explosions:function(ctx,game){var exps=game.explosions,i=exps.length,alpha=0.5,ex;while(i--){ex=exps[i];alpha=1-ex.per;ctx.fillStyle='rgba(255,255,0,'+alpha+')';ctx.strokeStyle='rgba(0,0,0,'+alpha+')';if(ex.active){ctx.beginPath();ctx.arc(ex.x,ex.y,ex.radius,0,Math.PI*2);ctx.fill();ctx.stroke();}}},buttons:function(ctx,buttons){Object.keys(buttons).forEach(function(key){var b=buttons[key];ctx.fillStyle='red';if(b.type==='toggle'&&b.bool){ctx.fillStyle='lime';} ctx.strokeStyle='gray';ctx.lineWidth=1;ctx.beginPath();ctx.arc(b.x,b.y,b.r,0,Math.PI*2);ctx.fill();ctx.stroke();ctx.textBaseline='middle';ctx.textAlign='center';ctx.fillStyle='white';ctx.font=(b.fontSize||10)+'px arial';if(b.type==='options'){var str=b.options[b.currentOption||0];ctx.fillText(str,b.x,b.y);} if(b.type==='basic'){ctx.fillText(b.label,b.x,b.y);} if(b.type==='toggle'){ctx.fillText(b.label,b.x,b.y);}});},debug:function(sm){debugModes[sm.debugMode](sm,sm.ctx,sm.canvas);},ver:function(ctx,sm){ctx.fillStyle='#dfdfdf';ctx.textAlign='left';ctx.fillText('v'+sm.ver,10,sm.canvas.height-15);}}} ());var buttonMod=(function(){var setupType=function(button,opt){if(button.type==='options'){button.options=opt.options||[];button.currentOption=0;button.label=button.options[0];} if(button.type==='toggle'){button.bool=opt.bool||false;button.onActive=opt.onActive||function(){};button.onInactive=opt.onInactive||function(){};}};var beforeOnClick={basic:function(button,api){},options:function(button,api){button.currentOption+=1;button.currentOption=button.currentOption>=button.options.length?0:button.currentOption;},toggle:function(button,api){button.bool=!button.bool;}};var afterOnClick={basic:function(button,api){},options:function(button,api){},toggle:function(button,api){if(button.bool){button.onActive(button,api);}else{button.onInactive(button,api);}}};return{create:function(opt){opt=opt||{};var button={x:opt.x===undefined?0:opt.x,y:opt.y===undefined?0:opt.y,r:opt.r===undefined?16:opt.r,label:opt.label||'',type:opt.type||'basic',onClick:opt.onClick||function(){}};setupType(button,opt);return button;},pointerCheckCollection:function(collection,point,api){var keys=Object.keys(collection),i=keys.length,button,d;while(i--){button=collection[keys[i]];d=utils.distance(point.x,point.y,button.x,button.y);if(d<button.r){beforeOnClick[button.type](button,api);button.onClick(button,api);afterOnClick[button.type](button,api)}}}};} ());(function(){var canvas=document.createElement('canvas'),ctx=canvas.getContext('2d'),container=document.getElementById('canvas-app')||document.body;container.appendChild(canvas);canvas.width=320;canvas.height=240;ctx.translate(0.5,0.5);var states={options:{buttons:{toGame:buttonMod.create({label:'game',x:25,y:200,r:10,onClick:function(button,sm){sm.currentState='game';}}),debugMode:buttonMod.create({x:100,y:120,r:16,type:'options',options:['none','general','weapon','level','map'],onClick:function(button,sm){sm.debugMode=button.options[button.currentOption];}})},update:function(sm,secs){var state=states[sm.currentState];draw.back(ctx,canvas);draw.buttons(ctx,state.buttons);draw.debug(sm);},pointerStart:function(sm,e){var state=states[sm.currentState],buttons=state.buttons,pos=utils.getCanvasRelative(e);buttonMod.pointerCheckCollection(state.buttons,pos,sm);},pointerMove:function(){},pointerEnd:function(){}},game:{buttons:{options:buttonMod.create({label:'options',fontSize:10,x:25,y:200,r:10,onClick:function(button,sm){sm.currentState='options';}}),changeWeapon:buttonMod.create({label:'Next Weapon',fontSize:8,x:280,y:210,r:16,onClick:function(button,sm){sm.game.weaponIndex+=1;sm.game.weaponIndex%=gameMod.Weapons.length;}}),autoPlay:buttonMod.create({label:'Auto Play',type:'toggle',fontSize:8,x:25,y:175,r:10,bool:true,onClick:function(button,sm){var ap=sm.game.autoPlay;ap.delay=ap.maxDelay;},onActive:function(button,sm){sm.game.autoPlay.enabled=button.bool;},onInactive:function(button,sm){sm.game.autoPlay.enabled=button.bool;}})},update:function(sm,secs){var state=states[sm.currentState];gameMod.update(sm.game,secs);draw.back(ctx,canvas);draw.map(ctx,sm.game.map,sm.game.cross);draw.explosions(ctx,sm.game);draw.cross(ctx,sm.game);draw.shots(ctx,sm.game);draw.buttons(ctx,state.buttons);draw.ver(ctx,sm);draw.debug(sm);},pointerStart:function(sm,e){var state=states[sm.currentState],buttons=state.buttons,pos=utils.getCanvasRelative(e);sm.game.cross.moveBackEnabled=true;crossMod.userAction(sm.game.cross,'start',e);sm.game.userDown=true;buttonMod.pointerCheckCollection(state.buttons,pos,sm);},pointerEnd:function(em,e){crossMod.userAction(sm.game.cross,'end',e);sm.game.userDown=false;},pointerMove:function(sm,e){crossMod.userAction(sm.game.cross,'move',e);}}};var sm={ver:'0.13.0',canvas:canvas,debugMode:'none',currentState:'game',ctx:ctx,game:gameMod.create({canvas:canvas}),input:{pointerDown:false,pos:{x:0,y:0}}};var pointerHanders={start:function(sm,e){var pos=sm.input.pos;sm.input.pointerDown=true;states[sm.currentState].pointerStart(sm,e);},move:function(sm,e){states[sm.currentState].pointerMove(sm,e);},end:function(sm,e){sm.input.pointerDown=false;states[sm.currentState].pointerEnd(sm,e);}};var createPointerHandler=function(sm,type){return function(e){sm.input.pos=utils.getCanvasRelative(e);e.preventDefault();pointerHanders[type](sm,e);};};canvas.addEventListener('mousedown',createPointerHandler(sm,'start'));canvas.addEventListener('mousemove',createPointerHandler(sm,'move'));canvas.addEventListener('mouseup',createPointerHandler(sm,'end'));canvas.addEventListener('touchstart',createPointerHandler(sm,'start'));canvas.addEventListener('touchmove',createPointerHandler(sm,'move'));canvas.addEventListener('touchend',createPointerHandler(sm,'end'));var lt=new Date(),FPS_target=30;var loop=function(){var now=new Date(),t=now-lt,secs=t/1000;requestAnimationFrame(loop);if(t>=1000/FPS_target){states[sm.currentState].update(sm,secs);lt=now;}};loop();} ());</script>

<p>So if you are just interested in playing I will inject a package here that reflects the state of the canvas example at the time that I last updated this posts content. I would recommend against spending to much time playing it so far at this time as I have not implement any way to have a save state, but that is on the todo list of course. Auto Play is enabled by default so if you want to can just watch the game play itself for a bit.</p>
<p>To check out the latest state of the source code with this example there is of course the <a href="https://github.com/dustinpfister/canvas-examples/tree/master/forpost/canvas-example-game-crosshairs" target="_blank" rel="external">corresponding folder in my canvas examples repository at github</a> for cross hairs.</p>
<h2 id="1-The-utility-module"><a href="#1-The-utility-module" class="headerlink" title="1 - The utility module"></a>1 - The utility module</h2><p>For the canvas example just like with many of my other examples this one has a custom utility library. I end up using this kind of library as a dumping ground for methods that are being used, or might end up being used in two or more modules in the over all project. There always seems to be a need for this kind of utility library that can be described as a kind of application specific, custom tailored lodash of sorts. In other words it is a collection of utility methods that I am actually going to use in one or more of the modules that compose the over all project.</p>
<p>One such method that I have here is a distance formula method that will just give me the distance between two points. This is a usual suspect that I have in many of these utility modules, and is often used in a number of expressions where and when needed. I am using the method in my cross module that I will be getting to later in this post that has to do with the major part of the user interface.</p>
<p>Another method that I often end up parking here is the get canvas relative method that helps with getting a point that is relative to the canvas element rather than window. In this canvas example I am not doing anything with multi touch, so I went with a method that will just use the first touch object in the changed touches array of a touch event. I will not be getting into detail about this method here as I have <a href="/2020/03/04/canvas-get-point-relative-to-canvas/">wrote a post on this topic of getting a canvas relative point in detail before hand</a>.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// UTILS</span></div><div class="line"><span class="keyword">var</span> utils = &#123;&#125;;</div><div class="line"><span class="comment">// get distance between two points</span></div><div class="line">utils.distance = <span class="function"><span class="keyword">function</span> (<span class="params">x1, y1, x2, y2</span>) </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="built_in">Math</span>.sqrt(<span class="built_in">Math</span>.pow(x1 - x2, <span class="number">2</span>) + <span class="built_in">Math</span>.pow(y1 - y2, <span class="number">2</span>));</div><div class="line">&#125;;</div><div class="line"><span class="comment">// get a canvas relative point</span></div><div class="line">utils.getCanvasRelative = <span class="function"><span class="keyword">function</span> (<span class="params">e</span>) </span>&#123;</div><div class="line">    <span class="keyword">var</span> canvas = e.target,</div><div class="line">    bx = canvas.getBoundingClientRect();</div><div class="line">    <span class="keyword">return</span> &#123;</div><div class="line">        <span class="attr">x</span>: (e.changedTouches ? e.changedTouches[<span class="number">0</span>].clientX : e.clientX) - bx.left,</div><div class="line">        <span class="attr">y</span>: (e.changedTouches ? e.changedTouches[<span class="number">0</span>].clientY : e.clientY) - bx.top,</div><div class="line">        <span class="attr">bx</span>: bx</div><div class="line">    &#125;;</div><div class="line">&#125;;</div><div class="line"><span class="comment">// return a percent value from another percent value</span></div><div class="line">utils.logPer = <span class="function"><span class="keyword">function</span> (<span class="params">per, high</span>) </span>&#123;</div><div class="line">    high = high === <span class="literal">undefined</span> ? <span class="number">2</span> : high;</div><div class="line">    per = per &lt; <span class="number">0</span> ? <span class="number">0</span> : per;</div><div class="line">    per = per &gt; <span class="number">1</span> ? <span class="number">1</span> : per;</div><div class="line">    <span class="keyword">return</span> <span class="built_in">Math</span>.log((<span class="number">1</span> + high - <span class="number">2</span>) + per) / <span class="built_in">Math</span>.log(high);</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>The logPer method is something that I worked out when it comes to havening a way to turn a linear percentage value into a percentage value that does not go up in a linear kind of way. As of this writing I am just using this method in my game module when it comes to the AI selecting a weapon. In time I might use this method, or something like it when it comes to maybe the experience point system which is something that I am sure I will be getting around to improve at some point if I do keep working on this project.</p>
<p>So now that I have the basic utility library out of the way lets move on to the modules that built on top of this to make a game modules that is used to create and update the main state of the game.</p>
<h2 id="2-The-experience-point-system"><a href="#2-The-experience-point-system" class="headerlink" title="2 - The experience point system"></a>2 - The experience point system</h2><p>So for this canvas example I want to have an experience point system. I did not work out anything that original for this project at least not of this writing, in fact I just copied over what I <a href="/2020/04/27/js-javascript-example-exp-system/">workout out in another post that has to do with, you guessed it, experience point systems</a>.</p>
<p>The module provided two public methods, one that can be used to create a level object by giving and experience point value, and another that does the inversion of that by giving a level value.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> XP = (<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="keyword">var</span> DEFAULTS = &#123;</div><div class="line">        <span class="attr">level</span>: <span class="number">1</span>,</div><div class="line">        <span class="attr">xp</span>: <span class="number">0</span>,</div><div class="line">        <span class="attr">cap</span>: <span class="number">30</span>,</div><div class="line">        <span class="attr">deltaNext</span>: <span class="number">50</span></div><div class="line">    &#125;;</div><div class="line">    <span class="comment">// set level with given xp</span></div><div class="line">    <span class="keyword">var</span> set = <span class="function"><span class="keyword">function</span> (<span class="params">xp, deltaNext</span>) </span>&#123;</div><div class="line">        <span class="keyword">return</span> (<span class="number">1</span> + <span class="built_in">Math</span>.sqrt(<span class="number">1</span> + <span class="number">8</span> * xp / deltaNext)) / <span class="number">2</span>;</div><div class="line">    &#125;;</div><div class="line">    <span class="comment">// get exp to the given level with given current_level and xp</span></div><div class="line">    <span class="keyword">var</span> getXPtoLevel = <span class="function"><span class="keyword">function</span> (<span class="params">level, deltaNext</span>) </span>&#123;</div><div class="line">        <span class="keyword">return</span> ((<span class="built_in">Math</span>.pow(level, <span class="number">2</span>) - level) * deltaNext) / <span class="number">2</span>;</div><div class="line">    &#125;;</div><div class="line">    <span class="keyword">var</span> parseByXP = <span class="function"><span class="keyword">function</span> (<span class="params">xp, cap, deltaNext</span>) </span>&#123;</div><div class="line">        xp = xp === <span class="literal">undefined</span> ? DEFAULTS.xp : xp;</div><div class="line">        cap = cap === <span class="literal">undefined</span> ? DEFAULTS.cap : cap;</div><div class="line">        deltaNext = deltaNext === <span class="literal">undefined</span> ? DEFAULTS.deltaNext : deltaNext;</div><div class="line">        <span class="keyword">var</span> l = set(xp, deltaNext);</div><div class="line">        l = l &gt; cap ? cap : l;</div><div class="line">        <span class="keyword">var</span> level = <span class="built_in">Math</span>.floor(l),</div><div class="line">        forNext = getXPtoLevel(level + <span class="number">1</span>, deltaNext);</div><div class="line">        forNext = l === cap ? <span class="literal">Infinity</span> : forNext;</div><div class="line">        <span class="keyword">var</span> toNext = l === cap ? <span class="literal">Infinity</span> : forNext - xp;</div><div class="line">        <span class="keyword">var</span> forLast = getXPtoLevel(level, deltaNext);</div><div class="line">        <span class="keyword">return</span> &#123;</div><div class="line">            <span class="attr">level</span>: level,</div><div class="line">            <span class="attr">levelFrac</span>: l,</div><div class="line">            <span class="attr">xp</span>: xp,</div><div class="line">            <span class="attr">per</span>: (xp - forLast) / (forNext - forLast),</div><div class="line">            <span class="attr">forNext</span>: forNext,</div><div class="line">            <span class="attr">toNext</span>: toNext,</div><div class="line">            <span class="attr">forLast</span>: forLast</div><div class="line">        &#125;;</div><div class="line">    &#125;;</div><div class="line">    <span class="keyword">return</span> &#123;</div><div class="line">        <span class="attr">parseByLevel</span>: <span class="function"><span class="keyword">function</span> (<span class="params">l, cap, deltaNext</span>) </span>&#123;</div><div class="line">            l = l === <span class="literal">undefined</span> ? DEFAULTS.level : l;</div><div class="line">            deltaNext = deltaNext === <span class="literal">undefined</span> ? DEFAULTS.deltaNext : deltaNext;</div><div class="line">            <span class="keyword">var</span> xp = getXPtoLevel(l, deltaNext);</div><div class="line">            <span class="built_in">console</span>.log(xp);</div><div class="line">            <span class="keyword">return</span> parseByXP(xp, cap, deltaNext);</div><div class="line">        &#125;,</div><div class="line">        <span class="attr">parseByXP</span>: parseByXP</div><div class="line">    &#125;;</div><div class="line">&#125;</div><div class="line">    ());</div></pre></td></tr></table></figure>
<p>I might get around to changing things around with this kind of system at a later point as I keep working on this example, so I do not want to write about this to much here if I am just going to need to rewrite everything extensively later. However for now it is working okay as a place holder of sorts until I get around to investing more time into developing this experience point system, and many of the other components.</p>
<p>In any case this experience point system is used in both the main game.js module, as well as the map.js module, and it goes without saying that this system will probably be used in a few more modules here and there as I keep working on additional minor releases of this project.</p>
<h2 id="3-The-cross-js-file"><a href="#3-The-cross-js-file" class="headerlink" title="3 - The cross.js file"></a>3 - The cross.js file</h2><p>In this section I will be going over the module that will be used to create and update a state object for a cross hairs state object that is used as a major component for the user interface aside from the buttons module, and state machine that I will be getting to later in this post. This main cross hairs state object contains a bunch of additional objects and properties that help with many points of interest in the canvas matrix. One such point of interest is the center point of the cross hairs area, which is now and will likely continue to be the center of the canvas element. Another is the actual cross hairs cursor position in the canvas, and yet another is an offset point that can be used as a way to navigate a map. The state of these points of interest are stored in the object that this module creates, and the module is also used as a way to update the state of this object.</p>
<p>The idea of this module is when the cross hairs point object is within an inner radius, the  cross hairs object is just used as a way to set the position of where a weapon is going to fire at what might be around that area. While the outer radius is used as a zone to define angle and rate of movement in terms of pixels per second when it comes to updating that offset value that I mentioned that can then in turn be used as a way to update the position of a map when it comes to how this is used outside of this module. </p>
<p>So when the cross hairs object is in the zone between inner and outer radius value that will effect the offset point in the cross state object. When the cross hairs object is within the inner radius then the offset value is not effected, and a isInner public method can be used as a way to find out if this is the case or not, and in that case the state of the object can be used differently in the case of this project it is being used as a means to determine where to shoot, however that is a matter that I will be getting to in detail later in the post when I get to the game module.</p>
<p>So with that said the module contains a number of private helper methods, some of which I have made public. There are helper methods that will return true or false if the cross hairs object is in the fire area, or in the movement area. There is also a helper method that has to do with moving the offset object based on the current values of the cross hairs object and a given value that is the number of seconds sense the last frame tick update.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> crossMod = (<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line"> </div><div class="line">    <span class="keyword">var</span> isInInner = <span class="function"><span class="keyword">function</span> (<span class="params">cross</span>) </span>&#123;</div><div class="line">        <span class="keyword">var</span> ch = cross.crosshairs,</div><div class="line">        center = cross.center;</div><div class="line">        <span class="keyword">return</span> utils.distance(ch.x, ch.y, center.x, center.y) &lt; cross.radiusInner;</div><div class="line">    &#125;;</div><div class="line"> </div><div class="line">    <span class="keyword">var</span> isInOuter = <span class="function"><span class="keyword">function</span> (<span class="params">cross</span>) </span>&#123;</div><div class="line">        <span class="keyword">var</span> ch = cross.crosshairs,</div><div class="line">        center = cross.center;</div><div class="line">        <span class="keyword">return</span> utils.distance(ch.x, ch.y, center.x, center.y) &gt;= cross.radiusInner;</div><div class="line">    &#125;;</div><div class="line"> </div><div class="line">    <span class="keyword">var</span> isOutOfBounds = <span class="function"><span class="keyword">function</span> (<span class="params">cross</span>) </span>&#123;</div><div class="line">        <span class="keyword">var</span> ch = cross.crosshairs,</div><div class="line">        center = cross.center;</div><div class="line">        <span class="keyword">return</span> utils.distance(ch.x, ch.y, center.x, center.y) &gt;= cross.radiusOuter;</div><div class="line">    &#125;;</div><div class="line"> </div><div class="line">    <span class="keyword">var</span> moveOffset = <span class="function"><span class="keyword">function</span> (<span class="params">cross, secs</span>) </span>&#123;</div><div class="line">        <span class="keyword">var</span> ch = cross.crosshairs,</div><div class="line">        center = cross.center,</div><div class="line">        per = &#123;</div><div class="line">            <span class="attr">min</span>: <span class="number">0.1</span>,</div><div class="line">            <span class="attr">max</span>: <span class="number">1</span>,</div><div class="line">            <span class="attr">current</span>: <span class="number">0.1</span></div><div class="line">        &#125;,</div><div class="line">        d = utils.distance(ch.x, ch.y, center.x, center.y) - cross.radiusInner;</div><div class="line">        per.current = per.min + (per.max - per.min) * (d / cross.radiusDiff);</div><div class="line">        cross.offset.x += <span class="built_in">Math</span>.cos(ch.heading) * cross.offset.pps * per.current * secs;</div><div class="line">        cross.offset.y += <span class="built_in">Math</span>.sin(ch.heading) * cross.offset.pps * per.current * secs;</div><div class="line">    &#125;;</div><div class="line"> </div><div class="line">    <span class="keyword">return</span> &#123;</div><div class="line">        <span class="attr">isInInner</span>: isInInner,</div><div class="line">        <span class="attr">isInOuter</span>: isInOuter,</div><div class="line">        <span class="attr">create</span>: <span class="function"><span class="keyword">function</span> (<span class="params">opt</span>) </span>&#123;</div><div class="line">            opt = opt || &#123;&#125;;</div><div class="line">            <span class="keyword">var</span> cross = &#123;</div><div class="line">                <span class="attr">userDown</span>: <span class="literal">false</span>,</div><div class="line">                <span class="attr">moveBackEnabled</span>: <span class="literal">false</span>,</div><div class="line">                <span class="attr">pps</span>: opt.pps || <span class="number">128</span>,</div><div class="line">                <span class="attr">radiusInner</span>: opt.radiusInner || (<span class="number">240</span> / <span class="number">4</span>),</div><div class="line">                <span class="attr">radiusOuter</span>: opt.radiusOuter || (<span class="number">240</span> / <span class="number">2.125</span>),</div><div class="line">                <span class="attr">radiusDiff</span>: <span class="number">0</span>,</div><div class="line">                <span class="attr">center</span>: &#123;</div><div class="line">                    <span class="attr">x</span>: opt.cx || (<span class="number">320</span> / <span class="number">2</span>),</div><div class="line">                    <span class="attr">y</span>: opt.cy || (<span class="number">240</span> / <span class="number">2</span>)</div><div class="line">                &#125;,</div><div class="line">                <span class="attr">crosshairs</span>: &#123;</div><div class="line">                    <span class="attr">x</span>: <span class="number">320</span> / <span class="number">2</span>,</div><div class="line">                    <span class="attr">y</span>: <span class="number">240</span> / <span class="number">2</span>,</div><div class="line">                    <span class="attr">heading</span>: <span class="number">0</span>,</div><div class="line">                    <span class="attr">radius</span>: <span class="number">16</span></div><div class="line">                &#125;,</div><div class="line">                <span class="attr">offset</span>: &#123;</div><div class="line">                    <span class="attr">x</span>: opt.offsetX || <span class="number">0</span>,</div><div class="line">                    <span class="attr">y</span>: opt.offsetY || <span class="number">0</span>,</div><div class="line">                    <span class="attr">pps</span>: <span class="number">256</span></div><div class="line">                &#125;</div><div class="line">            &#125;;</div><div class="line">            cross.radiusDiff = cross.radiusOuter - cross.radiusInner;</div><div class="line">            <span class="keyword">return</span> cross;</div><div class="line">        &#125;,</div><div class="line"> </div><div class="line">        <span class="attr">update</span>: <span class="function"><span class="keyword">function</span> (<span class="params">cross, secs</span>) </span>&#123;</div><div class="line">            secs = secs || <span class="number">0</span>;</div><div class="line">            <span class="keyword">var</span> ch = cross.crosshairs,</div><div class="line">            center = cross.center;</div><div class="line">            ch.heading = <span class="built_in">Math</span>.atan2(center.y - ch.y, center.x - ch.x);</div><div class="line"> </div><div class="line">            <span class="comment">// set bounds</span></div><div class="line">            <span class="keyword">if</span> (isOutOfBounds(cross)) &#123;</div><div class="line">                ch.x = center.x;</div><div class="line">                ch.y = center.y;</div><div class="line">                cross.userDown = <span class="literal">false</span>;</div><div class="line">            &#125;</div><div class="line"> </div><div class="line">            <span class="keyword">if</span> (isInOuter(cross)) &#123;</div><div class="line">                <span class="comment">// move back to innerRdaius if in outer area and userDown is false</span></div><div class="line">                <span class="keyword">if</span> (!cross.userDown &amp;&amp; cross.moveBackEnabled) &#123;</div><div class="line">                    ch.x += <span class="built_in">Math</span>.cos(ch.heading) * cross.pps * secs;</div><div class="line">                    ch.y += <span class="built_in">Math</span>.sin(ch.heading) * cross.pps * secs;</div><div class="line">                &#125;</div><div class="line">                <span class="comment">// apply changes to offset</span></div><div class="line">                moveOffset(cross, secs);</div><div class="line">            &#125;</div><div class="line">        &#125;,</div><div class="line"> </div><div class="line">        <span class="attr">userAction</span>: <span class="function"><span class="keyword">function</span> (<span class="params">cross, eventType, e</span>) </span>&#123;</div><div class="line">            <span class="keyword">var</span> pos = utils.getCanvasRelative(e),</div><div class="line">            ch = cross.crosshairs;</div><div class="line">            <span class="comment">//e.preventDefault();</span></div><div class="line">            <span class="keyword">if</span> (eventType === <span class="string">'start'</span>) &#123;</div><div class="line">                cross.userDown = <span class="literal">true</span>;</div><div class="line">                ch.x = pos.x;</div><div class="line">                ch.y = pos.y;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (eventType === <span class="string">'end'</span>) &#123;</div><div class="line">                cross.userDown = <span class="literal">false</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (eventType === <span class="string">'move'</span>) &#123;</div><div class="line">                <span class="keyword">if</span> (cross.userDown) &#123;</div><div class="line">                    ch.x = pos.x;</div><div class="line">                    ch.y = pos.y;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"> </div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line">    ());</div></pre></td></tr></table></figure>
<p>I then have my public API of this module that contains methods for both creating and updating a cross state object. In addition I have my userAction method that is used as a way to control the mutation of the cross hairs position. As you can see this is where my get canvas relative method is coming into play for now. When I first started working on this project I did not have the main state machine that I have now, and I have not yet transitioned everything over to just working out things like that there yet.</p>
<h2 id="4-The-map-js-file"><a href="#4-The-map-js-file" class="headerlink" title="4 - The map.js file"></a>4 - The map.js file</h2><p>So now that I have my cross hairs module I am also going to want to have a map file that will be used to create a map of cell objects. I can then move around the map with the state of a cross object created with the cross hairs modules create method when working out the game module. I went with having the offset values in the cross object rather than the map object, so I will be using a public method in this map module to get at cells by passing a cross object along with the map and canvas relative position values.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div><div class="line">306</div><div class="line">307</div><div class="line">308</div><div class="line">309</div><div class="line">310</div><div class="line">311</div><div class="line">312</div><div class="line">313</div><div class="line">314</div><div class="line">315</div><div class="line">316</div><div class="line">317</div><div class="line">318</div><div class="line">319</div><div class="line">320</div><div class="line">321</div><div class="line">322</div><div class="line">323</div><div class="line">324</div><div class="line">325</div><div class="line">326</div><div class="line">327</div><div class="line">328</div><div class="line">329</div><div class="line">330</div><div class="line">331</div><div class="line">332</div><div class="line">333</div><div class="line">334</div><div class="line">335</div><div class="line">336</div><div class="line">337</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> mapMod = (<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line"> </div><div class="line">    <span class="keyword">var</span> cellTypes = [&#123;</div><div class="line">            <span class="attr">i</span>: <span class="number">0</span>,</div><div class="line">            <span class="attr">type</span>: <span class="string">'grass'</span>,</div><div class="line">            <span class="attr">HP</span>: &#123;</div><div class="line">                <span class="attr">min</span>: <span class="number">5</span>,</div><div class="line">                <span class="attr">max</span>: <span class="number">10</span>,</div><div class="line">                <span class="attr">base</span>: <span class="number">1.05</span></div><div class="line">            &#125;,</div><div class="line">            <span class="attr">autoHeal</span>: &#123;</div><div class="line">                <span class="attr">rate</span>: <span class="number">0.5</span>,</div><div class="line">                <span class="attr">amount</span>: <span class="number">1</span></div><div class="line">            &#125;</div><div class="line">        &#125;, &#123;</div><div class="line">            <span class="attr">i</span>: <span class="number">1</span>,</div><div class="line">            <span class="attr">type</span>: <span class="string">'tree'</span>,</div><div class="line">            <span class="attr">HP</span>: &#123;</div><div class="line">                <span class="attr">min</span>: <span class="number">20</span>,</div><div class="line">                <span class="attr">max</span>: <span class="number">30</span>,</div><div class="line">                <span class="attr">base</span>: <span class="number">1.08</span></div><div class="line">            &#125;,</div><div class="line">            <span class="attr">autoHeal</span>: &#123;</div><div class="line">                <span class="attr">rate</span>: <span class="number">1</span>,</div><div class="line">                <span class="attr">amount</span>: <span class="number">5</span></div><div class="line">            &#125;</div><div class="line">        &#125;, &#123;</div><div class="line">            <span class="attr">i</span>: <span class="number">2</span>,</div><div class="line">            <span class="attr">type</span>: <span class="string">'rock'</span>,</div><div class="line">            <span class="attr">HP</span>: &#123;</div><div class="line">                <span class="attr">min</span>: <span class="number">35</span>,</div><div class="line">                <span class="attr">max</span>: <span class="number">50</span>,</div><div class="line">                <span class="attr">base</span>: <span class="number">1.15</span></div><div class="line">            &#125;,</div><div class="line">            <span class="attr">autoHeal</span>: &#123;</div><div class="line">                <span class="attr">rate</span>: <span class="number">3</span>,</div><div class="line">                <span class="attr">amount</span>: <span class="number">50</span></div><div class="line">            &#125;</div><div class="line">        &#125;,</div><div class="line"> </div><div class="line">    ];</div><div class="line"> </div><div class="line">    <span class="comment">// set a cell as a given type index</span></div><div class="line">    <span class="keyword">var</span> setCellType = <span class="function"><span class="keyword">function</span> (<span class="params">cell, typeIndex, opt</span>) </span>&#123;</div><div class="line"> </div><div class="line">        <span class="keyword">var</span> level = cell.levelObj.level,</div><div class="line">        min,</div><div class="line">        max;</div><div class="line"> </div><div class="line">        opt = opt || &#123;&#125;;</div><div class="line"> </div><div class="line">        <span class="comment">// set type and type index by way o given type index</span></div><div class="line">        cell.type = cellTypes[typeIndex];</div><div class="line">        cell.typeIndex = typeIndex;</div><div class="line"> </div><div class="line">        <span class="comment">// active flag should typically be set to true</span></div><div class="line">        cell.active = opt.active === <span class="literal">undefined</span> ? <span class="literal">true</span> : opt.active;</div><div class="line"> </div><div class="line">        <span class="comment">// HP</span></div><div class="line">        <span class="comment">//cell.maxHP = cell.type.HP.min + Math.round((cell.type.HP.max - cell.type.HP.min) * Math.random());</span></div><div class="line">        min = <span class="built_in">Math</span>.pow(level, cell.type.HP.base) * cell.type.HP.min;</div><div class="line">        max = <span class="built_in">Math</span>.pow(level, cell.type.HP.base) * cell.type.HP.max;</div><div class="line">        cell.maxHP = min + <span class="built_in">Math</span>.round((max - min) * <span class="built_in">Math</span>.random());</div><div class="line">        cell.HP = opt.HP === <span class="literal">undefined</span> ? cell.maxHP : opt.HP;</div><div class="line"> </div><div class="line">        <span class="comment">// autoHeal</span></div><div class="line">        cell.autoHeal.rate = cell.type.autoHeal.rate;</div><div class="line">        cell.autoHeal.amount = cell.type.autoHeal.amount;</div><div class="line">    &#125;;</div><div class="line"> </div><div class="line">    <span class="keyword">var</span> getHighestDamageCell = <span class="function"><span class="keyword">function</span> (<span class="params">map</span>) </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="built_in">Math</span>.max.apply(<span class="literal">null</span>, map.cells.map(<span class="function"><span class="keyword">function</span> (<span class="params">cell</span>) </span>&#123;</div><div class="line">                <span class="keyword">return</span> cell.damage;</div><div class="line">            &#125;));</div><div class="line">    &#125;;</div><div class="line"> </div><div class="line">    <span class="comment">// get cell method</span></div><div class="line">    <span class="keyword">var</span> get = <span class="function"><span class="keyword">function</span> (<span class="params">map, x, y</span>) </span>&#123;</div><div class="line">        <span class="keyword">if</span> (x &lt; <span class="number">0</span> || y &lt; <span class="number">0</span>) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="literal">undefined</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (x &gt;= map.cellWidth || y &gt;= map.cellHeight) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="literal">undefined</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> map.cells[y * map.cellWidth + x];</div><div class="line">    &#125;;</div><div class="line"> </div><div class="line">    <span class="comment">// auto heal a cell</span></div><div class="line">    <span class="keyword">var</span> autoHeal = <span class="function"><span class="keyword">function</span> (<span class="params">cell, secs</span>) </span>&#123;</div><div class="line">        cell.autoHeal.secs += secs;</div><div class="line">        <span class="keyword">if</span> (cell.autoHeal.secs &gt;= cell.autoHeal.rate) &#123;</div><div class="line">            cell.autoHeal.secs %= cell.autoHeal.rate;</div><div class="line">            cell.HP += cell.autoHeal.amount;</div><div class="line">            cell.HP = cell.HP &gt; cell.maxHP ? cell.maxHP : cell.HP;</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line"> </div><div class="line">    <span class="comment">// get border cells helper</span></div><div class="line">    <span class="keyword">var</span> getBorderCells = <span class="function"><span class="keyword">function</span> (<span class="params">map, cell</span>) </span>&#123;</div><div class="line">        <span class="keyword">var</span> i = <span class="number">8</span>,</div><div class="line">        borderCell,</div><div class="line">        cells = [],</div><div class="line">        r,</div><div class="line">        x,</div><div class="line">        y;</div><div class="line">        <span class="keyword">if</span> (!cell) &#123;</div><div class="line">            <span class="keyword">return</span> [];</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">while</span> (i--) &#123;</div><div class="line">            r = <span class="built_in">Math</span>.PI * <span class="number">2</span> / <span class="number">8</span> * i;</div><div class="line">            x = <span class="built_in">Math</span>.round(cell.x + <span class="built_in">Math</span>.cos(r));</div><div class="line">            y = <span class="built_in">Math</span>.round(cell.y + <span class="built_in">Math</span>.sin(r));</div><div class="line">            borderCell = get(map, x, y);</div><div class="line">            <span class="keyword">if</span> (borderCell) &#123;</div><div class="line">                cells.push(borderCell);</div><div class="line">            &#125;</div><div class="line"> </div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> cells;</div><div class="line">    &#125;;</div><div class="line"> </div><div class="line">    <span class="comment">// get the count of active border cells for the given cell and active status</span></div><div class="line">    <span class="keyword">var</span> getBorderCellsActiveCount = <span class="function"><span class="keyword">function</span> (<span class="params">map, cell, active</span>) </span>&#123;</div><div class="line">        active === <span class="literal">undefined</span> ? <span class="literal">true</span> : active;</div><div class="line">        <span class="keyword">var</span> borderCells = getBorderCells(map, cell);</div><div class="line">        <span class="keyword">return</span> borderCells.reduce(<span class="function"><span class="keyword">function</span> (<span class="params">acc, cell</span>) </span>&#123;</div><div class="line">            acc = <span class="keyword">typeof</span> acc === <span class="string">'object'</span> ? <span class="built_in">Number</span>(acc.active === active) : acc;</div><div class="line">            <span class="keyword">return</span> acc += <span class="built_in">Number</span>(cell.active == active);</div><div class="line">        &#125;);</div><div class="line">    &#125;;</div><div class="line"> </div><div class="line">    <span class="comment">// get all cells with an active state of true or false, and also filter farther with an</span></div><div class="line">    <span class="comment">// optional condition</span></div><div class="line">    <span class="keyword">var</span> getAllCellActiveState = <span class="function"><span class="keyword">function</span> (<span class="params">map, active, condition</span>) </span>&#123;</div><div class="line">        active = active === <span class="literal">undefined</span> ? <span class="literal">true</span> : active;</div><div class="line">        condition = condition === <span class="literal">undefined</span> ? <span class="function"><span class="keyword">function</span> (<span class="params">cell</span>) </span>&#123;</div><div class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</div><div class="line">        &#125;</div><div class="line">         : condition;</div><div class="line">        <span class="keyword">return</span> map.cells.filter(<span class="function"><span class="keyword">function</span> (<span class="params">cell</span>) </span>&#123;</div><div class="line">            <span class="keyword">if</span> (cell.active === active &amp;&amp; condition(map, cell)) &#123;</div><div class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">        &#125;);</div><div class="line">    &#125;;</div><div class="line"> </div><div class="line">    <span class="comment">// condition for gen cells</span></div><div class="line">    <span class="keyword">var</span> condition_gen_cell = <span class="function"><span class="keyword">function</span> (<span class="params">map, cell</span>) </span>&#123;</div><div class="line">        <span class="keyword">var</span> borderCells = getBorderCells(map, cell);</div><div class="line">        <span class="keyword">return</span> getBorderCellsActiveCount(map, cell, <span class="literal">true</span>) &gt;= <span class="number">1</span>;</div><div class="line">    &#125;;</div><div class="line"> </div><div class="line">    <span class="comment">// get all potential gen cells</span></div><div class="line">    <span class="keyword">var</span> getGenCells = <span class="function"><span class="keyword">function</span> (<span class="params">map</span>) </span>&#123;</div><div class="line">        <span class="keyword">return</span> getAllCellActiveState(map, <span class="literal">false</span>, condition_gen_cell);</div><div class="line">    &#125;;</div><div class="line"> </div><div class="line">    <span class="keyword">var</span> popRandomCell = <span class="function"><span class="keyword">function</span> (<span class="params">cells</span>) </span>&#123;</div><div class="line">        <span class="keyword">var</span> i = <span class="built_in">Math</span>.floor(<span class="built_in">Math</span>.random() * cells.length);</div><div class="line">        <span class="keyword">return</span> cells.splice(i, <span class="number">1</span>)[<span class="number">0</span>];</div><div class="line">    &#125;;</div><div class="line"> </div><div class="line">    <span class="comment">// generate new cells by way of given secs amount</span></div><div class="line">    <span class="keyword">var</span> gen = <span class="function"><span class="keyword">function</span> (<span class="params">map, secs</span>) </span>&#123;</div><div class="line">        <span class="keyword">var</span> cells,</div><div class="line">        cell,</div><div class="line">        i;</div><div class="line">        map.gen.secs += secs;</div><div class="line">        <span class="keyword">if</span> (map.gen.secs &gt;= map.gen.rate) &#123;</div><div class="line">            map.gen.secs %= map.gen.rate;</div><div class="line">            cells = getGenCells(map);</div><div class="line">            i = map.gen.count;</div><div class="line">            <span class="keyword">if</span> (cells.length - i &lt; <span class="number">0</span>) &#123;</div><div class="line">                i = cells.length;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (i &gt; <span class="number">0</span>) &#123;</div><div class="line">                <span class="comment">// activate 1 to map.gen.count cells</span></div><div class="line">                <span class="keyword">while</span> (i--) &#123;</div><div class="line">                    cell = popRandomCell(cells);</div><div class="line">                    setCellType(cell, <span class="built_in">Math</span>.round(cell.damagePer * (cellTypes.length - <span class="number">1</span>)));</div><div class="line">                &#125;</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="comment">// if no active cells</span></div><div class="line">                cells = getAllCellActiveState(map, <span class="literal">true</span>);</div><div class="line">                <span class="keyword">if</span> (cells.length === <span class="number">0</span>) &#123;</div><div class="line">                    cell = map.cells[map.gen.startCells[<span class="built_in">Math</span>.floor(<span class="built_in">Math</span>.random() * map.gen.startCells.length)]];</div><div class="line">                    setCellType(cell, <span class="number">0</span>);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line"> </div><div class="line">    <span class="comment">// PUBLIC API</span></div><div class="line">    <span class="keyword">return</span> &#123;</div><div class="line"> </div><div class="line">        <span class="attr">getAllCellActiveState</span>: getAllCellActiveState,</div><div class="line"> </div><div class="line">        <span class="attr">create</span>: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line"> </div><div class="line">            <span class="comment">// create map object</span></div><div class="line">            <span class="keyword">var</span> map = &#123;</div><div class="line">                <span class="attr">cellSize</span>: <span class="number">32</span>,</div><div class="line">                <span class="attr">cellWidth</span>: <span class="number">8</span>,</div><div class="line">                <span class="attr">cellHeight</span>: <span class="number">8</span>,</div><div class="line">                <span class="attr">cells</span>: [],</div><div class="line">                <span class="attr">cellLevel</span>: &#123;</div><div class="line">                    <span class="attr">cap</span>: <span class="number">5</span>,</div><div class="line">                    <span class="attr">deltaNext</span>: <span class="number">200</span></div><div class="line">                &#125;,</div><div class="line">                <span class="attr">percentRemain</span>: <span class="number">1</span>,</div><div class="line">                <span class="attr">gen</span>: &#123; <span class="comment">// global cell generate values</span></div><div class="line">                    rate: <span class="number">1</span>,</div><div class="line">                    <span class="attr">secs</span>: <span class="number">0</span>,</div><div class="line">                    <span class="attr">count</span>: <span class="number">2</span>,</div><div class="line">                    <span class="comment">// start cells for 32 x 16</span></div><div class="line">                    <span class="comment">// startCells: [0, 31, 480, 511] // corner cells</span></div><div class="line">                    <span class="comment">// startCells: [239, 240, 271, 272]// center cells</span></div><div class="line">                    <span class="comment">// startCells: [239, 240, 271, 272]</span></div><div class="line">                    <span class="comment">// 8 * 8 start cells</span></div><div class="line">                    startCells: [<span class="number">27</span>, <span class="number">28</span>, <span class="number">35</span>, <span class="number">36</span>, <span class="number">0</span>, <span class="number">63</span>, <span class="number">56</span>, <span class="number">7</span>]</div><div class="line">                &#125;,</div><div class="line">                <span class="attr">highDamageCell</span>: <span class="number">0</span></div><div class="line">            &#125;;</div><div class="line"> </div><div class="line">            <span class="comment">// setup cells for first time</span></div><div class="line">            <span class="keyword">var</span> i = <span class="number">0</span>,</div><div class="line">            cell,</div><div class="line">            x,</div><div class="line">            y,</div><div class="line">            len = map.cellWidth * map.cellHeight;</div><div class="line">            <span class="keyword">while</span> (i &lt; len) &#123;</div><div class="line">                cell = &#123;</div><div class="line">                    <span class="attr">i</span>: i,</div><div class="line">                    <span class="attr">x</span>: i % map.cellWidth,</div><div class="line">                    <span class="attr">y</span>: <span class="built_in">Math</span>.floor(i / map.cellWidth),</div><div class="line">                    <span class="attr">HP</span>: <span class="number">50</span>,</div><div class="line">                    <span class="attr">maxHP</span>: <span class="number">100</span>,</div><div class="line">                    <span class="attr">active</span>: <span class="literal">true</span>,</div><div class="line">                    <span class="attr">typeIndex</span>: <span class="number">0</span>,</div><div class="line">                    <span class="attr">typeName</span>: cellTypes[<span class="number">0</span>].name,</div><div class="line">                    <span class="attr">type</span>: cellTypes[<span class="number">0</span>],</div><div class="line">                    <span class="attr">autoHeal</span>: &#123;</div><div class="line">                        <span class="attr">rate</span>: <span class="number">1</span>,</div><div class="line">                        <span class="attr">amount</span>: <span class="number">5</span>,</div><div class="line">                        <span class="attr">secs</span>: <span class="number">0</span></div><div class="line">                    &#125;,</div><div class="line">                    <span class="attr">damage</span>: <span class="number">0</span>,</div><div class="line">                    <span class="attr">damagePer</span>: <span class="number">0</span>, <span class="comment">// damage relative to highest damaged cell</span></div><div class="line">                    levelObj: XP.parseByXP(<span class="number">0</span>, map.cellLevel.cap, map.cellLevel.deltaNext)</div><div class="line">                &#125;;</div><div class="line">                setCellType(cell, <span class="number">0</span>);</div><div class="line">                map.cells.push(cell);</div><div class="line">                i += <span class="number">1</span>;</div><div class="line">            &#125;</div><div class="line"> </div><div class="line">            <span class="keyword">return</span> map;</div><div class="line">        &#125;,</div><div class="line"> </div><div class="line">        <span class="attr">clampOffset</span>: <span class="function"><span class="keyword">function</span> (<span class="params">map, offset</span>) </span>&#123;</div><div class="line">            offset.x = offset.x &gt; <span class="number">0</span> ? <span class="number">0</span> : offset.x;</div><div class="line">            offset.y = offset.y &gt; <span class="number">0</span> ? <span class="number">0</span> : offset.y;</div><div class="line">            offset.x = offset.x &lt; map.cellWidth * map.cellSize * <span class="number">-1</span> ? map.cellWidth * map.cellSize * <span class="number">-1</span> : offset.x;</div><div class="line">            offset.y = offset.y &lt; map.cellHeight * map.cellSize * <span class="number">-1</span> ? map.cellHeight * map.cellSize * <span class="number">-1</span> : offset.y;</div><div class="line">        &#125;,</div><div class="line"> </div><div class="line">        <span class="comment">// get all cells from a given cell position, and radius from that position</span></div><div class="line">        getAllFromPointAndRadius: <span class="function"><span class="keyword">function</span> (<span class="params">map, x, y, r</span>) </span>&#123;</div><div class="line">            <span class="comment">//??? just do it the stupid way for now</span></div><div class="line">            <span class="keyword">var</span> i = map.cells.length,</div><div class="line">            d,</div><div class="line">            cell,</div><div class="line">            cells = [],</div><div class="line">            dists = [];</div><div class="line">            <span class="keyword">while</span> (i--) &#123;</div><div class="line">                cell = map.cells[i];</div><div class="line">                d = utils.distance(cell.x, cell.y, x, y);</div><div class="line">                <span class="keyword">if</span> (d &lt;= r) &#123;</div><div class="line">                    cells.push(cell);</div><div class="line">                    dists.push(d);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> &#123;</div><div class="line">                <span class="attr">cells</span>: cells,</div><div class="line">                <span class="attr">dists</span>: dists</div><div class="line">            &#125;;</div><div class="line">        &#125;,</div><div class="line"> </div><div class="line">        <span class="attr">getWithCanvasPointAndOffset</span>: <span class="function"><span class="keyword">function</span> (<span class="params">map, canvasX, canvasY, offsetX, offsetY</span>) </span>&#123;</div><div class="line">            <span class="keyword">var</span> x = canvasX - <span class="number">160</span> + <span class="built_in">Math</span>.abs(offsetX),</div><div class="line">            y = canvasY - <span class="number">120</span> + <span class="built_in">Math</span>.abs(offsetY);</div><div class="line">            <span class="keyword">return</span> get(map, <span class="built_in">Math</span>.floor(x / map.cellSize), <span class="built_in">Math</span>.floor(y / map.cellSize));</div><div class="line">        &#125;,</div><div class="line"> </div><div class="line">        <span class="attr">update</span>: <span class="function"><span class="keyword">function</span> (<span class="params">map, secs</span>) </span>&#123;</div><div class="line"> </div><div class="line">            <span class="keyword">var</span> i,</div><div class="line">            cell;</div><div class="line"> </div><div class="line">            map.highDamageCell = getHighestDamageCell(map);</div><div class="line">            map.percentRemain = <span class="number">0</span>;</div><div class="line"> </div><div class="line">            <span class="comment">// update cells</span></div><div class="line">            i = map.cells.length;</div><div class="line">            <span class="keyword">while</span> (i--) &#123;</div><div class="line">                cell = map.cells[i];</div><div class="line"> </div><div class="line">                <span class="comment">// if HP is bellow or equal to zero set cell inactive</span></div><div class="line">                <span class="keyword">if</span> (cell.HP &lt;= <span class="number">0</span>) &#123;</div><div class="line">                    cell.active = <span class="literal">false</span>;</div><div class="line">                &#125;</div><div class="line"> </div><div class="line">                <span class="comment">// if cell is active</span></div><div class="line">                <span class="keyword">if</span> (cell.active) &#123;</div><div class="line">                    <span class="comment">// apply auto heal</span></div><div class="line">                    autoHeal(cell, secs);</div><div class="line">                    <span class="comment">// update percentRemain</span></div><div class="line">                    map.percentRemain += cell.HP / cell.maxHP;</div><div class="line">                &#125;</div><div class="line"> </div><div class="line">                <span class="comment">// figure damage percent</span></div><div class="line">                <span class="keyword">if</span> (cell.damage != <span class="number">0</span>) &#123;</div><div class="line">                    cell.damagePer = cell.damage / map.highDamageCell;</div><div class="line">                &#125;</div><div class="line">                <span class="comment">// update level</span></div><div class="line">                cell.levelObj = XP.parseByXP(cell.damage, map.cellLevel.cap, map.cellLevel.deltaNext);</div><div class="line"> </div><div class="line">            &#125;</div><div class="line">            <span class="comment">// figure percentRemain by diving tabulated total by total cells</span></div><div class="line">            map.percentRemain /= map.cells.length;</div><div class="line"> </div><div class="line">            gen(map, secs);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">&#125;</div><div class="line">    ());</div></pre></td></tr></table></figure>
<h2 id="5-A-pool-js-module-for-creating-an-object-pool-to-be-used-for-shots-amd-any-other-future-display-object-pools"><a href="#5-A-pool-js-module-for-creating-an-object-pool-to-be-used-for-shots-amd-any-other-future-display-object-pools" class="headerlink" title="5 - A pool.js module for creating an object pool to be used for shots amd any other future display object pools"></a>5 - A pool.js module for creating an object pool to be used for shots amd any other future display object pools</h2><!-- edit bookmark -->
<p>I made a another post in which I touched base on <a href="/2020/07/20/canvas-example-object-pool/">object pools</a>. I decided to include such a module in this project that for starters will be used to create shot objects that will move from the side of the canvas to the target area where an attack was made on the map. In future versions of the canvas example display object pools could be used for all kinds of additional things where a display object would be called for such as explosions, enemies, and power ups.</p>
<p>The module for now just has three public methods, one to create an object pool, one to update an object pool, and another that will call the spawn method of a display object that is inactive if any is available.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> poolMod = (<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line"> </div><div class="line">    <span class="keyword">return</span> &#123;</div><div class="line"> </div><div class="line">        <span class="attr">create</span>: <span class="function"><span class="keyword">function</span> (<span class="params">opt</span>) </span>&#123;</div><div class="line">            opt = opt || &#123;&#125;;</div><div class="line">            opt.count = opt.count || <span class="number">10</span>;</div><div class="line">            <span class="keyword">var</span> i = <span class="number">0</span>,</div><div class="line">            pool = [];</div><div class="line">            <span class="keyword">while</span> (i &lt; opt.count) &#123;</div><div class="line">                pool.push(&#123;</div><div class="line">                    <span class="attr">active</span>: <span class="literal">false</span>,</div><div class="line">                    <span class="attr">x</span>: <span class="number">0</span>,</div><div class="line">                    <span class="attr">y</span>: <span class="number">0</span>,</div><div class="line">                    <span class="attr">radius</span>: <span class="number">8</span>,</div><div class="line">                    <span class="attr">heading</span>: <span class="number">0</span>,</div><div class="line">                    <span class="attr">pps</span>: <span class="number">32</span>,</div><div class="line">                    <span class="attr">lifespan</span>: opt.lifespan || <span class="number">3</span>,</div><div class="line">                    <span class="attr">data</span>: &#123;&#125;,</div><div class="line">                    <span class="attr">spawn</span>: opt.spawn || <span class="function"><span class="keyword">function</span> (<span class="params">obj, state</span>) </span>&#123;</div><div class="line">                        obj.active = <span class="literal">true</span>;</div><div class="line">                    &#125;,</div><div class="line">                    <span class="attr">purge</span>: opt.purge || <span class="function"><span class="keyword">function</span> (<span class="params">obj, state</span>) </span>&#123;&#125;,</div><div class="line">                    <span class="attr">update</span>: opt.update || <span class="function"><span class="keyword">function</span> (<span class="params">obj, state, secs</span>) </span>&#123;</div><div class="line">                        obj.x += obj.pps * secs;</div><div class="line">                        obj.lifespan -= secs;</div><div class="line">                    &#125;</div><div class="line">                &#125;);</div><div class="line">                i += <span class="number">1</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> pool;</div><div class="line">        &#125;,</div><div class="line"> </div><div class="line">        <span class="attr">spawn</span>: <span class="function"><span class="keyword">function</span> (<span class="params">pool, game, opt</span>) </span>&#123;</div><div class="line">            <span class="keyword">var</span> i = pool.length,</div><div class="line">            obj;</div><div class="line">            <span class="keyword">while</span> (i--) &#123;</div><div class="line">                obj = pool[i];</div><div class="line">                <span class="keyword">if</span> (!obj.active) &#123;</div><div class="line">                    obj.active = <span class="literal">true</span>;</div><div class="line">                    obj.spawn.call(obj, obj, game, opt);</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;,</div><div class="line"> </div><div class="line">        <span class="attr">update</span>: <span class="function"><span class="keyword">function</span> (<span class="params">pool, state, secs</span>) </span>&#123;</div><div class="line">            <span class="keyword">var</span> i = pool.length,</div><div class="line">            obj;</div><div class="line">            <span class="keyword">while</span> (i--) &#123;</div><div class="line">                obj = pool[i];</div><div class="line">                <span class="keyword">if</span> (obj.active) &#123;</div><div class="line">                    obj.update(obj, state, secs);</div><div class="line">                    obj.lifespan = obj.lifespan &lt; <span class="number">0</span> ? <span class="number">0</span> : obj.lifespan;</div><div class="line">                    <span class="keyword">if</span> (obj.lifespan === <span class="number">0</span>) &#123;</div><div class="line">                        obj.active = <span class="literal">false</span>;</div><div class="line">                        obj.purge.call(obj, obj, state);</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"> </div><div class="line">    &#125;</div><div class="line"> </div><div class="line">&#125;</div><div class="line">    ());</div></pre></td></tr></table></figure>
<p>As of this writing I am using the pool module to create a pool of display objects for shots that the player can fire by clicking in the inner circle area of the cross object. So I need a way to have a pool of objects that can be reused for the display objects that will represent these shots, and this is for starters what the pool.js module is for.</p>
<h2 id="6-The-game-js-file-for-creating-a-main-game-state-object"><a href="#6-The-game-js-file-for-creating-a-main-game-state-object" class="headerlink" title="6 - The game.js file for creating a main game state object"></a>6 - The game.js file for creating a main game state object</h2><p>So I ending up working out a main game module that will serve as a way to create and set up a main game state module for this canvas example. This module will create a main game state object that will contain an instance of the cross module object, along with a map object, and at least a single object pool for shot objects. This module will also attach a whole bunch of event handers for the canvas element.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div><div class="line">306</div><div class="line">307</div><div class="line">308</div><div class="line">309</div><div class="line">310</div><div class="line">311</div><div class="line">312</div><div class="line">313</div><div class="line">314</div><div class="line">315</div><div class="line">316</div><div class="line">317</div><div class="line">318</div><div class="line">319</div><div class="line">320</div><div class="line">321</div><div class="line">322</div><div class="line">323</div><div class="line">324</div><div class="line">325</div><div class="line">326</div><div class="line">327</div><div class="line">328</div><div class="line">329</div><div class="line">330</div><div class="line">331</div><div class="line">332</div><div class="line">333</div><div class="line">334</div><div class="line">335</div><div class="line">336</div><div class="line">337</div><div class="line">338</div><div class="line">339</div><div class="line">340</div><div class="line">341</div><div class="line">342</div><div class="line">343</div><div class="line">344</div><div class="line">345</div><div class="line">346</div><div class="line">347</div><div class="line">348</div><div class="line">349</div><div class="line">350</div><div class="line">351</div><div class="line">352</div><div class="line">353</div><div class="line">354</div><div class="line">355</div><div class="line">356</div><div class="line">357</div><div class="line">358</div><div class="line">359</div><div class="line">360</div><div class="line">361</div><div class="line">362</div><div class="line">363</div><div class="line">364</div><div class="line">365</div><div class="line">366</div><div class="line">367</div><div class="line">368</div><div class="line">369</div><div class="line">370</div><div class="line">371</div><div class="line">372</div><div class="line">373</div><div class="line">374</div><div class="line">375</div><div class="line">376</div><div class="line">377</div><div class="line">378</div><div class="line">379</div><div class="line">380</div><div class="line">381</div><div class="line">382</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> gameMod = (<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line"> </div><div class="line">    <span class="comment">// hard coded settings</span></div><div class="line">    <span class="keyword">var</span> hardSet = &#123;</div><div class="line">        <span class="attr">maxSecs</span>: <span class="number">0.25</span>, <span class="comment">// max seconds for sec value used in updates</span></div><div class="line">        deltaNext: <span class="number">10000</span>, <span class="comment">// deltaNext and levelCap</span></div><div class="line">        levelCap: <span class="number">100</span></div><div class="line">    &#125;;</div><div class="line"> </div><div class="line">    <span class="keyword">var</span> Weapons = [&#123;</div><div class="line">            <span class="attr">name</span>: <span class="string">'Blaster'</span>,</div><div class="line">            <span class="attr">pps</span>: <span class="number">256</span>,</div><div class="line">            <span class="attr">shotRate</span>: <span class="number">0.125</span>,</div><div class="line">            <span class="attr">blastRadius</span>: <span class="number">1</span>,</div><div class="line">            <span class="attr">maxDPS</span>: <span class="number">10</span>,</div><div class="line">            <span class="attr">accuracy</span>: <span class="number">0.75</span>,</div><div class="line">            <span class="attr">hitRadius</span>: <span class="number">64</span>,</div><div class="line">            <span class="attr">gunCount</span>: <span class="number">1</span>,</div><div class="line">            <span class="attr">level</span>: &#123;</div><div class="line">                <span class="attr">maxDPS_base</span>: <span class="number">10</span>,</div><div class="line">                <span class="attr">maxDPS_perLevel</span>: <span class="number">5</span></div><div class="line">            &#125;</div><div class="line">        &#125;, &#123;</div><div class="line">            <span class="attr">name</span>: <span class="string">'Assault Blaster'</span>,</div><div class="line">            <span class="attr">pps</span>: <span class="number">512</span>,</div><div class="line">            <span class="attr">shotRate</span>: <span class="number">0.125</span>,</div><div class="line">            <span class="attr">blastRadius</span>: <span class="number">2</span>,</div><div class="line">            <span class="attr">maxDPS</span>: <span class="number">5</span>,</div><div class="line">            <span class="attr">accuracy</span>: <span class="number">0.5</span>,</div><div class="line">            <span class="attr">hitRadius</span>: <span class="number">64</span>,</div><div class="line">            <span class="attr">gunCount</span>: <span class="number">4</span>,</div><div class="line">            <span class="attr">level</span>: &#123;</div><div class="line">                <span class="attr">maxDPS_base</span>: <span class="number">5</span>,</div><div class="line">                <span class="attr">maxDPS_perLevel</span>: <span class="number">6</span></div><div class="line">            &#125;</div><div class="line">        &#125;, &#123;</div><div class="line">            <span class="attr">name</span>: <span class="string">'Cannon'</span>,</div><div class="line">            <span class="attr">pps</span>: <span class="number">256</span>,</div><div class="line">            <span class="attr">shotRate</span>: <span class="number">0.5</span>,</div><div class="line">            <span class="attr">blastRadius</span>: <span class="number">3</span>,</div><div class="line">            <span class="attr">maxDPS</span>: <span class="number">20</span>,</div><div class="line">            <span class="attr">accuracy</span>: <span class="number">0.25</span>,</div><div class="line">            <span class="attr">hitRadius</span>: <span class="number">32</span>,</div><div class="line">            <span class="attr">gunCount</span>: <span class="number">2</span>,</div><div class="line">            <span class="attr">level</span>: &#123;</div><div class="line">                <span class="attr">maxDPS_base</span>: <span class="number">15</span>,</div><div class="line">                <span class="attr">maxDPS_perLevel</span>: <span class="number">10</span></div><div class="line">            &#125;</div><div class="line">        &#125;, &#123;</div><div class="line">            <span class="attr">name</span>: <span class="string">'Atom'</span>,</div><div class="line">            <span class="attr">pps</span>: <span class="number">256</span>,</div><div class="line">            <span class="attr">shotRate</span>: <span class="number">1</span>,</div><div class="line">            <span class="attr">blastRadius</span>: <span class="number">10</span>,</div><div class="line">            <span class="attr">maxDPS</span>: <span class="number">75</span>,</div><div class="line">            <span class="attr">accuracy</span>: <span class="number">0.9</span>,</div><div class="line">            <span class="attr">hitRadius</span>: <span class="number">64</span>,</div><div class="line">            <span class="attr">gunCount</span>: <span class="number">1</span>,</div><div class="line">            <span class="attr">level</span>: &#123;</div><div class="line">                <span class="attr">maxDPS_base</span>: <span class="number">75</span>,</div><div class="line">                <span class="attr">maxDPS_perLevel</span>: <span class="number">50</span></div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    ];</div><div class="line"> </div><div class="line">    <span class="keyword">var</span> setWeaponsToLevel = <span class="function"><span class="keyword">function</span> (<span class="params">game</span>) </span>&#123;</div><div class="line">        <span class="keyword">var</span> level = game.levelObj.level;</div><div class="line">        Weapons.forEach(<span class="function"><span class="keyword">function</span> (<span class="params">weapon</span>) </span>&#123;</div><div class="line">            <span class="keyword">var</span> lv = weapon.level;</div><div class="line">            weapon.maxDPS = lv.maxDPS_base + lv.maxDPS_perLevel * level;</div><div class="line">            weapon.accuracy = <span class="number">0.95</span> - <span class="number">0.9</span> * (<span class="number">1</span> - level / hardSet.levelCap);</div><div class="line">        &#125;);</div><div class="line">    &#125;;</div><div class="line"> </div><div class="line">    <span class="comment">// SHOT Object Options</span></div><div class="line">    <span class="keyword">var</span> shotOptions = &#123;</div><div class="line">        <span class="attr">count</span>: <span class="number">20</span>,</div><div class="line">        <span class="comment">// when a shot becomes active</span></div><div class="line">        spawn: <span class="function"><span class="keyword">function</span> (<span class="params">shot, game, radian</span>) </span>&#123;</div><div class="line">            <span class="keyword">var</span> offset = game.cross.offset,</div><div class="line">            w = Weapons[game.weaponIndex],</div><div class="line">            ch = game.cross.crosshairs,</div><div class="line">            r = <span class="built_in">Math</span>.random() * (<span class="built_in">Math</span>.PI * <span class="number">2</span>),</div><div class="line">            d = w.hitRadius * (<span class="number">1</span> - w.accuracy) * <span class="built_in">Math</span>.random(),</div><div class="line">            x = ch.x + <span class="built_in">Math</span>.cos(r) * d,</div><div class="line">            y = ch.y + <span class="built_in">Math</span>.sin(r) * d,</div><div class="line">            d;</div><div class="line">            <span class="comment">//shot.x = game.canvas.width;</span></div><div class="line">            <span class="comment">//shot.y = game.canvas.height;</span></div><div class="line">            shot.x = x + <span class="built_in">Math</span>.cos(radian) * game.canvas.width;</div><div class="line">            shot.y = y + <span class="built_in">Math</span>.sin(radian) * game.canvas.width;</div><div class="line">            shot.heading = <span class="built_in">Math</span>.atan2(y - shot.y, x - shot.x);</div><div class="line">            d = utils.distance(shot.x, shot.y, x, y);</div><div class="line">            shot.pps = w.pps;</div><div class="line">            shot.lifespan = d / shot.pps;</div><div class="line">            shot.offset = offset;</div><div class="line">        &#125;,</div><div class="line">        <span class="comment">// when a shot becomes inactive</span></div><div class="line">        purge: <span class="function"><span class="keyword">function</span> (<span class="params">shot, game</span>) </span>&#123;</div><div class="line">            poolMod.spawn(game.explosions, game, shot);</div><div class="line">        &#125;,</div><div class="line">        <span class="comment">// update method for a shot</span></div><div class="line">        update: <span class="function"><span class="keyword">function</span> (<span class="params">shot, game, secs</span>) </span>&#123;</div><div class="line">            shot.x += <span class="built_in">Math</span>.cos(shot.heading) * shot.pps * secs;</div><div class="line">            shot.y += <span class="built_in">Math</span>.sin(shot.heading) * shot.pps * secs;</div><div class="line">            shot.lifespan -= secs;</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line"> </div><div class="line">    <span class="comment">// Explosion Options</span></div><div class="line">    <span class="keyword">var</span> explosionOptions = &#123;</div><div class="line">        <span class="attr">count</span>: <span class="number">20</span>,</div><div class="line">        <span class="attr">spawn</span>: <span class="function"><span class="keyword">function</span> (<span class="params">ex, game, shot</span>) </span>&#123;</div><div class="line">            <span class="keyword">var</span> w = Weapons[game.weaponIndex];</div><div class="line">            ex.x = shot.x;</div><div class="line">            ex.y = shot.y;</div><div class="line">            ex.data.offset = &#123;</div><div class="line">                <span class="attr">x</span>: shot.offset.x,</div><div class="line">                <span class="attr">y</span>: shot.offset.y</div><div class="line">            &#125;;</div><div class="line">            ex.data.radiusEnd = game.map.cellSize * w.blastRadius;</div><div class="line">            ex.data.explosionTime = <span class="number">0.6</span>;</div><div class="line">            ex.data.maxDPS = w.maxDPS; ;</div><div class="line">            ex.lifespan = ex.data.explosionTime;</div><div class="line">            ex.per = <span class="number">0</span>;</div><div class="line">        &#125;,</div><div class="line">        <span class="attr">purge</span>: <span class="function"><span class="keyword">function</span> (<span class="params">ex, game</span>) </span>&#123;&#125;,</div><div class="line">        <span class="attr">update</span>: <span class="function"><span class="keyword">function</span> (<span class="params">ex, game, secs</span>) </span>&#123;</div><div class="line">            ex.per = (ex.data.explosionTime - ex.lifespan) / ex.data.explosionTime;</div><div class="line">            ex.radius = ex.data.radiusEnd * ex.per;</div><div class="line">            <span class="keyword">var</span> cell = mapMod.getWithCanvasPointAndOffset(game.map, ex.x, ex.y, ex.data.offset.x, ex.data.offset.y),</div><div class="line">            blastRadius = <span class="built_in">Math</span>.ceil((ex.radius + <span class="number">0.01</span>) / game.map.cellSize);</div><div class="line">            <span class="keyword">if</span> (cell) &#123;</div><div class="line">                <span class="keyword">var</span> targets = mapMod.getAllFromPointAndRadius(game.map, cell.x, cell.y, blastRadius);</div><div class="line">                targets.cells.forEach(<span class="function"><span class="keyword">function</span> (<span class="params">cell, i</span>) </span>&#123;</div><div class="line">                    <span class="comment">// apply damage</span></div><div class="line">                    <span class="keyword">var</span> damage = ex.data.maxDPS * (<span class="number">1</span> - (targets.dists[i] / blastRadius)) * secs;</div><div class="line">                    <span class="keyword">if</span> (cell.active) &#123;</div><div class="line">                        game.totalDamage += damage;</div><div class="line">                        cell.HP -= damage;</div><div class="line">                        cell.HP = cell.HP &lt; <span class="number">0</span> ? <span class="number">0</span> : cell.HP;</div><div class="line">                    &#125;</div><div class="line">                    cell.damage += damage;</div><div class="line">                &#125;);</div><div class="line">            &#125;</div><div class="line">            ex.lifespan -= secs;</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line"> </div><div class="line">    <span class="keyword">var</span> shoot = <span class="function"><span class="keyword">function</span> (<span class="params">game</span>) </span>&#123;</div><div class="line">        <span class="keyword">var</span> w = Weapons[game.weaponIndex];</div><div class="line">        <span class="keyword">if</span> (game.shotSecs &gt;= game.shotRate) &#123;</div><div class="line">            <span class="keyword">var</span> i = <span class="number">0</span>,</div><div class="line">            radian;</div><div class="line">            <span class="keyword">while</span> (i &lt; w.gunCount) &#123;</div><div class="line">                radian = <span class="built_in">Math</span>.PI * <span class="number">2</span> / <span class="number">4</span> * i + <span class="built_in">Math</span>.PI / <span class="number">4</span>;</div><div class="line">                poolMod.spawn(game.shots, game, radian);</div><div class="line">                i += <span class="number">1</span>;</div><div class="line">            &#125;</div><div class="line">            game.shotSecs = <span class="number">0</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line"> </div><div class="line">    <span class="comment">// AUTOPLAY</span></div><div class="line">    <span class="keyword">var</span> autoPlay = &#123;</div><div class="line">        <span class="attr">setRandomTarget</span>: <span class="function"><span class="keyword">function</span> (<span class="params">game</span>) </span>&#123;</div><div class="line">            <span class="keyword">var</span> ch = game.cross.crosshairs,</div><div class="line">            os = game.cross.offset,</div><div class="line">            ap = game.autoPlay,</div><div class="line">            map = game.map,</div><div class="line">            activeCells = mapMod.getAllCellActiveState(map, <span class="literal">true</span>),</div><div class="line">            x = <span class="built_in">Math</span>.floor(map.cellWidth * <span class="built_in">Math</span>.random()),</div><div class="line">            y = <span class="built_in">Math</span>.floor(map.cellHeight * <span class="built_in">Math</span>.random());</div><div class="line">            <span class="keyword">if</span> (activeCells.length &gt;= <span class="number">1</span>) &#123;</div><div class="line">                <span class="keyword">var</span> cell = activeCells[<span class="built_in">Math</span>.floor(activeCells.length * <span class="built_in">Math</span>.random())];</div><div class="line">                x = cell.x;</div><div class="line">                y = cell.y;</div><div class="line">            &#125;</div><div class="line">            ap.target.x = (map.cellSize / <span class="number">2</span> + (map.cellSize * x)) * <span class="number">-1</span>;</div><div class="line">            ap.target.y = (map.cellSize / <span class="number">2</span> + (map.cellSize * y)) * <span class="number">-1</span>;</div><div class="line">        &#125;,</div><div class="line"> </div><div class="line">        <span class="attr">setByPercentRemain</span>: <span class="function"><span class="keyword">function</span> (<span class="params">game</span>) </span>&#123;</div><div class="line">            <span class="keyword">var</span> map = game.map,</div><div class="line">            ap = game.autoPlay;</div><div class="line"> </div><div class="line">            <span class="comment">// hard coded default for weapon index</span></div><div class="line">            game.weaponIndex = <span class="number">0</span>;</div><div class="line"> </div><div class="line">            <span class="comment">// set AI values based on ap.behavior value</span></div><div class="line">            <span class="keyword">if</span> (ap.behavior === <span class="string">'cannon'</span>) &#123;</div><div class="line">                game.weaponIndex = <span class="number">2</span>;</div><div class="line">                ap.maxShootTime = <span class="number">3</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (ap.behavior === <span class="string">'total-kill'</span>) &#123;</div><div class="line">                game.weaponIndex = Weapons.length - <span class="number">1</span>;</div><div class="line">                ap.stopAtPercentRemain = <span class="number">0</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (ap.behavior === <span class="string">'weapon-switch'</span>) &#123;</div><div class="line">                game.weaponIndex = <span class="built_in">Math</span>.floor((Weapons.length) * utils.logPer(map.percentRemain, <span class="number">2</span>));</div><div class="line">            &#125;</div><div class="line">            game.weaponIndex = game.weaponIndex &gt;= Weapons.length ? Weapons.length - <span class="number">1</span> : game.weaponIndex;</div><div class="line">            <span class="comment">// stay on move mode if</span></div><div class="line">            <span class="keyword">if</span> (map.percentRemain &lt; ap.stopAtPercentRemain) &#123;</div><div class="line">                ap.mode = <span class="string">'move'</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;,</div><div class="line"> </div><div class="line">        <span class="attr">modes</span>: &#123;</div><div class="line"> </div><div class="line">            <span class="comment">// AI Move mode</span></div><div class="line">            move: <span class="function"><span class="keyword">function</span> (<span class="params">game, secs</span>) </span>&#123;</div><div class="line"> </div><div class="line">                <span class="keyword">var</span> ch = game.cross.crosshairs,</div><div class="line">                os = game.cross.offset,</div><div class="line">                ap = game.autoPlay,</div><div class="line">                map = game.map,</div><div class="line">                a = <span class="built_in">Math</span>.atan2(os.y - ap.target.y, os.x - ap.target.x),</div><div class="line">                cross = game.cross,</div><div class="line">                d = utils.distance(os.x, os.y, ap.target.x, ap.target.y),</div><div class="line">                delta = game.cross.radiusOuter - <span class="number">1</span>;</div><div class="line">                maxDelta = cross.radiusInner + cross.radiusDiff - <span class="number">1</span>,</div><div class="line">                minDelta = cross.radiusInner + <span class="number">5</span>,</div><div class="line">                slowDownDist = map.cellSize * <span class="number">4</span>,</div><div class="line">                <span class="comment">// !!! know bug where AI movement does not work as desired might</span></div><div class="line">                <span class="comment">// is temp fixed by setting a minDist, might still cause problems</span></div><div class="line">                <span class="comment">// with very low frame rates</span></div><div class="line">                minDist = map.cellSize / <span class="number">2</span>,</div><div class="line">                per = <span class="number">0</span>;</div><div class="line"> </div><div class="line">                <span class="keyword">if</span> (d &lt; slowDownDist) &#123;</div><div class="line">                    per = <span class="number">1</span> - d / slowDownDist;</div><div class="line">                &#125;</div><div class="line"> </div><div class="line">                ap.target.d = d;</div><div class="line"> </div><div class="line">                delta = maxDelta - (maxDelta - minDelta) * per;</div><div class="line"> </div><div class="line">                <span class="keyword">if</span> (d &lt; minDist) &#123;</div><div class="line">                    <span class="comment">// set right to target</span></div><div class="line">                    os.x = ap.target.x;</div><div class="line">                    os.y = ap.target.y;</div><div class="line">                    <span class="comment">// done</span></div><div class="line">                    ap.shootTime = ap.maxShootTime;</div><div class="line">                    autoPlay.setRandomTarget(game);</div><div class="line">                    ap.mode = <span class="string">'shoot'</span>;</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    <span class="comment">// !!! know bug where AI movement does not work as desired might</span></div><div class="line">                    <span class="comment">// be fixed here by way of a tempX and Y maybe</span></div><div class="line">                    ch.x = game.cross.center.x + <span class="built_in">Math</span>.cos(a) * delta;</div><div class="line">                    ch.y = game.cross.center.y + <span class="built_in">Math</span>.sin(a) * delta;</div><div class="line">                &#125;</div><div class="line"> </div><div class="line">            &#125;,</div><div class="line"> </div><div class="line">            <span class="attr">shoot</span>: <span class="function"><span class="keyword">function</span> (<span class="params">game, secs</span>) </span>&#123;</div><div class="line"> </div><div class="line">                <span class="keyword">var</span> ch = game.cross.crosshairs,</div><div class="line">                os = game.cross.offset,</div><div class="line">                ap = game.autoPlay,</div><div class="line">                map = game.map;</div><div class="line"> </div><div class="line">                ch.x = game.cross.center.x;</div><div class="line">                ch.y = game.cross.center.y;</div><div class="line">                shoot(game);</div><div class="line">                ap.shootTime -= secs;</div><div class="line">                <span class="keyword">if</span> (ap.shootTime &lt;= <span class="number">0</span>) &#123;</div><div class="line">                    ap.mode = <span class="string">'move'</span>;</div><div class="line">                    autoPlay.setRandomTarget(game);</div><div class="line">                &#125;</div><div class="line"> </div><div class="line">            &#125;</div><div class="line"> </div><div class="line">        &#125;,</div><div class="line"> </div><div class="line">        <span class="attr">update</span>: <span class="function"><span class="keyword">function</span> (<span class="params">game, secs</span>) </span>&#123;</div><div class="line"> </div><div class="line">            <span class="comment">// if autoplay</span></div><div class="line">            <span class="keyword">if</span> (game.autoPlay.enabled) &#123;</div><div class="line">                <span class="keyword">var</span> ch = game.cross.crosshairs,</div><div class="line">                os = game.cross.offset,</div><div class="line">                ap = game.autoPlay,</div><div class="line">                map = game.map;</div><div class="line">                game.autoPlay.delay -= secs;</div><div class="line">                <span class="keyword">if</span> (game.userDown) &#123;</div><div class="line">                    game.autoPlay.delay = game.autoPlay.maxDelay;</div><div class="line">                &#125;</div><div class="line">                game.autoPlay.delay = game.autoPlay.delay &lt; <span class="number">0</span> ? <span class="number">0</span> : game.autoPlay.delay;</div><div class="line">                <span class="keyword">if</span> (game.autoPlay.delay === <span class="number">0</span>) &#123;</div><div class="line">                    <span class="comment">// disable cross move back</span></div><div class="line">                    game.cross.moveBackEnabled = <span class="literal">false</span>;</div><div class="line">                    <span class="comment">// set by percent remain?</span></div><div class="line">                    autoPlay.setByPercentRemain(game);</div><div class="line">                    <span class="comment">// apply current mode</span></div><div class="line">                    autoPlay.modes[ap.mode](game, secs);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line"> </div><div class="line">    <span class="keyword">return</span> &#123;</div><div class="line">        <span class="attr">Weapons</span>: Weapons,</div><div class="line">        <span class="attr">create</span>: <span class="function"><span class="keyword">function</span> (<span class="params">opt</span>) </span>&#123;</div><div class="line">            opt = opt || &#123;&#125;;</div><div class="line">            <span class="keyword">var</span> game = &#123;</div><div class="line">                <span class="attr">levelObj</span>: &#123;&#125;,</div><div class="line">                <span class="attr">canvas</span>: opt.canvas,</div><div class="line">                <span class="attr">map</span>: mapMod.create(),</div><div class="line">                <span class="attr">cross</span>: &#123;&#125;,</div><div class="line">                <span class="attr">shots</span>: poolMod.create(shotOptions),</div><div class="line">                <span class="attr">explosions</span>: poolMod.create(explosionOptions),</div><div class="line">                <span class="attr">shotRate</span>: <span class="number">1</span>,</div><div class="line">                <span class="attr">shotSecs</span>: <span class="number">0</span>,</div><div class="line">                <span class="attr">weaponIndex</span>: <span class="number">3</span>,</div><div class="line">                <span class="attr">totalDamage</span>: <span class="number">0</span>,</div><div class="line">                <span class="attr">userDown</span>: <span class="literal">false</span>,</div><div class="line">                <span class="attr">autoPlay</span>: &#123;</div><div class="line">                    <span class="attr">enabled</span>: <span class="literal">true</span>,</div><div class="line">                    <span class="attr">behavior</span>: <span class="string">'cannon'</span>,</div><div class="line">                    <span class="attr">stopAtPercentRemain</span>: <span class="number">0</span>,</div><div class="line">                    <span class="attr">delay</span>: <span class="number">5</span>,</div><div class="line">                    <span class="attr">maxDelay</span>: <span class="number">5</span>,</div><div class="line">                    <span class="attr">mode</span>: <span class="string">'move'</span>,</div><div class="line">                    <span class="attr">shootTime</span>: <span class="number">5</span>,</div><div class="line">                    <span class="attr">maxShootTime</span>: <span class="number">5</span>,</div><div class="line">                    <span class="attr">target</span>: &#123;</div><div class="line">                        <span class="attr">x</span>: <span class="number">-16</span>,</div><div class="line">                        <span class="attr">y</span>: <span class="number">-16</span>,</div><div class="line">                        <span class="attr">d</span>: <span class="number">0</span></div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;;</div><div class="line">            <span class="comment">// set game level object for first time</span></div><div class="line">            game.levelObj = XP.parseByXP(game.totalDamage, hardSet.levelCap, hardSet.deltaNext);</div><div class="line">            <span class="comment">// first autoPlay target</span></div><div class="line">            autoPlay.setRandomTarget(game);</div><div class="line">            <span class="comment">// create cross object</span></div><div class="line">            game.cross = crossMod.create(&#123;</div><div class="line">                    <span class="attr">offsetX</span>: game.map.cellWidth * game.map.cellSize / <span class="number">2</span> * <span class="number">-1</span>,</div><div class="line">                    <span class="attr">offsetY</span>: game.map.cellHeight * game.map.cellSize / <span class="number">2</span> * <span class="number">-1</span>,</div><div class="line">                &#125;);</div><div class="line">            <span class="keyword">return</span> game;</div><div class="line">        &#125;,</div><div class="line"> </div><div class="line">        <span class="attr">update</span>: <span class="function"><span class="keyword">function</span> (<span class="params">game, secs</span>) </span>&#123;</div><div class="line"> </div><div class="line">            <span class="comment">// do not let secs go over hard coded max secs value</span></div><div class="line">            secs = secs &gt; hardSet.maxSecs ? hardSet.maxSecs : secs;</div><div class="line"> </div><div class="line">            game.shotRate = Weapons[game.weaponIndex].shotRate;</div><div class="line"> </div><div class="line">            <span class="comment">// cross object</span></div><div class="line">            crossMod.update(game.cross, secs);</div><div class="line"> </div><div class="line">            <span class="comment">// map</span></div><div class="line">            mapMod.clampOffset(game.map, game.cross.offset);</div><div class="line">            mapMod.update(game.map, secs);</div><div class="line"> </div><div class="line">            <span class="comment">// update pools</span></div><div class="line">            poolMod.update(game.shots, game, secs);</div><div class="line">            poolMod.update(game.explosions, game, secs);</div><div class="line"> </div><div class="line">            game.shotSecs += secs;</div><div class="line">            game.shotSecs = game.shotSecs &gt;= game.shotRate ? game.shotRate : game.shotSecs;</div><div class="line"> </div><div class="line">            <span class="comment">// shoot</span></div><div class="line">            <span class="keyword">if</span> (crossMod.isInInner(game.cross) &amp;&amp; game.cross.userDown) &#123;</div><div class="line">                shoot(game);</div><div class="line">            &#125;</div><div class="line"> </div><div class="line">            <span class="comment">// AutoPlay</span></div><div class="line">            autoPlay.update(game, secs);</div><div class="line"> </div><div class="line">            <span class="comment">// update level object</span></div><div class="line">            game.levelObj = XP.parseByXP(game.totalDamage, hardSet.levelCap, hardSet.deltaNext);</div><div class="line">            setWeaponsToLevel(game);</div><div class="line"> </div><div class="line">        &#125;</div><div class="line"> </div><div class="line">    &#125;</div><div class="line"> </div><div class="line">&#125;</div><div class="line">    ());</div></pre></td></tr></table></figure>
<h2 id="7-generate-sprite-sheets"><a href="#7-generate-sprite-sheets" class="headerlink" title="7 - generate sprite sheets"></a>7 - generate sprite sheets</h2><p>I wanted to at east start some kind of system that will be used to create sprite sheets. For now I just work out this genSheets module that creates sheets just for map cells. I am not happy with it thus far, and will get around to making a lot of changes here at a point in the future so I do not want to write to much about it.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> genSheets = (<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line"> </div><div class="line">    <span class="keyword">var</span> createSheet = <span class="function"><span class="keyword">function</span> (<span class="params">cellSize, cw, ch</span>) </span>&#123;</div><div class="line">        <span class="keyword">var</span> sheet = &#123;&#125;,</div><div class="line">        canvas = <span class="built_in">document</span>.createElement(<span class="string">'canvas'</span>),</div><div class="line">        ctx = canvas.getContext(<span class="string">'2d'</span>);</div><div class="line">        canvas.width = cellSize * cw;</div><div class="line">        canvas.height = cellSize * ch;</div><div class="line">        ctx.translate(<span class="number">0.5</span>, <span class="number">0.5</span>);</div><div class="line">        sheet.canvas = canvas;</div><div class="line">        sheet.ctx = ctx;</div><div class="line">        sheet.cellWidth = cw;</div><div class="line">        sheet.cellHeight = ch;</div><div class="line">        sheet.cellSize = cellSize;</div><div class="line">        <span class="keyword">return</span> sheet;</div><div class="line">    &#125;;</div><div class="line"> </div><div class="line">    <span class="keyword">var</span> drawBasicBox = <span class="function"><span class="keyword">function</span> (<span class="params">sheet, fill, stroke</span>) </span>&#123;</div><div class="line">        <span class="keyword">var</span> canvas = sheet.canvas,</div><div class="line">        ctx = sheet.ctx;</div><div class="line">        ctx.fillStyle = fill || <span class="string">'#008800'</span>;</div><div class="line">        ctx.fillRect(<span class="number">-1</span>, <span class="number">-1</span>, canvas.width + <span class="number">1</span>, canvas.height + <span class="number">1</span>);</div><div class="line">        ctx.strokeStyle = stroke || <span class="string">'lime'</span>;</div><div class="line">        <span class="keyword">var</span> i = <span class="number">0</span>,</div><div class="line">        s;</div><div class="line">        <span class="keyword">while</span> (i &lt; sheet.cellWidth) &#123;</div><div class="line">            ctx.save();</div><div class="line">            ctx.translate(<span class="number">16</span> + <span class="number">32</span> * i, <span class="number">16</span>);</div><div class="line">            s = <span class="number">28</span> - <span class="number">14</span> * (i / sheet.cellWidth);</div><div class="line">            ctx.beginPath();</div><div class="line">            ctx.rect(<span class="number">-14</span>, <span class="number">-14</span>, s, s);</div><div class="line">            ctx.stroke();</div><div class="line">            ctx.restore();</div><div class="line">            i += <span class="number">1</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line"> </div><div class="line">    <span class="keyword">var</span> sheets = [];</div><div class="line"> </div><div class="line">    [<span class="string">'#005500'</span>, <span class="string">'#000088'</span>, <span class="string">'#880000'</span>].forEach(<span class="function"><span class="keyword">function</span> (<span class="params">fill</span>) </span>&#123;</div><div class="line">        <span class="keyword">var</span> sheet = createSheet(<span class="number">32</span>, <span class="number">10</span>, <span class="number">1</span>),</div><div class="line">        canvas = sheet.canvas,</div><div class="line">        ctx = sheet.ctx;</div><div class="line">        drawBasicBox(sheet, fill, <span class="string">'#000000'</span>);</div><div class="line">        sheets.push(sheet);</div><div class="line">    &#125;);</div><div class="line"> </div><div class="line">    <span class="keyword">return</span> &#123;</div><div class="line">        <span class="attr">sheets</span>: sheets</div><div class="line">    &#125;;</div><div class="line"> </div><div class="line">&#125;</div><div class="line">    ());</div></pre></td></tr></table></figure>
<h2 id="8-The-draw-js-file"><a href="#8-The-draw-js-file" class="headerlink" title="8 - The draw.js file"></a>8 - The draw.js file</h2><p>So now that I have mt modules for creating state objects, I will now want a module with methods that are used to draw aspects of these state objects to a canvas element.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div><div class="line">306</div><div class="line">307</div><div class="line">308</div><div class="line">309</div><div class="line">310</div><div class="line">311</div><div class="line">312</div><div class="line">313</div><div class="line">314</div><div class="line">315</div><div class="line">316</div><div class="line">317</div><div class="line">318</div><div class="line">319</div><div class="line">320</div><div class="line">321</div><div class="line">322</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> draw = (<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line"> </div><div class="line">    <span class="keyword">var</span> hpColors = [<span class="string">'red'</span>, <span class="string">'orange'</span>, <span class="string">'lime'</span>];</div><div class="line"> </div><div class="line">    <span class="keyword">var</span> getHpColor = <span class="function"><span class="keyword">function</span> (<span class="params">per</span>) </span>&#123;</div><div class="line">        <span class="keyword">return</span> hpColors[<span class="built_in">Math</span>.floor((hpColors.length - <span class="number">0.01</span>) * per)];</div><div class="line">    &#125;;</div><div class="line"> </div><div class="line">    <span class="keyword">var</span> drawBar = <span class="function"><span class="keyword">function</span> (<span class="params">ctx, game, per, rStart, rLength, fill</span>) </span>&#123;</div><div class="line">        <span class="keyword">var</span> cross = game.cross,</div><div class="line">        center = cross.center;</div><div class="line">        ctx.lineWidth = <span class="number">3</span>;</div><div class="line">        ctx.strokeStyle = <span class="string">'gray'</span>;</div><div class="line">        ctx.beginPath();</div><div class="line">        ctx.arc(center.x, center.y, cross.radiusInner + <span class="number">5</span>, rStart, rStart + rLength);</div><div class="line">        ctx.stroke();</div><div class="line">        ctx.strokeStyle = fill || <span class="string">'lime'</span>;</div><div class="line">        ctx.beginPath();</div><div class="line">        ctx.arc(center.x, center.y, cross.radiusInner + <span class="number">5</span>, rStart, rStart + rLength * per);</div><div class="line">        ctx.stroke();</div><div class="line">    &#125;;</div><div class="line"> </div><div class="line">    <span class="comment">// draw the inner and outer cross circles</span></div><div class="line">    <span class="keyword">var</span> drawCrossCircles = <span class="function"><span class="keyword">function</span> (<span class="params">ctx, cross</span>) </span>&#123;</div><div class="line">        ctx.strokeStyle = <span class="string">'rgba(255,255,255,0.4)'</span>;</div><div class="line">        ctx.fillStyle = <span class="string">'rgba(255,0,0,0.4)'</span>;</div><div class="line">        ctx.lineWidth = <span class="number">1</span>;</div><div class="line">        ctx.beginPath();</div><div class="line">        ctx.arc(cross.center.x, cross.center.y, cross.radiusInner, <span class="number">0</span>, <span class="built_in">Math</span>.PI * <span class="number">2</span>);</div><div class="line">        ctx.stroke();</div><div class="line">        ctx.fill();</div><div class="line">        ctx.fillStyle = <span class="string">'rgba(0,0,0,0.2)'</span>;</div><div class="line">        ctx.beginPath();</div><div class="line">        ctx.arc(cross.center.x, cross.center.y, cross.radiusOuter, <span class="number">0</span>, <span class="built_in">Math</span>.PI * <span class="number">2</span>);</div><div class="line">        ctx.stroke();</div><div class="line">        ctx.fill();</div><div class="line">        ctx.beginPath();</div><div class="line">        ctx.arc(cross.crosshairs.x, cross.crosshairs.y, cross.crosshairs.radius, <span class="number">0</span>, <span class="built_in">Math</span>.PI * <span class="number">2</span>);</div><div class="line">        ctx.stroke();</div><div class="line">    &#125;;</div><div class="line"> </div><div class="line">    <span class="keyword">var</span> drawCrossHairs = <span class="function"><span class="keyword">function</span> (<span class="params">ctx, cross</span>) </span>&#123;</div><div class="line">        <span class="keyword">var</span> ch = cross.crosshairs;</div><div class="line">        ctx.strokeStyle = <span class="string">'rgba(200,0,0,0.5)'</span>;</div><div class="line">        ctx.lineWidth = <span class="number">2</span>;</div><div class="line">        ctx.beginPath();</div><div class="line">        ctx.moveTo(ch.x, ch.y - ch.radius * <span class="number">1.5</span>);</div><div class="line">        ctx.lineTo(ch.x, ch.y + ch.radius * <span class="number">1.5</span>);</div><div class="line">        ctx.stroke();</div><div class="line">        ctx.beginPath();</div><div class="line">        ctx.moveTo(ch.x - ch.radius * <span class="number">1.5</span>, ch.y);</div><div class="line">        ctx.lineTo(ch.x + ch.radius * <span class="number">1.5</span>, ch.y);</div><div class="line">        ctx.stroke();</div><div class="line">    &#125;;</div><div class="line"> </div><div class="line">    <span class="keyword">var</span> drawPercentRemainBar = <span class="function"><span class="keyword">function</span> (<span class="params">ctx, game</span>) </span>&#123;</div><div class="line">        <span class="keyword">var</span> cross = game.cross,</div><div class="line">        center = cross.center,</div><div class="line">        map = game.map;</div><div class="line">        drawBar(ctx, game, map.percentRemain, <span class="built_in">Math</span>.PI, <span class="built_in">Math</span>.PI / <span class="number">2</span>, getHpColor(map.percentRemain));</div><div class="line">    &#125;;</div><div class="line"> </div><div class="line">    <span class="keyword">var</span> drawAutoPlayDelayBar = <span class="function"><span class="keyword">function</span> (<span class="params">ctx, game</span>) </span>&#123;</div><div class="line">        <span class="keyword">var</span> ap = game.autoPlay;</div><div class="line">        drawBar(ctx, game, ap.delay / ap.maxDelay, <span class="number">0</span>, <span class="built_in">Math</span>.PI / <span class="number">4</span>, <span class="string">'cyan'</span>);</div><div class="line">    &#125;;</div><div class="line"> </div><div class="line">    <span class="comment">// draw the current weapon info</span></div><div class="line">    <span class="keyword">var</span> drawWeaponInfo = <span class="function"><span class="keyword">function</span> (<span class="params">ctx, game</span>) </span>&#123;</div><div class="line">        <span class="keyword">var</span> center = game.cross.center;</div><div class="line">        <span class="keyword">var</span> w = gameMod.Weapons[game.weaponIndex];</div><div class="line">        ctx.fillStyle = <span class="string">'#ff6060'</span>;</div><div class="line">        ctx.font = <span class="string">'10px courier'</span>;</div><div class="line">        ctx.textAlign = <span class="string">'center'</span>;</div><div class="line">        ctx.fillText(<span class="string">'Weapon: '</span> + w.name, center.x, center.y + <span class="number">75</span>);</div><div class="line">        ctx.fillText(<span class="string">'maxDPS: '</span> + w.maxDPS, center.x, center.y + <span class="number">85</span>);</div><div class="line"> </div><div class="line">    &#125;;</div><div class="line"> </div><div class="line">    <span class="comment">// draw a health bar for a cell</span></div><div class="line">    <span class="keyword">var</span> drawCellHealthBar = <span class="function"><span class="keyword">function</span> (<span class="params">ctx, map, cell, cross</span>) </span>&#123;</div><div class="line">        <span class="keyword">var</span> x = cell.x * map.cellSize + cross.offset.x + (<span class="number">320</span> / <span class="number">2</span>),</div><div class="line">        y = cell.y * map.cellSize + cross.offset.y + (<span class="number">240</span> / <span class="number">2</span>);</div><div class="line">        <span class="comment">//ctx.fillStyle = 'rgba(0,255,0,0.4)';</span></div><div class="line">        ctx.fillStyle = getHpColor(cell.HP / cell.maxHP);</div><div class="line">        ctx.globalAlpha = <span class="number">0.5</span>;</div><div class="line">        ctx.fillRect(x, y, map.cellSize * (cell.HP / cell.maxHP), <span class="number">5</span>);</div><div class="line">        ctx.globalAlpha = <span class="number">1</span>;</div><div class="line">    &#125;;</div><div class="line"> </div><div class="line">    <span class="keyword">var</span> setupDebug = <span class="function"><span class="keyword">function</span> (<span class="params">ctx, game</span>) </span>&#123;</div><div class="line">        ctx.fillStyle = <span class="string">'rgba(0,0,0,0.4)'</span>;</div><div class="line">        ctx.textBaseline = <span class="string">'top'</span>;</div><div class="line">        ctx.textAlign = <span class="string">'left'</span>;</div><div class="line">        ctx.fillRect(<span class="number">0</span>, <span class="number">0</span>, game.canvas.width, game.canvas.height);</div><div class="line">        ctx.fillStyle = <span class="string">'yellow'</span>;</div><div class="line">        ctx.textBaseline = <span class="string">'top'</span>;</div><div class="line">        ctx.font = <span class="string">'10px courier'</span>;</div><div class="line">    &#125;;</div><div class="line"> </div><div class="line">    <span class="keyword">var</span> cellLevel = <span class="function"><span class="keyword">function</span> (<span class="params">ctx, cell, x, y</span>) </span>&#123;</div><div class="line">        <span class="keyword">if</span> (cell.active) &#123;</div><div class="line">            ctx.fillStyle = <span class="string">'rgba(255,255,255,0.5)'</span>;</div><div class="line">            ctx.font = <span class="string">'7px courier'</span>;</div><div class="line">            ctx.fillText(<span class="string">'L'</span> + <span class="built_in">Math</span>.floor(cell.levelObj.level), x + <span class="number">3</span>, y + <span class="number">3</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line">    <span class="comment">/*</span></div><div class="line">    var cellDebug = function (ctx, cell, x, y) &#123;</div><div class="line">    ctx.fillStyle = '#00ff00';</div><div class="line">    ctx.font = '8px courier';</div><div class="line">    ctx.fillText('L' + Math.floor(cell.levelObj.level), x, y);</div><div class="line">    ctx.fillText(Math.floor(cell.damagePer * 100) + '%', x, y + 8);</div><div class="line">    ctx.fillText(Math.floor(cell.damage), x, y + 16);</div><div class="line">    ctx.fillText(Math.floor(cell.maxHP), x, y + 24);</div><div class="line">    &#125;;</div><div class="line">     */</div><div class="line">    <span class="keyword">var</span> debugModes = &#123;</div><div class="line">        <span class="attr">none</span>: <span class="function"><span class="keyword">function</span> (<span class="params">sm</span>) </span>&#123;&#125;,</div><div class="line">        <span class="attr">general</span>: <span class="function"><span class="keyword">function</span> (<span class="params">sm</span>) </span>&#123;</div><div class="line">            <span class="keyword">var</span> ctx = sm.ctx,</div><div class="line">            canvas = sm.canvas,</div><div class="line">            game = sm.game;</div><div class="line">            setupDebug(ctx, sm.game);</div><div class="line">            ctx.fillText(<span class="string">'pos: '</span> + game.cross.offset.x.toFixed(<span class="number">2</span>) + <span class="string">','</span> + game.cross.offset.y.toFixed(<span class="number">2</span>), <span class="number">10</span>, <span class="number">10</span>);</div><div class="line">            ctx.fillText(<span class="string">'percent remain: '</span> + <span class="built_in">Number</span>(game.map.percentRemain * <span class="number">100</span>).toFixed(<span class="number">2</span>), <span class="number">10</span>, <span class="number">20</span>);</div><div class="line">            ctx.fillText(<span class="string">'weapon: '</span> + gameMod.Weapons[game.weaponIndex].name, <span class="number">10</span>, <span class="number">30</span>);</div><div class="line">            ctx.fillText(<span class="string">'damage: '</span> + <span class="built_in">Math</span>.floor(game.totalDamage), <span class="number">10</span>, <span class="number">40</span>);</div><div class="line">            ctx.fillText(<span class="string">'high damage cell: '</span> + <span class="built_in">Math</span>.floor(game.map.highDamageCell), <span class="number">10</span>, <span class="number">50</span>);</div><div class="line">        &#125;,</div><div class="line">        <span class="attr">weapon</span>: <span class="function"><span class="keyword">function</span> (<span class="params">sm</span>) </span>&#123;</div><div class="line">            <span class="keyword">var</span> ctx = sm.ctx;</div><div class="line">            setupDebug(ctx, sm.game);</div><div class="line">            <span class="keyword">var</span> w = gameMod.Weapons[sm.game.weaponIndex];</div><div class="line">            ctx.fillText(<span class="string">'Current weapon: '</span>, <span class="number">10</span>, <span class="number">10</span>);</div><div class="line">            ctx.fillText(<span class="string">'name: '</span> + w.name, <span class="number">10</span>, <span class="number">20</span>);</div><div class="line">            ctx.fillText(<span class="string">'maxDPS: '</span> + w.maxDPS, <span class="number">10</span>, <span class="number">30</span>);</div><div class="line">            ctx.fillText(<span class="string">'accuracy: '</span> + w.accuracy.toFixed(<span class="number">2</span>), <span class="number">10</span>, <span class="number">40</span>);</div><div class="line">        &#125;,</div><div class="line">        <span class="attr">level</span>: <span class="function"><span class="keyword">function</span> (<span class="params">sm</span>) </span>&#123;</div><div class="line">            <span class="keyword">var</span> ctx = sm.ctx,</div><div class="line">            lv = sm.game.levelObj;</div><div class="line">            setupDebug(ctx, sm.game);</div><div class="line">            ctx.fillText(<span class="string">'Current level: '</span> + lv.level, <span class="number">10</span>, <span class="number">10</span>);</div><div class="line">            ctx.fillText(<span class="string">'xp: '</span> + lv.xp, <span class="number">10</span>, <span class="number">20</span>);</div><div class="line">            ctx.fillText(<span class="string">'forNext level: '</span> + lv.forNext, <span class="number">10</span>, <span class="number">30</span>);</div><div class="line">            ctx.fillText(<span class="string">'toNext level: '</span> + lv.toNext, <span class="number">10</span>, <span class="number">40</span>);</div><div class="line">            ctx.fillText(<span class="string">'per: '</span> + lv.per.toFixed(<span class="number">2</span>), <span class="number">10</span>, <span class="number">50</span>);</div><div class="line">            ctx.fillText(<span class="string">'forLast: '</span> + lv.forLast, <span class="number">10</span>, <span class="number">60</span>);</div><div class="line">        &#125;,</div><div class="line">        <span class="attr">map</span>: <span class="function"><span class="keyword">function</span> (<span class="params">sm</span>) </span>&#123;</div><div class="line">            <span class="keyword">var</span> ctx = sm.ctx,</div><div class="line">            map = sm.game.map;</div><div class="line">            setupDebug(ctx, sm.game);</div><div class="line">            ctx.fillText(<span class="string">'map.percentRemain: '</span> + map.percentRemain, <span class="number">10</span>, <span class="number">10</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line"> </div><div class="line">    <span class="keyword">var</span> cellTypeColors = [<span class="string">'green'</span>, <span class="string">'blue'</span>, <span class="string">'red'</span>],</div><div class="line">    sheets = genSheets.sheets;</div><div class="line"> </div><div class="line">    <span class="keyword">return</span> &#123;</div><div class="line">        <span class="comment">// draw background</span></div><div class="line">        back: <span class="function"><span class="keyword">function</span> (<span class="params">ctx, canvas</span>) </span>&#123;</div><div class="line">            ctx.fillStyle = <span class="string">'black'</span>;</div><div class="line">            ctx.fillRect(<span class="number">0</span>, <span class="number">0</span>, canvas.width, canvas.height);</div><div class="line">        &#125;,</div><div class="line">        <span class="comment">// draw cross hairs</span></div><div class="line">        cross: <span class="function"><span class="keyword">function</span> (<span class="params">ctx, game</span>) </span>&#123;</div><div class="line"> </div><div class="line">            <span class="comment">// draw basic circles</span></div><div class="line">            drawCrossCircles(ctx, game.cross);</div><div class="line"> </div><div class="line">            <span class="comment">// bars</span></div><div class="line">            drawPercentRemainBar(ctx, game); <span class="comment">// percentRemain</span></div><div class="line">            drawAutoPlayDelayBar(ctx, game); <span class="comment">// autoPlay delay</span></div><div class="line">            drawBar(ctx, game, game.shotSecs / game.shotRate, <span class="built_in">Math</span>.PI * <span class="number">0.33</span>, <span class="built_in">Math</span>.PI * <span class="number">0.33</span>, <span class="string">'red'</span>); <span class="comment">// shotRate</span></div><div class="line">            drawBar(ctx, game, game.levelObj.per, <span class="built_in">Math</span>.PI * <span class="number">1.69</span>, <span class="built_in">Math</span>.PI * <span class="number">0.3</span>, <span class="string">'blue'</span>); <span class="comment">// next level</span></div><div class="line"> </div><div class="line">            <span class="comment">// weapon info</span></div><div class="line">            drawWeaponInfo(ctx, game);</div><div class="line"> </div><div class="line">            <span class="comment">// draw cell and level info</span></div><div class="line">            <span class="keyword">var</span> cross = game.cross,</div><div class="line">            map = game.map,</div><div class="line">            ch = game.cross.crosshairs,</div><div class="line">            cell = mapMod.getWithCanvasPointAndOffset(game.map, ch.x, ch.y, cross.offset.x, cross.offset.y),</div><div class="line">            x = cross.center.x + cross.radiusOuter - <span class="number">45</span>,</div><div class="line">            y = cross.center.y;</div><div class="line"> </div><div class="line">            <span class="comment">// text atyle for info</span></div><div class="line">            ctx.fillStyle = <span class="string">'white'</span>;</div><div class="line">            ctx.textBaseline = <span class="string">'top'</span>;</div><div class="line">            ctx.textAlign = <span class="string">'left'</span>;</div><div class="line">            ctx.font = <span class="string">'8px arial'</span>;</div><div class="line"> </div><div class="line">            <span class="comment">// level info</span></div><div class="line">            ctx.fillText(<span class="string">'level: '</span> + game.levelObj.level, x, y - <span class="number">40</span>);</div><div class="line">            ctx.fillText(<span class="string">'xp: '</span> + <span class="built_in">Math</span>.floor(game.levelObj.xp), x, y - <span class="number">30</span>);</div><div class="line">            ctx.fillText(<span class="string">'next: '</span> + <span class="built_in">Math</span>.floor(game.levelObj.toNext), x, y - <span class="number">20</span>);</div><div class="line"> </div><div class="line">            <span class="comment">// cell info</span></div><div class="line">            <span class="keyword">if</span> (cell) &#123;</div><div class="line">                ctx.fillText(<span class="string">'pos: '</span> + cell.i + <span class="string">' ('</span> + cell.x + <span class="string">','</span> + cell.y + <span class="string">')'</span>, x, y);</div><div class="line">                ctx.fillText(<span class="string">'lv:'</span> + cell.levelObj.level, x, y + <span class="number">10</span>);</div><div class="line">                ctx.fillText(<span class="string">'hp:'</span> + <span class="built_in">Math</span>.floor(cell.HP) + <span class="string">'/'</span> + <span class="built_in">Math</span>.floor(cell.maxHP), x, y + <span class="number">20</span>);</div><div class="line">                ctx.fillText(<span class="string">'dam: '</span> + <span class="built_in">Math</span>.floor(cell.damage) + <span class="string">' ('</span> + <span class="built_in">Math</span>.round(cell.damagePer * <span class="number">100</span>) + <span class="string">'%)'</span>, x, y + <span class="number">30</span>);</div><div class="line"> </div><div class="line">                <span class="comment">// draw target cell</span></div><div class="line">                ctx.strokeStyle = <span class="string">'rgba(255,255,255,0.4)'</span>;</div><div class="line">                ctx.lineWidth = <span class="number">3</span>;</div><div class="line">                ctx.strokeRect(cell.x * map.cellSize + cross.offset.x + (<span class="number">320</span> / <span class="number">2</span>), cell.y * map.cellSize + cross.offset.y + (<span class="number">240</span> / <span class="number">2</span>), map.cellSize, map.cellSize);</div><div class="line">            &#125;</div><div class="line"> </div><div class="line">            <span class="comment">// draw the cross hairs</span></div><div class="line">            drawCrossHairs(ctx, game.cross);</div><div class="line"> </div><div class="line">        &#125;,</div><div class="line">        <span class="comment">// draw map</span></div><div class="line">        map: <span class="function"><span class="keyword">function</span> (<span class="params">ctx, map, cross</span>) </span>&#123;</div><div class="line">            ctx.strokeStyle = <span class="string">'grey'</span>;</div><div class="line">            ctx.lineWidth = <span class="number">3</span>;</div><div class="line">            map.cells.forEach(<span class="function"><span class="keyword">function</span> (<span class="params">cell</span>) </span>&#123;</div><div class="line">                <span class="keyword">var</span> x = cell.x * map.cellSize + cross.offset.x + (<span class="number">320</span> / <span class="number">2</span>),</div><div class="line">                y = cell.y * map.cellSize + cross.offset.y + (<span class="number">240</span> / <span class="number">2</span>),</div><div class="line">                per = cell.HP / cell.maxHP;</div><div class="line">                <span class="keyword">if</span> (cell.active) &#123;</div><div class="line">                    <span class="comment">// for active cell</span></div><div class="line">                    ctx.drawImage(sheets[cell.typeIndex].canvas, <span class="number">32</span> * <span class="built_in">Math</span>.floor(<span class="number">9</span> - cell.HP / cell.maxHP * <span class="number">9</span>), <span class="number">0</span>, <span class="number">32</span>, <span class="number">32</span>, x, y, map.cellSize, map.cellSize);</div><div class="line">                    <span class="keyword">if</span> (per &lt; <span class="number">1</span>) &#123;</div><div class="line">                        drawCellHealthBar(ctx, map, cell, cross);</div><div class="line">                    &#125;</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    <span class="comment">// for inactive cell</span></div><div class="line">                    ctx.lineWidth = <span class="number">1</span>;</div><div class="line">                    <span class="keyword">var</span> c = <span class="number">50</span> + <span class="built_in">Math</span>.round(<span class="number">200</span> * cell.damagePer);</div><div class="line">                    ctx.strokeStyle = <span class="string">'rgba(0,128,128, 0.4)'</span>;</div><div class="line">                    ctx.fillStyle = <span class="string">'rgba(0,'</span> + c + <span class="string">','</span> + c + <span class="string">', 0.7)'</span>;</div><div class="line">                    ctx.beginPath();</div><div class="line">                    ctx.rect(x, y, map.cellSize, map.cellSize);</div><div class="line">                    ctx.fill();</div><div class="line">                    ctx.stroke();</div><div class="line">                &#125;</div><div class="line">                cellLevel(ctx, cell, x, y);</div><div class="line">                <span class="comment">//cellDebug(ctx, cell, x, y);</span></div><div class="line">            &#125;);</div><div class="line">        &#125;,</div><div class="line">        <span class="attr">shots</span>: <span class="function"><span class="keyword">function</span> (<span class="params">ctx, game</span>) </span>&#123;</div><div class="line">            <span class="keyword">var</span> shots = game.shots,</div><div class="line">            i = shots.length,</div><div class="line">            shot;</div><div class="line">            <span class="keyword">while</span> (i--) &#123;</div><div class="line">                shot = shots[i];</div><div class="line">                ctx.fillStyle = <span class="string">'white'</span>;</div><div class="line">                ctx.strokeStyle = <span class="string">'black'</span>;</div><div class="line">                <span class="keyword">if</span> (shot.active) &#123;</div><div class="line">                    ctx.beginPath();</div><div class="line">                    ctx.arc(shot.x, shot.y, shot.radius, <span class="number">0</span>, <span class="built_in">Math</span>.PI * <span class="number">2</span>);</div><div class="line">                    ctx.fill();</div><div class="line">                    ctx.stroke();</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;,</div><div class="line">        <span class="attr">explosions</span>: <span class="function"><span class="keyword">function</span> (<span class="params">ctx, game</span>) </span>&#123;</div><div class="line">            <span class="keyword">var</span> exps = game.explosions,</div><div class="line">            i = exps.length,</div><div class="line">            alpha = <span class="number">0.5</span>,</div><div class="line">            ex;</div><div class="line">            <span class="keyword">while</span> (i--) &#123;</div><div class="line">                ex = exps[i];</div><div class="line">                alpha = <span class="number">1</span> - ex.per;</div><div class="line">                ctx.fillStyle = <span class="string">'rgba(255,255,0,'</span> + alpha + <span class="string">')'</span>;</div><div class="line">                ctx.strokeStyle = <span class="string">'rgba(0,0,0,'</span> + alpha + <span class="string">')'</span>;</div><div class="line"> </div><div class="line">                <span class="keyword">if</span> (ex.active) &#123;</div><div class="line">                    ctx.beginPath();</div><div class="line">                    ctx.arc(ex.x, ex.y, ex.radius, <span class="number">0</span>, <span class="built_in">Math</span>.PI * <span class="number">2</span>);</div><div class="line">                    ctx.fill();</div><div class="line">                    ctx.stroke();</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;,</div><div class="line">        <span class="attr">buttons</span>: <span class="function"><span class="keyword">function</span> (<span class="params">ctx, buttons</span>) </span>&#123;</div><div class="line">            <span class="built_in">Object</span>.keys(buttons).forEach(<span class="function"><span class="keyword">function</span> (<span class="params">key</span>) </span>&#123;</div><div class="line">                <span class="keyword">var</span> b = buttons[key];</div><div class="line">                ctx.fillStyle = <span class="string">'red'</span>;</div><div class="line">                <span class="keyword">if</span> (b.type === <span class="string">'toggle'</span> &amp;&amp; b.bool) &#123;</div><div class="line">                    ctx.fillStyle = <span class="string">'lime'</span>;</div><div class="line">                &#125;</div><div class="line">                ctx.strokeStyle = <span class="string">'gray'</span>;</div><div class="line">                ctx.lineWidth = <span class="number">1</span>;</div><div class="line">                ctx.beginPath();</div><div class="line">                ctx.arc(b.x, b.y, b.r, <span class="number">0</span>, <span class="built_in">Math</span>.PI * <span class="number">2</span>);</div><div class="line">                ctx.fill();</div><div class="line">                ctx.stroke();</div><div class="line">                ctx.textBaseline = <span class="string">'middle'</span>;</div><div class="line">                ctx.textAlign = <span class="string">'center'</span>;</div><div class="line">                ctx.fillStyle = <span class="string">'white'</span>;</div><div class="line">                ctx.font = (b.fontSize || <span class="number">10</span>) + <span class="string">'px arial'</span>;</div><div class="line">                <span class="keyword">if</span> (b.type === <span class="string">'options'</span>) &#123;</div><div class="line">                    <span class="keyword">var</span> str = b.options[b.currentOption || <span class="number">0</span>];</div><div class="line">                    ctx.fillText(str, b.x, b.y);</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">if</span> (b.type === <span class="string">'basic'</span>) &#123;</div><div class="line">                    ctx.fillText(b.label, b.x, b.y);</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">if</span> (b.type === <span class="string">'toggle'</span>) &#123;</div><div class="line">                    ctx.fillText(b.label, b.x, b.y);</div><div class="line">                &#125;</div><div class="line">            &#125;);</div><div class="line">        &#125;,</div><div class="line">        <span class="attr">debug</span>: <span class="function"><span class="keyword">function</span> (<span class="params">sm</span>) </span>&#123;</div><div class="line">            debugModes[sm.debugMode](sm, sm.ctx, sm.canvas);</div><div class="line">        &#125;,</div><div class="line">        <span class="attr">ver</span>: <span class="function"><span class="keyword">function</span> (<span class="params">ctx, sm</span>) </span>&#123;</div><div class="line">            ctx.fillStyle = <span class="string">'#dfdfdf'</span>;</div><div class="line">            ctx.textAlign = <span class="string">'left'</span>;</div><div class="line">            ctx.fillText(<span class="string">'v'</span> + sm.ver, <span class="number">10</span>, sm.canvas.height - <span class="number">15</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line">    ());</div></pre></td></tr></table></figure>
<h2 id="9-Buttons"><a href="#9-Buttons" class="headerlink" title="9 - Buttons"></a>9 - Buttons</h2><p>I have a module that helps me with creating button objects that I place in the canvas to preform certain actions. This way I can pull a lot of code that has to do with checking if a pointer position is over a button display object, or common button tasks like looping an index value for an option and so forth away from the main state machine and into its own module.</p>
<p>As of this writing I have just three button types, but in future releases I intend to add additional types that have to do with contorting settings of things like an upgrades menu and so forth.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> buttonMod = (<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line"> </div><div class="line">    <span class="comment">// setup a button object depending on type</span></div><div class="line">    <span class="keyword">var</span> setupType = <span class="function"><span class="keyword">function</span> (<span class="params">button, opt</span>) </span>&#123;</div><div class="line">        <span class="comment">// setup for 'options' type</span></div><div class="line">        <span class="keyword">if</span> (button.type === <span class="string">'options'</span>) &#123;</div><div class="line">            button.options = opt.options || [];</div><div class="line">            button.currentOption = <span class="number">0</span>;</div><div class="line">            button.label = button.options[<span class="number">0</span>];</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// setup a 'toggle' type</span></div><div class="line">        <span class="keyword">if</span> (button.type === <span class="string">'toggle'</span>) &#123;</div><div class="line">            button.bool = opt.bool || <span class="literal">false</span>;</div><div class="line">            button.onActive = opt.onActive || <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;&#125;;</div><div class="line">            button.onInactive = opt.onInactive || <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;&#125;;</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line"> </div><div class="line">    <span class="keyword">var</span> beforeOnClick = &#123;</div><div class="line">        <span class="attr">basic</span>: <span class="function"><span class="keyword">function</span> (<span class="params">button, api</span>) </span>&#123;&#125;,</div><div class="line">        <span class="attr">options</span>: <span class="function"><span class="keyword">function</span> (<span class="params">button, api</span>) </span>&#123;</div><div class="line">            button.currentOption += <span class="number">1</span>;</div><div class="line">            button.currentOption = button.currentOption &gt;= button.options.length ? <span class="number">0</span> : button.currentOption;</div><div class="line">        &#125;,</div><div class="line">        <span class="attr">toggle</span>: <span class="function"><span class="keyword">function</span> (<span class="params">button, api</span>) </span>&#123;</div><div class="line">            button.bool = !button.bool;</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line"> </div><div class="line">    <span class="keyword">var</span> afterOnClick = &#123;</div><div class="line">        <span class="attr">basic</span>: <span class="function"><span class="keyword">function</span> (<span class="params">button, api</span>) </span>&#123;&#125;,</div><div class="line">        <span class="attr">options</span>: <span class="function"><span class="keyword">function</span> (<span class="params">button, api</span>) </span>&#123;&#125;,</div><div class="line">        <span class="attr">toggle</span>: <span class="function"><span class="keyword">function</span> (<span class="params">button, api</span>) </span>&#123;</div><div class="line">            <span class="keyword">if</span> (button.bool) &#123;</div><div class="line">                button.onActive(button, api);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                button.onInactive(button, api);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line"> </div><div class="line">    <span class="keyword">return</span> &#123;</div><div class="line"> </div><div class="line">        <span class="comment">// create a single button</span></div><div class="line">        create: <span class="function"><span class="keyword">function</span> (<span class="params">opt</span>) </span>&#123;</div><div class="line">            opt = opt || &#123;&#125;;</div><div class="line">            <span class="keyword">var</span> button = &#123;</div><div class="line">                <span class="attr">x</span>: opt.x === <span class="literal">undefined</span> ? <span class="number">0</span> : opt.x,</div><div class="line">                <span class="attr">y</span>: opt.y === <span class="literal">undefined</span> ? <span class="number">0</span> : opt.y,</div><div class="line">                <span class="attr">r</span>: opt.r === <span class="literal">undefined</span> ? <span class="number">16</span> : opt.r,</div><div class="line">                <span class="attr">label</span>: opt.label || <span class="string">''</span>,</div><div class="line">                <span class="attr">type</span>: opt.type || <span class="string">'basic'</span>,</div><div class="line">                <span class="attr">onClick</span>: opt.onClick || <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;&#125;</div><div class="line">            &#125;;</div><div class="line">            setupType(button, opt);</div><div class="line">            <span class="keyword">return</span> button;</div><div class="line">        &#125;,</div><div class="line"> </div><div class="line">        <span class="comment">// check the given button collection</span></div><div class="line">        pointerCheckCollection: <span class="function"><span class="keyword">function</span> (<span class="params">collection, point, api</span>) </span>&#123;</div><div class="line">            <span class="keyword">var</span> keys = <span class="built_in">Object</span>.keys(collection),</div><div class="line">            i = keys.length,</div><div class="line">            button,</div><div class="line">            d;</div><div class="line">            <span class="keyword">while</span> (i--) &#123;</div><div class="line">                button = collection[keys[i]];</div><div class="line">                d = utils.distance(point.x, point.y, button.x, button.y);</div><div class="line">                <span class="keyword">if</span> (d &lt; button.r) &#123;</div><div class="line">                    beforeOnClick[button.type](button, api);</div><div class="line">                    button.onClick(button, api);</div><div class="line">                    afterOnClick[button.type](button, api)</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line">&#125;</div><div class="line">    ());</div></pre></td></tr></table></figure>
<h2 id="10-Now-for-a-Main-js-file-along-with-a-main-app-loop"><a href="#10-Now-for-a-Main-js-file-along-with-a-main-app-loop" class="headerlink" title="10 - Now for a Main.js file along with a main app loop"></a>10 - Now for a Main.js file along with a main app loop</h2><p>So now I need some additional code to pull everything together here in a main.js file that will be used after everything else is in place to work with. Here I create and inject a canvas element into a hard coded container element that I have in my html. I create instances of a map and cross state objects, and attach a whole bunch of event handers for mouse and touch events using the create event method of the cross module.</p>
<p>I then have an attack method that I will likely work into the map module, or some kind of future module that has to do with a weapons or something to that effect. I do not want to get into to much detail with that because at some point in the future I will just have to re write what I have to say about it when it comes to putting a little more time into this canvas example, because I think this one needs and deserve more work.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// MAIN file including state machine</span></div><div class="line">(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line"> </div><div class="line">    <span class="keyword">var</span> canvas = <span class="built_in">document</span>.createElement(<span class="string">'canvas'</span>),</div><div class="line">    ctx = canvas.getContext(<span class="string">'2d'</span>),</div><div class="line">    container = <span class="built_in">document</span>.getElementById(<span class="string">'canvas-app'</span>) || <span class="built_in">document</span>.body;</div><div class="line">    container.appendChild(canvas);</div><div class="line">    canvas.width = <span class="number">320</span>;</div><div class="line">    canvas.height = <span class="number">240</span>;</div><div class="line">    ctx.translate(<span class="number">0.5</span>, <span class="number">0.5</span>);</div><div class="line"> </div><div class="line">    <span class="keyword">var</span> states = &#123;</div><div class="line"> </div><div class="line">        <span class="attr">options</span>: &#123;</div><div class="line"> </div><div class="line">            <span class="comment">// button objects for the state</span></div><div class="line">            buttons: &#123;</div><div class="line">                <span class="attr">toGame</span>: buttonMod.create(&#123;</div><div class="line">                    <span class="attr">label</span>: <span class="string">'game'</span>,</div><div class="line">                    <span class="attr">x</span>: <span class="number">25</span>,</div><div class="line">                    <span class="attr">y</span>: <span class="number">200</span>,</div><div class="line">                    <span class="attr">r</span>: <span class="number">10</span>,</div><div class="line">                    <span class="attr">onClick</span>: <span class="function"><span class="keyword">function</span> (<span class="params">button, sm</span>) </span>&#123;</div><div class="line">                        <span class="comment">// set state to game</span></div><div class="line">                        sm.currentState = <span class="string">'game'</span>;</div><div class="line">                    &#125;</div><div class="line">                &#125;),</div><div class="line">                <span class="attr">debugMode</span>: buttonMod.create(&#123;</div><div class="line">                    <span class="attr">x</span>: <span class="number">100</span>,</div><div class="line">                    <span class="attr">y</span>: <span class="number">120</span>,</div><div class="line">                    <span class="attr">r</span>: <span class="number">16</span>,</div><div class="line">                    <span class="attr">type</span>: <span class="string">'options'</span>,</div><div class="line">                    <span class="attr">options</span>: [<span class="string">'none'</span>, <span class="string">'general'</span>, <span class="string">'weapon'</span>, <span class="string">'level'</span>, <span class="string">'map'</span>],</div><div class="line">                    <span class="attr">onClick</span>: <span class="function"><span class="keyword">function</span> (<span class="params">button, sm</span>) </span>&#123;</div><div class="line">                        sm.debugMode = button.options[button.currentOption];</div><div class="line">                    &#125;</div><div class="line">                &#125;)</div><div class="line">            &#125;,</div><div class="line"> </div><div class="line">            <span class="comment">// for each update tick</span></div><div class="line">            update: <span class="function"><span class="keyword">function</span> (<span class="params">sm, secs</span>) </span>&#123;</div><div class="line">                <span class="keyword">var</span> state = states[sm.currentState];</div><div class="line">                draw.back(ctx, canvas);</div><div class="line">                draw.buttons(ctx, state.buttons);</div><div class="line">                draw.debug(sm);</div><div class="line">            &#125;,</div><div class="line"> </div><div class="line">            <span class="comment">// events</span></div><div class="line">            pointerStart: <span class="function"><span class="keyword">function</span> (<span class="params">sm, e</span>) </span>&#123;</div><div class="line">                <span class="keyword">var</span> state = states[sm.currentState],</div><div class="line">                buttons = state.buttons,</div><div class="line">                pos = utils.getCanvasRelative(e);</div><div class="line">                <span class="comment">// check buttons for options state</span></div><div class="line">                buttonMod.pointerCheckCollection(state.buttons, pos, sm);</div><div class="line"> </div><div class="line">            &#125;,</div><div class="line">            <span class="attr">pointerMove</span>: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;&#125;,</div><div class="line">            <span class="attr">pointerEnd</span>: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;&#125;</div><div class="line">        &#125;,</div><div class="line"> </div><div class="line">        <span class="attr">game</span>: &#123;</div><div class="line"> </div><div class="line">            <span class="attr">buttons</span>: &#123;</div><div class="line">                <span class="attr">options</span>: buttonMod.create(&#123;</div><div class="line">                    <span class="attr">label</span>: <span class="string">'options'</span>,</div><div class="line">                    <span class="attr">fontSize</span>: <span class="number">10</span>,</div><div class="line">                    <span class="attr">x</span>: <span class="number">25</span>,</div><div class="line">                    <span class="attr">y</span>: <span class="number">200</span>,</div><div class="line">                    <span class="attr">r</span>: <span class="number">10</span>,</div><div class="line">                    <span class="attr">onClick</span>: <span class="function"><span class="keyword">function</span> (<span class="params">button, sm</span>) </span>&#123;</div><div class="line">                        sm.currentState = <span class="string">'options'</span>;</div><div class="line">                    &#125;</div><div class="line">                &#125;),</div><div class="line">                <span class="attr">changeWeapon</span>: buttonMod.create(&#123;</div><div class="line">                    <span class="attr">label</span>: <span class="string">'Next Weapon'</span>,</div><div class="line">                    <span class="attr">fontSize</span>: <span class="number">8</span>,</div><div class="line">                    <span class="attr">x</span>: <span class="number">280</span>,</div><div class="line">                    <span class="attr">y</span>: <span class="number">210</span>,</div><div class="line">                    <span class="attr">r</span>: <span class="number">16</span>,</div><div class="line">                    <span class="attr">onClick</span>: <span class="function"><span class="keyword">function</span> (<span class="params">button, sm</span>) </span>&#123;</div><div class="line">                        sm.game.weaponIndex += <span class="number">1</span>;</div><div class="line">                        sm.game.weaponIndex %= gameMod.Weapons.length;</div><div class="line">                    &#125;</div><div class="line">                &#125;),</div><div class="line">                <span class="attr">autoPlay</span>: buttonMod.create(&#123;</div><div class="line">                    <span class="attr">label</span>: <span class="string">'Auto Play'</span>,</div><div class="line">                    <span class="attr">type</span>: <span class="string">'toggle'</span>,</div><div class="line">                    <span class="attr">fontSize</span>: <span class="number">8</span>,</div><div class="line">                    <span class="attr">x</span>: <span class="number">25</span>,</div><div class="line">                    <span class="attr">y</span>: <span class="number">175</span>,</div><div class="line">                    <span class="attr">r</span>: <span class="number">10</span>,</div><div class="line">                    <span class="attr">bool</span>: <span class="literal">true</span>,</div><div class="line">                    <span class="attr">onClick</span>: <span class="function"><span class="keyword">function</span> (<span class="params">button, sm</span>) </span>&#123;</div><div class="line">                        <span class="keyword">var</span> ap = sm.game.autoPlay;</div><div class="line">                        ap.delay = ap.maxDelay;</div><div class="line">                    &#125;,</div><div class="line">                    <span class="attr">onActive</span>: <span class="function"><span class="keyword">function</span> (<span class="params">button, sm</span>) </span>&#123;</div><div class="line">                        sm.game.autoPlay.enabled = button.bool;</div><div class="line">                    &#125;,</div><div class="line">                    <span class="attr">onInactive</span>: <span class="function"><span class="keyword">function</span> (<span class="params">button, sm</span>) </span>&#123;</div><div class="line">                        sm.game.autoPlay.enabled = button.bool;</div><div class="line">                    &#125;</div><div class="line">                &#125;)</div><div class="line">            &#125;,</div><div class="line"> </div><div class="line">            <span class="attr">update</span>: <span class="function"><span class="keyword">function</span> (<span class="params">sm, secs</span>) </span>&#123;</div><div class="line">                <span class="keyword">var</span> state = states[sm.currentState];</div><div class="line">                <span class="comment">// update game state</span></div><div class="line">                gameMod.update(sm.game, secs);</div><div class="line"> </div><div class="line">                <span class="comment">// draw</span></div><div class="line">                draw.back(ctx, canvas);</div><div class="line">                draw.map(ctx, sm.game.map, sm.game.cross);</div><div class="line">                draw.explosions(ctx, sm.game);</div><div class="line">                draw.cross(ctx, sm.game);</div><div class="line">                draw.shots(ctx, sm.game);</div><div class="line">                <span class="comment">//draw.damageBar(ctx, sm.game);</span></div><div class="line">                draw.buttons(ctx, state.buttons);</div><div class="line">                draw.ver(ctx, sm);</div><div class="line">                draw.debug(sm);</div><div class="line">            &#125;,</div><div class="line">            <span class="attr">pointerStart</span>: <span class="function"><span class="keyword">function</span> (<span class="params">sm, e</span>) </span>&#123;</div><div class="line"> </div><div class="line">                <span class="keyword">var</span> state = states[sm.currentState],</div><div class="line">                buttons = state.buttons,</div><div class="line">                pos = utils.getCanvasRelative(e);</div><div class="line">                <span class="comment">// enable cross move back feature</span></div><div class="line">                sm.game.cross.moveBackEnabled = <span class="literal">true</span>;</div><div class="line">                crossMod.userAction(sm.game.cross, <span class="string">'start'</span>, e);</div><div class="line">                sm.game.userDown = <span class="literal">true</span>;</div><div class="line"> </div><div class="line">                <span class="comment">// check buttons for game state</span></div><div class="line">                buttonMod.pointerCheckCollection(state.buttons, pos, sm);</div><div class="line"> </div><div class="line">            &#125;,</div><div class="line">            <span class="attr">pointerEnd</span>: <span class="function"><span class="keyword">function</span> (<span class="params">em, e</span>) </span>&#123;</div><div class="line">                crossMod.userAction(sm.game.cross, <span class="string">'end'</span>, e);</div><div class="line">                sm.game.userDown = <span class="literal">false</span>;</div><div class="line">            &#125;,</div><div class="line">            <span class="attr">pointerMove</span>: <span class="function"><span class="keyword">function</span> (<span class="params">sm, e</span>) </span>&#123;</div><div class="line">                crossMod.userAction(sm.game.cross, <span class="string">'move'</span>, e);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"> </div><div class="line">    &#125;;</div><div class="line"> </div><div class="line">    <span class="keyword">var</span> sm = &#123;</div><div class="line">        <span class="attr">ver</span>: <span class="string">'0.13.0'</span>,</div><div class="line">        <span class="attr">canvas</span>: canvas,</div><div class="line">        <span class="attr">debugMode</span>: <span class="string">'none'</span>,</div><div class="line">        <span class="attr">currentState</span>: <span class="string">'game'</span>,</div><div class="line">        <span class="attr">ctx</span>: ctx,</div><div class="line">        <span class="attr">game</span>: gameMod.create(&#123;</div><div class="line">            <span class="attr">canvas</span>: canvas</div><div class="line">        &#125;),</div><div class="line">        <span class="attr">input</span>: &#123;</div><div class="line">            <span class="attr">pointerDown</span>: <span class="literal">false</span>,</div><div class="line">            <span class="attr">pos</span>: &#123;</div><div class="line">                <span class="attr">x</span>: <span class="number">0</span>,</div><div class="line">                <span class="attr">y</span>: <span class="number">0</span></div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line"> </div><div class="line">    <span class="keyword">var</span> pointerHanders = &#123;</div><div class="line">        <span class="attr">start</span>: <span class="function"><span class="keyword">function</span> (<span class="params">sm, e</span>) </span>&#123;</div><div class="line">            <span class="keyword">var</span> pos = sm.input.pos;</div><div class="line">            sm.input.pointerDown = <span class="literal">true</span>;</div><div class="line">            <span class="comment">//console.log('start');</span></div><div class="line">            states[sm.currentState].pointerStart(sm, e);</div><div class="line">        &#125;,</div><div class="line">        <span class="attr">move</span>: <span class="function"><span class="keyword">function</span> (<span class="params">sm, e</span>) </span>&#123;</div><div class="line">            <span class="comment">//console.log('move');</span></div><div class="line">            states[sm.currentState].pointerMove(sm, e);</div><div class="line">        &#125;,</div><div class="line">        <span class="attr">end</span>: <span class="function"><span class="keyword">function</span> (<span class="params">sm, e</span>) </span>&#123;</div><div class="line">            sm.input.pointerDown = <span class="literal">false</span>;</div><div class="line">            <span class="comment">//console.log('end');</span></div><div class="line">            states[sm.currentState].pointerEnd(sm, e);</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line"> </div><div class="line">    <span class="keyword">var</span> createPointerHandler = <span class="function"><span class="keyword">function</span> (<span class="params">sm, type</span>) </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> (<span class="params">e</span>) </span>&#123;</div><div class="line">            sm.input.pos = utils.getCanvasRelative(e);</div><div class="line">            e.preventDefault();</div><div class="line">            pointerHanders[type](sm, e);</div><div class="line">        &#125;;</div><div class="line">    &#125;;</div><div class="line"> </div><div class="line">    <span class="comment">// attach for mouse and touch</span></div><div class="line">    canvas.addEventListener(<span class="string">'mousedown'</span>, createPointerHandler(sm, <span class="string">'start'</span>));</div><div class="line">    canvas.addEventListener(<span class="string">'mousemove'</span>, createPointerHandler(sm, <span class="string">'move'</span>));</div><div class="line">    canvas.addEventListener(<span class="string">'mouseup'</span>, createPointerHandler(sm, <span class="string">'end'</span>));</div><div class="line">    canvas.addEventListener(<span class="string">'touchstart'</span>, createPointerHandler(sm, <span class="string">'start'</span>));</div><div class="line">    canvas.addEventListener(<span class="string">'touchmove'</span>, createPointerHandler(sm, <span class="string">'move'</span>));</div><div class="line">    canvas.addEventListener(<span class="string">'touchend'</span>, createPointerHandler(sm, <span class="string">'end'</span>));</div><div class="line"> </div><div class="line">    <span class="keyword">var</span> lt = <span class="keyword">new</span> <span class="built_in">Date</span>(),</div><div class="line">    FPS_target = <span class="number">30</span>;</div><div class="line">    <span class="keyword">var</span> loop = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">        <span class="keyword">var</span> now = <span class="keyword">new</span> <span class="built_in">Date</span>(),</div><div class="line">        t = now - lt,</div><div class="line">        secs = t / <span class="number">1000</span>;</div><div class="line">        requestAnimationFrame(loop);</div><div class="line">        <span class="keyword">if</span> (t &gt;= <span class="number">1000</span> / FPS_target) &#123;</div><div class="line">            states[sm.currentState].update(sm, secs);</div><div class="line">            lt = now;</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line">    loop();</div><div class="line"> </div><div class="line">&#125;</div><div class="line">    ());</div></pre></td></tr></table></figure>
<p>I then of course have my main app loop where I am using the requestAnimationFrame method, inside the loop method. In this loop method I am updating the state of the cross object and drawing the state of the cross and map objects.</p>
<p>I then have just a little HTML and inline css for the container for the canvas element, or elements at some point in the future if I get into layering with this one.</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">head</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">title</span>&gt;</span>canvas example game crosshairs<span class="tag">&lt;/<span class="name">title</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">head</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">body</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"canvas-app"</span> <span class="attr">style</span>=<span class="string">"width:320px;height:240px;margin-left:auto;margin-right:auto;"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"./lib/utils.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"./lib/exp_system.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"./lib/cross.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"./lib/map.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"./lib/pool.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"./lib/game.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"./lib/gen_sheets.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"./lib/draw.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"./lib/buttons.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"main.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">body</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></div></pre></td></tr></table></figure>
<p>So that is it when this canvas example is up and running I am able to move around and when I click on the map I cause damage to the areas that I click. Nothing to interesting at the point of this writing at least, but I think that this one has some decent potential when it comes to putting a little more time into it. I do have many other canvas examples in a state like this also that need more attention, but I am sure I will come back around to this one at some point.</p>
<h2 id="11-Conclusion"><a href="#11-Conclusion" class="headerlink" title="11 - Conclusion"></a>11 - Conclusion</h2><p>So now I have the basic idea of what I had in mind together at least, now it is just a question of what more I can do to it to make it more interesting. There is making it so that each time the player clicks or touches an area in the inner circle that causes a shot to fire from one side of the canvas or another to the point where such an event happened. So there is adding much more when it comes to weapons and what it is that we are shooting at. In addition there is doing something so that there are units in the map the shoot back at the player also.</p>
<p>I made <a href="/2020/01/26/canvas-example-pointer-movement/">another canvas example that is like this one when it comes to moving around a map that I called just simply pointer movement</a>. That one was programed a little differently from this one as that was just simply a means to move around a map by clicking and dragging away from the point that was clicked. Here I have a set of circles fixed at the center of the canvas, or any other location that I choose to fix these circle areas to. There is an outer circle area that is used to move around based on the distance from the end of the inner circle rather than the center point. In addition the inner circle area will not result in any movement, but is used as an area where I can shoot at things, but not move.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://dustinpfister.github.io/2020/07/29/canvas-example-game-crosshairs/" data-id="ckhcho9ff02q3psv19kaljz6c" class="article-share-link">Share</a>
      
        <a href="https://dustinpfister.github.io/2020/07/29/canvas-example-game-crosshairs/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/canvas/">canvas</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2020/08/01/lodash_isarraylike/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          The lodash is array like method, and array like objects in general
        
      </div>
    </a>
  
  
    <a href="/2020/07/28/vuejs-model/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">The vuejs model directive</div>
    </a>
  
</nav>

  
</article>



<section id="comments">

<div id="disqus_thread"></div>
<script>

var disqus_config = function () {
    this.page.url = 'https://dustinpfister.github.io/2020/07/29/canvas-example-game-crosshairs/index.html';
    this.page.identifier = '689';
    this.page.title = 'Canvas example of a cross hairs game';
};

(function() {
var d = document, s = d.createElement('script');
s.src = 'https://dustinpfister-github-io.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</section>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/angular/">angular</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/api/">api</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/backbone/">backbone</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/blog/">blog</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/canvas/">canvas</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/discovery/">discovery</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/express/">express</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/games/">games</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/git/">git</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/grunt/">grunt</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/hapi/">hapi</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/heroku/">heroku</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/hexo/">hexo</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/jquery/">jquery</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/js/">js</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/linux/">linux</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/lodash/">lodash</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/mongodb/">mongodb</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/node-js/">node.js</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/phaser/">phaser</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/statistics/">statistics</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/three-js/">three.js</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/vuejs/">vuejs</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/JSON/">JSON</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SEO/">SEO</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/angular/">angular</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/animation/">animation</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/automation/">automation</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/backbone/">backbone</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/blog/">blog</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/canvas/">canvas</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/corejs/">corejs</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/deterministic/">deterministic</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/discovery/">discovery</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ejs/">ejs</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/express/">express</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/games/">games</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/git/">git</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/grunt/">grunt</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hapi/">hapi</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/heroku/">heroku</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hexo/">hexo</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/jimp/">jimp</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/jquery/">jquery</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/js/">js</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/js13k/">js13k</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux/">linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/lodash/">lodash</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/math/">math</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mongodb/">mongodb</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/node-js/">node.js</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/phaser/">phaser</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/statistics/">statistics</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/structured-data/">structured-data</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/themes/">themes</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/three-js/">three.js</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vuejs/">vuejs</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/JSON/" style="font-size: 12.5px;">JSON</a> <a href="/tags/SEO/" style="font-size: 10.5px;">SEO</a> <a href="/tags/angular/" style="font-size: 13.5px;">angular</a> <a href="/tags/animation/" style="font-size: 12px;">animation</a> <a href="/tags/automation/" style="font-size: 12px;">automation</a> <a href="/tags/backbone/" style="font-size: 12.5px;">backbone</a> <a href="/tags/blog/" style="font-size: 14.5px;">blog</a> <a href="/tags/canvas/" style="font-size: 19px;">canvas</a> <a href="/tags/corejs/" style="font-size: 13px;">corejs</a> <a href="/tags/deterministic/" style="font-size: 10px;">deterministic</a> <a href="/tags/discovery/" style="font-size: 11px;">discovery</a> <a href="/tags/ejs/" style="font-size: 11.5px;">ejs</a> <a href="/tags/express/" style="font-size: 17px;">express</a> <a href="/tags/games/" style="font-size: 17.5px;">games</a> <a href="/tags/git/" style="font-size: 13px;">git</a> <a href="/tags/grunt/" style="font-size: 10px;">grunt</a> <a href="/tags/hapi/" style="font-size: 15px;">hapi</a> <a href="/tags/heroku/" style="font-size: 13.5px;">heroku</a> <a href="/tags/hexo/" style="font-size: 14px;">hexo</a> <a href="/tags/jimp/" style="font-size: 10.5px;">jimp</a> <a href="/tags/jquery/" style="font-size: 11.5px;">jquery</a> <a href="/tags/js/" style="font-size: 20px;">js</a> <a href="/tags/js13k/" style="font-size: 10px;">js13k</a> <a href="/tags/linux/" style="font-size: 15.5px;">linux</a> <a href="/tags/lodash/" style="font-size: 18.5px;">lodash</a> <a href="/tags/math/" style="font-size: 10px;">math</a> <a href="/tags/mongodb/" style="font-size: 14px;">mongodb</a> <a href="/tags/node-js/" style="font-size: 19.5px;">node.js</a> <a href="/tags/phaser/" style="font-size: 18px;">phaser</a> <a href="/tags/statistics/" style="font-size: 12.5px;">statistics</a> <a href="/tags/structured-data/" style="font-size: 10px;">structured-data</a> <a href="/tags/themes/" style="font-size: 10px;">themes</a> <a href="/tags/three-js/" style="font-size: 16.5px;">three.js</a> <a href="/tags/vuejs/" style="font-size: 16px;">vuejs</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/11/">November 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/10/">October 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/09/">September 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/08/">August 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/07/">July 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/06/">June 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/05/">May 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/04/">April 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">March 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/02/">February 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/01/">January 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">December 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">November 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">October 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">September 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">August 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">July 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/06/">June 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">May 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/04/">April 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">March 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/02/">February 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">January 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">December 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">November 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/10/">October 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/09/">September 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">August 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">July 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">June 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">May 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">April 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">March 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/02/">February 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/">January 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/">December 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/11/">November 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/10/">October 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">September 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">August 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/07/">July 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/06/">June 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/05/">May 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">April 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">March 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/02/">February 2017</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2020/11/10/linux-bash-script-build-js/">Linux Build Bash Script JavaScript Style</a>
          </li>
        
          <li>
            <a href="/2020/11/06/canvas-example-game-mr-sun-geo/">Mr Sun Geo.js and additional plug-ins</a>
          </li>
        
          <li>
            <a href="/2020/11/04/canvas-example-game-mr-sun-temp/">Mr sun Temp and Fusion plug-ins canvas example</a>
          </li>
        
          <li>
            <a href="/2020/11/03/canvas-example-game-mr-sun/">Mr sun canvas example</a>
          </li>
        
          <li>
            <a href="/2020/11/02/lodash_rearg/">The lodash _.rearg method and rearranging function arguments</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2020 Dustin Pfister<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a><br>
      <br>
      <a href="/privacy.html" target="_blank">Privacy Policy</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
    <a href="/2020/03/23/canvas-example/" class="mobile-nav-link">Canvas-Examples</a>
  
    <a href="https://github.com/dustinpfister" class="mobile-nav-link">Github</a>
  
    <a href="/about" class="mobile-nav-link">About</a>
  
</nav>
    
<script>
  var disqus_shortname = 'dustinpfister-github-io';
  
  var disqus_url = 'https://dustinpfister.github.io/2020/07/29/canvas-example-game-crosshairs/';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>


  </div>
</body>
</html>
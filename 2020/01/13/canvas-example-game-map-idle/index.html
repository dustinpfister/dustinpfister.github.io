<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <!-- disqus image-->
  <meta property="og:image" content="https://dustinpfister.github.io/css/images/banner.jpg">
  
  <title>A Canvas example of an idle game that makes use of a map | Dustin John Pfister at github pages</title>
  
  <!-- no index tag or blank here -->
  
  
  <link rel="canonical" href="https://dustinpfister.github.io/2020/01/13/canvas-example-game-map-idle/" />

  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="Today I will be writing about yet another canvas example, this one will be an idle game that makes use of a map or gird module. On top of the use of a grid module it will also make used of other modul">
<meta property="og:type" content="article">
<meta property="og:title" content="A Canvas example of an idle game that makes use of a map">
<meta property="og:url" content="https://dustinpfister.github.io/2020/01/13/canvas-example-game-map-idle/index.html">
<meta property="og:site_name" content="Dustin John Pfister at github pages">
<meta property="og:description" content="Today I will be writing about yet another canvas example, this one will be an idle game that makes use of a map or gird module. On top of the use of a grid module it will also make used of other modul">
<meta property="og:updated_time" content="2021-02-28T19:54:32.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="A Canvas example of an idle game that makes use of a map">
<meta name="twitter:description" content="Today I will be writing about yet another canvas example, this one will be an idle game that makes use of a map or gird module. On top of the use of a grid module it will also make used of other modul">
  
    <link rel="alternate" href="/atom.xml" title="Dustin John Pfister at github pages" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.ico">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  
<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-83195184-1', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->


  <!-- structured data set in structured-data.ejs -->
<script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "Person",
    "email": "distin.pfister@gmail.com",
    "givenName": "Dustin",
    "familyName" : "Pfister",
    "additionalName": "John",
    "name": "Dustin John Pfister",
    "gender": "Male"
}
</script>
<!-- end structured data -->
  
  <!-- adsense if indexed -->
  
  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
  (adsbygoogle = window.adsbygoogle || []).push({
    google_ad_client: "ca-pub-1658284027672315",
    enable_page_level_ads: true
  });
  </script>
  
  
</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <!-- added the image-->
        <div class="selfimage"></div>
        <!--<a href="/" id="logo">Dustin John Pfister at github pages</a>-->
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
          <a class="main-nav-link" href="/2020/03/23/canvas-example/">Canvas-Examples</a>
        
          <a class="main-nav-link" href="https://github.com/dustinpfister">Github</a>
        
          <a class="main-nav-link" href="/about">About</a>
        
      </nav>
      <nav id="sub-nav">
        <!-- removed rss link-->
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://dustinpfister.github.io"></form>
      </div>
    </div>
  </div>
</header>

<!-- adding my canvas thing ( Dustin ) -->
<script src="/js/the_matrix.js"></script>
      <div class="outer">
        <section id="main"><article itemscope itemtype="http://schema.org/Blog" id="post-canvas-example-game-map-idle" class="article article-type-post" itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/01/13/canvas-example-game-map-idle/" class="article-date"> Published:
  <time datetime="2020-01-14T00:01:00.000Z" itemprop="datePublished">2020-01-13</time>
</a>

    <!-- other info (dustin) -->
    <a href="/2020/01/13/canvas-example-game-map-idle/" class="article-date"> Modified:
  <time datetime="2021-02-28T19:54:32.000Z" itemprop="dateModified">2021-02-28</time>
</a>

    <span class="article-date">V1.33</span>

    
  <div class="article-category">
    <a class="article-category-link" href="/categories/canvas/">canvas</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      A Canvas example of an idle game that makes use of a map
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="text">
      
        <p>Today I will be writing about yet another <a href="/2020/03/23/canvas-example/">canvas example</a>, this one will be an <a href="https://en.wikipedia.org/wiki/Incremental_game" target="_blank" rel="external">idle game</a> that makes use of a map or gird module. On top of the use of a grid module it will also make used of other modules, methods, and concepts that I have covered in other canvas example posts. It makes use of a <a href="/2020/01/28/canvas-example-state-machine/">state machine</a> in the main app loop, and also a pointer movement module that I have worked out as yet another javaScript example that is closely tied to working with canvas.</p>
<p>In any case this canvas example will be a little involved, but I will have the whole state of the source code here as it was at the time of this writing. I might work on it more, or use it as a starting point for another project if I feel that this will be a good project that is worth more time. So for now lets take a look at what we have when it comes to this ma idle type canvas game example.</p>
<a id="more"></a>
<p><div id="canvas-app"></div></p>
<script src="/js/canvas-examples/game-map-idle/0.0.0/pkg.js"></script>

<h2 id="1-The-html-file-of-this-canvas-example-and-overview-of-what-is-to-come"><a href="#1-The-html-file-of-this-canvas-example-and-overview-of-what-is-to-come" class="headerlink" title="1 - The html file of this canvas example and overview of what is to come"></a>1 - The html file of this canvas example and overview of what is to come</h2><p>So maybe for this example it will be best to start with the HTML file, and the order of the external javaScript files. I am using a small custom trailered utility library that has some functions that I use in other modules so of course that must be loaded first before anything else.</p>
<p>In addition to the utility lib I am also using a Pointer Movement module that is not so different from the other one that I worked out in another post. This module just stores the state of some properties like an angle, and distance that is then used to update a map offset object. When I was first making this project I had that functionally baked into the map module but now have found that is better to pull it out of there.</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">head</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">title</span>&gt;</span>canvas example map idle<span class="tag">&lt;/<span class="name">title</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">head</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">body</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"gamearea"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"utils.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"pm.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"map.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"draw.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"main.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">body</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></div></pre></td></tr></table></figure>
<p>Speaking of the map module yes there is of course that which us used to create and store the state of a game map. There is a base object for each cell, and then an additional nested object for a building that is on the cell.</p>
<p>I then also have a draw module that is used to draw the current state of the map, as well as the state of the pointer movement state when navigating the map. The draw module is also used for displaying debug info on a per state basis for each state as at the time this was a work and progress.</p>
<p>Of course there is also a main.js file where the canvas element is created, and events are attached to the canvas. In addition this is where I have the state machine which I felt is needed for this canvas example to helper keep things better organized.</p>
<h2 id="2-utils"><a href="#2-utils" class="headerlink" title="2 - utils"></a>2 - utils</h2><p>The utils module for this canvas example is just two methods. One is a distance formula that is used in my pointer movement module, and in the map module when it comes to setting a worth value for land tiles. The other method is something that I am using when it comes to event attachment that just converts a window relative value to a canvas relative position.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> u = &#123;&#125;;</div><div class="line"> </div><div class="line">u.distance = <span class="function"><span class="keyword">function</span> (<span class="params">x1, y1, x2, y2</span>) </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="built_in">Math</span>.sqrt(<span class="built_in">Math</span>.pow(x1 - x2, <span class="number">2</span>) + <span class="built_in">Math</span>.pow(y1 - y2, <span class="number">2</span>));</div><div class="line">&#125;;</div><div class="line"> </div><div class="line"><span class="comment">// get canvas relative point</span></div><div class="line">u.getCanvasRelative = <span class="function"><span class="keyword">function</span> (<span class="params">e</span>) </span>&#123;</div><div class="line">    <span class="keyword">var</span> canvas = e.target,</div><div class="line">    bx = canvas.getBoundingClientRect(),</div><div class="line">    x = (e.touches ? e.touches[<span class="number">0</span>].clientX : e.clientX) - bx.left,</div><div class="line">    y = (e.touches ? e.touches[<span class="number">0</span>].clientY : e.clientY) - bx.top;</div><div class="line">    e.preventDefault();</div><div class="line">    <span class="keyword">return</span> &#123;</div><div class="line">        <span class="attr">x</span>: x,</div><div class="line">        <span class="attr">y</span>: y,</div><div class="line">        <span class="attr">bx</span>: bx</div><div class="line">    &#125;;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>The general process here is that if a helper method is just used in one module I leave it in there. However if I find that I am suing that method in more than one module I may place it here, and then make this module a dependency of those modules.</p>
<h2 id="3-Pointer-Movement-module"><a href="#3-Pointer-Movement-module" class="headerlink" title="3 - Pointer Movement module"></a>3 - Pointer Movement module</h2><p>So in this section I will be going over the Pointer Movement module for this canvas example. This is a module that is used for creating what I call a Pointer Movement state object that contains the current state of an angle, and delta value that can be used step a point object. </p>
<p>In this canvas example the module is used to pan the map around by applying the state of a Pointer Movement state object to the map offset values. More on that later when I get to the map module and the main javaScript file.</p>
<h3 id="3-1-The-beginning-of-the-module-and-the-newPm-method"><a href="#3-1-The-beginning-of-the-module-and-the-newPm-method" class="headerlink" title="3.1 - The beginning of the module and the newPm method"></a>3.1 - The beginning of the module and the newPm method</h3><p>So I start off the module with the beginnings of an IIFE as a way of containing everything in a closure.</p>
<p>The first public method is a method that is used to create a new Pointer Movement state object. This object contains a down property that should be set true when the user does something like clicking down a mouse button. There are then properties for a start point and current point when a user pointer action is preformed.</p>
<p>There is then an angle and delta value that are used as a way to step a point by way of Math cos and sin. More on that a little later when I get to the method that is used to do just that.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> PM = (<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line"> </div><div class="line">    <span class="keyword">var</span> api = &#123;&#125;;</div><div class="line"> </div><div class="line">    <span class="comment">// new Pointer Movement State Object</span></div><div class="line">    api.newPM = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">        <span class="keyword">return</span> &#123;</div><div class="line">            <span class="attr">down</span>: <span class="literal">false</span>,</div><div class="line">            <span class="attr">angle</span>: <span class="number">0</span>,</div><div class="line">            <span class="attr">dist</span>: <span class="number">0</span>,</div><div class="line">            <span class="attr">delta</span>: <span class="number">0</span>,</div><div class="line">            <span class="attr">sp</span>: &#123; <span class="comment">// start point</span></div><div class="line">                x: <span class="number">-1</span>,</div><div class="line">                <span class="attr">y</span>: <span class="number">-1</span></div><div class="line">            &#125;,</div><div class="line">            <span class="attr">cp</span>: &#123; <span class="comment">// current point</span></div><div class="line">                x: <span class="number">-1</span>,</div><div class="line">                <span class="attr">y</span>: <span class="number">-1</span></div><div class="line">            &#125;</div><div class="line">        &#125;;</div><div class="line">    &#125;;</div></pre></td></tr></table></figure>
<h3 id="3-2-Update-a-PM-state-object"><a href="#3-2-Update-a-PM-state-object" class="headerlink" title="3.2 - Update a PM state object"></a>3.2 - Update a PM state object</h3><p>This is the main update method for a PM state object. This method should be used in a main app loop, or a tick method of sorts in the state in which a PM state object is being used.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// update the pm based on startPoint, and currentPoint</span></div><div class="line">api.updatePM = <span class="function"><span class="keyword">function</span> (<span class="params">pm</span>) </span>&#123;</div><div class="line">    pm.dist = <span class="number">0</span>;</div><div class="line">    pm.delta = <span class="number">0</span>;</div><div class="line">    pm.angle = <span class="number">0</span>;</div><div class="line">    <span class="keyword">if</span> (pm.cp.x &gt;= <span class="number">0</span> &amp;&amp; pm.cp.y &gt;= <span class="number">0</span>) &#123;</div><div class="line">        pm.dist = u.distance(pm.sp.x, pm.sp.y, pm.cp.x, pm.cp.y);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (pm.down &amp;&amp; pm.dist &gt;= <span class="number">5</span>) &#123;</div><div class="line">        <span class="keyword">var</span> per = pm.dist / <span class="number">64</span>;</div><div class="line">        per = per &gt; <span class="number">1</span> ? <span class="number">1</span> : per;</div><div class="line">        per = per &lt; <span class="number">0</span> ? <span class="number">0</span> : per;</div><div class="line">        pm.delta = per * <span class="number">3</span>;</div><div class="line">        pm.angle = <span class="built_in">Math</span>.atan2(pm.cp.y - pm.sp.y, pm.cp.x - pm.sp.x);</div><div class="line">    &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<h3 id="3-2-Step-a-point-by-a-PM-state"><a href="#3-2-Step-a-point-by-a-PM-state" class="headerlink" title="3.2 - Step a point by a PM state"></a>3.2 - Step a point by a PM state</h3><p>Here I have the method that I use to step a point object with an x and y property by the current state of a PM state object. I just pass the PM state object as the first argument, and then the point I want to step, followed by an option invert boolean.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// step a point by the current values of the pm</span></div><div class="line">api.stepPointByPM = <span class="function"><span class="keyword">function</span> (<span class="params">pm, pt, invert</span>) </span>&#123;</div><div class="line">    invert = invert === <span class="literal">undefined</span> ? <span class="literal">false</span> : invert;</div><div class="line">    invert = invert ? <span class="number">-1</span> : <span class="number">1</span>;</div><div class="line">    pt.x += <span class="built_in">Math</span>.cos(pm.angle) * pm.delta * invert;</div><div class="line">    pt.y += <span class="built_in">Math</span>.sin(pm.angle) * pm.delta * invert;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<h3 id="3-3-Event-Handlers"><a href="#3-3-Event-Handlers" class="headerlink" title="3.3 - Event Handlers"></a>3.3 - Event Handlers</h3><p>Then I have some event handers for helping with the process of updating a PM state object by way of events. these events are meant to be used in an event hander where a canvas relative position has been obtained before hand. This canvas relative position is then passed as a second arguments after the usual PM state is give as the first.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line">    <span class="comment">// when a pointer action starts</span></div><div class="line">    api.onPointerStart = <span class="function"><span class="keyword">function</span> (<span class="params">pm, pos, e</span>) </span>&#123;</div><div class="line">        pm.down = <span class="literal">true</span>;</div><div class="line">        pm.sp = &#123;</div><div class="line">            <span class="attr">x</span>: pos.x,</div><div class="line">            <span class="attr">y</span>: pos.y</div><div class="line">        &#125;;</div><div class="line">    &#125;;</div><div class="line"> </div><div class="line">    <span class="comment">// when a pointer action moves</span></div><div class="line">    api.onPointerMove = <span class="function"><span class="keyword">function</span> (<span class="params">pm, pos, e</span>) </span>&#123;</div><div class="line">        pm.cp = &#123;</div><div class="line">            <span class="attr">x</span>: pos.x,</div><div class="line">            <span class="attr">y</span>: pos.y</div><div class="line">        &#125;;</div><div class="line">    &#125;;</div><div class="line"> </div><div class="line">    <span class="comment">// when a pointer actions ends</span></div><div class="line">    api.onPointerEnd = <span class="function"><span class="keyword">function</span> (<span class="params">pm, pos, e</span>) </span>&#123;</div><div class="line">        pm.down = <span class="literal">false</span>;</div><div class="line">        pm.sp = &#123;</div><div class="line">            <span class="attr">x</span>: <span class="number">-1</span>,</div><div class="line">            <span class="attr">y</span>: <span class="number">-1</span></div><div class="line">        &#125;;</div><div class="line">        pm.cp = &#123;</div><div class="line">            <span class="attr">x</span>: <span class="number">-1</span>,</div><div class="line">            <span class="attr">y</span>: <span class="number">-1</span></div><div class="line">        &#125;;</div><div class="line">    &#125;;</div><div class="line"> </div><div class="line">    <span class="keyword">return</span> api;</div><div class="line"> </div><div class="line">&#125;</div><div class="line">    ());</div></pre></td></tr></table></figure>
<h2 id="4-The-map-module-of-this-canvas-example"><a href="#4-The-map-module-of-this-canvas-example" class="headerlink" title="4 - The map module of this canvas example"></a>4 - The map module of this canvas example</h2><p>This section will be one the map module that can be used to create a map or gird object that contains an array of cell objects for each cell in the grid.</p>
<h3 id="4-1-The-parse-grid-properties-helper"><a href="#4-1-The-parse-grid-properties-helper" class="headerlink" title="4.1 - The parse grid properties helper"></a>4.1 - The parse grid properties helper</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> map = &#123;&#125;;</div><div class="line"> </div><div class="line"><span class="comment">// CREATE A GRID OBJECT</span></div><div class="line"> </div><div class="line"><span class="comment">// parse grid properties</span></div><div class="line">map.parseGridProps = <span class="function"><span class="keyword">function</span> (<span class="params">grid</span>) </span>&#123;</div><div class="line">    <span class="keyword">var</span> a = &#123;&#125;;</div><div class="line">    a.width = grid.width || <span class="number">64</span>;</div><div class="line">    a.height = grid.height || <span class="number">16</span>;</div><div class="line">    a.cellSize = grid.cellSize || <span class="number">32</span>;</div><div class="line">    a.offset = &#123;&#125;;</div><div class="line">    a.offset.x = grid.xOffset === <span class="literal">undefined</span> ? <span class="number">0</span> : grid.xOffset;</div><div class="line">    a.offset.y = grid.yOffset === <span class="literal">undefined</span> ? <span class="number">0</span> : grid.yOffset;</div><div class="line">    a.bufferSize = grid.bufferSize === <span class="literal">undefined</span> ? <span class="number">32</span> : grid.bufferSize;</div><div class="line">    a.selectedCellIndex = grid.selectedCellIndex || <span class="number">-1</span>;</div><div class="line">    a.cells = [];</div><div class="line">    <span class="comment">// game logic</span></div><div class="line">    a.money = <span class="number">0</span>; <span class="comment">// player money</span></div><div class="line">    a.lastUpdate = <span class="keyword">new</span> <span class="built_in">Date</span>();</div><div class="line">    a.tickTime = <span class="number">3000</span>;</div><div class="line">    <span class="keyword">return</span> a;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<h3 id="4-2-The-create-grid-object-method"><a href="#4-2-The-create-grid-object-method" class="headerlink" title="4.2 - The create grid object method"></a>4.2 - The create grid object method</h3><p>This is the method that is used to create a new grid or map object if you prefer by passing a cell width and height value.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// make and return a new grid object by just passing width and height values</span></div><div class="line">map.createGridObject = <span class="function"><span class="keyword">function</span> (<span class="params">w, h</span>) </span>&#123;</div><div class="line">    <span class="keyword">var</span> a = map.parseGridProps(&#123;</div><div class="line">            <span class="attr">width</span>: w,</div><div class="line">            <span class="attr">height</span>: h</div><div class="line">        &#125;);</div><div class="line">    <span class="keyword">return</span> map.createClearCellGrid(a);</div><div class="line">&#125;;</div><div class="line"> </div><div class="line"><span class="comment">// create a new grid object with blank cells by passing a given grid Object</span></div><div class="line">map.createClearCellGrid = <span class="function"><span class="keyword">function</span> (<span class="params">grid</span>) </span>&#123;</div><div class="line">    <span class="keyword">var</span> a = map.parseGridProps(grid);</div><div class="line">    <span class="comment">// create clean cells</span></div><div class="line">    <span class="keyword">var</span> i = <span class="number">0</span>,</div><div class="line">    x,</div><div class="line">    y,</div><div class="line">    len = a.width * a.height;</div><div class="line">    <span class="keyword">while</span> (i &lt; len) &#123;</div><div class="line">        a.cells.push(&#123;</div><div class="line">            <span class="attr">i</span>: i,</div><div class="line">            <span class="attr">x</span>: i % a.width,</div><div class="line">            <span class="attr">y</span>: <span class="built_in">Math</span>.floor(i / a.width),</div><div class="line">            <span class="attr">type</span>: <span class="number">0</span>, <span class="comment">// type index (0 - 4 = sand, 5 - 9 = grass, 10 -14 = wood),</span></div><div class="line">            worth: <span class="number">0</span>, <span class="comment">// the value of the cell</span></div><div class="line">            bought: <span class="literal">true</span>, <span class="comment">// has the player bought the cell</span></div><div class="line">            building: &#123;&#125;</div><div class="line">            <span class="comment">// the building object</span></div><div class="line">        &#125;);</div><div class="line">        i += <span class="number">1</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> a;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<h3 id="4-3-Set-grid-worth-helper"><a href="#4-3-Set-grid-worth-helper" class="headerlink" title="4.3 - Set grid worth helper"></a>4.3 - Set grid worth helper</h3><p>This is a quick method that I made to just set a worth property for each cell. The reasoning is that each cell should have some kind of worth, or price that is used in the process of unlocking the cell, or influencing the rate at which a building on it is producing money.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// GRID WORTH</span></div><div class="line"> </div><div class="line"><span class="comment">// set grid worth for all cells from a fixed point outwards</span></div><div class="line"><span class="comment">// using a base</span></div><div class="line">map.setGridWorth = <span class="function"><span class="keyword">function</span> (<span class="params">grid, x, y, b</span>) </span>&#123;</div><div class="line">    x = x === <span class="literal">undefined</span> ? <span class="number">0</span> : x;</div><div class="line">    y = y === <span class="literal">undefined</span> ? <span class="number">0</span> : y;</div><div class="line">    b = b === <span class="literal">undefined</span> ? <span class="number">2</span> : b;</div><div class="line">    <span class="keyword">var</span> i = grid.cells.length,</div><div class="line">    d,</div><div class="line">    cell;</div><div class="line">    <span class="keyword">while</span> (i--) &#123;</div><div class="line">        cell = grid.cells[i];</div><div class="line">        d = u.distance(cell.x, cell.y, x, y);</div><div class="line">        cell.worth = <span class="number">1</span> + <span class="built_in">Math</span>.pow(b, d);</div><div class="line">    &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<h3 id="4-4-Create-a-building"><a href="#4-4-Create-a-building" class="headerlink" title="4.4 - Create a building"></a>4.4 - Create a building</h3><p>I will want a method that can be called to create a building from a list of building options when it comes to the player creating a new building on a cell with an empty object for its building property.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// BUILDINGS</span></div><div class="line"> </div><div class="line"><span class="comment">// create a building object at the given cell position</span></div><div class="line">map.createBuilding = <span class="function"><span class="keyword">function</span> (<span class="params">grid, x, y, index, buildOptions</span>) </span>&#123;</div><div class="line">    buildOptions = buildOptions || [&#123;</div><div class="line">                <span class="attr">name</span>: <span class="string">'farm'</span>,</div><div class="line">                <span class="attr">moneyPerTick</span>: <span class="number">1</span></div><div class="line">            &#125;</div><div class="line">        ];</div><div class="line">    index = index === <span class="literal">undefined</span> ? <span class="number">0</span> : index;</div><div class="line">    <span class="keyword">var</span> cell = map.get(grid, x, y);</div><div class="line">    <span class="comment">// should be an empty object if not building is there</span></div><div class="line">    <span class="keyword">if</span> (cell.building.index === <span class="literal">undefined</span> &amp;&amp; cell.bought) &#123;</div><div class="line">        cell.building = <span class="built_in">Object</span>.assign(&#123;</div><div class="line">                <span class="attr">index</span>: index</div><div class="line">            &#125;, buildOptions[index]);</div><div class="line">    &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<h3 id="4-5-Clamp-map-offsets"><a href="#4-5-Clamp-map-offsets" class="headerlink" title="4.5 - Clamp map offsets"></a>4.5 - Clamp map offsets</h3><p>I am going to have to worry about map offsets going out of bounds, so i will want something that will wrap or clamp the map offsets.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">// BOUNDS</div><div class="line"> </div><div class="line">// return a set of clamped offset values for the given grid</div><div class="line">map.clampedOffsets = function (grid, canvas) &#123;</div><div class="line">    canvas = canvas || &#123;</div><div class="line">        width: 320,</div><div class="line">        height: 120</div><div class="line">    &#125;;</div><div class="line">    var w = grid.width * grid.cellSize,</div><div class="line">    h = grid.height * grid.cellSize,</div><div class="line">    bufferSize = grid.bufferSize,</div><div class="line">    xMin = bufferSize,</div><div class="line">    yMin = bufferSize,</div><div class="line">    xMax = (w - canvas.width + bufferSize) * -1,</div><div class="line">    yMax = (h - canvas.height + bufferSize) * -1,</div><div class="line">    x = grid.offset.x,</div><div class="line">    y = grid.offset.y;</div><div class="line">    // rules</div><div class="line">    x = x &gt; xMin ? xMin : x;</div><div class="line">    y = y &gt; yMin ? yMin : y;</div><div class="line">    x = x &lt; xMax ? xMax : x;</div><div class="line">    y = y &lt; yMax ? yMax : y;</div><div class="line">    // return offset values</div><div class="line">    return &#123;</div><div class="line">        x: x,</div><div class="line">        y: y</div><div class="line">    &#125;;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<h3 id="4-6-Get-a-cell-methods"><a href="#4-6-Get-a-cell-methods" class="headerlink" title="4.6 - Get a cell methods"></a>4.6 - Get a cell methods</h3><p>If I want to get a cell by index I can just use the index number with the array brackets syntax with the cell array property of a map object. However it would be nice to have some methods that can be used to abstract away some simple expressions that can be used to get a cell by a cell index position, or a canvas relative position from a mouse or touch event.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// GET CELL</span></div><div class="line"> </div><div class="line"><span class="comment">// get a cell from the given cell position</span></div><div class="line">map.get = <span class="function"><span class="keyword">function</span> (<span class="params">grid, x, y</span>) </span>&#123;</div><div class="line">    <span class="keyword">if</span> (x &lt; <span class="number">0</span> || y &lt; <span class="number">0</span> || x &gt;= grid.width || y &gt;= grid.height) &#123;</div><div class="line">        <span class="keyword">return</span> &#123;&#125;;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> grid.cells[y * grid.width + x];</div><div class="line">&#125;;</div><div class="line"> </div><div class="line"><span class="comment">// get a cell position by way of a point on a canvas</span></div><div class="line">map.getCellPositionFromCanvasPoint = <span class="function"><span class="keyword">function</span> (<span class="params">grid, x, y</span>) </span>&#123;</div><div class="line">    <span class="keyword">return</span> &#123;</div><div class="line">        <span class="attr">x</span>: <span class="built_in">Math</span>.floor((x - grid.offset.x) / grid.cellSize),</div><div class="line">        <span class="attr">y</span>: <span class="built_in">Math</span>.floor((y - grid.offset.y) / grid.cellSize)</div><div class="line">    &#125;;</div><div class="line">&#125;;</div><div class="line"> </div><div class="line"><span class="comment">// get a cell position by way of a point on a canvas</span></div><div class="line">map.getCellFromCanvasPoint = <span class="function"><span class="keyword">function</span> (<span class="params">grid, x, y</span>) </span>&#123;</div><div class="line">    <span class="keyword">var</span> pos = map.getCellPositionFromCanvasPoint(grid, x, y);</div><div class="line">    <span class="keyword">return</span> map.get(grid, pos.x, pos.y);</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<h3 id="4-7-update-the-map-object"><a href="#4-7-update-the-map-object" class="headerlink" title="4.7 - update the map object"></a>4.7 - update the map object</h3><p>So now I have the main update method of this map module that can be passes a map object, and then update the current money value with what is there in terms of buildings.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// UPDATE GRID</span></div><div class="line"> </div><div class="line">map.updateGrid = <span class="function"><span class="keyword">function</span> (<span class="params">grid</span>) </span>&#123;</div><div class="line">    <span class="keyword">var</span> now = <span class="keyword">new</span> <span class="built_in">Date</span>(),</div><div class="line">    t = now - grid.lastUpdate,</div><div class="line">    ticks = <span class="built_in">Math</span>.floor(t / grid.tickTime),</div><div class="line">    cell,</div><div class="line">    i = grid.cells.length;</div><div class="line">    <span class="keyword">if</span> (ticks &gt;= <span class="number">1</span>) &#123;</div><div class="line">        <span class="keyword">while</span> (i--) &#123;</div><div class="line">            cell = grid.cells[i];</div><div class="line">            <span class="keyword">if</span> (cell.building.index &gt;= <span class="number">0</span>) &#123;</div><div class="line">                <span class="comment">//grid.money += cell.moneyPerTick * ticks;</span></div><div class="line">                grid.money += cell.building.moneyPerTick * ticks;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        grid.lastUpdate = now;</div><div class="line">    &#125;</div><div class="line">    grid.offset = map.clampedOffsets(grid, canvas);</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<h2 id="5-draw"><a href="#5-draw" class="headerlink" title="5 - draw"></a>5 - draw</h2><p>This is a canvas example, so here is the draw module for this canvas example. Here I have all of the draw methods that are used to update the drawing context of the canvas element that is created and append in  the main javaScript file that I will be getting to in another section.</p>
<h2 id="5-1-draw-state-debug"><a href="#5-1-draw-state-debug" class="headerlink" title="5.1 - draw state debug"></a>5.1 - draw state debug</h2><p>So I made a draw method that will render different debug info depending on the current state of the state machine that I will be getting to when covering main.js in a section coming up.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> draw = (<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line"> </div><div class="line">    <span class="keyword">var</span> drawStateDebug = &#123;</div><div class="line">        <span class="attr">nav</span>: <span class="function"><span class="keyword">function</span> (<span class="params">ctx, grid, states</span>) </span>&#123;</div><div class="line">            <span class="keyword">var</span> pm = states.pm;</div><div class="line">            ctx.fillText(<span class="string">'pm.angle: '</span> + pm.angle, <span class="number">10</span>, <span class="number">30</span>);</div><div class="line">            ctx.fillText(<span class="string">'pm.down: '</span> + pm.down, <span class="number">10</span>, <span class="number">40</span>);</div><div class="line">            ctx.fillText(<span class="string">'pm.cp: '</span> + pm.cp.x, <span class="number">10</span>, <span class="number">50</span>);</div><div class="line">        &#125;,</div><div class="line">        <span class="attr">land</span>: <span class="function"><span class="keyword">function</span> (<span class="params">ctx, grid</span>) </span>&#123;</div><div class="line">            <span class="keyword">var</span> cell = grid.cells[grid.selectedCellIndex];</div><div class="line">            ctx.fillText(<span class="string">'index (x,y): '</span> + cell.i + <span class="string">' ('</span> + cell.x + <span class="string">','</span> + cell.y + <span class="string">')'</span>, <span class="number">10</span>, <span class="number">20</span>);</div><div class="line">            ctx.fillText(<span class="string">'worth: '</span> + cell.worth, <span class="number">10</span>, <span class="number">30</span>);</div><div class="line">        &#125;,</div><div class="line">        <span class="attr">building</span>: <span class="function"><span class="keyword">function</span> (<span class="params">ctx, grid</span>) </span>&#123;</div><div class="line">            <span class="keyword">var</span> cell = grid.cells[grid.selectedCellIndex],</div><div class="line">            build = cell.building;</div><div class="line">            ctx.fillText(<span class="string">'index (x,y): '</span> + cell.i + <span class="string">' ('</span> + cell.x + <span class="string">','</span> + cell.y + <span class="string">')'</span>, <span class="number">10</span>, <span class="number">20</span>);</div><div class="line">            ctx.fillText(<span class="string">'worth: '</span> + cell.worth, <span class="number">10</span>, <span class="number">30</span>);</div><div class="line">            ctx.fillText(<span class="string">'name: '</span> + build.name, <span class="number">10</span>, <span class="number">40</span>);</div><div class="line">            ctx.fillText(<span class="string">'money per tick: '</span> + build.moneyPerTick, <span class="number">10</span>, <span class="number">50</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;;</div></pre></td></tr></table></figure>
<h2 id="5-2-Draw-cells"><a href="#5-2-Draw-cells" class="headerlink" title="5.2 - Draw cells"></a>5.2 - Draw cells</h2><p>I will need some kind of draw method that will draw the current state of the map. For this canvas example I am working with small maps, and focusing on just getting the core of the game together. So with that said something that just loops over all the cells and draws them all at once each time will work okay for now.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// draw cells</span></div><div class="line"><span class="keyword">var</span> drawCells = <span class="function"><span class="keyword">function</span> (<span class="params">grid, ctx, canvas, pxRatio, xOffset, yOffset, cellSize</span>) </span>&#123;</div><div class="line">    <span class="keyword">var</span> colors = [<span class="string">'yellow'</span>, <span class="string">'green'</span>];</div><div class="line">    grid.cells.forEach(<span class="function"><span class="keyword">function</span> (<span class="params">cell</span>) </span>&#123;</div><div class="line">        ctx.fillStyle = colors[cell.type] || <span class="string">'white'</span>;</div><div class="line">        x = cell.x * cellSize + xOffset * pxRatio;</div><div class="line">        y = cell.y * cellSize + yOffset * pxRatio;</div><div class="line">        ctx.fillRect(x, y, cellSize, cellSize);</div><div class="line">        <span class="keyword">if</span> (!cell.bought) &#123;</div><div class="line">            ctx.fillStyle = <span class="string">'rgba(0,0,0,0.5)'</span>;</div><div class="line">            ctx.fillRect(x, y, cellSize, cellSize);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (cell.building.index &gt;= <span class="number">0</span>) &#123;</div><div class="line">            ctx.fillStyle = <span class="string">'red'</span>;</div><div class="line">            ctx.fillRect(x, y, cellSize, cellSize);</div><div class="line">        &#125;</div><div class="line">        ctx.strokeStyle = <span class="string">'white'</span>;</div><div class="line">        ctx.strokeRect(x, y, cellSize, cellSize);</div><div class="line">    &#125;);</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<h2 id="5-3-The-start-of-the-public-api-draw-background-and-draw-status-info"><a href="#5-3-The-start-of-the-public-api-draw-background-and-draw-status-info" class="headerlink" title="5.3 - The start of the public api, draw background, and draw status info."></a>5.3 - The start of the public api, draw background, and draw status info.</h2><p>I start off the public api with just returning an object literal that will hold all the public draw methods that will be used in main.js. I started it off with a draw background method that will just black the canvas to a plain black background. I also added a draw grid status info method that is the start of a game play status bar of sorts, rather than debug info.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">return</span> &#123;</div><div class="line"> </div><div class="line">    <span class="comment">// draw background</span></div><div class="line">    background: <span class="function"><span class="keyword">function</span> (<span class="params">ctx, canvas</span>) </span>&#123;</div><div class="line">        ctx.fillStyle = <span class="string">'black'</span>;</div><div class="line">        ctx.fillRect(<span class="number">0</span>, <span class="number">0</span>, canvas.width, canvas.height);</div><div class="line">    &#125;,</div><div class="line"> </div><div class="line">    <span class="comment">// draw status info bar</span></div><div class="line">    gridStatusInfo: <span class="function"><span class="keyword">function</span> (<span class="params">ctx, canvas, grid</span>) </span>&#123;</div><div class="line">        ctx.fillStyle = <span class="string">'rgba(255,255,255,0.5)'</span>;</div><div class="line">        ctx.fillRect(<span class="number">0</span>, canvas.height - <span class="number">20</span>, canvas.width, <span class="number">20</span>);</div><div class="line">        ctx.fillStyle = <span class="string">'black'</span>;</div><div class="line">        ctx.textBaseline = <span class="string">'top'</span>;</div><div class="line">        ctx.textAlign = <span class="string">'left'</span>;</div><div class="line">        ctx.font = <span class="string">'15px courier'</span>;</div><div class="line">        ctx.fillText(<span class="string">'$'</span> + grid.money.toFixed(<span class="number">2</span>), <span class="number">5</span>, canvas.height - <span class="number">15</span>);</div><div class="line">    &#125;,</div></pre></td></tr></table></figure>
<h2 id="5-4-Draw-build-menu"><a href="#5-4-Draw-build-menu" class="headerlink" title="5.4 - Draw build menu"></a>5.4 - Draw build menu</h2><p>Buildings are something that are created in this canvas example to increase the amount of money that the player gets over time. There is a state that the player will enter when a cell is clicked that contains no building, from there a build menu will be displayed that can be used to create a building on this land cell without a building.</p>
<p>So then I need a draw method that will render the current status of this build menu.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">buildMenu: <span class="function"><span class="keyword">function</span> (<span class="params">ctx, canvas, buildMenu</span>) </span>&#123;</div><div class="line">    ctx.fillStyle = <span class="string">'rgba(255,255,255,0.5)'</span>;</div><div class="line">    ctx.fillRect(<span class="number">0</span>, <span class="number">0</span>, <span class="number">96</span>, canvas.height);</div><div class="line">    ctx.strokeStyle = <span class="string">'rgba(255,0,0,0.5)'</span>;</div><div class="line">    ctx.strokeRect(<span class="number">0</span>, <span class="number">0</span>, <span class="number">96</span>, <span class="number">96</span>);</div><div class="line">    ctx.fillStyle = <span class="string">'rgba(255,0,0,0.5)'</span>;</div><div class="line">    ctx.textAlign = <span class="string">'center'</span>;</div><div class="line">    ctx.fillText(buildMenu.buildOptions[<span class="number">0</span>].name, <span class="number">48</span>, <span class="number">32</span>);</div><div class="line">&#125;,</div></pre></td></tr></table></figure>
<h2 id="5-5-draw-state-debug-info"><a href="#5-5-draw-state-debug-info" class="headerlink" title="5.5 - draw state debug info"></a>5.5 - draw state debug info</h2><p>Here I have the public method that will render the debug info for the current state, that makes use of the draw state debug object at the top of this draw module. I want to have it so that the first line is always the current state, followed by any additional info to draw if a draw debug info method for the current state is there.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">stateDebugInfo: <span class="function"><span class="keyword">function</span> (<span class="params">ctx, stateName, grid, states</span>) </span>&#123;</div><div class="line">    <span class="keyword">var</span> state = drawStateDebug[stateName];</div><div class="line">    ctx.fillStyle = <span class="string">'rgba(0,0,0,0.25)'</span>;</div><div class="line">    ctx.fillRect(<span class="number">0</span>, <span class="number">0</span>, canvas.width, canvas.height);</div><div class="line">    ctx.fillStyle = <span class="string">'white'</span>;</div><div class="line">    ctx.textAlign = <span class="string">'left'</span>;</div><div class="line">    ctx.fillText(<span class="string">'current state: '</span> + stateName, <span class="number">10</span>, <span class="number">10</span>);</div><div class="line">    <span class="keyword">if</span> (state) &#123;</div><div class="line">        state(ctx, grid, states);</div><div class="line">    &#125;</div><div class="line">&#125;,</div></pre></td></tr></table></figure>
<h2 id="5-6-draw-the-map"><a href="#5-6-draw-the-map" class="headerlink" title="5.6 - draw the map"></a>5.6 - draw the map</h2><p>Here is a draw method that will draw the current status of the map. It will of course call the draw cells method mentioned before hand, but will also draw the current selected cell if one is selected. </p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">map: <span class="function"><span class="keyword">function</span> (<span class="params">grid, ctx, canvas, pxRatio</span>) </span>&#123;</div><div class="line">    <span class="keyword">var</span> colors = [<span class="string">'yellow'</span>, <span class="string">'green'</span>],</div><div class="line">    cellSize = grid.cellSize || <span class="number">10</span>,</div><div class="line">    x,</div><div class="line">    y,</div><div class="line">    xOffset = grid.offset.x,</div><div class="line">    yOffset = grid.offset.y;</div><div class="line">    pxRatio = pxRatio || <span class="number">1</span>;</div><div class="line">    cellSize = cellSize * pxRatio;</div><div class="line">    ctx.lineWidth = <span class="number">1</span>;</div><div class="line">    drawCells(grid, ctx, canvas, pxRatio, xOffset, yOffset, cellSize);</div><div class="line">    <span class="keyword">if</span> (grid.selectedCellIndex &gt; <span class="number">-1</span>) &#123;</div><div class="line">        ctx.strokeStyle = <span class="string">'red'</span>;</div><div class="line">        <span class="keyword">var</span> cell = grid.cells[grid.selectedCellIndex],</div><div class="line">        x = cell.x * cellSize + xOffset * pxRatio;</div><div class="line">        y = cell.y * cellSize + yOffset * pxRatio;</div><div class="line">        ctx.strokeStyle = <span class="string">'red'</span>;</div><div class="line">        ctx.strokeRect(x, y, cellSize, cellSize);</div><div class="line">    &#125;</div><div class="line">&#125;,</div></pre></td></tr></table></figure>
<h2 id="5-7-draw-the-nav-circle"><a href="#5-7-draw-the-nav-circle" class="headerlink" title="5.7 - draw the nav circle"></a>5.7 - draw the nav circle</h2><p>Here I have a draw method that will render the current state of of a Pointer Movement state object. This is used in my navigation state in the state machine.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line">        <span class="comment">// draw a navigation circle when moving the map</span></div><div class="line">        navCirclePM: <span class="function"><span class="keyword">function</span> (<span class="params">pm, ctx, canvas</span>) </span>&#123;</div><div class="line">            <span class="keyword">var</span> cx = pm.sp.x,</div><div class="line">            cy = pm.sp.y,</div><div class="line">            x,</div><div class="line">            y,</div><div class="line">            min = <span class="number">64</span>,</div><div class="line">            per = <span class="number">0</span>,</div><div class="line">            a = pm.angle;</div><div class="line">            ctx.strokeStyle = <span class="string">'white'</span>;</div><div class="line">            ctx.lineWidth = <span class="number">3</span>;</div><div class="line">            <span class="comment">// draw circle</span></div><div class="line">            ctx.beginPath();</div><div class="line">            ctx.arc(cx, cy, min / <span class="number">2</span>, <span class="number">0</span>, <span class="built_in">Math</span>.PI * <span class="number">2</span>);</div><div class="line">            ctx.stroke();</div><div class="line">            <span class="comment">// draw direction line</span></div><div class="line">            x = <span class="built_in">Math</span>.cos(a) * min + cx;</div><div class="line">            y = <span class="built_in">Math</span>.sin(a) * min + cy;</div><div class="line">            ctx.beginPath();</div><div class="line">            ctx.moveTo(cx, cy);</div><div class="line">            ctx.lineTo(x, y);</div><div class="line">            ctx.stroke();</div><div class="line">            <span class="comment">// draw delta circle</span></div><div class="line">            per = pm.delta / <span class="number">3</span>;</div><div class="line">            x = <span class="built_in">Math</span>.cos(a) * min * per + cx;</div><div class="line">            y = <span class="built_in">Math</span>.sin(a) * min * per + cy;</div><div class="line">            ctx.beginPath();</div><div class="line">            ctx.arc(x, y, <span class="number">10</span>, <span class="number">0</span>, <span class="built_in">Math</span>.PI * <span class="number">2</span>);</div><div class="line">            ctx.stroke();</div><div class="line">        &#125;</div><div class="line"> </div><div class="line">    &#125;</div><div class="line"> </div><div class="line">&#125;</div><div class="line">    ());</div></pre></td></tr></table></figure>
<h2 id="6-main"><a href="#6-main" class="headerlink" title="6 - main"></a>6 - main</h2><p>Now for the main javaScriot file, here I create the canvas, attach events for the canvas, and define the state machine and main app loop which is also started here. This is also where I have what is begging to be another module for buildings, but for now it is just an object.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// CANVAS</span></div><div class="line"><span class="keyword">var</span> canvas = <span class="built_in">document</span>.createElement(<span class="string">'canvas'</span>),</div><div class="line">ctx = canvas.getContext(<span class="string">'2d'</span>),</div><div class="line">container = <span class="built_in">document</span>.getElementById(<span class="string">'gamearea'</span>) || <span class="built_in">document</span>.body;</div><div class="line">container.appendChild(canvas);</div><div class="line">canvas.width = <span class="number">320</span>;</div><div class="line">canvas.height = <span class="number">240</span>;</div><div class="line">ctx.translate(<span class="number">0.5</span>, <span class="number">0.5</span>);</div><div class="line"> </div><div class="line"><span class="comment">// BUILD MENU</span></div><div class="line"><span class="keyword">var</span> buildMenu = &#123;</div><div class="line">    <span class="attr">yOffet</span>: <span class="number">0</span>,</div><div class="line">    <span class="attr">buildOptions</span>: [&#123;</div><div class="line">            <span class="attr">name</span>: <span class="string">'farm'</span>,</div><div class="line">            <span class="attr">moneyPerTick</span>: <span class="number">1</span></div><div class="line">        &#125;</div><div class="line">    ]</div><div class="line">&#125;;</div><div class="line"> </div><div class="line"><span class="comment">// STATE</span></div><div class="line"><span class="keyword">var</span> states = &#123;</div><div class="line"> </div><div class="line">    <span class="attr">currentState</span>: <span class="string">'init'</span>,</div><div class="line"> </div><div class="line">    <span class="attr">grid</span>: map.createGridObject(<span class="number">17</span>, <span class="number">13</span>),</div><div class="line">    <span class="attr">pm</span>: PM.newPM(),</div><div class="line"> </div><div class="line">    <span class="comment">// ALWAYS STATE</span></div><div class="line">    always: &#123;</div><div class="line">        <span class="attr">tick</span>: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">            <span class="comment">// update and draw</span></div><div class="line">            map.updateGrid(states.grid);</div><div class="line">            draw.background(ctx, canvas); <span class="comment">// background</span></div><div class="line">            draw.map(states.grid, ctx, canvas); <span class="comment">// the map</span></div><div class="line">            draw.stateDebugInfo(ctx, states.currentState, states.grid, states);</div><div class="line">        &#125;</div><div class="line">    &#125;,</div><div class="line"> </div><div class="line">    <span class="comment">// INIT STATE</span></div><div class="line">    init: &#123;</div><div class="line">        <span class="attr">tick</span>: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">            grid = states.grid;</div><div class="line">            grid.offset = &#123;</div><div class="line">                <span class="attr">x</span>: grid.cellSize * grid.width / <span class="number">2</span> * <span class="number">-1</span> + canvas.width / <span class="number">2</span>,</div><div class="line">                <span class="attr">y</span>: grid.cellSize * grid.height / <span class="number">2</span> * <span class="number">-1</span> + canvas.height / <span class="number">2</span></div><div class="line">            &#125;;</div><div class="line">            map.setGridWorth(grid, <span class="number">0</span>, <span class="number">0</span>, <span class="number">2</span>);</div><div class="line">            <span class="comment">// starting building</span></div><div class="line">            map.createBuilding(grid, <span class="number">8</span>, <span class="number">6</span>, <span class="number">0</span>);</div><div class="line">            <span class="comment">// enter disp state</span></div><div class="line">            states.currentState = <span class="string">'disp'</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;,</div><div class="line"> </div><div class="line">    <span class="comment">// DISPLAY STATE</span></div><div class="line">    disp: &#123;</div><div class="line">        <span class="attr">tick</span>: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">            PM.updatePM(states.pm);</div><div class="line">            draw.gridStatusInfo(ctx, canvas, states.grid); <span class="comment">// status bar</span></div><div class="line">        &#125;,</div><div class="line">        <span class="attr">pointer</span>: &#123;</div><div class="line">            <span class="attr">start</span>: <span class="function"><span class="keyword">function</span> (<span class="params">pos, grid, e</span>) </span>&#123;</div><div class="line">                grid.mapMoveStartPoint = &#123;</div><div class="line">                    <span class="attr">x</span>: pos.x,</div><div class="line">                    <span class="attr">y</span>: pos.y</div><div class="line">                &#125;;</div><div class="line">                PM.onPointerStart(states.pm, pos, e);</div><div class="line">            &#125;,</div><div class="line">            <span class="attr">move</span>: <span class="function"><span class="keyword">function</span> (<span class="params">pos, grid, e</span>) </span>&#123;</div><div class="line">                <span class="comment">// movement can trigger nave state</span></div><div class="line">                PM.onPointerMove(states.pm, pos, e);</div><div class="line">                <span class="keyword">if</span> (states.pm.dist &gt;= <span class="number">32</span> &amp;&amp; states.pm.down) &#123;</div><div class="line">                    states.currentState = <span class="string">'nav'</span>;</div><div class="line">                &#125;</div><div class="line">            &#125;,</div><div class="line">            <span class="attr">end</span>: <span class="function"><span class="keyword">function</span> (<span class="params">pos, grid, e</span>) </span>&#123;</div><div class="line">                <span class="comment">// select a cell if not entering nav state</span></div><div class="line">                <span class="keyword">var</span> cell = map.getCellFromCanvasPoint(grid, pos.x, pos.y);</div><div class="line">                <span class="keyword">if</span> (cell.i === grid.selectedCellIndex) &#123;</div><div class="line">                    grid.selectedCellIndex = <span class="number">-1</span>;</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    <span class="keyword">if</span> (cell.i &gt;= <span class="number">0</span>) &#123;</div><div class="line">                        grid.selectedCellIndex = cell.i;</div><div class="line">                        <span class="keyword">var</span> cell = grid.cells[cell.i];</div><div class="line">                        <span class="comment">// if cell index enter building state</span></div><div class="line">                        <span class="keyword">if</span> (cell.building.index &gt;= <span class="number">0</span>) &#123;</div><div class="line">                            states.currentState = <span class="string">'building'</span>;</div><div class="line">                        &#125; <span class="keyword">else</span> &#123;</div><div class="line">                            <span class="comment">// else enter land state</span></div><div class="line">                            states.currentState = <span class="string">'land'</span>;</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;,</div><div class="line"> </div><div class="line">    <span class="comment">// NAV STATE</span></div><div class="line">    nav: &#123;</div><div class="line">        <span class="attr">tick</span>: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">            PM.updatePM(states.pm);</div><div class="line">            draw.navCirclePM(states.pm, ctx, canvas);</div><div class="line">            PM.stepPointByPM(states.pm, grid.offset, <span class="literal">true</span>);</div><div class="line">        &#125;,</div><div class="line">        <span class="attr">pointer</span>: &#123;</div><div class="line">            <span class="attr">move</span>: <span class="function"><span class="keyword">function</span> (<span class="params">pos, grid, e</span>) </span>&#123;</div><div class="line">                PM.onPointerMove(states.pm, pos, e);</div><div class="line">            &#125;,</div><div class="line">            <span class="attr">end</span>: <span class="function"><span class="keyword">function</span> (<span class="params">pos, grid, e</span>) </span>&#123;</div><div class="line">                PM.onPointerEnd(states.pm, pos, e);</div><div class="line">                <span class="comment">// return to disp</span></div><div class="line">                states.currentState = <span class="string">'disp'</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;,</div><div class="line"> </div><div class="line">    <span class="attr">land</span>: &#123;</div><div class="line">        <span class="attr">tick</span>: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">            draw.buildMenu(ctx, canvas, buildMenu);</div><div class="line">        &#125;,</div><div class="line">        <span class="attr">pointer</span>: &#123;</div><div class="line">            <span class="attr">end</span>: <span class="function"><span class="keyword">function</span> (<span class="params">pos, grid, e</span>) </span>&#123;</div><div class="line">                <span class="keyword">if</span> (pos.x &gt;= <span class="number">96</span>) &#123;</div><div class="line">                    grid.selectedCellIndex = <span class="number">-1</span>;</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    <span class="comment">// create a building</span></div><div class="line">                    <span class="keyword">if</span> (pos.y &lt;= <span class="number">96</span>) &#123;</div><div class="line">                        <span class="keyword">var</span> buildIndex = <span class="number">0</span>,</div><div class="line">                        cell = grid.cells[grid.selectedCellIndex];</div><div class="line">                        map.createBuilding(grid, cell.x, cell.y, buildIndex, buildMenu.buildOptions);</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">                PM.onPointerEnd(states.pm, pos, e);</div><div class="line">                states.currentState = <span class="string">'disp'</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;,</div><div class="line"> </div><div class="line">    <span class="attr">building</span>: &#123;</div><div class="line">        <span class="attr">tick</span>: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;&#125;,</div><div class="line">        <span class="attr">pointer</span>: &#123;</div><div class="line">            <span class="attr">end</span>: <span class="function"><span class="keyword">function</span> (<span class="params">pos, grid, e</span>) </span>&#123;</div><div class="line">                PM.onPointerEnd(states.pm, pos, e);</div><div class="line">                <span class="keyword">if</span> (pos.x &gt;= <span class="number">96</span>) &#123;</div><div class="line">                    grid.selectedCellIndex = <span class="number">-1</span>;</div><div class="line">                    states.currentState = <span class="string">'disp'</span>;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">&#125;;</div><div class="line"> </div><div class="line"><span class="comment">// MAIN APP LOOP</span></div><div class="line"><span class="keyword">var</span> loop = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">    requestAnimationFrame(loop);</div><div class="line">    states.always.tick();</div><div class="line">    states[states.currentState].tick();</div><div class="line">&#125;;</div><div class="line">loop();</div><div class="line"> </div><div class="line"><span class="comment">// EVENTS</span></div><div class="line"><span class="keyword">var</span> attachEvent = <span class="function"><span class="keyword">function</span> (<span class="params">canvas, domType, smType</span>) </span>&#123;</div><div class="line">    canvas.addEventListener(domType, <span class="function"><span class="keyword">function</span> (<span class="params">e</span>) </span>&#123;</div><div class="line">        <span class="keyword">var</span> pos = u.getCanvasRelative(e);</div><div class="line">        <span class="keyword">var</span> stateObj = states[states.currentState];</div><div class="line">        <span class="keyword">if</span> (stateObj.pointer) &#123;</div><div class="line">            <span class="keyword">var</span> handler = stateObj.pointer[smType];</div><div class="line">            <span class="keyword">if</span> (handler) &#123;</div><div class="line">                handler(pos, states.grid, e);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line">&#125;;</div><div class="line">attachEvent(canvas, <span class="string">'mousedown'</span>, <span class="string">'start'</span>);</div><div class="line">attachEvent(canvas, <span class="string">'mousemove'</span>, <span class="string">'move'</span>);</div><div class="line">attachEvent(canvas, <span class="string">'mouseup'</span>, <span class="string">'end'</span>);</div></pre></td></tr></table></figure>
<h2 id="7-Conclusion"><a href="#7-Conclusion" class="headerlink" title="7 - Conclusion"></a>7 - Conclusion</h2><p>When this canvas example is up an running I have a map centered with a starting building in the very center. Every time a certain amount of time passes I am given an amount of money because of the starting building that is generating income for me. I can then click on a land cell to get a build menu to which I can then use to create another building at that cell. In the event there there is a building at a cell I enter a separate build state that is reserved for doing things with that building. Finally when I am in the default display state, I can click hold and drag to enter a navigation state that uses the Pointer Movement state object to update the map offsets and pan the map.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://dustinpfister.github.io/2020/01/13/canvas-example-game-map-idle/" data-id="ckq9vbost004jfsv1ms2ubod3" class="article-share-link">Share</a>
      
        <a href="https://dustinpfister.github.io/2020/01/13/canvas-example-game-map-idle/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/canvas/">canvas</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2020/01/14/canvas-example-ball-bounce/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          A Canvas example of bouncing balls
        
      </div>
    </a>
  
  
    <a href="/2020/01/10/canvas-example-turret-defense/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Turret defense canvas example just the basic idea</div>
    </a>
  
</nav>

  
</article>



<section id="comments">

<div id="disqus_thread"></div>
<script>

var disqus_config = function () {
    this.page.url = 'https://dustinpfister.github.io/2020/01/13/canvas-example-game-map-idle/index.html';
    this.page.identifier = '591';
    this.page.title = 'A Canvas example of an idle game that makes use of a map';
};

(function() {
var d = document, s = d.createElement('script');
s.src = 'https://dustinpfister-github-io.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</section>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/angular/">angular</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/api/">api</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/backbone/">backbone</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/blog/">blog</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/canvas/">canvas</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/discovery/">discovery</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/express/">express</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/games/">games</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/git/">git</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/grunt/">grunt</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/hapi/">hapi</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/heroku/">heroku</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/hexo/">hexo</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/jquery/">jquery</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/js/">js</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/linux/">linux</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/lodash/">lodash</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/mongodb/">mongodb</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/node-js/">node.js</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/phaser/">phaser</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/python/">python</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/statistics/">statistics</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/three-js/">three.js</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/vuejs/">vuejs</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/JSON/">JSON</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SEO/">SEO</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/angular/">angular</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/animation/">animation</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/automation/">automation</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/backbone/">backbone</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/blog/">blog</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/canvas/">canvas</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/corejs/">corejs</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/deterministic/">deterministic</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/discovery/">discovery</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ejs/">ejs</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/express/">express</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/games/">games</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/git/">git</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/grunt/">grunt</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hapi/">hapi</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/heroku/">heroku</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hexo/">hexo</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/jimp/">jimp</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/jquery/">jquery</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/js/">js</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/js13k/">js13k</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux/">linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/lodash/">lodash</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/math/">math</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mongodb/">mongodb</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/node-js/">node.js</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/phaser/">phaser</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/python/">python</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/statistics/">statistics</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/structured-data/">structured-data</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/themes/">themes</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/three-js/">three.js</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vuejs/">vuejs</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/JSON/" style="font-size: 12.38px;">JSON</a> <a href="/tags/SEO/" style="font-size: 10.48px;">SEO</a> <a href="/tags/angular/" style="font-size: 13.33px;">angular</a> <a href="/tags/animation/" style="font-size: 11.9px;">animation</a> <a href="/tags/automation/" style="font-size: 11.9px;">automation</a> <a href="/tags/backbone/" style="font-size: 12.38px;">backbone</a> <a href="/tags/blog/" style="font-size: 14.76px;">blog</a> <a href="/tags/canvas/" style="font-size: 19.05px;">canvas</a> <a href="/tags/corejs/" style="font-size: 12.86px;">corejs</a> <a href="/tags/deterministic/" style="font-size: 10px;">deterministic</a> <a href="/tags/discovery/" style="font-size: 10.95px;">discovery</a> <a href="/tags/ejs/" style="font-size: 11.43px;">ejs</a> <a href="/tags/express/" style="font-size: 16.19px;">express</a> <a href="/tags/games/" style="font-size: 17.14px;">games</a> <a href="/tags/git/" style="font-size: 12.86px;">git</a> <a href="/tags/grunt/" style="font-size: 10px;">grunt</a> <a href="/tags/hapi/" style="font-size: 14.76px;">hapi</a> <a href="/tags/heroku/" style="font-size: 11.9px;">heroku</a> <a href="/tags/hexo/" style="font-size: 14.29px;">hexo</a> <a href="/tags/jimp/" style="font-size: 10.48px;">jimp</a> <a href="/tags/jquery/" style="font-size: 11.43px;">jquery</a> <a href="/tags/js/" style="font-size: 20px;">js</a> <a href="/tags/js13k/" style="font-size: 10px;">js13k</a> <a href="/tags/linux/" style="font-size: 16.67px;">linux</a> <a href="/tags/lodash/" style="font-size: 18.1px;">lodash</a> <a href="/tags/math/" style="font-size: 10px;">math</a> <a href="/tags/mongodb/" style="font-size: 14.29px;">mongodb</a> <a href="/tags/node-js/" style="font-size: 19.52px;">node.js</a> <a href="/tags/phaser/" style="font-size: 17.62px;">phaser</a> <a href="/tags/python/" style="font-size: 15.24px;">python</a> <a href="/tags/statistics/" style="font-size: 13.81px;">statistics</a> <a href="/tags/structured-data/" style="font-size: 10px;">structured-data</a> <a href="/tags/themes/" style="font-size: 10px;">themes</a> <a href="/tags/three-js/" style="font-size: 18.57px;">three.js</a> <a href="/tags/vuejs/" style="font-size: 15.71px;">vuejs</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/06/">June 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/05/">May 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/04/">April 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/03/">March 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/02/">February 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/01/">January 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/12/">December 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/11/">November 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/10/">October 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/09/">September 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/08/">August 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/07/">July 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/06/">June 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/05/">May 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/04/">April 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">March 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/02/">February 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/01/">January 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">December 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">November 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">October 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">September 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">August 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">July 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/06/">June 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">May 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/04/">April 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">March 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/02/">February 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">January 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">December 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">November 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/10/">October 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/09/">September 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">August 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">July 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">June 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">May 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">April 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">March 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/02/">February 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/">January 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/">December 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/11/">November 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/10/">October 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">September 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">August 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/07/">July 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/06/">June 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/05/">May 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">April 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">March 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/02/">February 2017</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2021/06/23/threejs-normal-material/">The normal material in threejs</a>
          </li>
        
          <li>
            <a href="/2021/06/22/threejs-emissive-map/">Emissive maps in threejs</a>
          </li>
        
          <li>
            <a href="/2021/06/21/threejs-texture-loader/">The texture loader in threejs</a>
          </li>
        
          <li>
            <a href="/2021/06/18/threejs-vector3-apply-euler/">Apply Euler angles to a Vector3 in threejs</a>
          </li>
        
          <li>
            <a href="/2021/06/17/threejs-vector3-apply-axis-angle/">Vector3 apply axis method</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2021 Dustin Pfister<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a><br>
      <br>
      <a href="/privacy.html" target="_blank">Privacy Policy</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
    <a href="/2020/03/23/canvas-example/" class="mobile-nav-link">Canvas-Examples</a>
  
    <a href="https://github.com/dustinpfister" class="mobile-nav-link">Github</a>
  
    <a href="/about" class="mobile-nav-link">About</a>
  
</nav>
    
<script>
  var disqus_shortname = 'dustinpfister-github-io';
  
  var disqus_url = 'https://dustinpfister.github.io/2020/01/13/canvas-example-game-map-idle/';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>


  </div>
</body>
</html>
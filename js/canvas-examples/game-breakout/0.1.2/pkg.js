/*
   canvas-example-game-breakout
   Copyright 2020 by Dustin Pfister
   https://raw.githubusercontent.com/dustinpfister/canvas-examples/master/LICENSE
 
   https://github.com/dustinpfister/canvas-examples
*/
var utils={};utils.TAU=Math.PI*2;utils.EPS=1e-15;utils.mod=function mod(x,m){return(x%m+m)%m};utils.boundingBox=function(x1,y1,w1,h1,x2,y2,w2,h2){return!(y1+h1<y2||y1>y2+h2||x1+w1<x2||x1>x2+w2)};utils.distance=function(x1,y1,x2,y2){return Math.sqrt(Math.pow(x1-x2,2)+Math.pow(y1-y2,2))};utils.angleNormalize=function(a,scale){return utils.mod(a,scale||utils.TAU)};utils.createCanvas=function(opt){opt=opt||{};opt.container=opt.container||document.getElementById("canvas-app")||document.body;opt.canvas=document.createElement("canvas");opt.ctx=opt.canvas.getContext("2d");opt.canvas.className="canvas_example";opt.canvas.width=opt.width===undefined?320:opt.width;opt.canvas.height=opt.height===undefined?240:opt.height;opt.ctx.translate(.5,.5);opt.canvas.onselectstart=function(){return false};opt.container.appendChild(opt.canvas);return opt};utils.getCanvasRelative=function(e){var canvas=e.target,bx=canvas.getBoundingClientRect(),pos={x:(e.changedTouches?e.changedTouches[0].clientX:e.clientX)-bx.left,y:(e.changedTouches?e.changedTouches[0].clientY:e.clientY)-bx.top,bx:bx};pos.x=Math.floor(pos.x/canvas.scrollWidth*canvas.width);pos.y=Math.floor(pos.y/canvas.scrollHeight*canvas.height);e.preventDefault();return pos};var breakout=function(){var createBlocks=function(opt){opt=opt||{};opt.sx=opt.sx||0;opt.sy=opt.sy||0;opt.blockWidth=opt.blockWidth||32;opt.blockHeight=opt.blockHeight||16;opt.gridWidth=opt.gridWidth||4;opt.gridHeight=opt.gridHeight||4;var blocks=[],i=0,len=opt.gridWidth*opt.gridHeight;while(i<len){var gx=i%opt.gridWidth,gy=Math.floor(i/opt.gridWidth);blocks.push({gx:gx,gy:gy,x:opt.sx+gx*opt.blockWidth,y:opt.sy+gy*opt.blockHeight,w:opt.blockWidth,h:opt.blockHeight,points:1,i:i});i+=1}return blocks};var movePaddle=function(state,secs){var paddle=state.paddle,d=0;if(state.input.left){d=-1}if(state.input.right){d=1}if(state.input.left&&state.input.right){d=0}paddle.x+=paddle.pps*secs*d;if(paddle.x+paddle.w>state.canvas.width){paddle.x=state.canvas.width-paddle.w}if(paddle.x<0){paddle.x=0}};var ballBlockHitCheck=function(ball,state){var blocks=state.blocks,i=blocks.length,bl;while(i--){bl=blocks[i];if(utils.boundingBox(ball.x,ball.y,1,1,bl.x,bl.y,bl.w,bl.h)){state.score+=bl.points;blocks.splice(i,1);if(blocks.length===0){setGame(state)}}}};var ballBounds=function(ball,canvas){if(ball.y<=ball.radius){ball.y=ball.radius;ball.heading=ball.heading*-1}if(ball.x>=canvas.width-ball.radius){ball.x=canvas.width-ball.radius;ball.heading=(ball.heading+Math.PI)*-1}if(ball.x<=ball.radius){ball.x=ball.radius;ball.heading=(ball.heading+Math.PI)*-1}};var ballPaddleHitCheck=function(ball,paddle){if(utils.boundingBox(ball.x,ball.y,1,1,paddle.x,paddle.y,paddle.w,paddle.h)){ball.heading=Math.PI*1.5;ball.y=paddle.y;var d=utils.distance(ball.x,ball.y,paddle.x+paddle.w/2,paddle.y),per=d/(paddle.w/2),dir=ball.x<paddle.x+paddle.w/2?-1:1,a=Math.PI/4*per*dir;ball.heading=Math.PI*1.5+a}};var resetBall=function(ballIndex,state){var ball=state.balls[ballIndex],len=state.balls.length,xAjust=len===1?0:-60+120/(len-1)*ballIndex,per=ballIndex/len;ball.x=state.canvas.width/2+xAjust;ball.y=state.canvas.height/1.5;ball.heading=Math.PI/2};var resetAllBalls=function(state){var i=state.balls.length;while(i--){resetBall(i,state)}};var addBalls=function(state,count){count=count||1;var canvas=state.canvas,i=count,ball;state.balls=state.balls||[];while(i--){ball={x:canvas.width/2-60,y:canvas.height/1.5,radius:5,heading:Math.PI-Math.PI/4,pps:128};state.balls.push(ball)}return ball};var moveBalls=function(state,secs){var i=0,ball,len=state.balls.length,paddle=state.paddle;while(i<len){ball=state.balls[i];ball.x+=Math.cos(ball.heading)*ball.pps*secs;ball.y+=Math.sin(ball.heading)*ball.pps*secs;if(ball.y>=state.canvas.height+ball.radius){resetBall(i,state)}ballBounds(ball,state.canvas);ballBlockHitCheck(ball,state);ballPaddleHitCheck(ball,state.paddle);ball.heading=utils.angleNormalize(ball.heading);i+=1}};var setGame=function(state){var canvas=state.canvas;state.blocks=createBlocks({sx:32,sy:32,blockWidth:(canvas.width-64)/8,blockHeight:16,gridWidth:8,gridHeight:5});state.balls=[];addBalls(state,3);resetAllBalls(state);state.paddle={x:canvas.width/2-60,y:canvas.height-30,w:120,h:15,pps:128}};var pointerHandlers={start:function(state,e){state.input.pointerDown=true},move:function(state,e){},end:function(state,e){state.input.pointerDown=false;state.input.left=false;state.input.right=false}};var createPointerHandler=function(state,type){return function(e){var pos=state.input.pos=utils.getCanvasRelative(e);e.preventDefault();pointerHandlers[type](state,e,pos)}};var api={};api.createNewState=function(canvas){canvas=canvas||{width:320,height:240};var state={ver:"0.1.2",score:0,input:{pointerDown:false,pos:{},left:false,right:false},canvas:canvas,balls:[],blocks:[],paddle:{}};setGame(state);canvas.addEventListener("mousedown",createPointerHandler(state,"start"));canvas.addEventListener("mousemove",createPointerHandler(state,"move"));canvas.addEventListener("mouseup",createPointerHandler(state,"end"));canvas.addEventListener("touchstart",createPointerHandler(state,"start"));canvas.addEventListener("touchmove",createPointerHandler(state,"move"));canvas.addEventListener("touchend",createPointerHandler(state,"end"));window.addEventListener("keydown",function(e){var key=e.key.toLowerCase();if(key==="a"){state.input.left=true}if(key==="d"){state.input.right=true}});window.addEventListener("keyup",function(e){var key=e.key.toLowerCase();if(key==="a"){state.input.left=false}if(key==="d"){state.input.right=false}});return state};var pointerMove=function(state){var pos=state.input.pos;if(state.input.pointerDown){state.input.left=false;state.input.right=false;if(pos.x<state.paddle.x+state.paddle.w/3){state.input.left=true;state.input.right=false}if(pos.x>state.paddle.x+state.paddle.w-state.paddle.w/3){state.input.left=false;state.input.right=true}}};api.update=function(state,secs){movePaddle(state,secs);moveBalls(state,secs);pointerMove(state)};return api}();var draw={};draw.background=function(ctx,canvas){ctx.fillStyle="black";ctx.fillRect(0,0,canvas.width,canvas.height)};draw.blocks=function(ctx,state){ctx.fillStyle="rgba(0,255,0,0.5)";ctx.strokeStyle="white";ctx.lineWidth=3;state.blocks.forEach(function(block){ctx.beginPath();ctx.rect(block.x,block.y,block.w,block.h);ctx.fill();ctx.stroke()})};draw.paddle=function(ctx,state){var paddle=state.paddle;ctx.fillStyle="blue";ctx.strokeStyle="white";ctx.lineWidth=3;ctx.beginPath();ctx.rect(paddle.x,paddle.y,paddle.w,paddle.h);ctx.fill();ctx.stroke()};draw.balls=function(ctx,state){ctx.fillStyle="red";ctx.strokeStyle="white";state.balls.forEach(function(ball){ctx.beginPath();ctx.arc(ball.x,ball.y,ball.radius,0,Math.PI*2);ctx.fill();ctx.stroke()})};draw.info=function(ctx,canvas,state){ctx.fillStyle="white";ctx.font="10px arial";ctx.textBaseline="top";ctx.fillText("v"+state.ver,5,canvas.height-15);ctx.fillText(state.score,5,5)};(function(){var canvasObj=utils.createCanvas(),canvas=canvasObj.canvas,ctx=canvasObj.ctx;var state=breakout.createNewState(canvas);var lt=new Date,FPS_target=30;var loop=function(){var now=new Date,t=now-lt,secs=t/1e3;requestAnimationFrame(loop);if(t>=1e3/FPS_target){breakout.update(state,secs);draw.background(ctx,canvas);draw.blocks(ctx,state);draw.paddle(ctx,state);draw.balls(ctx,state);draw.info(ctx,canvas,state);lt=now}};loop()})();

/*
   canvas-example-game-flappy-collector-idle
   Copyright 2020 by Dustin Pfister
   https://raw.githubusercontent.com/dustinpfister/canvas-examples/master/LICENSE
 
   https://github.com/dustinpfister/canvas-examples
*/
var utils={};utils.createCanvas=function(opt){opt=opt||{};opt.container=opt.container||document.getElementById("canvas-app")||document.body;opt.canvas=document.createElement("canvas");opt.ctx=opt.canvas.getContext("2d");opt.canvas.className="canvas_example";opt.canvas.width=opt.width===undefined?320:opt.width;opt.canvas.height=opt.height===undefined?240:opt.height;opt.ctx.translate(.5,.5);opt.canvas.onselectstart=function(){return false};opt.container.appendChild(opt.canvas);return opt};utils.getCanvasRelative=function(e){var canvas=e.target,bx=canvas.getBoundingClientRect(),pos={x:(e.changedTouches?e.changedTouches[0].clientX:e.clientX)-bx.left,y:(e.changedTouches?e.changedTouches[0].clientY:e.clientY)-bx.top,bx:bx};pos.x=Math.floor(pos.x/canvas.scrollWidth*canvas.width);pos.y=Math.floor(pos.y/canvas.scrollHeight*canvas.height);e.preventDefault();return pos};var game=function(){var bb=function(a,b){return!(a.y+a.size<b.y||a.y>b.y+b.size||a.x+a.size<b.x||a.x>b.x+b.size)};var spawnBerry=function(bird,canvas){var count=bird.berries.length,now=new Date,secs=(now-bird.berriesLastSpawn)/1e3;if(secs>=bird.berriesDelay){if(count<bird.berriesMax){var yRange=canvas.height-64,l=bird.berryLevel-1,p=(l>16?16:l)/16;bird.berries.push({x:canvas.width+32,y:yRange-Math.random()*yRange,size:32,pps:32+Math.floor(96*p),worth:1+.25*l})}bird.berriesLastSpawn=now}};var updateBerries=function(bird,secs,canvas){var i=bird.berries.length,berry;while(i--){berry=bird.berries[i];berry.x-=berry.pps*secs;if(bb(bird,berry)){bird.points+=berry.worth;bird.berries.splice(i,1);bird.berriesCollected+=1}if(berry.x<=berry.size*-1){bird.berries.splice(i,1)}}};var berryNextLevelSet=function(bird){var e=Math.floor(Math.log(bird.berriesCollected)/Math.log(2));bird.berriesNextLevel=e>=6?Math.pow(2,bird.berryLevel+5):64};var berryLevelCheck=function(bird){var e=Math.floor(Math.log(bird.berriesCollected)/Math.log(2));berryNextLevelSet(bird);bird.berryLevel=e>=6?e-4:1;berryNextLevelSet(bird)};var setBerriesDelay=function(bird){var l=bird.berryLevel-1,p=(l>16?16:l)/16;bird.berriesDelay=3-3.75*p};var updateBirdPPS=function(bird,secs){bird.pps=128-256*bird.flap;bird.flap=bird.flap>0?bird.flap-secs*1:0};var getShouldFlap=function(bird){var berry=bird.berries[0];if(berry){return berry.y+16<bird.y?true:false}return false};var api={};api.newBird=function(){return{ver:"0.0.1",x:32,y:0,size:32,flap:0,pps:0,lt:new Date,berries:[],berryLevel:1,berriesCollected:0,berriesNextLevel:Infinity,berriesLastSpawn:new Date,berriesDelay:3,berriesMax:100,points:0,shouldFlap:false,autoPlay:true,autoTime:5,autoDelay:5}};api.update=function(bird,canvas){var now=new Date,secs=(now-bird.lt)/1e3;bird.y+=bird.pps*secs;if(bird.y>=canvas.height-bird.size){bird.y=canvas.height-bird.size}if(bird.y<0){bird.y=0}updateBerries(bird,secs,canvas);spawnBerry(bird,canvas);berryNextLevelSet(bird);berryLevelCheck(bird);setBerriesDelay(bird);updateBirdPPS(bird,secs);bird.shouldFlap=getShouldFlap(bird);if(bird.autoPlay&&bird.shouldFlap){bird.flap=1}else{bird.autoTime-=secs;bird.autoTime=bird.autoTime<0?0:bird.autoTime;bird.autoPlay=bird.autoTime===0?true:false}bird.lt=new Date};api.flap=function(bird){bird.autoPlay=false;bird.autoTime=bird.autoDelay;bird.flap=1};return api}();var draw={};draw.background=function(ctx){ctx.fillStyle="black";ctx.fillRect(0,0,canvas.width,canvas.height)};draw.bird=function(bird,ctx){ctx.fillStyle="green";ctx.strokeStyle="white";ctx.fillRect(bird.x,bird.y,bird.size,bird.size);ctx.strokeRect(bird.x,bird.y,bird.size,bird.size)};draw.info=function(bird,ctx){ctx.fillStyle="white";ctx.textBaseline="top";ctx.fillText("points: "+bird.points,10,10);ctx.fillText("berry level: "+bird.berryLevel,10,20);ctx.fillText("berries collected: "+bird.berriesCollected+"/"+bird.berriesNextLevel,10,30);ctx.fillText("berries delay: "+bird.berriesDelay,10,40);if(bird.berries.length>0){berry=bird.berries[0];ctx.fillText("berry 0 worth: "+berry.worth,10,50);ctx.fillText("berry 0 pps: "+berry.pps,10,60)}};draw.berries=function(bird,ctx){ctx.fillStyle="red";ctx.strokeStyle="white";bird.berries.forEach(function(berry){ctx.fillRect(berry.x,berry.y,berry.size,berry.size);ctx.strokeRect(berry.x,berry.y,berry.size,berry.size)})};draw.autoTimeProgressBar=function(bird,ctx,canvas){var per=bird.autoTime/bird.autoDelay;if(bird.autoTime){ctx.fillStyle="rgba(255,255,255,0.2)";ctx.fillRect(0,canvas.height-10,canvas.width,10);ctx.fillStyle="rgba(0,0,255,0.2)";ctx.fillRect(0,canvas.height-10,canvas.width*per,10)}};draw.ver=function(bird,canvas,ctx){ctx.fillStyle="white";ctx.textBaseline="top";ctx.font="10px arial";ctx.fillText("v"+bird.ver,5,canvas.height-10)};var canvasObj=utils.createCanvas(),canvas=canvasObj.canvas,ctx=canvasObj.ctx;var bird=game.newBird();canvas.addEventListener("click",function(){game.flap(bird)});var loop=function(){requestAnimationFrame(loop);draw.background(ctx);draw.berries(bird,ctx);draw.bird(bird,ctx);draw.info(bird,ctx);draw.autoTimeProgressBar(bird,ctx,canvas);draw.ver(bird,canvas,ctx);game.update(bird,canvas)};loop();

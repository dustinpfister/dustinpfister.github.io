/*
   canvas-example-particles-search-destroy-and-spawn
   Copyright 2020 by Dustin Pfister
   https://raw.githubusercontent.com/dustinpfister/canvas-examples/master/LICENSE
 
   https://github.com/dustinpfister/canvas-examples
*/
var u={};u.distance=function(x1,y1,x2,y2){return Math.sqrt(Math.pow(x1-x2,2)+Math.pow(y1-y2,2))};u.clamp=function(obj,world){if(obj.x<0){obj.x=0}if(obj.y<0){obj.y=0}if(obj.x>=world.width){obj.x=world.width-1}if(obj.y>=world.height){obj.y=world.height-1}};u.perToRadian=function(per){return Math.PI*2*per};u.createCanvas=function(opt){opt=opt||{};opt.container=opt.container||document.getElementById("canvas-app")||document.body;opt.canvas=document.createElement("canvas");opt.ctx=opt.canvas.getContext("2d");opt.canvas.className="canvas_example";opt.canvas.width=opt.width===undefined?320:opt.width;opt.canvas.height=opt.height===undefined?240:opt.height;opt.ctx.translate(.5,.5);opt.canvas.onselectstart=function(){return false};opt.canvas.style.imageRendering="pixelated";opt.ctx.imageSmoothingEnabled=false;opt.container.appendChild(opt.canvas);return opt};u.getCanvasRelative=function(e){var canvas=e.target,bx=canvas.getBoundingClientRect(),pos={x:(e.changedTouches?e.changedTouches[0].clientX:e.clientX)-bx.left,y:(e.changedTouches?e.changedTouches[0].clientY:e.clientY)-bx.top,bx:bx};pos.x=Math.floor(pos.x/canvas.scrollWidth*canvas.width);pos.y=Math.floor(pos.y/canvas.scrollHeight*canvas.height);e.preventDefault();return pos};var paricles=function(){var PARTICLE_COUNT=10;var Particle=function(opt){opt=opt||{};this.x=opt.x||0;this.y=opt.y||0;this.radius=opt.radius||10;this.heading=opt.heading||0;this.pps=opt.pps||16;this.type=opt.type||"none";this.hpMax=opt.hpMax||100;this.hp=this.hpMax;this.radiusAttack=50;this.dps=50};Particle.prototype.move=function(secs){this.x+=Math.cos(this.heading)*this.pps*secs;this.y+=Math.sin(this.heading)*this.pps*secs};Particle.prototype.attack=function(part,secs){if(this.type==="hunter"&&part.type!="hunter"){if(u.distance(this.x,this.y,part.x,part.y)<=this.radiusAttack){part.hp-=this.dps*secs;part.hp=part.hp<0?0:part.hp}}};var createPool=function(state){var i=0,canvas=state.canvas;state.pool=[];while(i<PARTICLE_COUNT){state.pool.push(new Particle({x:canvas.width*Math.random(),y:canvas.height*Math.random(),heading:Math.PI*2*Math.random()}));i+=1}state.pool[0].type="hunter";state.pool[0].pps=32};var poolMove=function(state,secs){var i=state.pool.length,canvas=state.canvas,part;while(i--){part=state.pool[i];part.move(secs);u.clamp(part,state.canvas);if(part.x===0||part.y===0||part.x===canvas.width-1||part.y===canvas.height-1){part.heading=u.perToRadian(Math.random())}}};var poolAttack=function(state,secs){var hi=state.pool.length,hunter,i,part;while(hi--){hunter=state.pool[hi];if(hunter.type==="hunter"){i=state.pool.length;while(i--){part=state.pool[i];hunter.attack(part,secs)}}}};var poolPurge=function(state){var i=state.pool.length,part;while(i--){part=state.pool[i];if(part.hp<=0){state.pool.splice(i,1)}}};var poolSpawn=function(state){if(state.pool.length<PARTICLE_COUNT){state.pool.push(new Particle({x:canvas.width/2,y:canvas.height/2,heading:Math.PI*2*Math.random()}))}};return{create:function(opt){var state={ver:opt.ver||"",canvas:opt.canvas,ctx:opt.ctx,lt:new Date,pool:[]};createPool(state);return state},update:function(state){var now=new Date,t=now-state.lt,secs=t/1e3;poolMove(state,secs);poolAttack(state,secs);poolPurge(state);poolSpawn(state);state.lt=now}}}();var draw=function(){var drawPartBase=function(part){ctx.fillStyle=part.type==="hunter"?"red":"blue";ctx.beginPath();ctx.arc(part.x,part.y,part.radius,0,Math.PI*2);ctx.fill();ctx.stroke()};var drawPartHeading=function(part){var x=Math.cos(part.heading)*part.radius*2+part.x,y=Math.sin(part.heading)*part.radius*2+part.y;ctx.beginPath();ctx.moveTo(part.x,part.y);ctx.lineTo(x,y);ctx.stroke()};var drawPartHealth=function(part){var x=part.x-part.radius,y=part.y+part.radius+3,w=part.radius*2,h=part.radius/2,per=part.hp/part.hpMax;ctx.fillStyle="rgba(128,128,128,1)";ctx.beginPath();ctx.rect(x,y,w,h);ctx.fill();ctx.fillStyle="rgba(0,255,0,1)";ctx.beginPath();ctx.rect(x,y,w*per,h);ctx.fill()};var drawPartAttackRange=function(part){if(part.type==="hunter"){ctx.fillStyle="rgba(255,0,0,0.5)";ctx.beginPath();ctx.arc(part.x,part.y,part.radiusAttack,0,Math.PI*2);ctx.fill()}};return{back:function(state){var ctx=state.ctx,canvas=state.canvas;ctx.fillStyle="black";ctx.fillRect(0,0,canvas.width,canvas.height)},pool:function(state){var ctx=state.ctx,canvas=state.canvas,pool=state.pool,len=pool.length,part,i=0;ctx.lineWidth=3;ctx.strokeStyle="white";while(i<len){part=pool[i];drawPartBase(part);drawPartHeading(part);drawPartHealth(part);drawPartAttackRange(part);i+=1}},ver:function(ctx,canvas,state){ctx.fillStyle="gray";ctx.font="10px arial";ctx.textBaseline="top";ctx.textAlign="left";ctx.fillText("v"+state.ver,5,canvas.height-15)}}}();var canvasObj=u.createCanvas(),canvas=canvasObj.canvas,ctx=canvasObj.ctx;var state=paricles.create({ver:"0.0.1",canvas:canvas,ctx:ctx});var loop=function(){requestAnimationFrame(loop);draw.back(state);draw.pool(state);draw.ver(state.ctx,state.canvas,state);paricles.update(state)};loop();

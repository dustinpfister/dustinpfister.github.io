/*
   canvas-example-particles-binary
   Copyright 2020 by Dustin Pfister
   https://raw.githubusercontent.com/dustinpfister/canvas-examples/master/LICENSE
 
   https://github.com/dustinpfister/canvas-examples
*/
var u={};u.distance=function(x1,y1,x2,y2){return Math.sqrt(Math.pow(x1-x2,2)+Math.pow(y1-y2,2))};u.mod=function mod(x,m){return(x%m+m)%m};u.createCanvas=function(opt){opt=opt||{};opt.container=opt.container||document.getElementById("canvas-app")||document.body;opt.canvas=document.createElement("canvas");opt.ctx=opt.canvas.getContext("2d");opt.canvas.className="canvas_example";opt.canvas.width=opt.width===undefined?320:opt.width;opt.canvas.height=opt.height===undefined?240:opt.height;opt.ctx.translate(.5,.5);opt.canvas.onselectstart=function(){return false};opt.container.appendChild(opt.canvas);return opt};var paricles=function(){var DEFAULT_POOL_SIZE=100,PARTICLE_MIN_RADIUS=6,PARTICLE_MAX_RADIUS=64,PARTICLE_MAX_LIFE=3e3,PARTICLE_UPDATE_METHODS={noop:function(part,pool,secs){},fixed_heading_change:function(part,state,secs){part.degreesPerSecond=u.mod(part.degreesPerSecond+90,180)-90;part.heading+=Math.PI/180*part.degreesPerSecond*secs},DPS_change:function(part,state,secs){var roll=Math.random();var dir=roll<.5?-1:1;part.degreesPerSecond+=360*secs*dir;this.fixed_heading_change(part,state,secs)}};var randomHeading=function(min,max){min=min===undefined?0:min;max=max===undefined?359:max;var degree=min+Math.random()*(max-min);return Math.PI/180*degree};var Particle=function(){this.x=-1;this.y=-1;this.degreesPerSecond=-90+180*Math.random();this.updateKey="DPS_change";this.heading=0;this.bits="00";this.pps=32;this.life=PARTICLE_MAX_LIFE;this.radius=PARTICLE_MIN_RADIUS;this.per=1};Particle.prototype.activate=function(side,canvas){this.bits=side===1?"10":"01";this.x=canvas.width/2;this.y=side===1?0:canvas.height-1;this.heading=side===1?randomHeading(45,135):randomHeading(225,315);this.pps=32+128*Math.random();this.life=PARTICLE_MAX_LIFE;this.radius=PARTICLE_MIN_RADIUS;this.per=1};Particle.prototype.deactivate=function(){this.bits="00";this.x=-1;this.y=-1};var createPool=function(){var len=DEFAULT_POOL_SIZE,i=len,pool=[];while(i--){pool.push(new Particle)}return pool};var partHitCheck=function(state,part){var i=state.pool.length,compare;if(part.bits==="11"||part.bits==="00"){return}while(i--){compare=state.pool[i];if(part===compare||compare.bits==="11"||compare.bits===part.bits||compare.bits==="00"){continue}if(u.distance(part.x,part.y,compare.x,compare.y)<=16){part.bits="11";part.pps=0;part.x=(part.x+compare.x)/2;part.y=(part.y+compare.y)/2;compare.deactivate();break}}};var spawn=function(state,t){state.lastSpawn+=t;if(state.lastSpawn>=state.spawnRate){state.lastSpawn=u.mod(state.lastSpawn,state.spawnRate);var i=state.pool.length;while(i--){var part=state.pool[i];if(part.bits==="00"){part.activate(state.nextSide,state.canvas);state.nextSide=u.mod(state.nextSide+1,2);break}}}};var updatePool=function(state,t){var secs=t/1e3,i=state.pool.length,part;while(i--){part=state.pool[i];if(part.bits==="10"||part.bits==="01"){if(PARTICLE_UPDATE_METHODS[part.updateKey]){PARTICLE_UPDATE_METHODS[part.updateKey].call(PARTICLE_UPDATE_METHODS,part,state,secs)}part.x+=Math.cos(part.heading)*part.pps*secs;part.y+=Math.sin(part.heading)*part.pps*secs;part.x=u.mod(part.x,state.canvas.width);part.y=u.mod(part.y,state.canvas.height);partHitCheck(state,part)}if(part.bits==="11"){part.per=1-part.life/PARTICLE_MAX_LIFE;var deltaRadius=(PARTICLE_MAX_RADIUS-PARTICLE_MIN_RADIUS)*part.per;part.radius=PARTICLE_MIN_RADIUS+deltaRadius;part.life-=t;if(part.life<0){part.deactivate()}}}};return{create:function(opt){opt=opt||{};state={ver:opt.ver||"",canvas:opt.canvas||null,ctx:opt.ctx||null,pool:createPool(),lastTime:new Date,spawnRate:60,lastSpawn:0,nextSide:0};return state},update:function(state){var now=new Date,t=now-state.lastTime,secs=t/1e3;updatePool(state,t);spawn(state,t);state.lastTime=now}}}();var draw=function(){var gradient;return{setGradient:function(state){var canvas=state.canvas;gradient=state.ctx.createLinearGradient(0,0,canvas.width,canvas.height);gradient.addColorStop(0,"#9f0000");gradient.addColorStop(1,"#00009f")},background:function(state){var ctx=state.ctx,canvas=state.canvas;ctx.fillStyle=gradient||"black";ctx.fillRect(0,0,canvas.width,canvas.height)},pool:function(state){var i=state.pool.length;ctx.strokeStyle="white";while(i--){var part=state.pool[i];if(part.bits!="00"){var color=part.bits==="01"?"blue":"red";color=part.bits==="11"?"#bf00bf":color;ctx.globalAlpha=.8;if(part.bits==="11"){ctx.globalAlpha=1-part.per}ctx.beginPath();ctx.fillStyle=color;ctx.arc(part.x,part.y,part.radius,0,Math.PI*2);ctx.fill();ctx.stroke()}}ctx.globalAlpha=1},debug:function(state){},ver:function(state){var ctx=state.ctx;ctx.fillStyle="rgba(255,255,255,0.2)";ctx.font="8px arial";ctx.textBaseline="top";ctx.textAlign="left";ctx.fillText("v"+state.ver,3,state.canvas.height-13)}}}();var canvasObj=u.createCanvas(),canvas=canvasObj.canvas,ctx=canvasObj.ctx;var state=paricles.create({ver:"0.1.0",canvas:canvas,ctx:ctx});draw.setGradient(state);var loop=function(){requestAnimationFrame(loop);draw.background(state);draw.pool(state);draw.ver(state);paricles.update(state)};loop();

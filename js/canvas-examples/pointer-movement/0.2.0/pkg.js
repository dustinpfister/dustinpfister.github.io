/*
   canvas-example-pointer-movement
   Copyright 2020 by Dustin Pfister
   https://raw.githubusercontent.com/dustinpfister/canvas-examples/master/LICENSE
 
   https://github.com/dustinpfister/canvas-examples
*/
var utils={};utils.TAU=Math.PI*2;utils.distance=function(x1,y1,x2,y2){return Math.sqrt(Math.pow(x1-x2,2)+Math.pow(y1-y2,2))};utils.mod=function(x,m){return(x%m+m)%m};utils.radianToScale=function(radian,scale){scale=scale===undefined?360:scale;return radian/(Math.PI*2)*scale};utils.createCanvas=function(opt){opt=opt||{};opt.container=opt.container||document.getElementById("canvas-app")||document.body;opt.canvas=document.createElement("canvas");opt.ctx=opt.canvas.getContext("2d");opt.canvas.className="canvas_example";opt.canvas.width=opt.width===undefined?320:opt.width;opt.canvas.height=opt.height===undefined?240:opt.height;opt.ctx.translate(.5,.5);opt.canvas.onselectstart=function(){return false};opt.canvas.style.imageRendering="pixelated";opt.ctx.imageSmoothingEnabled=false;opt.container.appendChild(opt.canvas);return opt};utils.getCanvasRelative=function(e){var canvas=e.target,bx=canvas.getBoundingClientRect(),pos={x:(e.changedTouches?e.changedTouches[0].clientX:e.clientX)-bx.left,y:(e.changedTouches?e.changedTouches[0].clientY:e.clientY)-bx.top,bx:bx};pos.x=Math.floor(pos.x/canvas.scrollWidth*canvas.width);pos.y=Math.floor(pos.y/canvas.scrollHeight*canvas.height);e.preventDefault();return pos};var PM=function(){var lockToDirs=function(radian,dirCount){var dir=Math.round(radian/utils.TAU*dirCount);return utils.mod(utils.TAU/dirCount*dir,utils.TAU)};var applyMode=function(pm,radian){if(pm.mode.substr(0,3)==="dir"){var dirCount=Number(pm.mode.substr(3,pm.mode.length));dirCount=String(dirCount)==="NaN"?360:dirCount;dirCount=dirCount<=0?360:dirCount;pm.angle=lockToDirs(radian,dirCount)}};var api={};api.create=function(opt){opt=opt||{};return{ver:"0.2.0",secs:0,longDownTime:opt.longDownTime||3,mode:opt.mode||"dir1440",modeIndex:0,modesList:opt.modesList||"dir360,dir8,dir4,dir1440,fine".split(","),down:false,angle:0,dist:0,distMin:opt.distMin===undefined?16:opt.distMin,distMax:opt.distMax||64,per:0,PPS:0,maxPPS:opt.maxPPS===undefined?128:opt.maxPPS,sp:{x:0,y:0},cp:{x:0,y:0}}};api.update=function(pm,secs){pm.dist=0;pm.PPS=0;pm.angle=0;pm.mode=pm.modesList[pm.modeIndex];pm.dist=utils.distance(pm.sp.x,pm.sp.y,pm.cp.x,pm.cp.y);if(pm.down&&pm.dist>=pm.distMin){pm.secs=0;pm.per=(pm.dist-pm.distMin)/pm.distMax;pm.per=pm.per>1?1:pm.per;pm.per=pm.per<0?0:pm.per;pm.PPS=pm.per*pm.maxPPS;var radian=utils.mod(Math.atan2(pm.cp.y-pm.sp.y,pm.cp.x-pm.sp.x),utils.TAU);pm.angle=radian;applyMode(pm,radian)}else{pm.secs+=secs;pm.secs=pm.secs>=pm.longDownTime?pm.longDownTime:pm.secs;if(pm.secs==pm.longDownTime){pm.modeIndex+=1;pm.modeIndex=utils.mod(pm.modeIndex,pm.modesList.length);pm.secs=0}}};api.stepPointByPM=function(pm,pt,secs){secs=secs===undefined?1:secs;pt.x+=Math.cos(pm.angle)*pm.PPS*secs;pt.y+=Math.sin(pm.angle)*pm.PPS*secs};api.onPointerStart=function(pm){return function(e){var pos=utils.getCanvasRelative(e);pm.down=true;pm.secs=0;pm.sp={x:pos.x,y:pos.y};pm.cp={x:pos.x,y:pos.y}}};api.onPointerMove=function(pm){return function(e){var pos=utils.getCanvasRelative(e);pm.cp={x:pos.x,y:pos.y}}};api.onPointerEnd=function(pm){return function(e){var pos=utils.getCanvasRelative(e);pm.down=false;pm.secs=0;pm.sp={x:0,y:0};pm.cp={x:0,y:0}}};return api}();var draw=function(){var api={};api.background=function(pm,ctx,canvas,style){ctx.fillStyle=style||"black";ctx.fillRect(0,0,canvas.width,canvas.height)};api.PTGridlines=function(pt,ctx,canvas,cellSize){var cellX=-1,cellY=-1,x,y;cellSize=cellSize===undefined?256:cellSize;ctx.strokeStyle="#282828";ctx.lineWidth=3;while(cellX<Math.ceil(canvas.width/cellSize)+1){x=cellX*cellSize-pt.x%cellSize;ctx.beginPath();ctx.moveTo(x,0);ctx.lineTo(x,canvas.height);ctx.stroke();cellX+=1}while(cellY<Math.ceil(canvas.height/cellSize)+1){y=cellY*cellSize-pt.y%cellSize;ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(canvas.width,y);ctx.stroke();cellY+=1}};var draw_pm_circle=function(pm,ctx,per){per=per===undefined?1:per;ctx.beginPath();ctx.arc(pm.sp.x,pm.sp.y,pm.distMax/2*per,0,Math.PI*2);ctx.stroke();ctx.fill()};var draw_pm_dir_line=function(pm,ctx){var x=Math.cos(pm.angle)*pm.distMax+pm.sp.x,y=Math.sin(pm.angle)*pm.distMax+pm.sp.y;ctx.beginPath();ctx.moveTo(pm.sp.x,pm.sp.y);ctx.lineTo(x,y);ctx.stroke()};var draw_pm_pps_circle=function(pm,ctx){var per=pm.PPS/pm.maxPPS,x=Math.cos(pm.angle)*pm.distMax*per+pm.sp.x;y=Math.sin(pm.angle)*pm.distMax*per+pm.sp.y;ctx.beginPath();ctx.arc(x,y,10,0,Math.PI*2);ctx.stroke()};var draw_pm_info=function(pm,ctx){var x=pm.sp.x+pm.distMax*.6,y=pm.sp.y+10;ctx.fillStyle="lime";ctx.textBaseline="top";ctx.textAlign="left";ctx.font="10px arial";ctx.fillText("mode: "+pm.mode,x,y);ctx.fillText("PPS: "+Math.round(pm.PPS)+" / "+pm.maxPPS+" ("+Math.round(pm.per*100)+"%)",x,y+12);ctx.fillText("A: "+utils.radianToScale(pm.angle).toFixed(2),x,y+24)};api.navCircle=function(pm,ctx,canvas){if(pm.down){ctx.strokeStyle="white";ctx.lineWidth=3;if(pm.PPS>0){ctx.fillStyle="rgba(0,255,0,0.4)";draw_pm_circle(pm,ctx,1);draw_pm_dir_line(pm,ctx);draw_pm_pps_circle(pm,ctx);draw_pm_info(pm,ctx)}else{var per=pm.secs/pm.longDownTime;ctx.globalAlpha=per;if(per>=.25){ctx.fillStyle="rgba(0,255,255,0.1)";draw_pm_circle(pm,ctx,1);ctx.fillStyle="rgba(0,255,255,0.4)";draw_pm_circle(pm,ctx,(per-.25)/.75);draw_pm_info(pm,ctx)}}ctx.globalAlpha=1}};api.debugInfo=function(pm,pt,ctx,canvas){ctx.fillStyle="lime";ctx.textBaseline="top";ctx.textAlign="left";ctx.font="20px arial";ctx.fillText("pos: "+Math.floor(pt.x)+", "+Math.floor(pt.y),10,10)};api.ver=function(ctx,pm){ctx.fillStyle="lime";ctx.font="10px courier";ctx.textBaseline="top";ctx.textAlign="left";ctx.fillText("v"+pm.ver,5,canvas.height-15)};return api}();var canvasObj=utils.createCanvas({width:640,height:480}),canvas=canvasObj.canvas,ctx=canvasObj.ctx;var pm=PM.create({modesList:"dir32,dir16,dir12,dir8,dir4,dir360,dir1440,fine".split(","),longDownTime:2,distMin:32,distMax:128,maxPPS:512});var pt={x:0,y:0};var lt=new Date;var loop=function(){var now=new Date,t=now-lt,secs=t/1e3;requestAnimationFrame(loop);PM.update(pm,secs);PM.stepPointByPM(pm,pt,secs);draw.background(pm,ctx,canvas,"black");draw.PTGridlines(pt,ctx,canvas,128);draw.navCircle(pm,ctx,canvas);draw.debugInfo(pm,pt,ctx,canvas);draw.ver(ctx,pm);lt=now};loop();canvas.addEventListener("mousedown",PM.onPointerStart(pm));canvas.addEventListener("mousemove",PM.onPointerMove(pm));canvas.addEventListener("mouseup",PM.onPointerEnd(pm));canvas.addEventListener("touchstart",PM.onPointerStart(pm));canvas.addEventListener("touchmove",PM.onPointerMove(pm));canvas.addEventListener("touchend",PM.onPointerEnd(pm));canvas.addEventListener("mouseout",PM.onPointerEnd(pm));canvas.addEventListener("touchcancel",PM.onPointerEnd(pm));

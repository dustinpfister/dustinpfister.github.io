/*
   canvas-example-pop-the-lock
   Copyright 2020 by Dustin Pfister
   https://raw.githubusercontent.com/dustinpfister/canvas-examples/master/LICENSE
 
   https://github.com/dustinpfister/canvas-examples
*/
var utils={};utils.distance=function(x1,y1,x2,y2){return Math.sqrt(Math.pow(x1-x2,2)+Math.pow(y1-y2,2))};utils.mod=function(x,m){return(x%m+m)%m};utils.createCanvas=function(opt){opt=opt||{};opt.container=opt.container||document.getElementById("canvas-app")||document.body;opt.canvas=document.createElement("canvas");opt.ctx=opt.canvas.getContext("2d");opt.canvas.className="canvas_example";opt.canvas.width=opt.width===undefined?320:opt.width;opt.canvas.height=opt.height===undefined?240:opt.height;opt.ctx.translate(.5,.5);opt.canvas.onselectstart=function(){return false};opt.canvas.style.imageRendering="pixelated";opt.ctx.imageSmoothingEnabled=false;opt.container.appendChild(opt.canvas);return opt};utils.getCanvasRelative=function(e){var canvas=e.target,bx=canvas.getBoundingClientRect(),pos={x:(e.changedTouches?e.changedTouches[0].clientX:e.clientX)-bx.left,y:(e.changedTouches?e.changedTouches[0].clientY:e.clientY)-bx.top,bx:bx};pos.x=Math.floor(pos.x/canvas.scrollWidth*canvas.width);pos.y=Math.floor(pos.y/canvas.scrollHeight*canvas.height);e.preventDefault();return pos};var ptl={ver:"0.0.0",sec_current:0,sec_target:4,sec_total:100,sec_margin:4,tick_dir:-1,tick_rate:30,tick_last:new Date,inRange:false,score:0,wrapSec:function(sec){if(sec>this.sec_total){sec%=this.sec_total}if(sec<0){sec=this.sec_total-(this.sec_total+Math.abs(sec))%this.sec_total}return sec},getInRange:function(){return this.sec_current>=this.sec_target-this.sec_margin&&this.sec_current<=this.sec_target+this.sec_margin},click:function(e){ptl.score+=ptl.inRange?1:-1;if(ptl.inRange){ptl.tick_dir=ptl.tick_dir===1?-1:1;ptl.randomTarget()}},randomTarget:function(){this.sec_target=Math.floor(Math.random()*(this.sec_total-this.sec_margin*2))+this.sec_margin},tick:function(){var time=new Date-this.tick_last,ticks=time/this.tick_rate;this.sec_current+=ticks*this.tick_dir;this.sec_current=this.wrapSec(this.sec_current);this.inRange=this.getInRange();this.tick_last=new Date}};var drawPTL=function(ptl,ctx,canvas){var r,x,y;ctx.globalAlpha=1;ctx.fillStyle="black";ctx.fillRect(0,0,canvas.width,canvas.height);ctx.strokeStyle="white";ctx.lineWidth=3;ctx.beginPath();ctx.arc(canvas.width/2,canvas.height/2,100,0,Math.PI*2);ctx.stroke();ctx.strokeStyle="red";ctx.beginPath();ctx.arc(canvas.width/2,canvas.height/2,100,ptl.wrapSec(ptl.sec_target-ptl.sec_margin)/ptl.sec_total*Math.PI*2,ptl.wrapSec(ptl.sec_target+ptl.sec_margin)/ptl.sec_total*Math.PI*2);ctx.stroke();ctx.strokeStyle="blue";ctx.beginPath();r=ptl.sec_current/ptl.sec_total*Math.PI*2;x=Math.cos(r)*100+canvas.width/2;y=Math.sin(r)*100+canvas.height/2;ctx.arc(x,y,10,0,Math.PI*2);ctx.stroke();ctx.fillStyle=ptl.score>0?"green":"red";ctx.textBaseline="middle";ctx.textAlign="center";ctx.font="25px arial";ctx.fillText(ptl.score,canvas.width/2,canvas.height/2);ctx.fillStyle="yellow";ctx.textBaseline="top";ctx.textAlign="left";ctx.globalAlpha=.35;ctx.font="10px arial";ctx.fillText("sec_current "+ptl.sec_current.toFixed(2),10,10);ctx.fillText("inrange "+ptl.inRange,10,20);ctx.fillStyle="white";ctx.textBaseline="top";ctx.font="10px arial";ctx.textAlign="left";ctx.fillText("v"+ptl.ver,5,canvas.height-15)};(function(){var canvasObj=utils.createCanvas({width:320,height:240});var canvas=canvasObj.canvas;var ctx=canvasObj.ctx;canvas.addEventListener("click",ptl.click);ptl.randomTarget();var loop=function(){requestAnimationFrame(loop);ptl.tick();drawPTL(ptl,ctx,canvas)};loop()})();

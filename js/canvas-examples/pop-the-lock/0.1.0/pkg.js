/*
   canvas-example-pop-the-lock
   Copyright 2020 by Dustin Pfister
   https://raw.githubusercontent.com/dustinpfister/canvas-examples/master/LICENSE
 
   https://github.com/dustinpfister/canvas-examples
*/
var utils={};utils.distance=function(x1,y1,x2,y2){return Math.sqrt(Math.pow(x1-x2,2)+Math.pow(y1-y2,2))};utils.mod=function(x,m){return(x%m+m)%m};utils.createCanvas=function(opt){opt=opt||{};opt.container=opt.container||document.getElementById("canvas-app")||document.body;opt.canvas=document.createElement("canvas");opt.ctx=opt.canvas.getContext("2d");opt.canvas.className="canvas_example";opt.canvas.width=opt.width===undefined?320:opt.width;opt.canvas.height=opt.height===undefined?240:opt.height;opt.ctx.translate(.5,.5);opt.canvas.onselectstart=function(){return false};opt.canvas.style.imageRendering="pixelated";opt.ctx.imageSmoothingEnabled=false;opt.container.appendChild(opt.canvas);return opt};utils.getCanvasRelative=function(e){var canvas=e.target,bx=canvas.getBoundingClientRect(),pos={x:(e.changedTouches?e.changedTouches[0].clientX:e.clientX)-bx.left,y:(e.changedTouches?e.changedTouches[0].clientY:e.clientY)-bx.top,bx:bx};pos.x=Math.floor(pos.x/canvas.scrollWidth*canvas.width);pos.y=Math.floor(pos.y/canvas.scrollHeight*canvas.height);e.preventDefault();return pos};var gameMod=function(){var getInRange=function(game){return game.deg.current>=game.deg.target-game.deg.margin&&game.deg.current<=game.deg.target+game.deg.margin};var randomTarget=function(game){game.deg.target=Math.floor(Math.random()*(game.deg.total-game.deg.margin*2))+game.deg.margin};var api={};api.create=function(){var game={ver:"0.1.0",deg:{perSec:40,current:0,target:4,total:100,margin:4},dir:-1,inRange:false,score:0};randomTarget(game);return game};api.update=function(game,secs){game.deg.current+=game.deg.perSec*secs*game.dir;game.deg.current=utils.mod(game.deg.current,game.deg.total);game.inRange=getInRange(game)};api.click=function(game){game.score+=game.inRange?1:-1;if(game.inRange){game.dir=game.dir===1?-1:1;randomTarget(game)}};return api}();var draw=function(){var baseCircle=function(ctx,canvas){ctx.strokeStyle="white";ctx.lineWidth=3;ctx.beginPath();ctx.arc(canvas.width/2,canvas.height/2,100,0,Math.PI*2);ctx.stroke()};var targetRange=function(ctx,canvas,game){ctx.strokeStyle="red";ctx.beginPath();ctx.arc(canvas.width/2,canvas.height/2,100,utils.mod(game.deg.target-game.deg.margin,game.deg.total)/game.deg.total*Math.PI*2,utils.mod(game.deg.target+game.deg.margin,game.deg.total)/game.deg.total*Math.PI*2);ctx.stroke()};var info=function(ctx,canvas,game){ctx.fillStyle="yellow";ctx.textBaseline="top";ctx.textAlign="left";ctx.globalAlpha=.35;ctx.font="10px arial";ctx.fillText("deg.current "+game.deg.current.toFixed(2),10,10);ctx.fillText("inrange "+game.inRange,10,20)};var current_pos=function(ctx,canvas,game){ctx.strokeStyle="blue";ctx.beginPath();var r=game.deg.current/game.deg.total*Math.PI*2,x=Math.cos(r)*100+canvas.width/2,y=Math.sin(r)*100+canvas.height/2;ctx.arc(x,y,10,0,Math.PI*2);ctx.stroke()};var score=function(ctx,canvas,game){ctx.fillStyle=game.score>0?"green":"red";ctx.textBaseline="middle";ctx.textAlign="center";ctx.font="25px arial";ctx.fillText(game.score,canvas.width/2,canvas.height/2)};var api={};api.background=function(ctx,canvas,style){ctx.globalAlpha=1;ctx.fillStyle=style||"black";ctx.fillRect(0,0,canvas.width,canvas.height)};api.PTL=function(ctx,canvas,game){baseCircle(ctx,canvas);targetRange(ctx,canvas,game);current_pos(ctx,canvas,game);score(ctx,canvas,game);info(ctx,canvas,game)};api.ver=function(ctx,canvas,game){ctx.fillStyle="white";ctx.textBaseline="top";ctx.font="10px arial";ctx.textAlign="left";ctx.fillText("v"+game.ver,5,canvas.height-15)};return api}();(function(){var canvasObj=utils.createCanvas({width:320,height:240}),canvas=canvasObj.canvas,ctx=canvasObj.ctx;var sm={game:gameMod.create(),lt:new Date,currentState:"game",states:{}};sm.states.game={update:function(sm,secs){gameMod.update(sm.game,secs)},draw:function(sm,ctx,canvas){draw.PTL(ctx,canvas,sm.game)},click:function(sm,pos,e){gameMod.click(sm.game)}};var loop=function(){var now=new Date,secs=(now-sm.lt)/1e3;requestAnimationFrame(loop);sm.states[sm.currentState].update(sm,secs);draw.background(ctx,canvas,"#0a0a0a");sm.states[sm.currentState].draw(sm,ctx,canvas);draw.ver(ctx,canvas,sm.game);sm.lt=now};loop();canvas.addEventListener("click",function(e){var pos=utils.getCanvasRelative(e);sm.states[sm.currentState].click(sm,pos,e)})})();

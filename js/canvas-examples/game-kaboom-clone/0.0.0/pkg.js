/*
   canvas-example-game-kaboom-clone
   Copyright 2020 by Dustin Pfister
   https://raw.githubusercontent.com/dustinpfister/canvas-examples/master/LICENSE
 
   https://github.com/dustinpfister/canvas-examples
*/
var utils={};utils.bb=function(a,b){return!(a.y+a.h<b.y||a.y>b.y+b.h||a.x+a.w<b.x||a.x>b.x+b.w)};utils.distance=function(x1,y1,x2,y2){return Math.sqrt(Math.pow(x1-x2,2)+Math.pow(y1-y2,2))};utils.createCanvas=function(opt){opt=opt||{};opt.container=opt.container||document.getElementById("canvas-app")||document.body;opt.canvas=document.createElement("canvas");opt.ctx=opt.canvas.getContext("2d");opt.canvas.className="canvas_example";opt.canvas.width=opt.width===undefined?320:opt.width;opt.canvas.height=opt.height===undefined?240:opt.height;opt.ctx.translate(.5,.5);opt.canvas.onselectstart=function(){return false};opt.container.appendChild(opt.canvas);return opt};utils.getCanvasRelative=function(e){var canvas=e.target,bx=canvas.getBoundingClientRect(),pos={x:(e.changedTouches?e.changedTouches[0].clientX:e.clientX)-bx.left,y:(e.changedTouches?e.changedTouches[0].clientY:e.clientY)-bx.top,bx:bx};pos.x=Math.floor(pos.x/canvas.scrollWidth*canvas.width);pos.y=Math.floor(pos.y/canvas.scrollHeight*canvas.height);e.preventDefault();return pos};var kaboom=function(){var BOMBER={y:100,w:32},PLAYER={y:350,w:64,h:64},BUTTON_PAUSE={x:16,y:432,w:128,h:32},BUTTON_NEW_GAME={x:320-64,y:240-16,w:128,h:32};var LEVELS={};var i=1,totalLevels=30,per;while(i<=totalLevels){per=(i-1)/(totalLevels-1);LEVELS[i]={bombPPS:64+300*per,bombCount:10+90*per,bomber:{pps:32+950*per,changeRate:.5-.3*per,dropRate:1/(Math.floor(5*per)+1)}};i+=1}var clampBoundaries=function(objState,objConst){if(objState.x>640-objConst.w){objState.x=640-objConst.w}if(objState.x<0){objState.x=0}};var moveBomber=function(state,secs){var bomber=state.bomber;bomber.x+=Math.floor(bomber.pps*secs*bomber.dir);clampBoundaries(bomber,BOMBER);bomber.changeTime+=secs;if(bomber.changeTime>=bomber.changeRate){bomber.dir=1-Math.floor(Math.random()*3);bomber.changeTime%=bomber.changeRate}};var movePlayer=function(state,secs){var player=state.player,inputPos=player.inputPos,hw=PLAYER.w/2,x=inputPos.x-hw;player.dir=0;var d=utils.distance(player.x,PLAYER.y,x,PLAYER.y);dir=d<hw?d/hw:1;if(inputPos.down){if(x<player.x){player.dir=dir*-1}if(x>player.x){player.dir=dir}}if(player.inputKeys.a){player.dir=-1}if(player.inputKeys.d){player.dir=1}if(player.inputAI){var bomb=state.bombs[0];if(bomb){var d=utils.distance(player.x+16,PLAYER.y,bomb.x,PLAYER.y);dir=d<hw?d/hw:1;if(bomb.x<player.x+16){player.dir=dir*-1}if(bomb.x>player.x+16){player.dir=dir}}}player.x+=Math.floor(player.pps*secs*player.dir);clampBoundaries(player,PLAYER)};var moveBomb=function(bomb,secs){bomb.y+=bomb.pps*secs;if(bomb.y>480){bomb.y=480}};var dropBombs=function(state,secs){var bomber=state.bomber;bomber.dropTime+=secs;if(bomber.dropTime>=bomber.dropRate){if(state.bombCount>0){state.bombs.push({x:bomber.x,y:BOMBER.y,w:32,h:32,pps:state.bombPPS})}state.bombCount-=1;state.bombCount=state.bombCount<0?0:state.bombCount;bomber.dropTime%=bomber.dropRate}};var bombHit=function(state,bombIndex){var bomb=state.bombs[bombIndex],player=state.player;if(bomb){if(utils.bb({x:player.x,y:PLAYER.y,w:PLAYER.w,h:PLAYER.h},bomb)){state.score+=1*state.level;state.bombs.splice(bombIndex,1)}}};var bombOut=function(state,bombIndex){var bomb=state.bombs[bombIndex],player=state.player;if(bomb){if(bomb.y===480){player.hp-=1;player.hp=player.hp<0?0:player.hp;state.bombs=[]}}};var levelOverCheck=function(state){if(state.bombCount===0&&state.bombs.length===0){setLevel(state,state.level+=1)}};var gameOverCheck=function(state){if(state.player.hp===0){state.gameOver=true}};var createState=function(level){level=level||1;var state={ver:"0.0.0",lt:new Date,gameOver:false,pauseTime:3,pauseMessage:"",score:0,level:level,bomber:{x:320,dir:1,pps:0,changeTime:0,changeRate:.5,dropTime:0,dropRate:1},bombPPS:0,bombCount:0,bombs:[],player:{x:320,inputPos:{x:320,y:0,down:false},inputKeys:{a:false,b:false},inputAI:false,hp:3,dir:-1,pps:900}};setLevel(state,level);state.pauseMessage="level: "+state.level;return state};var setLevel=function(state,level){var maxLevel=Object.keys(LEVELS).length;state.level=level===undefined?state.level:level;state.level=state.level>maxLevel?maxLevel:state.level;levelObj=LEVELS[state.level];state.bomber.pps=levelObj.bomber.pps;state.bomber.changeRate=levelObj.bomber.changeRate;state.bomber.dropRate=levelObj.bomber.dropRate;state.bombPPS=levelObj.bombPPS;state.bombCount=levelObj.bombCount;state.pauseTime=1;state.bomber.dropTime=0;state.bomber.changeTime=0;state.pauseMessage="level: "+state.level};var api={LEVELS:LEVELS,BOMBER:BOMBER,PLAYER:PLAYER,BUTTON_PAUSE:BUTTON_PAUSE,BUTTON_NEW_GAME:BUTTON_NEW_GAME,createState:createState,pointerStart:function(state,e){var pos=utils.getCanvasRelative(e);e.preventDefault();if(!state.gameOver&&utils.bb(pos,BUTTON_PAUSE)){if(state.pauseTime===-1){state.pauseTime=0;return}if(state.pauseTime===0){state.pauseTime=-1;state.pauseMessage="paused";return}}if(state.gameOver&&utils.bb(pos,BUTTON_NEW_GAME)){Object.assign(state,createState(1))}},update:function(state){var now=new Date,t=now-state.lt,secs=t/1e3,bomber=state.bomber;if(state.gameOver){state.pauseTime=-1;state.pauseMessage="Game Over"}if(state.pauseTime===-1||state.pauseTime>0){state.lt=now;if(state.pauseTime>0){state.pauseTime-=secs;state.pauseTime=state.pauseTime<0?0:state.pauseTime}return}moveBomber(state,secs);movePlayer(state,secs);dropBombs(state,secs);var i=state.bombs.length,player=state.player,bomb;while(i--){bomb=state.bombs[i];moveBomb(bomb,secs);bombHit(state,i);bombOut(state,i)}levelOverCheck(state);gameOverCheck(state);state.lt=now}};return api}();var draw={};draw.back=function(ctx,canvas){ctx.fillStyle="blue";ctx.fillRect(0,0,canvas.width,canvas.height);ctx.fillStyle="green";ctx.fillRect(0,kaboom.BOMBER.y,canvas.width,canvas.height-kaboom.BOMBER.y)};draw.bomber=function(ctx,state){ctx.fillStyle="black";ctx.fillRect(state.bomber.x,kaboom.BOMBER.y-64,kaboom.BOMBER.w,64)};draw.bombs=function(ctx,state){var i=state.bombs.length,bomb;ctx.fillStyle="red";while(i--){bomb=state.bombs[i];ctx.fillRect(bomb.x,bomb.y,32,32)}};draw.player=function(ctx,state){ctx.fillStyle="lime";ctx.fillRect(state.player.x,kaboom.PLAYER.y,kaboom.PLAYER.w,kaboom.PLAYER.h)};draw.score=function(ctx,state){ctx.fillStyle="white";ctx.font="10px arial";ctx.textBaseline="top";ctx.textAlign="center";ctx.fillText(state.score,320,20)};draw.ui=function(ctx,state){var button=kaboom.BUTTON_PAUSE;ctx.fillStyle="white";ctx.fillRect(button.x,button.y,button.w,button.h);if(state.gameOver){button=kaboom.BUTTON_NEW_GAME;ctx.fillStyle="white";ctx.fillRect(button.x,button.y,button.w,button.h)}};draw.pauseOverlay=function(ctx,canvas,state){if(state.pauseTime>0||state.pauseTime===-1){ctx.fillStyle="rgba(0,0,0,0.5)";ctx.fillRect(0,0,canvas.width,canvas.height);ctx.fillStyle="white";ctx.font="20px arial";ctx.textBaseline="top";ctx.textAlign="center";ctx.fillText(state.pauseMessage,canvas.width/2,200)}};draw.debug=function(ctx,state){ctx.fillStyle="white";ctx.font="10px arial";ctx.textBaseline="top";ctx.textAlign="left";ctx.fillText("level: "+state.level,10,10);ctx.fillText("bombCount: "+state.bombCount,10,20);ctx.fillText("bomber: { x: "+state.bomber.x+", dir: "+state.bomber.dir+", pps: "+state.bomber.pps+" }",10,30);ctx.fillText("player: { x: "+state.player.x+", hp: "+state.player.hp+", dir: "+state.player.dir+", inputAI: "+state.player.inputAI+", pps: "+state.player.pps+" }",10,40)};draw.ver=function(ctx,canvas,state){ctx.fillStyle="white";ctx.textBaseline="top";ctx.font="10px arial";ctx.textAlign="left";ctx.fillText("v"+state.ver,5,canvas.height-10)};var canvasObj=utils.createCanvas({width:640,height:480}),canvas=canvasObj.canvas,ctx=canvasObj.ctx;var state=kaboom.createState(1);canvas.addEventListener("mousedown",function(e){state.player.inputPos.down=true;kaboom.pointerStart(state,e)});canvas.addEventListener("mousemove",function(e){e.preventDefault();var pos=utils.getCanvasRelative(e),player=state.player;player.inputPos.x=pos.x;player.inputPos.y=pos.y});canvas.addEventListener("mouseup",function(e){state.player.inputPos.down=false});window.addEventListener("keydown",function(e){var key=e.key.toLowerCase(),player=state.player;player.inputKeys[key]=true;if(key==="i"){player.inputAI=!player.inputAI}});window.addEventListener("keyup",function(e){var key=e.key.toLowerCase(),player=state.player;player.inputKeys[key]=false});var loop=function(){requestAnimationFrame(loop);kaboom.update(state);draw.back(ctx,canvas);draw.bomber(ctx,state);draw.bombs(ctx,state);draw.player(ctx,state);draw.score(ctx,state);draw.ui(ctx,state);draw.pauseOverlay(ctx,canvas,state);draw.ver(ctx,canvas,state);draw.debug(ctx,state)};loop();
